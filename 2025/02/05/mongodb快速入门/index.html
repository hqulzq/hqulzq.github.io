<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hqulzq.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="文档对应的视频来自bibi黑马程序员MongoDB基础入门到高级进阶 课程目标 理解MongoDB的业务场景、熟悉MongoDB的简介、特点和体系结构、数据类型等。 能够在Windows和Linux下安装和启动MongoDB、图形化管理界面Compass的安装使用 掌握MongoDB基本常用命令实现数据的CRUD 掌握MongoDB的索引类型、索引管理、执行计划。 使用Spring Data Mo">
<meta property="og:type" content="article">
<meta property="og:title" content="mongodb快速入门">
<meta property="og:url" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Lzq&#39;s blog">
<meta property="og:description" content="文档对应的视频来自bibi黑马程序员MongoDB基础入门到高级进阶 课程目标 理解MongoDB的业务场景、熟悉MongoDB的简介、特点和体系结构、数据类型等。 能够在Windows和Linux下安装和启动MongoDB、图形化管理界面Compass的安装使用 掌握MongoDB基本常用命令实现数据的CRUD 掌握MongoDB的索引类型、索引管理、执行计划。 使用Spring Data Mo">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240124144808.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240124152221.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240124153239.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125185048.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125185207.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125204652.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125204912.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125205417.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125205711.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125205754.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125210642.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125210724.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125210747.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125225043.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125225206.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240125225437.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240126184037.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240126184503.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240126203405.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240126203415.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240126215010.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240126215056.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240126223343.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240126224029.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240126224101.png&quot;">
<meta property="og:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240126231041.png&quot;">
<meta property="article:published_time" content="2025-02-05T13:18:57.000Z">
<meta property="article:modified_time" content="2025-02-27T02:37:03.597Z">
<meta property="article:author" content="Zongqing Li">
<meta property="article:tag" content="快速入门">
<meta property="article:tag" content="mongodb">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/QQ%E6%88%AA%E5%9B%BE20240124144808.png&quot;">

<link rel="canonical" href="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>mongodb快速入门 | Lzq's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lzq's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">31</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">12</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">41</span></a>

  </li>
        <li class="menu-item menu-item-book">

    <a href="/book" rel="section"><i class="fas fa-book fa-fw"></i>Book</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hqulzq.github.io/2025/02/05/mongodb%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://github.com/hqulzq/hqulzq.github.io/blob/main/images/userimg.jpg?raw=true">
      <meta itemprop="name" content="Zongqing Li">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lzq's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mongodb快速入门
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-02-05 21:18:57" itemprop="dateCreated datePublished" datetime="2025-02-05T21:18:57+08:00">2025-02-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-02-27 10:37:03" itemprop="dateModified" datetime="2025-02-27T10:37:03+08:00">2025-02-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1bJ411x7mq">文档对应的视频来自bibi黑马程序员MongoDB基础入门到高级进阶</a></p>
<h1 id="课程目标"><a href="#课程目标" class="headerlink" title="课程目标"></a>课程目标</h1><ul>
<li>理解MongoDB的业务场景、熟悉MongoDB的简介、特点和体系结构、数据类型等。</li>
<li>能够在Windows和Linux下安装和启动MongoDB、图形化管理界面Compass的安装使用</li>
<li>掌握MongoDB基本常用命令实现数据的CRUD</li>
<li>掌握MongoDB的索引类型、索引管理、执行计划。</li>
<li>使用Spring Data MongoDB完成文章评论业务的开发<span id="more"></span>
<h1 id="1-MongoDB相关概念"><a href="#1-MongoDB相关概念" class="headerlink" title="1 MongoDB相关概念"></a>1 MongoDB相关概念</h1></li>
</ul>
<h2 id="1-1-业务应用场景"><a href="#1-1-业务应用场景" class="headerlink" title="1.1 业务应用场景"></a>1.1 业务应用场景</h2><p>传统的关系型数据库（如MySQL），在数据操作的“三高”需求以及应对Web2.0的网站需求面前，显得力不从心。解释：“三高”需求：</p>
<ul>
<li>High performance - 对数据库高并发读写的需求。</li>
<li>Huge Storage - 对海量数据的高效率存储和访问的需求。</li>
<li>High Scalability &amp;&amp; High Availability- 对数据库的高可扩展性和高可用性的需求。</li>
</ul>
<h6 id="而MongoDB可应对“三高”需求"><a href="#而MongoDB可应对“三高”需求" class="headerlink" title="而MongoDB可应对“三高”需求"></a>而MongoDB可应对“三高”需求</h6><p>具体的应用场景如：</p>
<ul>
<li>1 ）社交场景，使用 MongoDB 存储存储用户信息，以及用户发表的朋友圈信息，通过地理位置索引实现附近的人、地点等功能。</li>
<li>2 ）游戏场景，使用 MongoDB 存储游戏用户信息，用户的装备、积分等直接以内嵌文档的形式存储，方便查询、高效率存储和访问。</li>
<li>3 ）物流场景，使用 MongoDB 存储订单信息，订单状态在运送过程中会不断更新，以 MongoDB 内嵌数组的形式来存储，一次查询就能将订单所有的变更读取出来。</li>
<li>4 ）物联网场景，使用 MongoDB 存储所有接入的智能设备信息，以及设备汇报的日志信息，并对这些信息进行多维度的分析。</li>
<li>5 ）视频直播，使用 MongoDB 存储用户信息、点赞互动信息等。</li>
</ul>
<p>这些应用场景中，数据操作方面的共同特点是：</p>
<ul>
<li>（ 1 ）数据量大</li>
<li>（ 2 ）写入操作频繁（读写都很频繁）</li>
<li>（ 3 ）价值较低的数据，对事务性要求不高</li>
</ul>
<p>对于这样的数据，我们更适合使用MongoDB来实现数据的存储。</p>
<h6 id="什么时候选择MongoDB"><a href="#什么时候选择MongoDB" class="headerlink" title="什么时候选择MongoDB"></a>什么时候选择MongoDB</h6><h6 id="在架构选型上，除了上述的三个特点外，如果你还犹豫是否要选择它？可以考虑以下的一些问题"><a href="#在架构选型上，除了上述的三个特点外，如果你还犹豫是否要选择它？可以考虑以下的一些问题" class="headerlink" title="在架构选型上，除了上述的三个特点外，如果你还犹豫是否要选择它？可以考虑以下的一些问题"></a>在架构选型上，除了上述的三个特点外，如果你还犹豫是否要选择它？可以考虑以下的一些问题</h6><ul>
<li>应用不需要事务及复杂 join 支持</li>
<li>新应用，需求会变，数据模型无法确定，想快速迭代开发</li>
<li>应用需要2000-3000以上的读写QPS（更高也可以）</li>
<li>应用需要TB甚至 PB 级别数据存储</li>
<li>应用发展迅速，需要能快速水平扩展</li>
<li>应用要求存储的数据不丢失</li>
<li>应用需要99.999%高可用</li>
<li>应用需要大量的地理位置查询、文本查询</li>
</ul>
<p>如果上述有 1 个符合，可以考虑 MongoDB， 2 个及以上的符合，选择 MongoDB 绝不会后悔。</p>
<p>思考：如果用MySQL呢？</p>
<p>答：相对MySQL，可以以更低的成本解决问题（包括学习、开发、运维等成本）</p>
<h2 id="1-2-MongoDB简介"><a href="#1-2-MongoDB简介" class="headerlink" title="1.2 MongoDB简介"></a>1.2 MongoDB简介</h2><blockquote>
<p>MongoDB是一个开源、高性能、无模式的文档型数据库，当初的设计就是用于简化开发和方便扩展，是NoSQL数据库产品中的一种。是最像关系型数据库（MySQL）的非关系型数据库。</p>
<p>它支持的数据结构非常松散，是一种类似于 JSON 的 格式叫BSON，所以它既可以存储比较复杂的数据类型，又相当的灵活。</p>
<p>MongoDB中的记录是一个文档，它是一个由字段和值对（field:<br>value）组成的数据结构。MongoDB文档类似于JSON对象，即一个文档认为就是一个对象。字段的数据类型是字符型，它的值除了使用基本的一些类型外，还可以包括其他文档、普通数组和文档数组。</p>
</blockquote>
<h2 id="1-3-体系结构"><a href="#1-3-体系结构" class="headerlink" title="1.3 体系结构"></a>1.3 体系结构</h2><h4 id="MySQL和MongoDB对比"><a href="#MySQL和MongoDB对比" class="headerlink" title="MySQL和MongoDB对比"></a>MySQL和MongoDB对比</h4><p><img src="QQ截图20240124144808.png&quot;" alt="输入图片说明"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">SQL术语/概念</th>
<th style="text-align:center">MongoDB术语/概念</th>
<th style="text-align:center">解释/说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">database</td>
<td style="text-align:center">database</td>
<td style="text-align:center">数据库</td>
</tr>
<tr>
<td style="text-align:center">table</td>
<td style="text-align:center">collection</td>
<td style="text-align:center">数据库表/集合</td>
</tr>
<tr>
<td style="text-align:center">row</td>
<td style="text-align:center">document</td>
<td style="text-align:center">数据记录行/文档</td>
</tr>
<tr>
<td style="text-align:center">column</td>
<td style="text-align:center">field</td>
<td style="text-align:center">数据字段/域</td>
</tr>
<tr>
<td style="text-align:center">index</td>
<td style="text-align:center">index</td>
<td style="text-align:center">索引</td>
</tr>
<tr>
<td style="text-align:center">table joins</td>
<td style="text-align:center"></td>
<td style="text-align:center">表连接,MongoDB不支持</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">嵌入文档</td>
<td style="text-align:center">MongoDB通过嵌入式文档来替代多表连接</td>
</tr>
<tr>
<td style="text-align:center">primary key</td>
<td style="text-align:center">primary key</td>
<td style="text-align:center">主键,MongoDB自动将_id字段设置为主键</td>
</tr>
</tbody>
</table>
</div>
<h2 id="1-4-数据模型"><a href="#1-4-数据模型" class="headerlink" title="1.4 数据模型"></a>1.4 数据模型</h2><blockquote>
<p>MongoDB的最小存储单位就是文档(document)对象。文档(document)对象对应于关系型数据库的行。数据在MongoDB中以BSON（Binary-JSON）文档的格式存储在磁盘上。</p>
<p>BSON（Binary Serialized Document Format）是一种类json的一种二进制形式的存储格式，简称Binary<br>JSON。BSON和JSON一样，支持内嵌的文档对象和数组对象，但是BSON有JSON没有的一些数据类型，如Date和BinData类型。</p>
<p>BSON采用了类似于 C 语言结构体的名称、对表示方法，支持内嵌的文档对象和数组对象，具有轻量性、可遍历性、高效性的三个特点，可以有效描述非结构化数据和结构化数据。这种格式的优点是灵活性高，但它的缺点是空间利用率不是很理想。</p>
<p>Bson中，除了基本的JSON类型：string,integer,boolean,double,null,array和object，mongo还使用了特殊的数据类型。这些类型包括date,object<br>id,binary data,regular expression 和code。每一个驱动都以特定语言的方式实现了这些类型，查看你的驱动的文档来获取详 细信息。</p>
</blockquote>
<h6 id="BSON数据类型参考列表"><a href="#BSON数据类型参考列表" class="headerlink" title="BSON数据类型参考列表"></a>BSON数据类型参考列表</h6><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">数据类型</th>
<th style="text-align:center">描述</th>
<th style="text-align:center">举例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">字符串</td>
<td style="text-align:center">UTF-8字符串都可表示为字符串类型的数据</td>
<td style="text-align:center">{“x” : “foobar”}</td>
</tr>
<tr>
<td style="text-align:center">对象id</td>
<td style="text-align:center">对象id是文档的 12 字节的唯一 ID</td>
<td style="text-align:center">{“X” :ObjectId() }</td>
</tr>
<tr>
<td style="text-align:center">布尔值</td>
<td style="text-align:center">真或者假：true或者false</td>
<td style="text-align:center">{“x”:true}+</td>
</tr>
<tr>
<td style="text-align:center">数组</td>
<td style="text-align:center">值的集合或者列表可以表示成数组</td>
<td style="text-align:center">{“x” ： [“a”, “b”, “c”]}</td>
</tr>
<tr>
<td style="text-align:center">32位整数</td>
<td style="text-align:center">类型不可用。JavaScript仅支持 64 位浮点数，所以 32 位整数会被自动转换。</td>
<td style="text-align:center">shell是不支持该类型的，shell中默认会转换成64位浮点数</td>
</tr>
<tr>
<td style="text-align:center">64 位整数</td>
<td style="text-align:center">不支持这个类型。shell会使用一个特殊的内嵌文档来显示 64 位整数</td>
<td style="text-align:center">shell是不支持该类型的，shell中默认会转换成 64位浮点数</td>
</tr>
<tr>
<td style="text-align:center">64 位浮点数</td>
<td style="text-align:center">shell中的数字就是这一种类型</td>
<td style="text-align:center">{“x”：3.14159，”y”：3}</td>
</tr>
<tr>
<td style="text-align:center">null</td>
<td style="text-align:center">表示空值或者未定义的对象</td>
<td style="text-align:center">{“x”:null}</td>
</tr>
<tr>
<td style="text-align:center">undefined</td>
<td style="text-align:center">文档中也可以使用未定义类型 v{“x”:undefined}</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">符号</td>
<td style="text-align:center">shell不支持，shell会将数据库中的符号类型的数据自动转换成字符串</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">正则表达式</td>
<td style="text-align:center">文档中可以包含正则表达式，采用JavaScript的正则表达式语法</td>
<td style="text-align:center">{“x” ： /foobar/i}</td>
</tr>
<tr>
<td style="text-align:center">代码</td>
<td style="text-align:center">文档中还可以包含JavaScript代码</td>
<td style="text-align:center">{“x” ： function() { /<em>……</em>/ }}</td>
</tr>
<tr>
<td style="text-align:center">二进制数据</td>
<td style="text-align:center">二进制数据可以由任意字节的串组成，不过shell中无法使用</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">最大值/最小值</td>
<td style="text-align:center">BSON包括一个特殊类型，表示可能的最大值。shell中没有这个类型。</td>
</tr>
</tbody>
</table>
</div>
<h6 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h6><p>shell默认使用 64 位浮点型数值。{“x”：3.14}或{“x”：3}。对于整型值，可以使用NumberInt（ 4 字节符号整数）或NumberLong（ 8<br>字节符号整数），{“x”:NumberInt(“3”)}{“x”:NumberLong(“3”)}</p>
<h2 id="1-5-MongoDB的特点"><a href="#1-5-MongoDB的特点" class="headerlink" title="1.5 MongoDB的特点"></a>1.5 MongoDB的特点</h2><h4 id="MongoDB主要有如下特点"><a href="#MongoDB主要有如下特点" class="headerlink" title="MongoDB主要有如下特点"></a>MongoDB主要有如下特点</h4><ul>
<li>（ 1 ）高性能：<br>*<br>MongoDB提供高性能的数据持久性。特别是,对嵌入式数据模型的支持减少了数据库系统上的I/O活动。索引支持更快的查询，并且可以包含来自嵌入式文档和数组的键。（文本索引解决搜索的需求、TTL索引解决历史数据自动过期的需求、地理位置索引可用于构建各种<br>O2O 应用）mmapv1、wiredtiger、mongorocks（rocksdb）、in-memory 等多引擎支持满足各种场景需求。Gridfs解决文件存储的需求。</li>
<li>（ 2 ）高可用性：<ul>
<li>MongoDB的复制工具称为副本集（replica set），它可提供自动故障转移和数据冗余。</li>
</ul>
</li>
<li>（ 3 ）高扩展性：<br>*<br>MongoDB提供了水平可扩展性作为其核心功能的一部分。分片将数据分布在一组集群的机器上。（海量数据存储，服务能力水平扩展）从3.4开始，MongoDB支持基于片键创建数据区域。在一个平衡的集群中，MongoDB将一个区域所覆盖的读写只定向到该区域内的那些片。</li>
<li>（ 4 ）丰富的查询支持：<ul>
<li>MongoDB支持丰富的查询语言，支持读和写操作(CRUD)，比如数据聚合、文本搜索和地理空间查询等。</li>
</ul>
</li>
<li>（ 5 ）其他特点：如无模式（动态模式）、灵活的文档模型、</li>
</ul>
<h1 id="2-单机部署"><a href="#2-单机部署" class="headerlink" title="2 单机部署"></a>2 单机部署</h1><h2 id="2-1-Windows系统中的安装启动"><a href="#2-1-Windows系统中的安装启动" class="headerlink" title="2.1 Windows系统中的安装启动"></a>2.1 Windows系统中的安装启动</h2><h4 id="第一步：下载安装包"><a href="#第一步：下载安装包" class="headerlink" title="第一步：下载安装包"></a>第一步：下载安装包</h4><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/download-center#community">MongoDB 提供了可用于 32 位和 64 位系统的预编译二进制包，你可以从MongoDB官网下载安装，MongoDB 预编译二进制包下载地址：</a></p>
<p><img src="QQ截图20240124152221.png&quot;" alt="输入图片说明"></p>
<h4 id="根据上图所示下载zip包"><a href="#根据上图所示下载zip包" class="headerlink" title="根据上图所示下载zip包"></a>根据上图所示下载zip包</h4><h4 id="提示：版本的选择"><a href="#提示：版本的选择" class="headerlink" title="提示：版本的选择"></a>提示：版本的选择</h4><h4 id="MongoDB的版本命名规范如：x-y-z"><a href="#MongoDB的版本命名规范如：x-y-z" class="headerlink" title="MongoDB的版本命名规范如：x.y.z"></a>MongoDB的版本命名规范如：x.y.z</h4><ul>
<li>y为奇数时表示当前版本为开发版，如：1.5.2、4.1.13；</li>
<li>y为偶数时表示当前版本为稳定版，如：1.6.3、4.0.10；</li>
<li>z是修正版本号，数字越大越好。</li>
</ul>
<p>详情：<a target="_blank" rel="noopener" href="http://docs.mongodb.org/manual/release-notes/#release-version-numbers">http://docs.mongodb.org/manual/release-notes/#release-version-numbers</a></p>
<h4 id="第二步：解压安装启动"><a href="#第二步：解压安装启动" class="headerlink" title="第二步：解压安装启动"></a>第二步：解压安装启动</h4><ul>
<li>将压缩包解压到一个目录中。</li>
<li>在解压目录中，手动建立一个目录用于存放数据文件，如data/db</li>
</ul>
<h4 id="方式-1-：命令行参数方式启动服务"><a href="#方式-1-：命令行参数方式启动服务" class="headerlink" title="方式 1 ：命令行参数方式启动服务"></a>方式 1 ：命令行参数方式启动服务</h4><p>在bin目录中打开命令行提示符，输入如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod - -dbpath=..\data\db</span><br></pre></td></tr></table></figure>
<h6 id="我们在启动信息中可以看到，mongoDB的默认端口是-27017-，如果我们想改变默认的启动端口，可以通过—port来指定端口。为了方便我们每次启动，可以将安装目录的bin目录设置到环境变量的path中，bin目录下是一些常用命令，比如mongod启动服务用的，mongo客户端连接服务用的"><a href="#我们在启动信息中可以看到，mongoDB的默认端口是-27017-，如果我们想改变默认的启动端口，可以通过—port来指定端口。为了方便我们每次启动，可以将安装目录的bin目录设置到环境变量的path中，bin目录下是一些常用命令，比如mongod启动服务用的，mongo客户端连接服务用的" class="headerlink" title="我们在启动信息中可以看到，mongoDB的默认端口是 27017 ，如果我们想改变默认的启动端口，可以通过—port来指定端口。为了方便我们每次启动，可以将安装目录的bin目录设置到环境变量的path中，bin目录下是一些常用命令，比如mongod启动服务用的，mongo客户端连接服务用的"></a>我们在启动信息中可以看到，mongoDB的默认端口是 27017 ，如果我们想改变默认的启动端口，可以通过—port来指定端口。为了方便我们每次启动，可以将安装目录的bin目录设置到环境变量的path中，bin目录下是一些常用命令，比如mongod启动服务用的，mongo客户端连接服务用的</h6><h4 id="方式-2-：配置文件方式启动服务"><a href="#方式-2-：配置文件方式启动服务" class="headerlink" title="方式 2 ：配置文件方式启动服务"></a>方式 2 ：配置文件方式启动服务</h4><p>在解压目录中新建<code>config</code>文件夹，该文件夹中新建配置文件<code>mongod.conf</code>，内如参考如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">The directory <span class="built_in">where</span> the mongod instance stores its data.Default Value is <span class="string">&quot;\data\db&quot;</span> on Windows.</span></span><br><span class="line">  dbPath:  D:\02_Server\DBServer\mongodb-win32-x86_64-2008plus-ssl-4.0.1\data</span><br></pre></td></tr></table></figure>
<p>详细配置项内容可以参考官方文档：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/configuration-options/">https://docs.mongodb.com/manual/reference/configuration-options/</a></p>
<h4 id="【注意】"><a href="#【注意】" class="headerlink" title="【注意】"></a>【注意】</h4><ul>
<li><p>1 ）配置文件中如果使用双引号，比如路径地址，自动会将双引号的内容转义。如果不转义，则会报错：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error-parsing-yaml-config-file-yaml-cpp-error-at-line-3-column-15-unknown-escape-character-d</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><ul>
<li>a. 对\换成/或\\</li>
<li><p>b. 如果路径中没有空格，则无需加引号。</p>
</li>
<li><p>2 ）配置文件中不能以Tab分割字段</p>
</li>
</ul>
<h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h4><ul>
<li>将其转换成空格。</li>
</ul>
<h4 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongod -f ../config/mongod.conf</span><br><span class="line">或</span><br><span class="line">mongod --config ../config/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="更多参数配置"><a href="#更多参数配置" class="headerlink" title="更多参数配置"></a>更多参数配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">The path of the <span class="built_in">log</span> file to <span class="built_in">which</span> mongod or mongos should send all diagnostic logging information</span></span><br><span class="line">  path: &quot;D:/02_Server/DBServer/mongodb-win32-x86_64-2008plus-ssl-4.0.1/log/mongod.log&quot;</span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">The directory <span class="built_in">where</span> the mongod instance stores its data.Default Value is <span class="string">&quot;/data/db&quot;</span>.</span></span><br><span class="line">  dbPath: &quot;D:/02_Server/DBServer/mongodb-win32-x86_64-2008plus-ssl-4.0.1/data&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIp: 127.0.0.1</span></span><br><span class="line">  port: 27017</span><br><span class="line">setParameter:</span><br><span class="line">  enableLocalhostAuthBypass: false</span><br></pre></td></tr></table></figure>
<h2 id="2-2-Shell连接-mongo命令"><a href="#2-2-Shell连接-mongo命令" class="headerlink" title="2.2 Shell连接(mongo命令)"></a>2.2 Shell连接(mongo命令)</h2><h4 id="在命令提示符输入以下shell命令即可完成登陆"><a href="#在命令提示符输入以下shell命令即可完成登陆" class="headerlink" title="在命令提示符输入以下shell命令即可完成登陆"></a>在命令提示符输入以下shell命令即可完成登陆</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongo</span><br><span class="line">或</span><br><span class="line">mongo --host=127.0.0.1 --port=27017</span><br></pre></td></tr></table></figure>
<h4 id="查看已经有的数据库"><a href="#查看已经有的数据库" class="headerlink" title="查看已经有的数据库"></a>查看已经有的数据库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show databases</span><br></pre></td></tr></table></figure>
<h4 id="退出mongodb"><a href="#退出mongodb" class="headerlink" title="退出mongodb"></a>退出mongodb</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>
<h4 id="更多参数可以通过帮助查看"><a href="#更多参数可以通过帮助查看" class="headerlink" title="更多参数可以通过帮助查看"></a>更多参数可以通过帮助查看</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongo --help</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="提示-1"><a href="#提示-1" class="headerlink" title="提示"></a>提示</h4><p>MongoDB javascript shell是一个基于javascript的解释器，故是支持js程序的。</p>
<h2 id="2-3-Compass-图形化界面客户端"><a href="#2-3-Compass-图形化界面客户端" class="headerlink" title="2.3 Compass-图形化界面客户端"></a>2.3 Compass-图形化界面客户端</h2><blockquote>
<p>到MongoDB官网下载MongoDB Compass，</p>
<p>地址：<a target="_blank" rel="noopener" href="https://www.mongodb.com/download-center/v2/compass?initial=true">https://www.mongodb.com/download-center/v2/compass?initial=true</a></p>
<p>如果是下载安装版，则按照步骤安装；如果是下载加压缩版，直接解压，执行里面的MongoDBCompassCommunity.exe文件即可。</p>
<p>在打开的界面中，输入主机地址、端口等相关信息，点击连接：</p>
</blockquote>
<p><img src="QQ截图20240124153239.png&quot;" alt="输入图片说明"></p>
<h2 id="2-4-Linux系统中的安装启动和连接"><a href="#2-4-Linux系统中的安装启动和连接" class="headerlink" title="2.4 Linux系统中的安装启动和连接"></a>2.4 Linux系统中的安装启动和连接</h2><h4 id="目标：在Linux中部署一个单机的MongoDB，作为生产环境下使用"><a href="#目标：在Linux中部署一个单机的MongoDB，作为生产环境下使用" class="headerlink" title="目标：在Linux中部署一个单机的MongoDB，作为生产环境下使用"></a>目标：在Linux中部署一个单机的MongoDB，作为生产环境下使用</h4><h4 id="提示：和Windows下操作差不多"><a href="#提示：和Windows下操作差不多" class="headerlink" title="提示：和Windows下操作差不多"></a>提示：和Windows下操作差不多</h4><h4 id="步骤如下"><a href="#步骤如下" class="headerlink" title="步骤如下"></a>步骤如下</h4><ul>
<li><p>（ 1 ）先到官网下载压缩包包 mongod-linux-x86_64-4.0.10.tgz 。</p>
</li>
<li><p>（ 2 ）上传压缩包到Linux中，解压到当前目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf mongodb-linux-x86_64-4.0.10.tgz</span><br></pre></td></tr></table></figure>
</li>
<li><p>（ 3 ）移动解压后的文件夹到指定的目录中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv mongodb-linux-x86_64-4.0.10 /usr/local/mongodb</span><br></pre></td></tr></table></figure>
</li>
<li><p>（ 4 ）新建几个目录，分别用来存储数据和日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">数据存储目录</span></span><br><span class="line">mkdir -p /mongodb/single/data/db</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">日志存储目录</span></span><br><span class="line">mkdir -p /mongodb/single/log</span><br></pre></td></tr></table></figure>
<ul>
<li><p>（ 5 ）新建并修改配置文件</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /mongodb/single/mongod.conf</span><br></pre></td></tr></table></figure>
<ul>
<li><p>配置文件的内容如下：</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash"><span class="comment">#The path of the log file to which mongod or mongos should send all diagnostic logging information</span></span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/single/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">#The directory where the mongod instance stores its data.Default Value is &quot;/data/db&quot;.</span></span></span><br><span class="line">  dbPath: &quot;/mongodb/single/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP，默认是localhost</span></span><br><span class="line">  bindIp: localhost, 192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIp</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口，默认是 27017</span></span><br><span class="line">  port: 27017</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>（ 6 ）启动MongoDB服务</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost single]# /usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 90384</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>如果启动后不是successfully，则是启动失败了。原因基本上就是配置文件有问题。</p>
<h4 id="通过进程来查看服务是否启动了"><a href="#通过进程来查看服务是否启动了" class="headerlink" title="通过进程来查看服务是否启动了"></a>通过进程来查看服务是否启动了</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost single]# ps -ef |grep mongod</span><br><span class="line">root 90384 1 0 8月26 ? 00:02:13 /usr/local/mongdb/bin/mongod -f /mongodb/single/mongod.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>7 ）分别使用mongo命令和compass工具来连接测试。</li>
</ul>
<h4 id="提示：如果远程连接不上，需要配置防火墙放行，或直接关闭linux防火墙"><a href="#提示：如果远程连接不上，需要配置防火墙放行，或直接关闭linux防火墙" class="headerlink" title="提示：如果远程连接不上，需要配置防火墙放行，或直接关闭linux防火墙"></a>提示：如果远程连接不上，需要配置防火墙放行，或直接关闭linux防火墙</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看防火墙状态</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">临时关闭防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">开机禁止启动防火墙</span></span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 8 ）停止关闭服务</li>
</ul>
<h4 id="停止服务的方式有两种：快速关闭和标准关闭，下面依次说明"><a href="#停止服务的方式有两种：快速关闭和标准关闭，下面依次说明" class="headerlink" title="停止服务的方式有两种：快速关闭和标准关闭，下面依次说明"></a>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明</h4><ul>
<li>（一）快速关闭方法（快速，简单，数据可能会出错）</li>
</ul>
<p>目标：通过系统的kill命令直接杀死进程： 杀完要检查一下，避免有的没有杀掉。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通过进程编号关闭节点</span></span><br><span class="line">kill -2 54410</span><br></pre></td></tr></table></figure>
<h4 id="【补充】"><a href="#【补充】" class="headerlink" title="【补充】"></a>【补充】</h4><p>如果一旦是因为数据损坏，则需要进行如下操作（了解）：</p>
<ul>
<li><p>1 ）删除lock文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f /mongodb/single/data/db/*.lock</span><br></pre></td></tr></table></figure>
</li>
<li><p>2 ）修复数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongdb/bin/mongod --repair --dbpath=/mongodb/single/data/db</span><br></pre></td></tr></table></figure>
</li>
<li><p>（二）标准的关闭方法（数据不容易出错，但麻烦）：</p>
</li>
</ul>
<p>目标：通过mongo客户端中的shutdownServer命令来关闭服务</p>
<p>主要的操作步骤参考如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27017</span><br><span class="line"><span class="meta prompt_">//#</span><span class="language-bash">切换到admin库</span></span><br><span class="line">use admin</span><br><span class="line">//关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure>
<h1 id="3-基本常用命令"><a href="#3-基本常用命令" class="headerlink" title="3 基本常用命令"></a>3 基本常用命令</h1><h2 id="3-1-案例需求"><a href="#3-1-案例需求" class="headerlink" title="3.1 案例需求"></a>3.1 案例需求</h2><p>存放文章评论的数据存放到MongoDB中，数据结构参考如下：</p>
<p><em>数据库：articledb</em></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">字段名称</th>
<th style="text-align:center">字段含义</th>
<th style="text-align:center">字段类型</th>
<th style="text-align:center">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">_id</td>
<td style="text-align:center">ID</td>
<td style="text-align:center">ObjectId或String</td>
<td style="text-align:center">Mongo的主键的字段</td>
</tr>
<tr>
<td style="text-align:center">articleid</td>
<td style="text-align:center">文章ID</td>
<td style="text-align:center">String</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">content</td>
<td style="text-align:center">评论内容</td>
<td style="text-align:center">String</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">userid</td>
<td style="text-align:center">评论人ID</td>
<td style="text-align:center">String</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">nickname</td>
<td style="text-align:center">评论人昵称</td>
<td style="text-align:center">String</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">createdatetime</td>
<td style="text-align:center">评论的日期时间</td>
<td style="text-align:center">Date</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">likenum</td>
<td style="text-align:center">点赞数</td>
<td style="text-align:center">Int32</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">replynum</td>
<td style="text-align:center">回复数</td>
<td style="text-align:center">Int32</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">state</td>
<td style="text-align:center">状态</td>
<td style="text-align:center">String</td>
<td style="text-align:center">0：不可见；1：可见；</td>
</tr>
<tr>
<td style="text-align:center">parentid</td>
<td style="text-align:center">上级ID</td>
<td style="text-align:center">String</td>
<td style="text-align:center">如果为0表示文章的顶级评论</td>
</tr>
</tbody>
</table>
</div>
<h2 id="3-2-数据库操作"><a href="#3-2-数据库操作" class="headerlink" title="3.2 数据库操作"></a>3.2 数据库操作</h2><h2 id="3-2-1-选择和创建数据库"><a href="#3-2-1-选择和创建数据库" class="headerlink" title="3.2.1 选择和创建数据库"></a>3.2.1 选择和创建数据库</h2><h4 id="选择和创建数据库的语法格式"><a href="#选择和创建数据库的语法格式" class="headerlink" title="选择和创建数据库的语法格式"></a>选择和创建数据库的语法格式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use 数据库名称</span><br></pre></td></tr></table></figure>
<h4 id="如果数据库不存在则自动创建，例如，以下语句创建spitdb数据库"><a href="#如果数据库不存在则自动创建，例如，以下语句创建spitdb数据库" class="headerlink" title="如果数据库不存在则自动创建，例如，以下语句创建spitdb数据库"></a>如果数据库不存在则自动创建，例如，以下语句创建spitdb数据库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use articledb</span><br></pre></td></tr></table></figure>
<h4 id="查看有权限查看的所有的数据库命令"><a href="#查看有权限查看的所有的数据库命令" class="headerlink" title="查看有权限查看的所有的数据库命令"></a>查看有权限查看的所有的数据库命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show dbs</span><br><span class="line">或</span><br><span class="line">show databases</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意: 在 MongoDB 中，集合只有在内容插入后才会创建! 就是说，创建集合(数据表)后要再插入一个文档(记录)，集合才会真正创建。</p>
</blockquote>
<h4 id="查看当前正在使用的数据库命令"><a href="#查看当前正在使用的数据库命令" class="headerlink" title="查看当前正在使用的数据库命令"></a>查看当前正在使用的数据库命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db</span><br></pre></td></tr></table></figure>
<p>MongoDB 中默认的数据库为 test，如果你没有选择数据库，集合将存放在 test 数据库中。</p>
<h4 id="另外"><a href="#另外" class="headerlink" title="另外"></a>另外</h4><p>数据库名可以是满足以下条件的任意UTF-8字符串。</p>
<ul>
<li>不能是空字符串（””)。</li>
<li>不得含有’ ‘（空格)、.、$、/、\和\0 (空字符)。</li>
<li>应全部小写。</li>
<li>最多 64 字节。</li>
</ul>
<p>有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库。</p>
<ul>
<li>admin： 从权限的角度来看，这是”root”数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。</li>
<li>local: 这个数据永远不会被复制，可以用来存储限于本地单台服务器的任意集合</li>
<li>config: 当Mongo用于分片设置时，config数据库在内部使用，用于保存分片的相关信息。</li>
</ul>
<h2 id="3-2-2-数据库的删除"><a href="#3-2-2-数据库的删除" class="headerlink" title="3.2.2 数据库的删除"></a>3.2.2 数据库的删除</h2><h4 id="MongoDB-删除数据库的语法格式如下"><a href="#MongoDB-删除数据库的语法格式如下" class="headerlink" title="MongoDB 删除数据库的语法格式如下"></a>MongoDB 删除数据库的语法格式如下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure>
<p><code>提示：主要用来删除已经持久化的数据库</code></p>
<h2 id="3-3-集合操作"><a href="#3-3-集合操作" class="headerlink" title="3.3 集合操作"></a>3.3 集合操作</h2><p>集合，类似关系型数据库中的表。</p>
<p>可以显示的创建，也可以隐式的创建。</p>
<h3 id="3-3-1-集合的显式创建（了解）"><a href="#3-3-1-集合的显式创建（了解）" class="headerlink" title="3.3.1 集合的显式创建（了解）"></a>3.3.1 集合的显式创建（了解）</h3><h4 id="基本语法格式"><a href="#基本语法格式" class="headerlink" title="基本语法格式"></a>基本语法格式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(name)</span><br></pre></td></tr></table></figure>
<h4 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h4><ul>
<li>name: 要创建的集合名称</li>
</ul>
<h4 id="例如：创建一个名为mycollection的普通集合"><a href="#例如：创建一个名为mycollection的普通集合" class="headerlink" title="例如：创建一个名为mycollection的普通集合"></a>例如：创建一个名为mycollection的普通集合</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(&quot;mycollection&quot;)</span><br></pre></td></tr></table></figure>
<h4 id="查看当前库中的表：show-tables命令"><a href="#查看当前库中的表：show-tables命令" class="headerlink" title="查看当前库中的表：show tables命令"></a>查看当前库中的表：show tables命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show collections</span><br><span class="line">或</span><br><span class="line">show tables</span><br></pre></td></tr></table></figure>
<ul>
<li>集合的命名规范：</li>
<li>集合名不能是空字符串””。</li>
<li>集合名不能含有\0字符（空字符)，这个字符表示集合名的结尾。</li>
<li>集合名不能以”system.”开头，这是为系统集合保留的前缀。</li>
<li>用户创建的集合名字不能含有保留字符。有些驱动程序的确支持在集合名里面包含，这是因为某些系统生成的集合中包含该字符。除非你要访问这种系统创建的集合，否则千万不要在名字里出现$。</li>
</ul>
<h3 id="3-3-2-集合的隐式创建"><a href="#3-3-2-集合的隐式创建" class="headerlink" title="3.3.2 集合的隐式创建"></a>3.3.2 集合的隐式创建</h3><p>当向一个集合中插入一个文档的时候，如果集合不存在，则会自动创建集合。</p>
<p>详见文档的插入章节。</p>
<p>提示：通常我们使用隐式创建文档即可。</p>
<h3 id="3-3-3-集合的删除"><a href="#3-3-3-集合的删除" class="headerlink" title="3.3.3 集合的删除"></a>3.3.3 集合的删除</h3><h4 id="集合删除语法格式如下"><a href="#集合删除语法格式如下" class="headerlink" title="集合删除语法格式如下"></a>集合删除语法格式如下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.collection.drop()</span><br><span class="line">或</span><br><span class="line">db.集合.drop()</span><br></pre></td></tr></table></figure>
<h4 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h4><p>如果成功删除选定集合，则 drop() 方法返回 true，否则返回 false。</p>
<p>例如：要删除mycollection集合</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.mycollection.drop()</span><br></pre></td></tr></table></figure>
<h2 id="3-4-文档基本CRUD"><a href="#3-4-文档基本CRUD" class="headerlink" title="3.4 文档基本CRUD"></a>3.4 文档基本CRUD</h2><p>文档（document）的数据结构和 JSON 基本一样。</p>
<p>所有存储在集合中的数据都是 BSON 格式。</p>
<h3 id="3-4-1-文档的插入"><a href="#3-4-1-文档的插入" class="headerlink" title="3.4.1 文档的插入"></a>3.4.1 文档的插入</h3><ul>
<li>（ 1 ）单个文档插入</li>
</ul>
<p>使用insert() 或 save() 方法向集合中插入文档，语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.insert(</span><br><span class="line">  &lt;document or array of documents&gt;,</span><br><span class="line">  &#123;</span><br><span class="line">  writeConcern: &lt;document&gt;,</span><br><span class="line">  ordered: &lt;boolean&gt;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">document</td>
<td style="text-align:center">document or array</td>
<td style="text-align:center">要插入到集合中的文档或文档数组。（(json格式）</td>
</tr>
<tr>
<td style="text-align:center">writeConcern</td>
<td style="text-align:center">document</td>
<td style="text-align:center">Optional. A document expressing the write concern. Omit to use the default write concern. See Write Concern.Do not explicitly set the write concern for the operation if run in a transaction. To use write concern with transactions, see Transactions and Write Concern.</td>
</tr>
<tr>
<td style="text-align:center">ordered</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">可选。如果为真，则按顺序插入数组中的文档，如果其中一个文档出现错误，MongoDB将返回而不处理数组中的其余文档。如果为假，则执行无序插入，如果其中一个文档出现错误，则继续处理数组中的主文档。在版本2.6+中默认为true</td>
</tr>
</tbody>
</table>
</div>
<h4 id="【示例】"><a href="#【示例】" class="headerlink" title="【示例】"></a>【示例】</h4><h4 id="要向comment的集合-表-中插入一条测试数据"><a href="#要向comment的集合-表-中插入一条测试数据" class="headerlink" title="要向comment的集合(表)中插入一条测试数据"></a>要向comment的集合(表)中插入一条测试数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insert(&#123;&quot;articleid&quot;:&quot;100000&quot;,&quot;content&quot;:&quot;今天天气真好，阳光明媚&quot;,&quot;userid&quot;:&quot;1001&quot;,&quot;nickname&quot;:&quot;Rose&quot;,&quot;createdatetime&quot;:new Date(),&quot;likenum&quot;:NumberInt(10),&quot;state&quot;:null&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="提示-2"><a href="#提示-2" class="headerlink" title="提示"></a>提示</h4><ul>
<li>1 ）comment集合如果不存在，则会隐式创建</li>
<li>2 ）mongo中的数字，默认情况下是double类型，如果要存整型，必须使用函数NumberInt(整型数字)，否则取出来就有问题了。</li>
<li>3 ）插入当前日期使用new Date()</li>
<li>4 ）插入的数据没有指定_id，会自动生成主键值</li>
<li>5 ）如果某字段没值，可以赋值为null，或不写该字段。</li>
</ul>
<h4 id="执行后，如下，说明插入一个数据成功了"><a href="#执行后，如下，说明插入一个数据成功了" class="headerlink" title="执行后，如下，说明插入一个数据成功了"></a>执行后，如下，说明插入一个数据成功了</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br></pre></td></tr></table></figure>
<h4 id="注意-1"><a href="#注意-1" class="headerlink" title="注意"></a>注意</h4><ul>
<li>1.文档中的键/值对是有序的。</li>
<li>2.文档中的值不仅可以是在双引号里面的字符串，还可以是其他几种数据类型（甚至可以是整个嵌入的文档)。</li>
<li>3.MongoDB区分类型和大小写。</li>
<li>4.MongoDB的文档不能有重复的键。</li>
<li>5.文档的键是字符串。除了少数例外情况，键可以使用任意UTF-8字符。</li>
</ul>
<h4 id="文档键命名规范"><a href="#文档键命名规范" class="headerlink" title="文档键命名规范"></a>文档键命名规范</h4><ul>
<li>键不能含有\0 (空字符)。这个字符用来表示键的结尾。</li>
<li>.和$有特别的意义，只有在特定环境下才能使用。</li>
<li><p>以下划线”_”开头的键是保留的(不是严格要求的)。</p>
</li>
<li><p>（ 2 ）批量插入</p>
</li>
</ul>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.collection.insertMany(</span><br><span class="line">  [ &lt;document 1&gt; , &lt;document 2&gt;, ... ],</span><br><span class="line">  &#123;</span><br><span class="line">  writeConcern: &lt;document&gt;,</span><br><span class="line">  ordered: &lt;boolean&gt;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="参数-1"><a href="#参数-1" class="headerlink" title="参数"></a>参数</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">document</td>
<td style="text-align:center">document</td>
<td style="text-align:center">要插入到集合中的文档或文档数组。（(json格式）</td>
</tr>
<tr>
<td style="text-align:center">writeConcern</td>
<td style="text-align:center">document</td>
<td style="text-align:center">Optional. A document expressing the write concern. Omit to use the default write concern.Do not explicitly set the write concern for the operation if run in a transaction. To use write concern with transactions, see Transactions and Write Concern.</td>
</tr>
<tr>
<td style="text-align:center">ordered</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">可选。一个布尔值，指定Mongod实例应执行有序插入还是无序插入。默认为true。</td>
</tr>
</tbody>
</table>
</div>
<h4 id="【示例】-1"><a href="#【示例】-1" class="headerlink" title="【示例】"></a>【示例】</h4><p>批量插入多条文章评论：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insertMany([</span><br><span class="line">  &#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(1000),&quot;state&quot;:&quot;1&quot;&#125;,&#123;&quot;_id&quot;:&quot;2&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;,&quot;userid&quot;:&quot;1005&quot;,&quot;nickname&quot;:&quot;伊人憔悴&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T23:58:51.485Z&quot;),&quot;likenum&quot;:NumberInt(888),&quot;state&quot;:&quot;1&quot;&#125;,&#123;&quot;_id&quot;:&quot;3&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我一直喝凉开水，冬天夏天都喝。&quot;,&quot;userid&quot;:&quot;1004&quot;,&quot;nickname&quot;:&quot;杰克船长&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T01:05:06.321Z&quot;),&quot;likenum&quot;:NumberInt(666),&quot;state&quot;:&quot;1&quot;&#125;,&#123;&quot;_id&quot;:&quot;4&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;专家说不能空腹吃饭，影响健康。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T08:18:35.288Z&quot;),&quot;likenum&quot;:NumberInt(2000),&quot;state&quot;:&quot;1&quot;&#125;,&#123;&quot;_id&quot;:&quot;5&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;研究表明，刚烧开的水千万不能喝，因为烫嘴。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T11:01:02.521Z&quot;),&quot;likenum&quot;:NumberInt(3000),&quot;state&quot;:&quot;1&quot;&#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<h4 id="提示-3"><a href="#提示-3" class="headerlink" title="提示"></a>提示</h4><p>插入时指定了_id，则主键就是该值。</p>
<p>如果某条数据插入失败，将会终止插入，但已经插入成功的数据不会回滚掉。</p>
<p>因为批量插入由于数据较多容易出现失败，因此，可以使用try catch进行异常捕捉处理，测试的时候可以不处理。如（了解）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">db.comment.insertMany([</span><br><span class="line">  &#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(1000),&quot;state&quot;:&quot;1&quot;&#125;,&#123;&quot;_id&quot;:&quot;2&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;,&quot;userid&quot;:&quot;1005&quot;,&quot;nickname&quot;:&quot;伊人憔悴&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T23:58:51.485Z&quot;),&quot;likenum&quot;:NumberInt(888),&quot;state&quot;:&quot;1&quot;&#125;,&#123;&quot;_id&quot;:&quot;3&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我一直喝凉开水，冬天夏天都喝。&quot;,&quot;userid&quot;:&quot;1004&quot;,&quot;nickname&quot;:&quot;杰克船长&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T01:05:06.321Z&quot;),&quot;likenum&quot;:NumberInt(666),&quot;state&quot;:&quot;1&quot;&#125;,&#123;&quot;_id&quot;:&quot;4&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;专家说不能空腹吃饭，影响健康。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T08:18:35.288Z&quot;),&quot;likenum&quot;:NumberInt(2000),&quot;state&quot;:&quot;1&quot;&#125;,&#123;&quot;_id&quot;:&quot;5&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;研究表明，刚烧开的水千万不能喝，因为烫嘴。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T11:01:02.521Z&quot;),&quot;likenum&quot;:NumberInt(3000),&quot;state&quot;:&quot;1&quot;&#125;</span><br><span class="line">  ]);</span><br><span class="line">&#125; catch (e) &#123;</span><br><span class="line">  print (e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-2-文档的基本查询"><a href="#3-4-2-文档的基本查询" class="headerlink" title="3.4.2 文档的基本查询"></a>3.4.2 文档的基本查询</h3><h4 id="查询数据的语法格式如下"><a href="#查询数据的语法格式如下" class="headerlink" title="查询数据的语法格式如下"></a>查询数据的语法格式如下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(&lt;query&gt;, [projection])</span><br></pre></td></tr></table></figure>
<h4 id="参数-2"><a href="#参数-2" class="headerlink" title="参数"></a>参数</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">query</td>
<td style="text-align:center">document</td>
<td style="text-align:center">可选。使用查询运算符指定选择筛选器。若要返回集合中的所有文档，请省略此参数或传递空文档( {} )。</td>
</tr>
<tr>
<td style="text-align:center">projection</td>
<td style="text-align:center">document</td>
<td style="text-align:center">可选。指定要在与查询筛选器匹配的文档中返回的字段（投影）。若要返回匹配文档中的所有字段，请省略此参数。</td>
</tr>
</tbody>
</table>
</div>
<h4 id="【示例】-2"><a href="#【示例】-2" class="headerlink" title="【示例】"></a>【示例】</h4><ul>
<li>（ 1 ）查询所有</li>
</ul>
<p>如果我们要查询spit集合的所有文档，我们输入以下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find()</span><br><span class="line">或</span><br><span class="line">db.comment.find(&#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>这里你会发现每条文档会有一个叫_id的字段，这个相当于我们原来关系数据库中表的主键，当你在插入文档记录时没有指定该字段，<br>MongoDB会自动创建，其类型是ObjectID类型。</p>
<p>如果我们在插入文档记录时指定该字段也可以，其类型可以是ObjectID类型，也可以是MongoDB支持的任意类型。</p>
<p>如果我想按一定条件来查询，比如我想查询userid为 1003 的记录，怎么办？很简单！只 要在find()中添加参数即可，参数也是json格式，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&#x27;1003&#x27;&#125;)</span><br></pre></td></tr></table></figure>
<p>如果你只需要返回符合条件的第一条数据，我们可以使用findOne命令来实现，语法和find一样。如：查询用户编号是 1003<br>的记录，但只最多返回符合条件的第一条记录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.findOne(&#123;userid:&#x27;1003&#x27;&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 2 ）投影查询（Projection Query）：</li>
</ul>
<p>如果要查询结果返回部分字段，则需要使用投影查询（不显示所有字段，只显示指定的字段）。如：查询结果只显示_id、userid、nickname:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">db.comment.find(&#123;userid:<span class="string">&quot;1003&quot;</span>&#125;,&#123;userid:1,nickname:1&#125;)</span></span><br><span class="line">&#123; &quot;_id&quot; : &quot;4&quot;, &quot;userid&quot; : &quot;1003&quot;, &quot;nickname&quot; : &quot;凯撒&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : &quot;5&quot;, &quot;userid&quot; : &quot;1003&quot;, &quot;nickname&quot; : &quot;凯撒&quot; &#125;</span><br></pre></td></tr></table></figure>
<h4 id="默认-id会显示"><a href="#默认-id会显示" class="headerlink" title="默认_id会显示"></a>默认_id会显示</h4><p>如：查询结果只显示、userid、nickname，不显示_id：</p>
<h4 id="再例如：查询所有数据，但只显示-id、userid、nickname"><a href="#再例如：查询所有数据，但只显示-id、userid、nickname" class="headerlink" title="再例如：查询所有数据，但只显示_id、userid、nickname"></a>再例如：查询所有数据，但只显示_id、userid、nickname</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">db.comment.find(&#123;&#125;,&#123;userid:1,nickname:1&#125;)</span></span><br></pre></td></tr></table></figure>
<h3 id="3-4-3-文档的更新"><a href="#3-4-3-文档的更新" class="headerlink" title="3.4.3 文档的更新"></a>3.4.3 文档的更新</h3><h4 id="更新文档的语法"><a href="#更新文档的语法" class="headerlink" title="更新文档的语法"></a>更新文档的语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update(query, update, options)</span><br><span class="line">//或</span><br><span class="line">db.collection.update(</span><br><span class="line">  &lt;query&gt;,</span><br><span class="line">  &lt;update&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">    upsert: &lt;boolean&gt;,</span><br><span class="line">    multi: &lt;boolean&gt;,</span><br><span class="line">    writeConcern: &lt;document&gt;,</span><br><span class="line">    collation: &lt;document&gt;,</span><br><span class="line">    arrayFilters: [ &lt;filterdocument1&gt;, ... ],</span><br><span class="line">    hint: &lt;document|string&gt; // Available starting in MongoDB 4.2</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="参数-3"><a href="#参数-3" class="headerlink" title="参数"></a>参数</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">query</td>
<td style="text-align:center">document</td>
<td style="text-align:center">更新的选择条件。可以使用与find（）方法中相同的查询选择器，类似sql update查询内where后面的。。在3.0版中进行了更改：当使用upsert:true执行update（）时，如果查询使用点表示法在_id字段上指定条件，则MongoDB将拒绝插入新文档。</td>
</tr>
<tr>
<td style="text-align:center">update</td>
<td style="text-align:center">document or pipeline</td>
<td style="text-align:center">要应用的修改。该值可以是：包含更新运算符表达式的文档，或仅包含：对的替换文档，或在MongoDB 4.2中启动聚合管道。管道可以由以下阶段组成：</td>
</tr>
<tr>
<td style="text-align:center">upsert</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">可选。如果设置为true，则在没有与查询条件匹配的文档时创建新文档。默认值为false，如果找不到匹配项，则不会插入新文档。</td>
</tr>
<tr>
<td style="text-align:center">multi</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">可选。如果设置为true，则更新符合查询条件的多个文档。如果设置为false，则更新一个文档。默认值为false。</td>
</tr>
<tr>
<td style="text-align:center">writeConcern</td>
<td style="text-align:center">document</td>
<td style="text-align:center">可选。表示写问题的文档。抛出异常的级别。</td>
</tr>
<tr>
<td style="text-align:center">collation</td>
<td style="text-align:center">document</td>
<td style="text-align:center">可选。指定要用于操作的校对规则。校对规则允许用户为字符串比较指定特定于语言的规则，例如字母大小写和重音标记的规则。校对规则选项具有以下语法：校对规则：{区域设置：，caseLevel:，caseFirst:，强度：，numericordering:，替代：，最大变量：，向后：}指定校对规则时，区域设置字段是必需的；所有其他校对规则字段都是可选的。有关字段的说明，请参阅校对规则文档。如果未指定校对规则，但集合具有默认校对规则（请参见db.createCollection（）），则该操作将使用为集合指定的校对规则。如果没有为集合或操作指定校对规则，MongoDB将使用以前版本中使用的简单二进制比较进行字符串比较。不能为一个操作指定多个校对规则。例如，不能为每个字段指定不同的校对规则，或者如果使用排序执行查找，则不能将一个校对规则用于查找，另一个校对规则用于排序。3.4版新增。</td>
</tr>
<tr>
<td style="text-align:center">arrayFilters</td>
<td style="text-align:center">array</td>
<td style="text-align:center">可选。一个筛选文档数组，用于确定要为数组字段上的更新操作修改哪些数组元素。在更新文档中，使用[ 筛 选 的</td>
</tr>
<tr>
<td style="text-align:center">hint</td>
<td style="text-align:center">Document or string</td>
<td style="text-align:center">可选。指定用于支持查询谓词的索引的文档或字符串。该选项可以采用索引规范文档或索引名称字符串。如果指定的索引不存在，则说明操作错误。例如，请参阅版本4中的“为更新操作指定提示。</td>
</tr>
</tbody>
</table>
</div>
<h4 id="提示-4"><a href="#提示-4" class="headerlink" title="提示"></a>提示</h4><h4 id="主要关注前四个参数即可"><a href="#主要关注前四个参数即可" class="headerlink" title="主要关注前四个参数即可"></a>主要关注前四个参数即可</h4><h4 id="【示例】-3"><a href="#【示例】-3" class="headerlink" title="【示例】"></a>【示例】</h4><ul>
<li>（ 1 ）覆盖的修改</li>
</ul>
<h4 id="如果我们想修改-id为-1-的记录，点赞量为-1001-，输入以下语句"><a href="#如果我们想修改-id为-1-的记录，点赞量为-1001-，输入以下语句" class="headerlink" title="如果我们想修改_id为 1 的记录，点赞量为 1001 ，输入以下语句"></a>如果我们想修改_id为 1 的记录，点赞量为 1001 ，输入以下语句</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(&#123;_id:&quot;1&quot;&#125;,&#123;likenum:NumberInt(1001)&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="执行后，我们会发现，这条文档除了likenum字段其它字段都不见了"><a href="#执行后，我们会发现，这条文档除了likenum字段其它字段都不见了" class="headerlink" title="执行后，我们会发现，这条文档除了likenum字段其它字段都不见了"></a>执行后，我们会发现，这条文档除了likenum字段其它字段都不见了</h4><ul>
<li>（ 2 ）局部修改</li>
</ul>
<p>为了解决这个问题，我们需要使用修改器$set来实现，命令如下：</p>
<p>我们想修改_id为 2 的记录，浏览量为 889 ，输入以下语句：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(&#123;_id:&quot;2&quot;&#125;,&#123;$set:&#123;likenum:NumberInt(889)&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>这样就OK啦。</p>
<ul>
<li>（ 3 ）批量的修改</li>
</ul>
<h4 id="更新所有用户为-1003-的用户的昵称为凯撒大帝"><a href="#更新所有用户为-1003-的用户的昵称为凯撒大帝" class="headerlink" title="更新所有用户为 1003 的用户的昵称为凯撒大帝"></a>更新所有用户为 1003 的用户的昵称为凯撒大帝</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//默认只修改第一条数据</span><br><span class="line">db.comment.update(&#123;userid:&quot;1003&quot;&#125;,&#123;$set:&#123;nickname:&quot;凯撒2&quot;&#125;&#125;)</span><br><span class="line">//修改所有符合条件的数据</span><br><span class="line">db.comment.updateMany(&#123;_id:&quot;2&quot;&#125;,&#123;$set:&#123;likenum:889&#125;&#125;)</span><br><span class="line">或</span><br><span class="line">db.comment.update(&#123;userid:&quot;1003&quot;&#125;,&#123;$set:&#123;nickname:&quot;凯撒大帝&quot;&#125;&#125;,&#123;multi:true&#125;)</span><br></pre></td></tr></table></figure>
<p><code>提示：如果不加后面的参数，则只更新符合条件的第一条记录</code></p>
<ul>
<li>（ 3 ）列值增长的修改</li>
</ul>
<h4 id="如果我们想实现对某列值在原有值的基础上进行增加或减少，可以使用-inc运算符来实现"><a href="#如果我们想实现对某列值在原有值的基础上进行增加或减少，可以使用-inc运算符来实现" class="headerlink" title="如果我们想实现对某列值在原有值的基础上进行增加或减少，可以使用$inc运算符来实现"></a>如果我们想实现对某列值在原有值的基础上进行增加或减少，可以使用$inc运算符来实现</h4><h4 id="需求：对-3-号数据的点赞数，每次递增-1"><a href="#需求：对-3-号数据的点赞数，每次递增-1" class="headerlink" title="需求：对 3 号数据的点赞数，每次递增 1"></a>需求：对 3 号数据的点赞数，每次递增 1</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(&#123;_id:&quot;3&quot;&#125;,&#123;$inc:&#123;likenum:NumberInt(1)&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="3-4-4-删除文档"><a href="#3-4-4-删除文档" class="headerlink" title="3.4.4 删除文档"></a>3.4.4 删除文档</h3><h4 id="删除文档的语法结构"><a href="#删除文档的语法结构" class="headerlink" title="删除文档的语法结构"></a>删除文档的语法结构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.remove(条件)</span><br><span class="line">or</span><br><span class="line">删除单个文档：db.collection.deleteOne()</span><br><span class="line">删除多个文档：db.collection.deleteMany()</span><br></pre></td></tr></table></figure>
<h4 id="以下语句可以将数据全部删除，请慎用"><a href="#以下语句可以将数据全部删除，请慎用" class="headerlink" title="以下语句可以将数据全部删除，请慎用"></a>以下语句可以将数据全部删除，请慎用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.comment.remove(&#123;&#125;)</span><br><span class="line">or</span><br><span class="line">删除单个文档：db.collection.deleteOne()</span><br><span class="line">删除多个文档：db.collection.deleteMany()</span><br></pre></td></tr></table></figure>
<h4 id="如果删除-id-1的记录，输入以下语句"><a href="#如果删除-id-1的记录，输入以下语句" class="headerlink" title="如果删除_id=1的记录，输入以下语句"></a>如果删除_id=1的记录，输入以下语句</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.remove(&#123;_id:&quot;1&quot;&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="3-5-文档的分页查询"><a href="#3-5-文档的分页查询" class="headerlink" title="3.5 文档的分页查询"></a>3.5 文档的分页查询</h2><h3 id="3-5-1-统计查询"><a href="#3-5-1-统计查询" class="headerlink" title="3.5.1 统计查询"></a>3.5.1 统计查询</h3><h4 id="统计查询使用count-方法，语法如下"><a href="#统计查询使用count-方法，语法如下" class="headerlink" title="统计查询使用count()方法，语法如下"></a>统计查询使用count()方法，语法如下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.count(query, options)</span><br></pre></td></tr></table></figure>
<h4 id="参数-4"><a href="#参数-4" class="headerlink" title="参数"></a>参数</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">query</td>
<td style="text-align:center">document</td>
<td style="text-align:center">查询选择条件。</td>
</tr>
<tr>
<td style="text-align:center">options</td>
<td style="text-align:center">document</td>
<td style="text-align:center">可选。用于修改计数的额外选项。</td>
</tr>
</tbody>
</table>
</div>
<h4 id="提示-5"><a href="#提示-5" class="headerlink" title="提示"></a>提示</h4><p>可选项暂时不使用。</p>
<h4 id="【示例】-4"><a href="#【示例】-4" class="headerlink" title="【示例】"></a>【示例】</h4><ul>
<li>（ 1 ）统计所有记录数：</li>
</ul>
<h4 id="统计comment集合的所有的记录数"><a href="#统计comment集合的所有的记录数" class="headerlink" title="统计comment集合的所有的记录数"></a>统计comment集合的所有的记录数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.count()</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 2 ）按条件统计记录数：</li>
</ul>
<h4 id="例如：统计userid为-1003-的记录条数"><a href="#例如：统计userid为-1003-的记录条数" class="headerlink" title="例如：统计userid为 1003 的记录条数"></a>例如：统计userid为 1003 的记录条数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.count(&#123;userid:&quot;1003&quot;&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="提示-6"><a href="#提示-6" class="headerlink" title="提示"></a>提示</h4><p>默认情况下count()方法返回符合条件的全部记录条数。</p>
<h3 id="3-5-2-分页列表查询"><a href="#3-5-2-分页列表查询" class="headerlink" title="3.5.2 分页列表查询"></a>3.5.2 分页列表查询</h3><h4 id="可以使用limit-方法来读取指定数量的数据，使用skip-方法来跳过指定数量的数据"><a href="#可以使用limit-方法来读取指定数量的数据，使用skip-方法来跳过指定数量的数据" class="headerlink" title="可以使用limit()方法来读取指定数量的数据，使用skip()方法来跳过指定数量的数据"></a>可以使用limit()方法来读取指定数量的数据，使用skip()方法来跳过指定数量的数据</h4><h4 id="基本语法如下所示"><a href="#基本语法如下所示" class="headerlink" title="基本语法如下所示"></a>基本语法如下所示</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find().limit(NUMBER).skip(NUMBER)</span><br></pre></td></tr></table></figure>
<h4 id="如果你想返回指定条数的记录，可以在find方法后调用limit来返回结果-TopN-，默认值-20-，例如"><a href="#如果你想返回指定条数的记录，可以在find方法后调用limit来返回结果-TopN-，默认值-20-，例如" class="headerlink" title="如果你想返回指定条数的记录，可以在find方法后调用limit来返回结果(TopN)，默认值 20 ，例如"></a>如果你想返回指定条数的记录，可以在find方法后调用limit来返回结果(TopN)，默认值 20 ，例如</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().limit(3)</span><br></pre></td></tr></table></figure>
<h4 id="skip方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）-默认值是-0"><a href="#skip方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）-默认值是-0" class="headerlink" title="skip方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）,默认值是 0"></a>skip方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）,默认值是 0</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().skip(3)</span><br></pre></td></tr></table></figure>
<h4 id="分页查询：需求：每页-2-个，第二页开始：跳过前两条数据，接着值显示-3-和-4-条数据"><a href="#分页查询：需求：每页-2-个，第二页开始：跳过前两条数据，接着值显示-3-和-4-条数据" class="headerlink" title="分页查询：需求：每页 2 个，第二页开始：跳过前两条数据，接着值显示 3 和 4 条数据"></a>分页查询：需求：每页 2 个，第二页开始：跳过前两条数据，接着值显示 3 和 4 条数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//第一页</span><br><span class="line">db.comment.find().skip(0).limit(2)</span><br><span class="line">//第二页</span><br><span class="line">db.comment.find().skip(2).limit(2)</span><br><span class="line">//第三页</span><br><span class="line">db.comment.find().skip(4).limit(2)</span><br></pre></td></tr></table></figure>
<h3 id="3-5-3-排序查询"><a href="#3-5-3-排序查询" class="headerlink" title="3.5.3 排序查询"></a>3.5.3 排序查询</h3><h4 id="sort-方法对数据进行排序，sort-方法可以通过参数指定排序的字段，并使用-1-和-1-来指定排序的方式，其中-1-为升序排列，而-1-是用于降序排列"><a href="#sort-方法对数据进行排序，sort-方法可以通过参数指定排序的字段，并使用-1-和-1-来指定排序的方式，其中-1-为升序排列，而-1-是用于降序排列" class="headerlink" title="sort() 方法对数据进行排序，sort() 方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而 -1 是用于降序排列"></a>sort() 方法对数据进行排序，sort() 方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而 -1 是用于降序排列</h4><h4 id="语法如下所示"><a href="#语法如下所示" class="headerlink" title="语法如下所示"></a>语法如下所示</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find().sort(&#123;KEY:1&#125;)</span><br><span class="line">或</span><br><span class="line">db.集合名称.find().sort(排序方式)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="例如"><a href="#例如" class="headerlink" title="例如"></a>例如</h4><h4 id="对userid降序排列，并对访问量进行升序排列"><a href="#对userid降序排列，并对访问量进行升序排列" class="headerlink" title="对userid降序排列，并对访问量进行升序排列"></a>对userid降序排列，并对访问量进行升序排列</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().sort(&#123;userid:-1,likenum:1&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="提示-7"><a href="#提示-7" class="headerlink" title="提示"></a>提示</h4><p><code>skip(), limilt(), sort()三个放在一起执行的时候，执行的顺序是先 sort(), 然后是 skip()，最后是显示的 limit()，和命令编写顺序无关。</code></p>
<h2 id="3-6-文档的更多查询"><a href="#3-6-文档的更多查询" class="headerlink" title="3.6 文档的更多查询"></a>3.6 文档的更多查询</h2><h3 id="3-6-1-正则的复杂条件查询"><a href="#3-6-1-正则的复杂条件查询" class="headerlink" title="3.6.1 正则的复杂条件查询"></a>3.6.1 正则的复杂条件查询</h3><h4 id="MongoDB的模糊查询是通过正则表达式的方式实现的。格式为"><a href="#MongoDB的模糊查询是通过正则表达式的方式实现的。格式为" class="headerlink" title="MongoDB的模糊查询是通过正则表达式的方式实现的。格式为"></a>MongoDB的模糊查询是通过正则表达式的方式实现的。格式为</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(&#123;field:/正则表达式/&#125;)</span><br><span class="line">或</span><br><span class="line">db.集合.find(&#123;字段:/正则表达式/&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="提示：正则表达式是js的语法，直接量的写法"><a href="#提示：正则表达式是js的语法，直接量的写法" class="headerlink" title="提示：正则表达式是js的语法，直接量的写法"></a>提示：正则表达式是js的语法，直接量的写法</h4><h4 id="例如，我要查询评论内容包含“开水”的所有文档，代码如下"><a href="#例如，我要查询评论内容包含“开水”的所有文档，代码如下" class="headerlink" title="例如，我要查询评论内容包含“开水”的所有文档，代码如下"></a>例如，我要查询评论内容包含“开水”的所有文档，代码如下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;content:/开水/&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="如果要查询评论的内容中以“专家”开头的，代码如下"><a href="#如果要查询评论的内容中以“专家”开头的，代码如下" class="headerlink" title="如果要查询评论的内容中以“专家”开头的，代码如下"></a>如果要查询评论的内容中以“专家”开头的，代码如下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;content:/^专家/&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="3-6-2-比较查询"><a href="#3-6-2-比较查询" class="headerlink" title="3.6.2 比较查询"></a>3.6.2 比较查询</h3><h4 id="lt-lt-gt-gt-这个操作符也是很常用的，格式如下"><a href="#lt-lt-gt-gt-这个操作符也是很常用的，格式如下" class="headerlink" title="&lt;, &lt;=, &gt;, &gt;= 这个操作符也是很常用的，格式如下"></a>&lt;, &lt;=, &gt;, &gt;= 这个操作符也是很常用的，格式如下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $gt: value &#125;&#125;) // 大于: field &gt; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $lt: value &#125;&#125;) // 小于: field &lt; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $gte: value &#125;&#125;) // 大于等于: field &gt;= value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $lte: value &#125;&#125;) // 小于等于: field &lt;= value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $ne: value &#125;&#125;) // 不等于: field != value</span><br></pre></td></tr></table></figure>
<h4 id="示例：查询评论点赞数量大于-700-的记录"><a href="#示例：查询评论点赞数量大于-700-的记录" class="headerlink" title="示例：查询评论点赞数量大于 700 的记录"></a>示例：查询评论点赞数量大于 700 的记录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;likenum:&#123;$gt:NumberInt(700)&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="3-6-3-包含查询"><a href="#3-6-3-包含查询" class="headerlink" title="3.6.3 包含查询"></a>3.6.3 包含查询</h3><h4 id="包含使用-in操作符。-示例：查询评论的集合中userid字段包含-1003-或-1004-的文档"><a href="#包含使用-in操作符。-示例：查询评论的集合中userid字段包含-1003-或-1004-的文档" class="headerlink" title="包含使用$in操作符。 示例：查询评论的集合中userid字段包含 1003 或 1004 的文档"></a>包含使用$in操作符。 示例：查询评论的集合中userid字段包含 1003 或 1004 的文档</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&#123;$in:[&quot;1003&quot;,&quot;1004&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="不包含使用-nin操作符。-示例：查询评论集合中userid字段不包含-1003-和-1004-的文档"><a href="#不包含使用-nin操作符。-示例：查询评论集合中userid字段不包含-1003-和-1004-的文档" class="headerlink" title="不包含使用$nin操作符。 示例：查询评论集合中userid字段不包含 1003 和 1004 的文档"></a>不包含使用$nin操作符。 示例：查询评论集合中userid字段不包含 1003 和 1004 的文档</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&#123;$nin:[&quot;1003&quot;,&quot;1004&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="3-6-4-条件连接查询"><a href="#3-6-4-条件连接查询" class="headerlink" title="3.6.4 条件连接查询"></a>3.6.4 条件连接查询</h3><h4 id="我们如果需要查询同时满足两个以上条件，需要使用-and操作符将条件进行关联。（相-当于SQL的and）-格式为"><a href="#我们如果需要查询同时满足两个以上条件，需要使用-and操作符将条件进行关联。（相-当于SQL的and）-格式为" class="headerlink" title="我们如果需要查询同时满足两个以上条件，需要使用$and操作符将条件进行关联。（相 当于SQL的and） 格式为"></a>我们如果需要查询同时满足两个以上条件，需要使用$and操作符将条件进行关联。（相 当于SQL的and） 格式为</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">and:[ &#123; &#125;,&#123; &#125;,&#123; &#125; ]</span></span><br></pre></td></tr></table></figure>
<h4 id="示例：查询评论集合中likenum大于等于-700-并且小于-2000-的文档"><a href="#示例：查询评论集合中likenum大于等于-700-并且小于-2000-的文档" class="headerlink" title="示例：查询评论集合中likenum大于等于 700 并且小于 2000 的文档"></a>示例：查询评论集合中likenum大于等于 700 并且小于 2000 的文档</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;$and:[&#123;likenum:&#123;$gte:NumberInt(700)&#125;&#125;,&#123;likenum:&#123;$lt:NumberInt(2000)&#125;&#125;]&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="如果两个以上条件之间是或者的关系，我们使用-操作符进行关联，与前面-and的使用方式相同-格式为"><a href="#如果两个以上条件之间是或者的关系，我们使用-操作符进行关联，与前面-and的使用方式相同-格式为" class="headerlink" title="如果两个以上条件之间是或者的关系，我们使用 操作符进行关联，与前面 and的使用方式相同 格式为"></a>如果两个以上条件之间是或者的关系，我们使用 操作符进行关联，与前面 and的使用方式相同 格式为</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">or:[ &#123; &#125;,&#123; &#125;,&#123; &#125; ]</span></span><br></pre></td></tr></table></figure>
<h4 id="示例：查询评论集合中userid为-1003-，或者点赞数小于-1000-的文档记录"><a href="#示例：查询评论集合中userid为-1003-，或者点赞数小于-1000-的文档记录" class="headerlink" title="示例：查询评论集合中userid为 1003 ，或者点赞数小于 1000 的文档记录"></a>示例：查询评论集合中userid为 1003 ，或者点赞数小于 1000 的文档记录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;$or:[ &#123;userid:&quot;1003&quot;&#125; ,&#123;likenum:&#123;$lt:1000&#125; &#125;]&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="3-7-常用命令小结"><a href="#3-7-常用命令小结" class="headerlink" title="3.7 常用命令小结"></a>3.7 常用命令小结</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">选择切换数据库：use articledb</span><br><span class="line">插入数据：db.comment.insert(&#123;bson数据&#125;)</span><br><span class="line">查询所有数据：db.comment.find();</span><br><span class="line">条件查询数据：db.comment.find(&#123;条件&#125;)</span><br><span class="line">查询符合条件的第一条记录：db.comment.findOne(&#123;条件&#125;)</span><br><span class="line">查询符合条件的前几条记录：db.comment.find(&#123;条件&#125;).limit(条数)</span><br><span class="line">查询符合条件的跳过的记录：db.comment.find(&#123;条件&#125;).skip(条数)</span><br><span class="line">修改数据：db.comment.update(&#123;条件&#125;,&#123;修改后的数据&#125;) 或db.comment.update(&#123;条件&#125;,&#123;$set:&#123;要修改部分的字段:数据&#125;)</span><br><span class="line">修改数据并自增某字段值：db.comment.update(&#123;条件&#125;,&#123;$inc:&#123;自增的字段:步进值&#125;&#125;)</span><br><span class="line">删除数据：db.comment.remove(&#123;条件&#125;)</span><br><span class="line">统计查询：db.comment.count(&#123;条件&#125;)</span><br><span class="line">模糊查询：db.comment.find(&#123;字段名:/正则表达式/&#125;)</span><br><span class="line">条件比较运算：db.comment.find(&#123;字段名:&#123;$gt:值&#125;&#125;)</span><br><span class="line">包含查询：db.comment.find(&#123;字段名:&#123;$in:[值1，值2]&#125;&#125;)或db.comment.find(&#123;字段名:&#123;$nin:[值1，值2]&#125;&#125;)</span><br><span class="line">条件连接查询：db.comment.find(&#123;$and:[&#123;条件1&#125;,&#123;条件2&#125;]&#125;)或db.comment.find(&#123;$or:[&#123;条件1&#125;,&#123;条件2&#125;]&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="4-索引-Index"><a href="#4-索引-Index" class="headerlink" title="4 索引-Index"></a>4 索引-Index</h1><h2 id="4-1-概述"><a href="#4-1-概述" class="headerlink" title="4.1 概述"></a>4.1 概述</h2><blockquote>
<p>索引支持在MongoDB中高效地执行查询。如果没有索引，MongoDB必须执行全集合扫描，即扫描集合中的每个文档，以选择与查询语句<br>匹配的文档。这种扫描全集合的查询效率是非常低的，特别在处理大量的数据时，查询可以要花费几十秒甚至几分钟，这对网站的性能是非常致命的。</p>
<p>如果查询存在适当的索引，MongoDB可以使用该索引限制必须检查的文档数。</p>
<p>索引是特殊的数据结构，它以易于遍历的形式存储集合数据集的一小部分。索引存储特定字段或一组字段的值，按字段值排序。索引项的排序支持有效的相等匹配和基于范围的查询操作。此外，MongoDB还可以使用索引中的排序返回排序结果。</p>
</blockquote>
<h4 id="官网文档：https-docs-mongodb-com-manual-indexes"><a href="#官网文档：https-docs-mongodb-com-manual-indexes" class="headerlink" title="官网文档：https://docs.mongodb.com/manual/indexes/"></a>官网文档：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/indexes/">https://docs.mongodb.com/manual/indexes/</a></h4><h4 id="了解"><a href="#了解" class="headerlink" title="了解"></a>了解</h4><h4 id="MongoDB索引使用B树数据结构（确切的说是B-Tree，MySQL是B-Tree）"><a href="#MongoDB索引使用B树数据结构（确切的说是B-Tree，MySQL是B-Tree）" class="headerlink" title="MongoDB索引使用B树数据结构（确切的说是B-Tree，MySQL是B+Tree）"></a>MongoDB索引使用B树数据结构（确切的说是B-Tree，MySQL是B+Tree）</h4><h2 id="4-2-索引的类型"><a href="#4-2-索引的类型" class="headerlink" title="4.2 索引的类型"></a>4.2 索引的类型</h2><h2 id="4-2-1-单字段索引"><a href="#4-2-1-单字段索引" class="headerlink" title="4.2.1 单字段索引"></a>4.2.1 单字段索引</h2><blockquote>
<p>MongoDB支持在文档的单个字段上创建用户定义的升序/降序索引，称为单字段索引（Single Field<br>Index）。对于单个字段索引和排序操作，索引键的排序顺序（即升序或降序）并不重要，因为MongoDB可以在任何方向上遍历索引。</p>
</blockquote>
<p><img src="QQ截图20240125185048.png&quot;" alt="输入图片说明"></p>
<h2 id="4-2-2-复合索引"><a href="#4-2-2-复合索引" class="headerlink" title="4.2.2 复合索引"></a>4.2.2 复合索引</h2><blockquote>
<p>MongoDB还支持多个字段的用户定义索引，即复合索引（Compound Index）。复合索引中列出的字段顺序具有重要意义。例如，如果复合索引由{<br>userid: 1 , score: - 1 }组成，则索引首先按userid正序排序，然后在每个userid的值内，再在按score倒序排序。</p>
</blockquote>
<p><img src="QQ截图20240125185207.png&quot;" alt="输入图片说明"></p>
<h3 id="4-2-3-其他索引"><a href="#4-2-3-其他索引" class="headerlink" title="4.2.3 其他索引"></a>4.2.3 其他索引</h3><blockquote>
<p>地理空间索引（Geospatial Index）、文本索引（Text Indexes）、哈希索引（Hashed Indexes）。</p>
</blockquote>
<h4 id="地理空间索引（Geospatial-Index）"><a href="#地理空间索引（Geospatial-Index）" class="headerlink" title="地理空间索引（Geospatial Index）"></a>地理空间索引（Geospatial Index）</h4><blockquote>
<p>为了支持对地理空间坐标数据的有效查询，MongoDB提供了两种特殊的索引：返回结果时使用平面几何的二维索引和返回结果时使用球面几何的二维球面索引。</p>
</blockquote>
<h4 id="文本索引（Text-Indexes）"><a href="#文本索引（Text-Indexes）" class="headerlink" title="文本索引（Text Indexes）"></a>文本索引（Text Indexes）</h4><blockquote>
<p>MongoDB提供了一种文本索引类型，支持在集合中搜索字符串内容。这些文本索引不存储特定于语言的停止词（例如“the”、“a”、“or”），而将集合中的词作为词干，只存储根词。</p>
</blockquote>
<h4 id="哈希索引（Hashed-Indexes）"><a href="#哈希索引（Hashed-Indexes）" class="headerlink" title="哈希索引（Hashed Indexes）"></a>哈希索引（Hashed Indexes）</h4><blockquote>
<p>为了支持基于散列的分片，MongoDB提供了散列索引类型，它对字段值的散列进行索引。这些索引在其范围内的值分布更加随机，但只支持相等匹配，不支持基于范围的查询。</p>
</blockquote>
<h2 id="4-3-索引的管理操作"><a href="#4-3-索引的管理操作" class="headerlink" title="4.3 索引的管理操作"></a>4.3 索引的管理操作</h2><h3 id="4-3-1-索引的查看"><a href="#4-3-1-索引的查看" class="headerlink" title="4.3.1 索引的查看"></a>4.3.1 索引的查看</h3><h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><h4 id="返回一个集合中的所有索引的数组"><a href="#返回一个集合中的所有索引的数组" class="headerlink" title="返回一个集合中的所有索引的数组"></a>返回一个集合中的所有索引的数组</h4><h4 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.getIndexes()</span><br></pre></td></tr></table></figure>
<h4 id="提示：该语法命令运行要求是MongoDB-3-0"><a href="#提示：该语法命令运行要求是MongoDB-3-0" class="headerlink" title="提示：该语法命令运行要求是MongoDB 3.0+"></a>提示：该语法命令运行要求是MongoDB 3.0+</h4><h4 id="【示例】-5"><a href="#【示例】-5" class="headerlink" title="【示例】"></a>【示例】</h4><h4 id="查看comment集合中所有的索引情况"><a href="#查看comment集合中所有的索引情况" class="headerlink" title="查看comment集合中所有的索引情况"></a>查看comment集合中所有的索引情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.comment.getIndexes()</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">  &quot;v&quot; : 2,</span><br><span class="line">  &quot;key&quot; : &#123;</span><br><span class="line">    &quot;_id&quot; : 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;name&quot; : &quot;_id_&quot;,</span><br><span class="line">  &quot;ns&quot; : &quot;articledb.comment&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="结果中显示的是默认-id索引"><a href="#结果中显示的是默认-id索引" class="headerlink" title="结果中显示的是默认_id索引"></a>结果中显示的是默认_id索引</h4><h4 id="默认-id索引"><a href="#默认-id索引" class="headerlink" title="默认_id索引"></a>默认_id索引</h4><blockquote>
<p>MongoDB在创建集合的过程中，在_id字段上创建一个唯一的索引，默认名字为_id_，该索引可防止客户端插入两个具有相同值的文档，您不能在_id字段上删除此索引。</p>
</blockquote>
<p><code>注意：该索引是唯一索引，因此值不能重复，即_id值不能重复的。在分片集群中，通常使用_id作为片键。</code></p>
<h3 id="4-3-2-索引的创建"><a href="#4-3-2-索引的创建" class="headerlink" title="4.3.2 索引的创建"></a>4.3.2 索引的创建</h3><h4 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h4><h4 id="在集合上创建索引"><a href="#在集合上创建索引" class="headerlink" title="在集合上创建索引"></a>在集合上创建索引</h4><h4 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.createIndex(keys, options)</span><br></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">keys</td>
<td style="text-align:center">document</td>
<td style="text-align:center">包含字段和值对的文档，其中字段是索引键，值描述该字段的索引类型。对于字段上的升序索引，请指定值 1 ；对于降序索引，请指定值-1。比如：{字段: 1 或- 1 }，其中 1 为指定按升序创建索引，如果你 想按降序来创建索引指定为 -1 即可。另外，MongoDB支持几种不同的索引类型，包括文本、地理空间和哈希索引。</td>
</tr>
<tr>
<td style="text-align:center">options</td>
<td style="text-align:center">document</td>
<td style="text-align:center">可选。包含一组控制索引创建的选项的文档。有关详细信息，请参见选项详情列表。</td>
</tr>
</tbody>
</table>
</div>
<h4 id="options（更多选项）列表"><a href="#options（更多选项）列表" class="headerlink" title="options（更多选项）列表"></a>options（更多选项）列表</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">background</td>
<td style="text-align:center">Boolean</td>
<td style="text-align:center">建索引过程会阻塞其它数据库操作，background可指定以后台方式创建索引，即增加”background” 可选参数。 “background” 默认值为false。</td>
</tr>
<tr>
<td style="text-align:center">unique</td>
<td style="text-align:center">Boolean</td>
<td style="text-align:center">建立的索引是否唯一。指定为true创建唯一索引。默认值为false.</td>
</tr>
<tr>
<td style="text-align:center">name</td>
<td style="text-align:center">string</td>
<td style="text-align:center">索引的名称。如果未指定，MongoDB的通过连接索引的字段名和排序顺序生成一个索引名称。</td>
</tr>
<tr>
<td style="text-align:center">dropDups</td>
<td style="text-align:center">Boolean</td>
<td style="text-align:center">3.0+版本已废弃。在建立唯一索引时是否删除重复记录,指定 true 创建唯一索引。默认值为false.</td>
</tr>
<tr>
<td style="text-align:center">sparse</td>
<td style="text-align:center">Boolean</td>
<td style="text-align:center">对文档中不存在的字段数据不启用索引；这个参数需要特别注意，如果设置为true的话，在索引字段中不会查询出不包含对应字段的文档.。默认值为 false.</td>
</tr>
<tr>
<td style="text-align:center">expireAfterSeconds</td>
<td style="text-align:center">integer</td>
<td style="text-align:center">指定一个以秒为单位的数值，完成 TTL设定，设定集合的生存时间。</td>
</tr>
<tr>
<td style="text-align:center">v</td>
<td style="text-align:center">index version</td>
<td style="text-align:center">索引的版本号。默认的索引版本取决于mongod创建索引时运行的版本。</td>
</tr>
<tr>
<td style="text-align:center">weights</td>
<td style="text-align:center">document</td>
<td style="text-align:center">索引权重值，数值在 1 到 99,999 之间，表示该索引相对于其他索引字段的得分权重。</td>
</tr>
<tr>
<td style="text-align:center">default_language</td>
<td style="text-align:center">string</td>
<td style="text-align:center">对于文本索引，该参数决定了停用词及词干和词器的规则的列表。 默认为英语</td>
</tr>
<tr>
<td style="text-align:center">language_override</td>
<td style="text-align:center">string</td>
<td style="text-align:center">对于文本索引，该参数指定了包含在文档中的字段名，语言覆盖默认的language，默认值为language.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="提示-8"><a href="#提示-8" class="headerlink" title="提示"></a>提示</h4><blockquote>
<p>注意在 3.0.0 版本前创建索引方法为 db.collection.ensureIndex()，之后的版本使用了 db.collection.createIndex()<br>方法，ensureIndex()还能用，但只是 createIndex()的别名。</p>
</blockquote>
<h4 id="【示例】-6"><a href="#【示例】-6" class="headerlink" title="【示例】"></a>【示例】</h4><ul>
<li>（ 1 ）单字段索引示例：对userid字段建立索引：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> db.comment.createIndex(&#123;userid:1&#125;)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;createdCollectionAutomatically&quot; : false,</span><br><span class="line">    &quot;numIndexesBefore&quot; : 1,</span><br><span class="line">    &quot;numIndexesAfter&quot; : 2,</span><br><span class="line">    &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="参数-1-：按升序创建索引"><a href="#参数-1-：按升序创建索引" class="headerlink" title="参数 1 ：按升序创建索引"></a>参数 1 ：按升序创建索引</h4><h4 id="可以查看一下"><a href="#可以查看一下" class="headerlink" title="可以查看一下"></a>可以查看一下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">db.comment.getIndexes()</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;v&quot; : 2,</span><br><span class="line">    &quot;key&quot; : &#123;</span><br><span class="line">    &quot;_id&quot; : 1</span><br><span class="line">  &#125;,</span><br><span class="line">    &quot;name&quot; : &quot;_id_&quot;,</span><br><span class="line">    &quot;ns&quot; : &quot;articledb.comment&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">  &quot;v&quot; : 2,</span><br><span class="line">  &quot;key&quot; : &#123;</span><br><span class="line">    &quot;userid&quot; : 1</span><br><span class="line">  &#125;,</span><br><span class="line">    &quot;name&quot; : &quot;userid_1&quot;,</span><br><span class="line">    &quot;ns&quot; : &quot;articledb.comment&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>索引名字为`userid_1</p>
<p>compass查看：</p>
<p><img src="QQ截图20240125204652.png&quot;" alt="输入图片说明"></p>
<ul>
<li>（ 2 ）复合索引：对userid和nickname同时建立复合（Compound）索引：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> db.comment.createIndex(&#123;userid:1,nickname:-1&#125;)</span><br><span class="line">&#123;</span><br><span class="line">  &quot;createdCollectionAutomatically&quot; : false,</span><br><span class="line">  &quot;numIndexesBefore&quot; : 2,</span><br><span class="line">  &quot;numIndexesAfter&quot; : 3,</span><br><span class="line">  &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="查看一下索引"><a href="#查看一下索引" class="headerlink" title="查看一下索引"></a>查看一下索引</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">db.comment.getIndexes()</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;v&quot; : 2,</span><br><span class="line">    &quot;key&quot; : &#123;</span><br><span class="line">      &quot;_id&quot; : 1</span><br><span class="line">  &#125;,</span><br><span class="line">    &quot;name&quot; : &quot;_id_&quot;,</span><br><span class="line">    &quot;ns&quot; : &quot;articledb.comment&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;v&quot; : 2,</span><br><span class="line">    &quot;key&quot; : &#123;</span><br><span class="line">      &quot;userid&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">      &quot;name&quot; : &quot;userid_1&quot;,</span><br><span class="line">      &quot;ns&quot; : &quot;articledb.comment&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;v&quot; : 2,</span><br><span class="line">      &quot;key&quot; : &#123;</span><br><span class="line">        &quot;userid&quot; : 1,</span><br><span class="line">        &quot;nickname&quot; : -1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;name&quot; : &quot;userid_1_nickname_-1&quot;,</span><br><span class="line">    &quot;ns&quot; : &quot;articledb.comment&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="compass中"><a href="#compass中" class="headerlink" title="compass中"></a>compass中</h4><p><img src="QQ截图20240125204912.png&quot;" alt="输入图片说明"></p>
<h3 id="4-3-3-索引的移除"><a href="#4-3-3-索引的移除" class="headerlink" title="4.3.3 索引的移除"></a>4.3.3 索引的移除</h3><h4 id="说明：可以移除指定的索引，或移除所有索引"><a href="#说明：可以移除指定的索引，或移除所有索引" class="headerlink" title="说明：可以移除指定的索引，或移除所有索引"></a>说明：可以移除指定的索引，或移除所有索引</h4><h4 id="一、指定索引的移除"><a href="#一、指定索引的移除" class="headerlink" title="一、指定索引的移除"></a>一、指定索引的移除</h4><h4 id="语法-3"><a href="#语法-3" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.dropIndex(index)</span><br></pre></td></tr></table></figure>
<h4 id="参数-5"><a href="#参数-5" class="headerlink" title="参数"></a>参数</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">index</td>
<td style="text-align:center">string or document</td>
<td style="text-align:center">指定要删除的索引。可以通过索引名称或索引规范文档指定索引。若要删除文本索引，请指定索引名称。</td>
</tr>
</tbody>
</table>
</div>
<h4 id="【示例】-7"><a href="#【示例】-7" class="headerlink" title="【示例】"></a>【示例】</h4><h4 id="删除comment集合中userid字段上的升序索引"><a href="#删除comment集合中userid字段上的升序索引" class="headerlink" title="删除comment集合中userid字段上的升序索引"></a>删除comment集合中userid字段上的升序索引</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> db.comment.dropIndex(&#123;userid:1&#125;)</span><br><span class="line">&#123; &quot;nIndexesWas&quot; : 3, &quot;ok&quot; : 1 &#125;</span><br></pre></td></tr></table></figure>
<h4 id="查看已经删除了"><a href="#查看已经删除了" class="headerlink" title="查看已经删除了"></a>查看已经删除了</h4><h4 id="二、所有索引的移除"><a href="#二、所有索引的移除" class="headerlink" title="二、所有索引的移除"></a>二、所有索引的移除</h4><h4 id="语法-4"><a href="#语法-4" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.dropIndexes()</span><br></pre></td></tr></table></figure>
<h4 id="【示例】-8"><a href="#【示例】-8" class="headerlink" title="【示例】"></a>【示例】</h4><h4 id="删除spit集合中所有索引"><a href="#删除spit集合中所有索引" class="headerlink" title="删除spit集合中所有索引"></a>删除spit集合中所有索引</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.comment.dropIndexes()</span><br><span class="line">&#123;</span><br><span class="line">  &quot;nIndexesWas&quot; : 2,</span><br><span class="line">  &quot;msg&quot; : &quot;non-_id indexes dropped for collection&quot;,</span><br><span class="line">  &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>提示：_id的字段的索引是无法删除的，只能删除非_id字段的索引。</code></p>
<h2 id="4-4-索引的使用"><a href="#4-4-索引的使用" class="headerlink" title="4.4 索引的使用^"></a>4.4 索引的使用^</h2><h3 id="4-4-1-执行计划"><a href="#4-4-1-执行计划" class="headerlink" title="4.4.1 执行计划"></a>4.4.1 执行计划</h3><blockquote>
<p>分析查询性能（Analyze Query Performance）通常使用执行计划（解释计划、Explain Plan）来查看查询的情况，如查询耗费的时间、是否基于索引查询等。</p>
<p>那么，通常，我们想知道，建立的索引是否有效，效果如何，都需要通过执行计划查看。</p>
</blockquote>
<h4 id="语法-5"><a href="#语法-5" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(query,options).explain(options)</span><br></pre></td></tr></table></figure>
<h4 id="【示例】-9"><a href="#【示例】-9" class="headerlink" title="【示例】"></a>【示例】</h4><h4 id="查看根据userid查询数据的情况"><a href="#查看根据userid查询数据的情况" class="headerlink" title="查看根据userid查询数据的情况"></a>查看根据userid查询数据的情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> db.comment.find(&#123;userid:&quot;1003&quot;&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line"> &quot;queryPlanner&quot; : &#123;</span><br><span class="line">  &quot;plannerVersion&quot; : 1,</span><br><span class="line">  &quot;namespace&quot; : &quot;test.comment&quot;,</span><br><span class="line">  &quot;indexFilterSet&quot; : false,</span><br><span class="line">  &quot;parsedQuery&quot; : &#123;</span><br><span class="line">   &quot;userid&quot; : &#123;</span><br><span class="line">    &quot;$eq&quot; : &quot;1003&quot;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;queryHash&quot; : &quot;37A12FC3&quot;,</span><br><span class="line">  &quot;planCacheKey&quot; : &quot;37A12FC3&quot;,</span><br><span class="line">  &quot;winningPlan&quot; : &#123;</span><br><span class="line">   &quot;stage&quot; : &quot;COLLSCAN&quot;,</span><br><span class="line">   &quot;filter&quot; : &#123;</span><br><span class="line">    &quot;userid&quot; : &#123;</span><br><span class="line">     &quot;$eq&quot; : &quot;1003&quot;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;direction&quot; : &quot;forward&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;rejectedPlans&quot; : [ ]</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;serverInfo&quot; : &#123;</span><br><span class="line">  &quot;host&quot; : &quot;localhost.localdomain&quot;,</span><br><span class="line">  &quot;port&quot; : 27017,</span><br><span class="line">  &quot;version&quot; : &quot;4.4.28&quot;,</span><br><span class="line">  &quot;gitVersion&quot; : &quot;61c2baf63a060f7c12bd76e779044800ae18710b&quot;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="关键点看：”stage”-“COLLSCAN”-表示全集合扫描"><a href="#关键点看：”stage”-“COLLSCAN”-表示全集合扫描" class="headerlink" title="关键点看：”stage” : “COLLSCAN”,表示全集合扫描"></a>关键点看：”stage” : “COLLSCAN”,表示全集合扫描</h4><p><img src="QQ截图20240125205417.png&quot;" alt="输入图片说明"></p>
<h4 id="下面对userid建立索引"><a href="#下面对userid建立索引" class="headerlink" title="下面对userid建立索引"></a>下面对userid建立索引</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;userid:1&#125;)</span><br><span class="line">&#123;</span><br><span class="line">  &quot;createdCollectionAutomatically&quot; : false,</span><br><span class="line">  &quot;numIndexesBefore&quot; : 1,</span><br><span class="line">  &quot;numIndexesAfter&quot; : 2,</span><br><span class="line">  &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="再次查看执行计划"><a href="#再次查看执行计划" class="headerlink" title="再次查看执行计划"></a>再次查看执行计划</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&quot;1013&quot;&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line"> &quot;queryPlanner&quot; : &#123;</span><br><span class="line">  &quot;plannerVersion&quot; : 1,</span><br><span class="line">  &quot;namespace&quot; : &quot;test.comment&quot;,</span><br><span class="line">  &quot;indexFilterSet&quot; : false,</span><br><span class="line">  &quot;parsedQuery&quot; : &#123;</span><br><span class="line">   &quot;userid&quot; : &#123;</span><br><span class="line">    &quot;$eq&quot; : &quot;1013&quot;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;queryHash&quot; : &quot;37A12FC3&quot;,</span><br><span class="line">  &quot;planCacheKey&quot; : &quot;7FDF74EC&quot;,</span><br><span class="line">  &quot;winningPlan&quot; : &#123;</span><br><span class="line">   &quot;stage&quot; : &quot;FETCH&quot;,</span><br><span class="line">   &quot;inputStage&quot; : &#123;</span><br><span class="line">    &quot;stage&quot; : &quot;IXSCAN&quot;,</span><br><span class="line">    &quot;keyPattern&quot; : &#123;</span><br><span class="line">     &quot;userid&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;indexName&quot; : &quot;userid_1&quot;,</span><br><span class="line">    &quot;isMultiKey&quot; : false,</span><br><span class="line">    &quot;multiKeyPaths&quot; : &#123;</span><br><span class="line">     &quot;userid&quot; : [ ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;isUnique&quot; : false,</span><br><span class="line">    &quot;isSparse&quot; : false,</span><br><span class="line">    &quot;isPartial&quot; : false,</span><br><span class="line">    &quot;indexVersion&quot; : 2,</span><br><span class="line">    &quot;direction&quot; : &quot;forward&quot;,</span><br><span class="line">    &quot;indexBounds&quot; : &#123;</span><br><span class="line">     &quot;userid&quot; : [</span><br><span class="line">      &quot;[\&quot;1013\&quot;, \&quot;1013\&quot;]&quot;</span><br><span class="line">     ]</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;rejectedPlans&quot; : [ ]</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;serverInfo&quot; : &#123;</span><br><span class="line">  &quot;host&quot; : &quot;localhost.localdomain&quot;,</span><br><span class="line">  &quot;port&quot; : 27017,</span><br><span class="line">  &quot;version&quot; : &quot;4.4.28&quot;,</span><br><span class="line">  &quot;gitVersion&quot; : &quot;61c2baf63a060f7c12bd76e779044800ae18710b&quot;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="关键点看：”stage”-“IXSCAN”-基于索引的扫描"><a href="#关键点看：”stage”-“IXSCAN”-基于索引的扫描" class="headerlink" title="关键点看：”stage” : “IXSCAN”,基于索引的扫描"></a>关键点看：”stage” : “IXSCAN”,基于索引的扫描</h4><h4 id="compass查看"><a href="#compass查看" class="headerlink" title="compass查看"></a>compass查看</h4><p><img src="QQ截图20240125205711.png&quot;" alt="输入图片说明"></p>
<h3 id="4-4-2-涵盖的查询"><a href="#4-4-2-涵盖的查询" class="headerlink" title="4.4.2 涵盖的查询"></a>4.4.2 涵盖的查询</h3><h4 id="Covered-Queries"><a href="#Covered-Queries" class="headerlink" title="Covered Queries"></a>Covered Queries</h4><blockquote>
<p>当查询条件和查询的投影仅包含索引字段时，MongoDB直接从索引返回结果，而不扫描任何文档或将文档带入内存。 这些覆盖的查询可以<br>非常有效。</p>
</blockquote>
<p><img src="QQ截图20240125205754.png&quot;" alt="输入图片说明"></p>
<h4 id="更多：https-docs-mongodb-com-manual-core-query-optimization-read-operations-covered-query"><a href="#更多：https-docs-mongodb-com-manual-core-query-optimization-read-operations-covered-query" class="headerlink" title="更多：https://docs.mongodb.com/manual/core/query-optimization/#read-operations-covered-query"></a>更多：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/query-optimization/#read-operations-covered-query">https://docs.mongodb.com/manual/core/query-optimization/#read-operations-covered-query</a></h4><h4 id="【示例】-10"><a href="#【示例】-10" class="headerlink" title="【示例】"></a>【示例】</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.comment.find(&#123;userid:<span class="string">&quot;1003&quot;</span>&#125;,&#123;userid:1,_id:0&#125;)</span></span><br><span class="line">&#123; &quot;userid&quot; : &quot;1003&quot; &#125;</span><br><span class="line">&#123; &quot;userid&quot; : &quot;1003&quot; &#125;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.comment.find(&#123;userid:<span class="string">&quot;1003&quot;</span>&#125;,&#123;userid:1,_id:0&#125;).explain()</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;queryPlanner&quot; : &#123;</span><br><span class="line">    &quot;plannerVersion&quot; : 1,</span><br><span class="line">    &quot;namespace&quot; : &quot;articledb.comment&quot;,</span><br><span class="line">    &quot;indexFilterSet&quot; : false,</span><br><span class="line">    &quot;parsedQuery&quot; : &#123;</span><br><span class="line">      &quot;userid&quot; : &#123;</span><br><span class="line">        &quot;$eq&quot; : &quot;1003&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;winningPlan&quot; : &#123;</span><br><span class="line">      &quot;stage&quot; : &quot;PROJECTION&quot;,</span><br><span class="line">      &quot;transformBy&quot; : &#123;</span><br><span class="line">        &quot;userid&quot; : 1,</span><br><span class="line">        &quot;_id&quot; : 0</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;inputStage&quot; : &#123;</span><br><span class="line">        &quot;stage&quot; : &quot;IXSCAN&quot;,</span><br><span class="line">        &quot;keyPattern&quot; : &#123;</span><br><span class="line">          &quot;userid&quot; : 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;indexName&quot; : &quot;userid_1&quot;,</span><br><span class="line">        &quot;isMultiKey&quot; : false,</span><br><span class="line">        &quot;multiKeyPaths&quot; : &#123;</span><br><span class="line">          &quot;userid&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;isUnique&quot; : false,</span><br><span class="line">        &quot;isSparse&quot; : false,</span><br><span class="line">        &quot;isPartial&quot; : false,</span><br><span class="line">        &quot;indexVersion&quot; : 2,</span><br><span class="line">        &quot;direction&quot; : &quot;forward&quot;,</span><br><span class="line">        &quot;indexBounds&quot; : &#123;</span><br><span class="line">          &quot;userid&quot; : [</span><br><span class="line">          &quot;[\&quot;1003\&quot;, \&quot;1003\&quot;]&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;rejectedPlans&quot; : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;serverInfo&quot; : &#123;</span><br><span class="line">    &quot;host&quot; : &quot;bobohost.localdomain&quot;,</span><br><span class="line">    &quot;port&quot; : 27017,</span><br><span class="line">    &quot;version&quot; : &quot;4.0.10&quot;,</span><br><span class="line">    &quot;gitVersion&quot; : &quot;c389e7f69f637f7a1ac3cc9fae843b635f20b766&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Compass中"><a href="#Compass中" class="headerlink" title="Compass中"></a>Compass中</h4><p><img src="QQ截图20240125210642.png&quot;" alt="输入图片说明"></p>
<h1 id="5-文章评论"><a href="#5-文章评论" class="headerlink" title="5 文章评论"></a>5 文章评论</h1><h2 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a>5.1 需求分析</h2><h4 id="某头条的文章评论业务如下"><a href="#某头条的文章评论业务如下" class="headerlink" title="某头条的文章评论业务如下"></a>某头条的文章评论业务如下</h4><p><img src="QQ截图20240125210724.png&quot;" alt="输入图片说明"></p>
<p><img src="QQ截图20240125210747.png&quot;" alt="输入图片说明"></p>
<p>文章示例参考：早晨空腹喝水，是对还是错？<a target="_blank" rel="noopener" href="https://www.toutiao.com/a6721476546088927748/">https://www.toutiao.com/a6721476546088927748/</a></p>
<p>需要实现以下功能：</p>
<ul>
<li>1）基本增删改查API</li>
<li>2）根据文章id查询评论</li>
<li>3）评论点赞</li>
</ul>
<h2 id="5-2-表结构分析"><a href="#5-2-表结构分析" class="headerlink" title="5.2 表结构分析"></a>5.2 表结构分析</h2><h4 id="数据库：articledb"><a href="#数据库：articledb" class="headerlink" title="数据库：articledb"></a>数据库：articledb</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">字段名称</th>
<th style="text-align:center">字段含义</th>
<th style="text-align:center">字段类型</th>
<th style="text-align:center">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">_id</td>
<td style="text-align:center">ID</td>
<td style="text-align:center">ObjectId或String</td>
<td style="text-align:center">Mongo的主键的字段</td>
</tr>
<tr>
<td style="text-align:center">articleid</td>
<td style="text-align:center">文章ID</td>
<td style="text-align:center">String</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">content</td>
<td style="text-align:center">评论内容</td>
<td style="text-align:center">String</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">userid</td>
<td style="text-align:center">评论人ID</td>
<td style="text-align:center">String</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">nickname</td>
<td style="text-align:center">评论人昵称</td>
<td style="text-align:center">String</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">createdatetime</td>
<td style="text-align:center">评论的日期时间</td>
<td style="text-align:center">Date</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">likenum</td>
<td style="text-align:center">点赞数</td>
<td style="text-align:center">Int32</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">replynum</td>
<td style="text-align:center">回复数</td>
<td style="text-align:center">Int32</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">state</td>
<td style="text-align:center">状态</td>
<td style="text-align:center">String</td>
<td style="text-align:center">0 ：不可见； 1 ：可见；</td>
</tr>
<tr>
<td style="text-align:center">parentid</td>
<td style="text-align:center">上级ID</td>
<td style="text-align:center">String</td>
<td style="text-align:center">如果为 0 表示文章的顶级评论</td>
</tr>
</tbody>
</table>
</div>
<h2 id="5-3-技术选型"><a href="#5-3-技术选型" class="headerlink" title="5.3 技术选型"></a>5.3 技术选型</h2><h3 id="5-3-1-mongodb-driver（了解）"><a href="#5-3-1-mongodb-driver（了解）" class="headerlink" title="5.3.1 mongodb-driver（了解）"></a>5.3.1 mongodb-driver（了解）</h3><blockquote>
<p>mongodb-driver是mongo官方推出的java连接mongoDB的驱动包，相当于JDBC驱动。我们通过一个入门的案例来了解mongodb-driver的基本使用。</p>
</blockquote>
<p>官方驱动说明和下载：<a target="_blank" rel="noopener" href="http://mongodb.github.io/mongo-java-driver/">http://mongodb.github.io/mongo-java-driver/</a></p>
<p>官方驱动示例文档：<a target="_blank" rel="noopener" href="http://mongodb.github.io/mongo-java-driver/3.8/driver/getting-started/quick-start/">http://mongodb.github.io/mongo-java-driver/3.8/driver/getting-started/quick-start/</a></p>
<h3 id="5-3-2-SpringDataMongoDB"><a href="#5-3-2-SpringDataMongoDB" class="headerlink" title="5.3.2 SpringDataMongoDB"></a>5.3.2 SpringDataMongoDB</h3><p>SpringData家族成员之一，用于操作MongoDB的持久层框架，封装了底层的mongodb-driver。</p>
<p>官网主页： <a target="_blank" rel="noopener" href="https://projects.spring.io/spring-data-mongodb/">https://projects.spring.io/spring-data-mongodb/</a></p>
<p>我们十次方项目的吐槽微服务就采用SpringDataMongoDB框架。</p>
<h2 id="5-4-文章微服务模块搭建"><a href="#5-4-文章微服务模块搭建" class="headerlink" title="5.4 文章微服务模块搭建"></a>5.4 文章微服务模块搭建</h2><ul>
<li>（ 1 ）搭建项目工程article，pom.xml引入依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.itcast<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>article<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>（ 2 ）创建application.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#数据源配置</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="comment"># 主机地址</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.141</span></span><br><span class="line">      <span class="comment"># 数据库</span></span><br><span class="line">      <span class="attr">database:</span> <span class="string">articledb</span></span><br><span class="line">      <span class="comment"># 默认端口是27017</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">      <span class="comment">#也可以使用uri连接</span></span><br><span class="line">      <span class="comment">#uri: mongodb://192.168.40.134:27017/articledb</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>（ 3 ）创建启动类</li>
</ul>
<h4 id="cn-itcast-article-ArticleApplication"><a href="#cn-itcast-article-ArticleApplication" class="headerlink" title="cn.itcast.article.ArticleApplication"></a>cn.itcast.article.ArticleApplication</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArticleApplication</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    SpringApplication.run(ArticleApplication.class, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 4 ）启动项目，看是否能正常启动，控制台没有错误。</li>
</ul>
<h2 id="5-5-文章评论实体类的编写"><a href="#5-5-文章评论实体类的编写" class="headerlink" title="5.5 文章评论实体类的编写"></a>5.5 文章评论实体类的编写</h2><h4 id="创建实体类-创建包cn-itcast-article，包下建包po用于存放实体类，创建实体类"><a href="#创建实体类-创建包cn-itcast-article，包下建包po用于存放实体类，创建实体类" class="headerlink" title="创建实体类 创建包cn.itcast.article，包下建包po用于存放实体类，创建实体类"></a>创建实体类 创建包cn.itcast.article，包下建包po用于存放实体类，创建实体类</h4><h4 id="cn-itcast-article-po-Comment"><a href="#cn-itcast-article-po-Comment" class="headerlink" title="cn.itcast.article.po.Comment"></a>cn.itcast.article.po.Comment</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.po;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.index.Indexed;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Field;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 文章评论实体类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//把一个java类声明为mongodb的文档，可以通过collection参数指定这个类对应的文档。</span></span><br><span class="line"><span class="comment">//@Document(collection=&quot;mongodb 对应 collection 名&quot;)</span></span><br><span class="line"><span class="comment">// 若未加 @Document ，该 bean save 到 mongo 的 comment collection</span></span><br><span class="line"><span class="comment">// 若添加 @Document ，则 save 到 comment collection</span></span><br><span class="line"><span class="meta">@Document(collection=&quot;comment&quot;)</span><span class="comment">//可以省略，如果省略，则默认使用类名小写映射集合</span></span><br><span class="line"><span class="comment">//复合索引</span></span><br><span class="line"><span class="comment">// @CompoundIndex( def = &quot;&#123;&#x27;userid&#x27;: 1, &#x27;nickname&#x27;: -1&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Comment</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">  <span class="comment">//主键标识，该属性的值会自动对应mongodb的主键字段&quot;_id&quot;，如果该属性名就叫“id”,则该注解可以省略，否则必须写</span></span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="keyword">private</span> String id;<span class="comment">//主键</span></span><br><span class="line">  <span class="comment">//该属性对应mongodb的字段的名字，如果一致，则无需该注解</span></span><br><span class="line">  <span class="meta">@Field(&quot;content&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> String content;<span class="comment">//吐槽内容</span></span><br><span class="line">  <span class="keyword">private</span> Date publishtime;<span class="comment">//发布日期</span></span><br><span class="line">  <span class="comment">//添加了一个单字段的索引</span></span><br><span class="line">  <span class="meta">@Indexed</span></span><br><span class="line">  <span class="keyword">private</span> String userid;<span class="comment">//发布人ID</span></span><br><span class="line">  <span class="keyword">private</span> String nickname;<span class="comment">//昵称</span></span><br><span class="line">  <span class="keyword">private</span> LocalDateTime createdatetime;<span class="comment">//评论的日期时间</span></span><br><span class="line">  <span class="keyword">private</span> Integer likenum;<span class="comment">//点赞数</span></span><br><span class="line">  <span class="keyword">private</span> Integer replynum;<span class="comment">//回复数</span></span><br><span class="line">  <span class="keyword">private</span> String state;<span class="comment">//状态</span></span><br><span class="line">  <span class="keyword">private</span> String parentid;<span class="comment">//上级ID</span></span><br><span class="line">  <span class="keyword">private</span> String articleid;</span><br><span class="line">  <span class="comment">//getter and setter.....</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(String id)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.id = id;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> content;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContent</span><span class="params">(String content)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.content = content;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> Date <span class="title function_">getPublishtime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> publishtime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPublishtime</span><span class="params">(Date publishtime)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.publishtime = publishtime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getUserid</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userid;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserid</span><span class="params">(String userid)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.userid = userid;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getNickname</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nickname;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNickname</span><span class="params">(String nickname)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.nickname = nickname;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> LocalDateTime <span class="title function_">getCreatedatetime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> createdatetime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCreatedatetime</span><span class="params">(LocalDateTime createdatetime)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.createdatetime = createdatetime;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> Integer <span class="title function_">getLikenum</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> likenum;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLikenum</span><span class="params">(Integer likenum)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.likenum = likenum;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> Integer <span class="title function_">getReplynum</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> replynum;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setReplynum</span><span class="params">(Integer replynum)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.replynum = replynum;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">(String state)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.state = state;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getParentid</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> parentid;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParentid</span><span class="params">(String parentid)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.parentid = parentid;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getArticleid</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> articleid;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setArticleid</span><span class="params">(String articleid)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.articleid = articleid;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Comment&#123;&quot;</span> +</span><br><span class="line">      <span class="string">&quot;id=&#x27;&quot;</span> + id + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">      <span class="string">&quot;, content=&#x27;&quot;</span> + content + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">      <span class="string">&quot;, publishtime=&quot;</span> + publishtime +</span><br><span class="line">      <span class="string">&quot;, userid=&#x27;&quot;</span> + userid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">      <span class="string">&quot;, nickname=&#x27;&quot;</span> + nickname + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">      <span class="string">&quot;, createdatetime=&quot;</span> + createdatetime +</span><br><span class="line">      <span class="string">&quot;, likenum=&quot;</span> + likenum +</span><br><span class="line">      <span class="string">&quot;, replynum=&quot;</span> + replynum +</span><br><span class="line">      <span class="string">&quot;, state=&#x27;&quot;</span> + state + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">      <span class="string">&quot;, parentid=&#x27;&quot;</span> + parentid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">      <span class="string">&quot;, articleid=&#x27;&quot;</span> + articleid + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="说明-2"><a href="#说明-2" class="headerlink" title="说明"></a>说明</h4><p><code>索引可以大大提升查询效率，一般在查询字段上添加索引，索引的添加可以通过Mongo的命令来添加，也可以在Java的实体类中通过注解添加。</code></p>
<ul>
<li>1 ）单字段索引注解@Indexed</li>
</ul>
<p>org.springframework.data.mongodb.core.index.Indexed.class</p>
<p>声明该字段需要索引，建索引可以大大的提高查询效率。</p>
<h4 id="Mongo命令参考"><a href="#Mongo命令参考" class="headerlink" title="Mongo命令参考"></a>Mongo命令参考</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;&quot;userid&quot;:1&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>2 ）复合索引注解@CompoundIndex</li>
</ul>
<p>org.springframework.data.mongodb.core.index.CompoundIndex.class</p>
<p>复合索引的声明，建复合索引可以有效地提高多字段的查询效率。</p>
<h4 id="Mongo命令参考-1"><a href="#Mongo命令参考-1" class="headerlink" title="Mongo命令参考"></a>Mongo命令参考</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;&quot;userid&quot;:1,&quot;nickname&quot;:-1&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="5-6-文章评论的基本增删改查"><a href="#5-6-文章评论的基本增删改查" class="headerlink" title="5.6 文章评论的基本增删改查"></a>5.6 文章评论的基本增删改查</h2><ul>
<li>（ 1 ）创建数据访问接口 cn.itcast.article包下创建dao包，包下创建接口</li>
</ul>
<h4 id="cn-itcast-article-dao-CommentRepository"><a href="#cn-itcast-article-dao-CommentRepository" class="headerlink" title="cn.itcast.article.dao.CommentRepository"></a>cn.itcast.article.dao.CommentRepository</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.dao;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.po.Comment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.repository.MongoRepository;</span><br><span class="line"><span class="comment">//评论的持久层接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CommentRepository</span> <span class="keyword">extends</span> <span class="title class_">MongoRepository</span>&lt;Comment,String&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 2 ）创建业务逻辑类 cn.itcast.article包下创建service包，包下创建类</li>
</ul>
<h4 id="cn-itcast-article-service-CommentService"><a href="#cn-itcast-article-service-CommentService" class="headerlink" title="cn.itcast.article.service.CommentService"></a>cn.itcast.article.service.CommentService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.service;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.dao.CommentRepository;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.po.Comment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="comment">//评论的业务层</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommentService</span> &#123;</span><br><span class="line">  <span class="comment">//注入dao</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> CommentRepository commentRepository;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 保存一个评论</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> comment</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveComment</span><span class="params">(Comment comment)</span>&#123;</span><br><span class="line">    <span class="comment">//如果需要自定义主键，可以在这里指定主键；如果不指定主键，MongoDB会自动生成主键</span></span><br><span class="line">    <span class="comment">//设置一些默认初始值。。。</span></span><br><span class="line">    <span class="comment">//调用dao</span></span><br><span class="line">    commentRepository.save(comment);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 更新评论</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> comment</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateComment</span><span class="params">(Comment comment)</span>&#123;</span><br><span class="line">    <span class="comment">//调用dao</span></span><br><span class="line">    commentRepository.save(comment);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 根据id删除评论</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteCommentById</span><span class="params">(String id)</span>&#123;</span><br><span class="line">    <span class="comment">//调用dao</span></span><br><span class="line">    commentRepository.deleteById(id);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 查询所有评论</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">public</span> List&lt;Comment&gt; <span class="title function_">findCommentList</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//调用dao</span></span><br><span class="line">    <span class="keyword">return</span> commentRepository.findAll();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 根据id查询评论</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">public</span> Comment <span class="title function_">findCommentById</span><span class="params">(String id)</span>&#123;</span><br><span class="line">    <span class="comment">//调用dao</span></span><br><span class="line">    <span class="keyword">return</span> commentRepository.findById(id).get();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>（ 3 ）新建Junit测试类，测试保存和查询所有：</li>
</ul>
<h4 id="cn-itcast-article-service-CommentServiceTest"><a href="#cn-itcast-article-service-CommentServiceTest" class="headerlink" title="cn.itcast.article.service.CommentServiceTest"></a>cn.itcast.article.service.CommentServiceTest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.article.service;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.ArticleApplication;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.article.po.Comment;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="comment">//测试评论的业务层</span></span><br><span class="line"><span class="comment">//SpringBoot的Junit集成测试</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="comment">//SpringBoot的测试环境初始化，参数：启动类</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = ArticleApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommentServiceTest</span> &#123;</span><br><span class="line">  <span class="comment">//注入Service</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> CommentService commentService;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 保存一个评论</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSaveComment</span><span class="params">()</span>&#123;</span><br><span class="line">    Comment comment=<span class="keyword">new</span> <span class="title class_">Comment</span>();</span><br><span class="line">    comment.setArticleid(<span class="string">&quot;100000&quot;</span>);</span><br><span class="line">    comment.setContent(<span class="string">&quot;测试添加的数据&quot;</span>);</span><br><span class="line">    comment.setCreatedatetime(LocalDateTime.now());</span><br><span class="line">    comment.setUserid(<span class="string">&quot;1003&quot;</span>);</span><br><span class="line">    comment.setNickname(<span class="string">&quot;凯撒大帝&quot;</span>);</span><br><span class="line">    comment.setState(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    comment.setLikenum(<span class="number">0</span>);</span><br><span class="line">    comment.setReplynum(<span class="number">0</span>);</span><br><span class="line">    commentService.saveComment(comment);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 查询所有数据</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindAll</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;Comment&gt; list = commentService.findCommentList();</span><br><span class="line">    System.out.println(list);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 测试根据id查询</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindCommentById</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Comment</span> <span class="variable">comment</span> <span class="operator">=</span> commentService.findCommentById(<span class="string">&quot;5d6a27b81b8d374798cf0b41&quot;</span>);</span><br><span class="line">    System.out.println(comment);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="添加结果"><a href="#添加结果" class="headerlink" title="添加结果"></a>添加结果</h4><p><img src="QQ截图20240125225043.png&quot;" alt="输入图片说明"></p>
<h2 id="5-7-根据上级ID查询文章评论的分页列表"><a href="#5-7-根据上级ID查询文章评论的分页列表" class="headerlink" title="5.7 根据上级ID查询文章评论的分页列表"></a>5.7 根据上级ID查询文章评论的分页列表</h2><ul>
<li>（ 1 ）CommentRepository新增方法定义</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据父id，查询子评论的分页列表</span></span><br><span class="line">Page&lt;Comment&gt; <span class="title function_">findByParentid</span><span class="params">(String parentid, Pageable pageable)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 2 ）CommentService新增方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据父id查询分页列表</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> parentid</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> size</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> Page&lt;Comment&gt; <span class="title function_">findCommentListPageByParentid</span><span class="params">(String parentid,<span class="type">int</span> page ,<span class="type">int</span> size)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> commentRepository.findByParentid(parentid, PageRequest.of(page-<span class="number">1</span>,size));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="（-3-）junit测试用例"><a href="#（-3-）junit测试用例" class="headerlink" title="（ 3 ）junit测试用例"></a>（ 3 ）junit测试用例</h4><h4 id="cn-itcast-article-service-CommentServiceTest-1"><a href="#cn-itcast-article-service-CommentServiceTest-1" class="headerlink" title="cn.itcast.article.service.CommentServiceTest"></a>cn.itcast.article.service.CommentServiceTest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 测试根据父id查询子评论的分页列表</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindCommentListPageByParentid</span><span class="params">()</span>&#123;</span><br><span class="line">  Page&lt;Comment&gt; pageResponse = commentService.findCommentListPageByParentid(<span class="string">&quot;3&quot;</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">  System.out.println(<span class="string">&quot;----总记录数：&quot;</span>+pageResponse.getTotalElements());</span><br><span class="line">  System.out.println(<span class="string">&quot;----当前页数据：&quot;</span>+pageResponse.getContent());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="（-4-）测试"><a href="#（-4-）测试" class="headerlink" title="（ 4 ）测试"></a>（ 4 ）测试</h4><h4 id="使用compass快速插入一条测试数据，数据的内容是对-3-号评论内容进行评论"><a href="#使用compass快速插入一条测试数据，数据的内容是对-3-号评论内容进行评论" class="headerlink" title="使用compass快速插入一条测试数据，数据的内容是对 3 号评论内容进行评论"></a>使用compass快速插入一条测试数据，数据的内容是对 3 号评论内容进行评论</h4><p><img src="QQ截图20240125225206.png&quot;" alt="输入图片说明"></p>
<h4 id="执行测试，结果"><a href="#执行测试，结果" class="headerlink" title="执行测试，结果"></a>执行测试，结果</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">----总记录数：1</span><br><span class="line">----当前页数据：[Comment&#123;id=&#x27;33&#x27;, content=&#x27;你年轻，火力大&#x27;, publishtime=null, userid=&#x27;1003&#x27;, nickname=&#x27;凯撒大帝&#x27;,</span><br><span class="line">createdatetime=null, likenum=null, replynum=null, state=&#x27;null&#x27;, parentid=&#x27;3&#x27;, articleid=&#x27;100001&#x27;&#125;]</span><br></pre></td></tr></table></figure>
<h2 id="5-8-MongoTemplate实现评论点赞"><a href="#5-8-MongoTemplate实现评论点赞" class="headerlink" title="5.8 MongoTemplate实现评论点赞"></a>5.8 MongoTemplate实现评论点赞</h2><h4 id="我们看一下以下点赞的临时示例代码：-CommentService-新增updateThumbup方法"><a href="#我们看一下以下点赞的临时示例代码：-CommentService-新增updateThumbup方法" class="headerlink" title="我们看一下以下点赞的临时示例代码： CommentService 新增updateThumbup方法"></a>我们看一下以下点赞的临时示例代码： CommentService 新增updateThumbup方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 点赞-效率低</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCommentThumbupToIncrementingOld</span><span class="params">(String id)</span>&#123;</span><br><span class="line">  <span class="type">Comment</span> <span class="variable">comment</span> <span class="operator">=</span> CommentRepository.findById(id).get();</span><br><span class="line">  comment.setLikenum(comment.getLikenum()+<span class="number">1</span>);</span><br><span class="line">  CommentRepository.save(comment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上方法虽然实现起来比较简单，但是执行效率并不高，因为我只需要将点赞数加<br>1就可以了，没必要查询出所有字段修改后再更新所有字段。(蝴蝶效应)</p>
</blockquote>
<h4 id="我们可以使用MongoTemplate类来实现对某列的操作"><a href="#我们可以使用MongoTemplate类来实现对某列的操作" class="headerlink" title="我们可以使用MongoTemplate类来实现对某列的操作"></a>我们可以使用MongoTemplate类来实现对某列的操作</h4><ul>
<li>（ 1 ）修改CommentService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注入MongoTemplate</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 点赞数+1</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCommentLikenum</span><span class="params">(String id)</span>&#123;</span><br><span class="line">  <span class="comment">//查询对象</span></span><br><span class="line">  Query query=Query.query(Criteria.where(<span class="string">&quot;_id&quot;</span>).is(id));</span><br><span class="line">  <span class="comment">//更新对象</span></span><br><span class="line">  Update update=<span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">  <span class="comment">//局部更新，相当于$set</span></span><br><span class="line">  <span class="comment">// update.set(key,value)</span></span><br><span class="line">  <span class="comment">//递增$inc</span></span><br><span class="line">  <span class="comment">// update.inc(&quot;likenum&quot;,1);</span></span><br><span class="line">  update.inc(<span class="string">&quot;likenum&quot;</span>);</span><br><span class="line">  <span class="comment">//参数1：查询对象</span></span><br><span class="line">  <span class="comment">//参数2：更新对象</span></span><br><span class="line">  <span class="comment">//参数3：集合的名字或实体类的类型Comment.class</span></span><br><span class="line">  mongoTemplate.updateFirst(query,update,<span class="string">&quot;comment&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>（ 2 ）测试用例：</li>
</ul>
<h4 id="cn-itcast-article-service-CommentServiceTest-2"><a href="#cn-itcast-article-service-CommentServiceTest-2" class="headerlink" title="cn.itcast.article.service.CommentServiceTest"></a>cn.itcast.article.service.CommentServiceTest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 点赞数+1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdateCommentLikenum</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//对3号文档的点赞数+1</span></span><br><span class="line">  commentService.updateCommentLikenum(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="执行测试用例后，发现点赞数-1了"><a href="#执行测试用例后，发现点赞数-1了" class="headerlink" title="执行测试用例后，发现点赞数+1了"></a>执行测试用例后，发现点赞数+1了</h4><p><img src="QQ截图20240125225437.png&quot;" alt="输入图片说明"></p>
<h1 id="MongoDB集群和安全"><a href="#MongoDB集群和安全" class="headerlink" title="MongoDB集群和安全"></a>MongoDB集群和安全</h1><h1 id="1-副本集-Replica-Sets"><a href="#1-副本集-Replica-Sets" class="headerlink" title="1. 副本集-Replica Sets"></a>1. 副本集-Replica Sets</h1><h2 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h2><blockquote>
<p>MongoDB中的副本集（Replica Set）是一组维护相同数据集的mongod服务。 副本集可提供冗余和高可用性，是所有生产部署的基础。</p>
<p>也可以说，副本集类似于有自动故障恢复功能的主从集群。通俗的讲就是用多台机器进行同一数据的异步同步，<br>从而使多台机器拥有同一数据的多个副本，并且当主库当掉时在不需要用户干预的情况下自动切换其他备份服务器做主库。<br>而且还可以利用副本服务器做只读服务器，实现读写分离，提高负载。</p>
</blockquote>
<ul>
<li>（ 1 ）冗余和数据可用性</li>
</ul>
<blockquote>
<p>复制提供冗余并提高数据可用性。 通过在不同数据库服务器上提供多个数据副本，复制可提供一定级别的容错功能，以防止丢失单个数据库服务器。</p>
<p>在某些情况下，复制可以提供增加的读取性能，因为客户端可以将读取操作发送到不同的服务上， 在不同数据中心维护数据副本可以增加分布式应用程序的数据位置和可用性。<br>您还可以为专用目的维护其他副本，例如灾难恢复，报告或备份。</p>
</blockquote>
<ul>
<li>（ 2 ）MongoDB中的复制</li>
</ul>
<blockquote>
<p>副本集是一组维护相同数据集的mongod实例。 副本集包含多个数据承载节点和可选的一个仲裁节点。在承载数据的节点中，一个且仅一个成员被视为主节点，而其他节点被视为次要（从）节点。</p>
<p>主节点接收所有写操作。 副本集只能有一个主要能够确认具有{w：“most”}写入关注的写入;<br>虽然在某些情况下，另一个mongod实例可能暂时认为自己也是主要的。主要记录其操作日志中的数据集的所有更改，即oplog。</p>
</blockquote>
<p><img src="QQ截图20240126184037.png&quot;" alt="输入图片说明"></p>
<p><code>辅助(副本)节点复制主节点的oplog并将操作应用于其数据集，以使辅助节点的数据集反映主节点的数据集。如果主要人员不在，则符合条件的中学将举行选举以选出新的主要人员。</code></p>
<ul>
<li>（ 3 ）主从复制和副本集区别</li>
</ul>
<blockquote>
<p>主从集群和副本集最大的区别就是副本集没有固定的“主节点”；整个集群会选出一个“主节点”，当其挂掉后，<br>又在剩下的从节点中选中其他节点为“主节点”，副本集总有一个活跃点(主、primary)和一个或多个备份节点(从、secondary)。</p>
</blockquote>
<h2 id="1-2-副本集的三个角色"><a href="#1-2-副本集的三个角色" class="headerlink" title="1.2 副本集的三个角色"></a>1.2 副本集的三个角色</h2><h4 id="副本集有两种类型三种角色"><a href="#副本集有两种类型三种角色" class="headerlink" title="副本集有两种类型三种角色"></a>副本集有两种类型三种角色</h4><h4 id="两种类型"><a href="#两种类型" class="headerlink" title="两种类型"></a>两种类型</h4><ul>
<li>主节点（Primary）类型：数据操作的主要连接点，可读写。</li>
<li>次要（辅助、从）节点（Secondaries）类型：数据冗余备份节点，可以读或选举。</li>
</ul>
<h4 id="三种角色"><a href="#三种角色" class="headerlink" title="三种角色"></a>三种角色</h4><ul>
<li>主要成员（Primary）：主要接收所有写操作。就是主节点。</li>
<li>副本成员（Replicate）：从主节点通过复制操作以维护相同的数据集，即备份数据，不可写操作，但可 以读操作（但需要配置）。是默认的一种从节点类型。</li>
<li>仲裁者（Arbiter）：不保留任何数据的副本，只具有投票选举作用。当然也可以将仲裁服务器维护为副本集的一部分，即副本成员同时也可以是仲裁者。也是一种从节点类型。</li>
</ul>
<h4 id="关于仲裁者的额外说明"><a href="#关于仲裁者的额外说明" class="headerlink" title="关于仲裁者的额外说明"></a>关于仲裁者的额外说明</h4><blockquote>
<p>您可以将额外的mongod实例添加到副本集作为仲裁者。 仲裁者不维护数据集。 仲裁者的目的是通过响应其他副本集成员的心跳和选举请求来维护副本集中的仲裁。<br>因为它们不存储数据集，所以仲裁器可以是提供副本集仲裁功能的好方法，其资源成本比具有数据集的全功能副本集成员更便宜。</p>
<p>如果您的副本集具有偶数个成员，请添加仲裁者以获得主要选举中的“大多数”投票。 仲裁者不需要专用硬件。</p>
<p>仲裁者将永远是仲裁者，而主要人员可能会退出并成为次要人员，而次要人员可能成为选举期间的主要人员。</p>
<p>如果你的副本+主节点的个数是偶数，建议加一个仲裁者，形成奇数，容易满足大多数的投票。</p>
<p>如果你的副本+主节点的个数是奇数，可以不加仲裁者。</p>
</blockquote>
<h2 id="1-3-副本集架构目标"><a href="#1-3-副本集架构目标" class="headerlink" title="1.3 副本集架构目标"></a>1.3 副本集架构目标</h2><h4 id="一主一副本一仲裁"><a href="#一主一副本一仲裁" class="headerlink" title="一主一副本一仲裁"></a>一主一副本一仲裁</h4><p><img src="QQ截图20240126184503.png&quot;" alt="输入图片说明"></p>
<h2 id="1-4-副本集的创建"><a href="#1-4-副本集的创建" class="headerlink" title="1.4 副本集的创建"></a>1.4 副本集的创建</h2><h3 id="1-4-1-第一步：创建主节点"><a href="#1-4-1-第一步：创建主节点" class="headerlink" title="1.4.1 第一步：创建主节点"></a>1.4.1 第一步：创建主节点</h3><h4 id="建立存放数据和日志的目录"><a href="#建立存放数据和日志的目录" class="headerlink" title="建立存放数据和日志的目录"></a>建立存放数据和日志的目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-----------myrs</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">主节点</span></span><br><span class="line">mkdir -p /mongodb/replica_sets/myrs_27017/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/replica_sets/myrs_27017/data/db</span><br></pre></td></tr></table></figure>
<h4 id="新建或修改配置文件"><a href="#新建或修改配置文件" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/replica_sets/myrs_27017/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myrs-27017"><a href="#myrs-27017" class="headerlink" title="myrs_27017"></a>myrs_27017</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/replica_sets/myrs_27017/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/replica_sets/myrs_27017/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/replica_sets/myrs_27017/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIp</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27017</span><br><span class="line">replication:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">副本集的名称 (必须三个配置文件的名字都需要一致)</span></span><br><span class="line">  replSetName: myrs</span><br></pre></td></tr></table></figure>
<h4 id="启动节点服务"><a href="#启动节点服务" class="headerlink" title="启动节点服务"></a>启动节点服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27017/mongod.conf</span><br></pre></td></tr></table></figure>
<h3 id="1-4-2-第二步：创建副本节点"><a href="#1-4-2-第二步：创建副本节点" class="headerlink" title="1.4.2 第二步：创建副本节点"></a>1.4.2 第二步：创建副本节点</h3><h4 id="建立存放数据和日志的目录-1"><a href="#建立存放数据和日志的目录-1" class="headerlink" title="建立存放数据和日志的目录"></a>建立存放数据和日志的目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-----------myrs</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">副本节点</span></span><br><span class="line">mkdir -p /mongodb/replica_sets/myrs_27018/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/replica_sets/myrs_27018/data/db</span><br></pre></td></tr></table></figure>
<h4 id="新建或修改配置文件-1"><a href="#新建或修改配置文件-1" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/replica_sets/myrs_27018/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myrs-27018"><a href="#myrs-27018" class="headerlink" title="myrs_27018"></a>myrs_27018</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/replica_sets/myrs_27018/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/replica_sets/myrs_27018/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/replica_sets/myrs_27018/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIp</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27018</span><br><span class="line">replication:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">副本集的名称 (必须三个配置文件的名字都需要一致)</span></span><br><span class="line">  replSetName: myrs</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="启动节点服务-1"><a href="#启动节点服务-1" class="headerlink" title="启动节点服务"></a>启动节点服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27018/mongod.conf</span><br></pre></td></tr></table></figure>
<h3 id="1-4-3-第三步：创建仲裁节点"><a href="#1-4-3-第三步：创建仲裁节点" class="headerlink" title="1.4.3 第三步：创建仲裁节点"></a>1.4.3 第三步：创建仲裁节点</h3><h4 id="建立存放数据和日志的目录-2"><a href="#建立存放数据和日志的目录-2" class="headerlink" title="建立存放数据和日志的目录"></a>建立存放数据和日志的目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-----------myrs</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">仲裁节点</span></span><br><span class="line">mkdir -p /mongodb/replica_sets/myrs_27019/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/replica_sets/myrs_27019/data/db</span><br></pre></td></tr></table></figure>
<h4 id="仲裁节点"><a href="#仲裁节点" class="headerlink" title="仲裁节点"></a>仲裁节点</h4><h4 id="新建或修改配置文件-2"><a href="#新建或修改配置文件-2" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/replica_sets/myrs_27019/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myrs-27019"><a href="#myrs-27019" class="headerlink" title="myrs_27019"></a>myrs_27019</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/replica_sets/myrs_27019/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/replica_sets/myrs_27019/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/replica_sets/myrs_27019/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIp</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27019</span><br><span class="line">replication:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">副本集的名称 (必须三个配置文件的名字都需要一致)</span></span><br><span class="line">  replSetName: myrs</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="启动节点服务-2"><a href="#启动节点服务-2" class="headerlink" title="启动节点服务"></a>启动节点服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27019/mongod.conf</span><br></pre></td></tr></table></figure>
<h3 id="1-4-5-第四步：初始化配置副本集和主节点"><a href="#1-4-5-第四步：初始化配置副本集和主节点" class="headerlink" title="1.4.5 第四步：初始化配置副本集和主节点"></a>1.4.5 第四步：初始化配置副本集和主节点</h3><h4 id="使用客户端命令连接任意一个节点，但这里尽量要连接主节点-27017节点"><a href="#使用客户端命令连接任意一个节点，但这里尽量要连接主节点-27017节点" class="headerlink" title="使用客户端命令连接任意一个节点，但这里尽量要连接主节点(27017节点)"></a>使用客户端命令连接任意一个节点，<code>但这里尽量要连接主节点(27017节点)</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongo --host=180.76.159.126 --port=27017</span><br></pre></td></tr></table></figure>
<h4 id="结果，连接上之后，很多命令无法使用，，比如show-dbs等，必须初始化副本集才行"><a href="#结果，连接上之后，很多命令无法使用，，比如show-dbs等，必须初始化副本集才行" class="headerlink" title="结果，连接上之后，很多命令无法使用，，比如show dbs等，必须初始化副本集才行"></a>结果，连接上之后，很多命令无法使用，，比如show dbs等，必须初始化副本集才行</h4><h4 id="准备初始化新的副本集"><a href="#准备初始化新的副本集" class="headerlink" title="准备初始化新的副本集"></a>准备初始化新的副本集</h4><h4 id="语法-6"><a href="#语法-6" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate(configuration)</span><br></pre></td></tr></table></figure>
<h4 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">configuration</td>
<td style="text-align:center">document</td>
<td style="text-align:center">Optional. A document that specifies configuration for the new replica set. If a configuration is not specified,MongoDB uses a default replica set configuration.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="【示例】-11"><a href="#【示例】-11" class="headerlink" title="【示例】"></a>【示例】</h4><h4 id="使用默认的配置来初始化副本集"><a href="#使用默认的配置来初始化副本集" class="headerlink" title="使用默认的配置来初始化副本集"></a>使用默认的配置来初始化副本集</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate()</span><br></pre></td></tr></table></figure>
<h4 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; rs.initiate()</span><br><span class="line">&#123;</span><br><span class="line">  &quot;info2&quot; : &quot;no configuration specified. Using a default configuration for the set&quot;,</span><br><span class="line">  &quot;me&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">  &quot;ok&quot; : 1,</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1565760476, 1),</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1565760476, 1),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">    &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">    &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">myrs:SECONDARY&gt;</span><br><span class="line">myrs:PRIMARY&gt;</span><br></pre></td></tr></table></figure>
<h4 id="提示-9"><a href="#提示-9" class="headerlink" title="提示"></a>提示</h4><ul>
<li>1 ）“ok”的值为 1 ，说明创建成功。</li>
<li>2 ）命令行提示符发生变化，变成了一个从节点角色，此时默认不能读写。稍等片刻，回车，变成主节点。</li>
</ul>
<h3 id="1-4-6-第五步：查看副本集的配置内容"><a href="#1-4-6-第五步：查看副本集的配置内容" class="headerlink" title="1.4.6 第五步：查看副本集的配置内容"></a>1.4.6 第五步：查看副本集的配置内容</h3><h4 id="说明-3"><a href="#说明-3" class="headerlink" title="说明"></a>说明</h4><h4 id="返回包含当前副本集配置的文档"><a href="#返回包含当前副本集配置的文档" class="headerlink" title="返回包含当前副本集配置的文档"></a>返回包含当前副本集配置的文档</h4><h4 id="语法-7"><a href="#语法-7" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.conf(configuration)</span><br></pre></td></tr></table></figure>
<h4 id="提示-10"><a href="#提示-10" class="headerlink" title="提示"></a>提示</h4><h4 id="rs-config-是该方法的别名"><a href="#rs-config-是该方法的别名" class="headerlink" title="rs.config()是该方法的别名"></a>rs.config()是该方法的别名</h4><h4 id="configuration：可选，如果没有配置，则使用默认主节点配置"><a href="#configuration：可选，如果没有配置，则使用默认主节点配置" class="headerlink" title="configuration：可选，如果没有配置，则使用默认主节点配置"></a>configuration：可选，如果没有配置，则使用默认主节点配置</h4><h4 id="【示例】-12"><a href="#【示例】-12" class="headerlink" title="【示例】"></a>【示例】</h4><h4 id="在-27017-上执行副本集中当前节点的默认节点配置"><a href="#在-27017-上执行副本集中当前节点的默认节点配置" class="headerlink" title="在 27017 上执行副本集中当前节点的默认节点配置"></a>在 27017 上执行副本集中当前节点的默认节点配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.conf()</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : &quot;myrs&quot;,</span><br><span class="line">  &quot;version&quot; : 1,</span><br><span class="line">  &quot;protocolVersion&quot; : NumberLong(1),</span><br><span class="line">  &quot;writeConcernMajorityJournalDefault&quot; : true,</span><br><span class="line">  &quot;members&quot; : [</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;_id&quot; : 0,</span><br><span class="line">    &quot;host&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">    &quot;arbiterOnly&quot; : false,</span><br><span class="line">    &quot;buildIndexes&quot; : true,</span><br><span class="line">    &quot;hidden&quot; : false,</span><br><span class="line">    &quot;priority&quot; : 1,</span><br><span class="line">    &quot;tags&quot; : &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">    &quot;votes&quot; : 1</span><br><span class="line">  &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;settings&quot; : &#123;</span><br><span class="line">    &quot;chainingAllowed&quot; : true,</span><br><span class="line">    &quot;heartbeatIntervalMillis&quot; : 2000,</span><br><span class="line">    &quot;heartbeatTimeoutSecs&quot; : 10,</span><br><span class="line">    &quot;electionTimeoutMillis&quot; : 10000,</span><br><span class="line">    &quot;catchUpTimeoutMillis&quot; : -1,</span><br><span class="line">    &quot;catchUpTakeoverDelayMillis&quot; : 30000,</span><br><span class="line">    &quot;getLastErrorModes&quot; : &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;getLastErrorDefaults&quot; : &#123;</span><br><span class="line">      &quot;w&quot; : 1,</span><br><span class="line">      &quot;wtimeout&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;replicaSetId&quot; : ObjectId(&quot;5d539bdcd6a308e600d126bb&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="说明-4"><a href="#说明-4" class="headerlink" title="说明"></a>说明</h4><ul>
<li>1 ）”_id” : “myrs”：副本集的配置数据存储的主键值，默认就是副本集的名字</li>
<li>2 ）”members”：副本集成员数组，此时只有一个：”host” : “ 180. 76. 159. 126 : 27017 “，该成员不是仲裁节点：”arbiterOnly” :<br>false，优先级（权重值）：”priority” : 1 ,</li>
<li>3 ）”settings”：副本集的参数配置。</li>
</ul>
<h4 id="提示：副本集配置的查看命令，本质是查询的是system-replset的表中的数据"><a href="#提示：副本集配置的查看命令，本质是查询的是system-replset的表中的数据" class="headerlink" title="提示：副本集配置的查看命令，本质是查询的是system.replset的表中的数据"></a>提示：副本集配置的查看命令，本质是查询的是system.replset的表中的数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; use local</span><br><span class="line">switched to db local</span><br><span class="line">myrs:PRIMARY&gt; show collections</span><br><span class="line">oplog.rs</span><br><span class="line">replset.election</span><br><span class="line">replset.minvalid</span><br><span class="line">replset.oplogTruncateAfterPoint</span><br><span class="line">startup_log</span><br><span class="line">system.replset</span><br><span class="line">system.rollback.id</span><br><span class="line">myrs:PRIMARY&gt; db.system.replset.find()</span><br><span class="line">&#123; &quot;_id&quot; : &quot;myrs&quot;, &quot;version&quot; : 1, &quot;protocolVersion&quot; : NumberLong(1),</span><br><span class="line">&quot;writeConcernMajorityJournalDefault&quot; : true, &quot;members&quot; : [ &#123; &quot;_id&quot; : 0, &quot;host&quot; :</span><br><span class="line">&quot;180.76.159.126:27017&quot;, &quot;arbiterOnly&quot; : false, &quot;buildIndexes&quot; : true, &quot;hidden&quot; :</span><br><span class="line">false, &quot;priority&quot; : 1, &quot;tags&quot; : &#123; &#125;, &quot;slaveDelay&quot; : NumberLong(0), &quot;votes&quot; : 1</span><br><span class="line">&#125; ], &quot;settings&quot; : &#123; &quot;chainingAllowed&quot; : true, &quot;heartbeatIntervalMillis&quot; : 2000,</span><br><span class="line">&quot;heartbeatTimeoutSecs&quot; : 10, &quot;electionTimeoutMillis&quot; : 10000,</span><br><span class="line">&quot;catchUpTimeoutMillis&quot; : -1, &quot;catchUpTakeoverDelayMillis&quot; : 30000,</span><br><span class="line">&quot;getLastErrorModes&quot; : &#123; &#125;, &quot;getLastErrorDefaults&quot; : &#123; &quot;w&quot; : 1, &quot;wtimeout&quot; : 0</span><br><span class="line">&#125;, &quot;replicaSetId&quot; : ObjectId(&quot;5d539bdcd6a308e600d126bb&quot;) &#125; &#125;</span><br><span class="line">myrs:PRIMARY&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="1-4-7-第六步：查看副本集状态"><a href="#1-4-7-第六步：查看副本集状态" class="headerlink" title="1.4.7 第六步：查看副本集状态"></a>1.4.7 第六步：查看副本集状态</h3><h4 id="检查副本集状态"><a href="#检查副本集状态" class="headerlink" title="检查副本集状态"></a>检查副本集状态</h4><h4 id="说明-5"><a href="#说明-5" class="headerlink" title="说明"></a>说明</h4><h4 id="返回包含状态信息的文档。此输出使用从副本集的其他成员发送的心跳包中获得的数据反映副本集的当前状态"><a href="#返回包含状态信息的文档。此输出使用从副本集的其他成员发送的心跳包中获得的数据反映副本集的当前状态" class="headerlink" title="返回包含状态信息的文档。此输出使用从副本集的其他成员发送的心跳包中获得的数据反映副本集的当前状态"></a>返回包含状态信息的文档。此输出使用从副本集的其他成员发送的心跳包中获得的数据反映副本集的当前状态</h4><h4 id="语法-8"><a href="#语法-8" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.status()</span><br></pre></td></tr></table></figure>
<h4 id="【示例】-13"><a href="#【示例】-13" class="headerlink" title="【示例】"></a>【示例】</h4><h4 id="在-27017-上查看副本集状态"><a href="#在-27017-上查看副本集状态" class="headerlink" title="在 27017 上查看副本集状态"></a>在 27017 上查看副本集状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line"> &quot;set&quot; : &quot;myrs&quot;,</span><br><span class="line"> &quot;date&quot; : ISODate(&quot;2024-01-27T02:56:52.934Z&quot;),</span><br><span class="line"> &quot;myState&quot; : 1,</span><br><span class="line"> &quot;term&quot; : NumberLong(1),</span><br><span class="line"> &quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line"> &quot;syncSourceId&quot; : -1,</span><br><span class="line"> &quot;heartbeatIntervalMillis&quot; : NumberLong(2000),</span><br><span class="line"> &quot;majorityVoteCount&quot; : 1,</span><br><span class="line"> &quot;writeMajorityCount&quot; : 1,</span><br><span class="line"> &quot;votingMembersCount&quot; : 1,</span><br><span class="line"> &quot;writableVotingMembersCount&quot; : 1,</span><br><span class="line"> &quot;optimes&quot; : &#123;</span><br><span class="line">  &quot;lastCommittedOpTime&quot; : &#123;</span><br><span class="line">   &quot;ts&quot; : Timestamp(1706324204, 1),</span><br><span class="line">   &quot;t&quot; : NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;lastCommittedWallTime&quot; : ISODate(&quot;2024-01-27T02:56:44.868Z&quot;),</span><br><span class="line">  &quot;readConcernMajorityOpTime&quot; : &#123;</span><br><span class="line">   &quot;ts&quot; : Timestamp(1706324204, 1),</span><br><span class="line">   &quot;t&quot; : NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;readConcernMajorityWallTime&quot; : ISODate(&quot;2024-01-27T02:56:44.868Z&quot;),</span><br><span class="line">  &quot;appliedOpTime&quot; : &#123;</span><br><span class="line">   &quot;ts&quot; : Timestamp(1706324204, 1),</span><br><span class="line">   &quot;t&quot; : NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;durableOpTime&quot; : &#123;</span><br><span class="line">   &quot;ts&quot; : Timestamp(1706324204, 1),</span><br><span class="line">   &quot;t&quot; : NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;lastAppliedWallTime&quot; : ISODate(&quot;2024-01-27T02:56:44.868Z&quot;),</span><br><span class="line">  &quot;lastDurableWallTime&quot; : ISODate(&quot;2024-01-27T02:56:44.868Z&quot;)</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;lastStableRecoveryTimestamp&quot; : Timestamp(1706324154, 1),</span><br><span class="line"> &quot;electionCandidateMetrics&quot; : &#123;</span><br><span class="line">  &quot;lastElectionReason&quot; : &quot;electionTimeout&quot;,</span><br><span class="line">  &quot;lastElectionDate&quot; : ISODate(&quot;2024-01-27T02:54:04.810Z&quot;),</span><br><span class="line">  &quot;electionTerm&quot; : NumberLong(1),</span><br><span class="line">  &quot;lastCommittedOpTimeAtElection&quot; : &#123;</span><br><span class="line">   &quot;ts&quot; : Timestamp(0, 0),</span><br><span class="line">   &quot;t&quot; : NumberLong(-1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;lastSeenOpTimeAtElection&quot; : &#123;</span><br><span class="line">   &quot;ts&quot; : Timestamp(1706324044, 1),</span><br><span class="line">   &quot;t&quot; : NumberLong(-1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;numVotesNeeded&quot; : 1,</span><br><span class="line">  &quot;priorityAtElection&quot; : 1,</span><br><span class="line">  &quot;electionTimeoutMillis&quot; : NumberLong(10000),</span><br><span class="line">  &quot;newTermStartDate&quot; : ISODate(&quot;2024-01-27T02:54:04.836Z&quot;),</span><br><span class="line">  &quot;wMajorityWriteAvailabilityDate&quot; : ISODate(&quot;2024-01-27T02:54:04.860Z&quot;)</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;members&quot; : [</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;_id&quot; : 0,</span><br><span class="line">   &quot;name&quot; : &quot;localhost.localdomain:27017&quot;,</span><br><span class="line">   &quot;health&quot; : 1,</span><br><span class="line">   &quot;state&quot; : 1,</span><br><span class="line">   &quot;stateStr&quot; : &quot;PRIMARY&quot;,</span><br><span class="line">   &quot;uptime&quot; : 376,</span><br><span class="line">   &quot;optime&quot; : &#123;</span><br><span class="line">    &quot;ts&quot; : Timestamp(1706324204, 1),</span><br><span class="line">    &quot;t&quot; : NumberLong(1)</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;optimeDate&quot; : ISODate(&quot;2024-01-27T02:56:44Z&quot;),</span><br><span class="line">   &quot;lastAppliedWallTime&quot; : ISODate(&quot;2024-01-27T02:56:44.868Z&quot;),</span><br><span class="line">   &quot;lastDurableWallTime&quot; : ISODate(&quot;2024-01-27T02:56:44.868Z&quot;),</span><br><span class="line">   &quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">   &quot;syncSourceId&quot; : -1,</span><br><span class="line">   &quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">   &quot;electionTime&quot; : Timestamp(1706324044, 2),</span><br><span class="line">   &quot;electionDate&quot; : ISODate(&quot;2024-01-27T02:54:04Z&quot;),</span><br><span class="line">   &quot;configVersion&quot; : 1,</span><br><span class="line">   &quot;configTerm&quot; : 1,</span><br><span class="line">   &quot;self&quot; : true,</span><br><span class="line">   &quot;lastHeartbeatMessage&quot; : &quot;&quot;</span><br><span class="line">  &#125;</span><br><span class="line"> ],</span><br><span class="line"> &quot;ok&quot; : 1,</span><br><span class="line"> &quot;$clusterTime&quot; : &#123;</span><br><span class="line">  &quot;clusterTime&quot; : Timestamp(1706324204, 1),</span><br><span class="line">  &quot;signature&quot; : &#123;</span><br><span class="line">   &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">   &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;operationTime&quot; : Timestamp(1706324204, 1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="说明-6"><a href="#说明-6" class="headerlink" title="说明"></a>说明</h4><ul>
<li>1 ）”set” : “myrs”：副本集的名字</li>
<li>2 ）”myState”: 1：说明状态正常</li>
<li>3 ）”members”：副本集成员数组，此时只有一个：”name” : “ 180. 76. 159. 126 : 27017 “，该成员的角色是”stateStr” : “PRIMARY”<br>,该节点是健康的：”health” : 1 。</li>
</ul>
<h3 id="1-4-8-第四步：添加副本从节点"><a href="#1-4-8-第四步：添加副本从节点" class="headerlink" title="1.4.8 第四步：添加副本从节点"></a>1.4.8 第四步：添加副本从节点</h3><h4 id="在主节点添加从节点，将其他成员加入到副本集"><a href="#在主节点添加从节点，将其他成员加入到副本集" class="headerlink" title="在主节点添加从节点，将其他成员加入到副本集"></a>在主节点添加从节点，将其他成员加入到副本集</h4><h4 id="语法-9"><a href="#语法-9" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.add(host, arbiterOnly)</span><br></pre></td></tr></table></figure>
<h4 id="选项-1"><a href="#选项-1" class="headerlink" title="选项"></a>选项</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">host</td>
<td style="text-align:center">string or document</td>
<td style="text-align:center">要添加到副本集的新成员。 指定为字符串或配置文档：1）如果是一个字符串，则需要指定新成员的主机名和可选的端口号；2）如果是一个文档，请指定在members数组中找到的副本集成员配置文档。 您必须在成员配置文档中指定主机字段。有关文档配置字段的说明，详见下方文档：“主机成员的配置文档”</td>
</tr>
<tr>
<td style="text-align:center">arbiterOnly</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">可选的。 仅在 <host> 值为字符串时适用。 如果为true，则添加的主机是仲裁者。</td>
</tr>
</tbody>
</table>
</div>
<h4 id="主机成员的配置文档"><a href="#主机成员的配置文档" class="headerlink" title="主机成员的配置文档"></a>主机成员的配置文档</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  _id: &lt;int&gt;,</span><br><span class="line">  host: &lt;string&gt;, // required</span><br><span class="line">  arbiterOnly: &lt;boolean&gt;,</span><br><span class="line">  buildIndexes: &lt;boolean&gt;,</span><br><span class="line">  hidden: &lt;boolean&gt;,</span><br><span class="line">  priority: &lt;number&gt;,</span><br><span class="line">  tags: &lt;document&gt;,</span><br><span class="line">  slaveDelay: &lt;int&gt;,</span><br><span class="line">  votes: &lt;number&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="【示例】-14"><a href="#【示例】-14" class="headerlink" title="【示例】"></a>【示例】</h4><h4 id="将-27018-的副本节点添加到副本集中"><a href="#将-27018-的副本节点添加到副本集中" class="headerlink" title="将 27018 的副本节点添加到副本集中"></a>将 27018 的副本节点添加到副本集中</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.add(&quot;180.76.159.126:27018&quot;)</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ok&quot; : 1,</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1565761757, 1),</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1565761757, 1),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="说明-7"><a href="#说明-7" class="headerlink" title="说明"></a>说明</h4><ul>
<li>1 ）”ok” : 1 ：说明添加成功。</li>
</ul>
<h4 id="查看副本集状态"><a href="#查看副本集状态" class="headerlink" title="查看副本集状态"></a>查看副本集状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line"> &quot;set&quot;: &quot;myrs&quot;,</span><br><span class="line"> &quot;date&quot;: ISODate(&quot;2019-08-14T05:50:05.738Z&quot;),</span><br><span class="line"> &quot;myState&quot;: 1,</span><br><span class="line"> &quot;term&quot;: NumberLong(1),</span><br><span class="line"> &quot;syncingTo&quot;: &quot;&quot;,</span><br><span class="line"> &quot;syncSourceHost&quot;: &quot;&quot;,</span><br><span class="line"> &quot;syncSourceId&quot;: -1,</span><br><span class="line"> &quot;heartbeatIntervalMillis&quot;: NumberLong(2000),</span><br><span class="line"> &quot;optimes&quot;: &#123;</span><br><span class="line">  &quot;lastCommittedOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1565761798, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;readConcernMajorityOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1565761798, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;appliedOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1565761798, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;durableOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1565761798, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;lastStableCheckpointTimestamp&quot;: Timestamp(1565761798, 1),</span><br><span class="line"> &quot;members&quot;: [&#123;</span><br><span class="line">   &quot;_id&quot;: 0,</span><br><span class="line">   &quot;name&quot;: &quot;180.76.159.126:27017&quot;,</span><br><span class="line">   &quot;health&quot;: 1,</span><br><span class="line">   &quot;state&quot;: 1,</span><br><span class="line">   &quot;stateStr&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">   说明： &quot;uptime&quot;: 1639,</span><br><span class="line">   &quot;optime&quot;: &#123;</span><br><span class="line">    &quot;ts&quot;: Timestamp(1565761798, 1),</span><br><span class="line">    &quot;t&quot;: NumberLong(1)</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;optimeDate&quot;: ISODate(&quot;2019-08-14T05:49:58Z&quot;),</span><br><span class="line">   &quot;syncingTo&quot;: &quot;&quot;,</span><br><span class="line">   &quot;syncSourceHost&quot;: &quot;&quot;,</span><br><span class="line">   &quot;syncSourceId&quot;: -1,</span><br><span class="line">   &quot;infoMessage&quot;: &quot;&quot;,</span><br><span class="line">   &quot;electionTime&quot;: Timestamp(1565760476, 2),</span><br><span class="line">   &quot;electionDate&quot;: ISODate(&quot;2019-08-14T05:27:56Z&quot;),</span><br><span class="line">   &quot;configVersion&quot;: 2,</span><br><span class="line">   &quot;self&quot;: true,</span><br><span class="line">   &quot;lastHeartbeatMessage&quot;: &quot;&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;_id&quot;: 1,</span><br><span class="line">   &quot;name&quot;: &quot;180.76.159.126:27018&quot;,</span><br><span class="line">   &quot;health&quot;: 1,</span><br><span class="line">   &quot;state&quot;: 2,</span><br><span class="line">   &quot;stateStr&quot;: &quot;SECONDARY&quot;,</span><br><span class="line">   &quot;uptime&quot;: 48,</span><br><span class="line">   &quot;optime&quot;: &#123;</span><br><span class="line">    &quot;ts&quot;: Timestamp(1565761798, 1),</span><br><span class="line">    &quot;t&quot;: NumberLong(1)</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;optimeDurable&quot;: &#123;</span><br><span class="line">    &quot;ts&quot;: Timestamp(1565761798, 1),</span><br><span class="line">    &quot;t&quot;: NumberLong(1)</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;optimeDate&quot;: ISODate(&quot;2019-08-14T05:49:58Z&quot;),</span><br><span class="line">   &quot;optimeDurableDate&quot;: ISODate(&quot;2019-08-14T05:49:58Z&quot;),</span><br><span class="line">   &quot;lastHeartbeat&quot;: ISODate(&quot;2019-08-14T05:50:05.294Z&quot;),</span><br><span class="line">   &quot;lastHeartbeatRecv&quot;: ISODate(&quot;2019-08-</span><br><span class="line">    14 T05: 50: 05.476 Z &quot;),</span><br><span class="line">    &quot;pingMs&quot;: NumberLong(0),</span><br><span class="line">    &quot;lastHeartbeatMessage&quot;: &quot;&quot;,</span><br><span class="line">    &quot;syncingTo&quot;: &quot;180.76.159.126:27017&quot;,</span><br><span class="line">    &quot;syncSourceHost&quot;: &quot;180.76.159.126:27017&quot;,</span><br><span class="line">    &quot;syncSourceId&quot;: 0,</span><br><span class="line">    &quot;infoMessage&quot;: &quot;&quot;,</span><br><span class="line">    &quot;configVersion&quot;: 2</span><br><span class="line">   &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;ok&quot;: 1,</span><br><span class="line">  &quot;operationTime&quot;: Timestamp(1565761798, 1),</span><br><span class="line">  &quot;$clusterTime&quot;: &#123;</span><br><span class="line">   &quot;clusterTime&quot;: Timestamp(1565761798, 1),</span><br><span class="line">   &quot;signature&quot;: &#123;</span><br><span class="line">    &quot;hash&quot;: BinData(0, &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">    &quot;keyId&quot;: NumberLong(0)</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>1 ）”name” : “ 180. 76. 159. 126 : 27018 “是第二个节点的名字，其角色是”stateStr” :”SECONDARY”</li>
</ul>
<h3 id="1-4-9-第五步：添加仲裁从节点"><a href="#1-4-9-第五步：添加仲裁从节点" class="headerlink" title="1.4.9 第五步：添加仲裁从节点"></a>1.4.9 第五步：添加仲裁从节点</h3><h4 id="添加一个仲裁节点到副本集"><a href="#添加一个仲裁节点到副本集" class="headerlink" title="添加一个仲裁节点到副本集"></a>添加一个仲裁节点到副本集</h4><h4 id="语法-10"><a href="#语法-10" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.addArb(host)</span><br></pre></td></tr></table></figure>
<h4 id="将-27019-的仲裁节点添加到副本集中"><a href="#将-27019-的仲裁节点添加到副本集中" class="headerlink" title="将 27019 的仲裁节点添加到副本集中"></a>将 27019 的仲裁节点添加到副本集中</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.addArb(&quot;180.76.159.126:27019&quot;)</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ok&quot; : 1,</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1565761959, 1),</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1565761959, 1),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="说明-8"><a href="#说明-8" class="headerlink" title="说明"></a>说明</h4><ul>
<li>1 ）”ok” : 1 ：说明添加成功。</li>
</ul>
<h4 id="查看副本集状态-1"><a href="#查看副本集状态-1" class="headerlink" title="查看副本集状态"></a>查看副本集状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line"> &quot;set&quot;: &quot;myrs&quot;,</span><br><span class="line"> &quot;date&quot;: ISODate(&quot;2019-08-14T05:53:27.198Z&quot;),</span><br><span class="line"> &quot;myState&quot;: 1,</span><br><span class="line"> &quot;term&quot;: NumberLong(1),</span><br><span class="line"> &quot;syncingTo&quot;: &quot;&quot;,</span><br><span class="line"> &quot;syncSourceHost&quot;: &quot;&quot;,</span><br><span class="line"> &quot;syncSourceId&quot;: -1,</span><br><span class="line"> &quot;heartbeatIntervalMillis&quot;: NumberLong(2000),</span><br><span class="line"> &quot;optimes&quot;: &#123;</span><br><span class="line">  &quot;lastCommittedOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1565761998, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;readConcernMajorityOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1565761998, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;appliedOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1565761998, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;durableOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1565761998, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;lastStableCheckpointTimestamp&quot;: Timestamp(1565761978, 1),</span><br><span class="line"> &quot;members&quot;: [&#123;</span><br><span class="line">    &quot;_id&quot;: 0,</span><br><span class="line">    &quot;name&quot;: &quot;180.76.159.126:27017&quot;,</span><br><span class="line">    &quot;health&quot;: 1,</span><br><span class="line">    &quot;state&quot;: 1,</span><br><span class="line">    &quot;stateStr&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">    &quot;uptime&quot;: 1841,</span><br><span class="line">    &quot;optime&quot;: &#123;</span><br><span class="line">     &quot;ts&quot;: Timestamp(1565761998, 1),</span><br><span class="line">     &quot;t&quot;: NumberLong(1)</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;optimeDate&quot;: ISODate(&quot;2019-08-14T05:53:18Z&quot;),</span><br><span class="line">    &quot;syncingTo&quot;: &quot;&quot;,</span><br><span class="line">    &quot;syncSourceHost&quot;: &quot;&quot;,</span><br><span class="line">    &quot;syncSourceId&quot;: -1,</span><br><span class="line">    &quot;infoMessage&quot;: &quot;&quot;,</span><br><span class="line">    &quot;electionTime&quot;: Timestamp(1565760476, 2),</span><br><span class="line">    &quot;electionDate&quot;: ISODate(&quot;2019-08-14T05:27:56Z&quot;),</span><br><span class="line">    &quot;configVersion&quot;: 3,</span><br><span class="line">    &quot;self&quot;: true,</span><br><span class="line">    &quot;lastHeartbeatMessage&quot;: &quot;&quot;</span><br><span class="line">   &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">    &quot;_id&quot;: 1,</span><br><span class="line">    &quot;name&quot;: &quot;180.76.159.126:27018&quot;,</span><br><span class="line">    &quot;health&quot;: 1,</span><br><span class="line">    &quot;state&quot;: 2,</span><br><span class="line">    &quot;stateStr&quot;: &quot;SECONDARY&quot;,</span><br><span class="line">    &quot;uptime&quot;: 249,</span><br><span class="line">    &quot;optime&quot;: &#123;</span><br><span class="line">     &quot;ts&quot;: Timestamp(1565761998, 1),</span><br><span class="line">     &quot;t&quot;: NumberLong(1)</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;optimeDurable&quot;: &#123;</span><br><span class="line">     &quot;ts&quot;: Timestamp(1565761998, 1),</span><br><span class="line">     &quot;t&quot;: NumberLong(1)</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;optimeDate&quot;: ISODate(&quot;2019-08-14T05:53:18Z&quot;),</span><br><span class="line">    &quot;optimeDurableDate&quot;: ISODate(&quot;2019-08-14T05:53:18Z&quot;),</span><br><span class="line">    &quot;lastHeartbeat&quot;: ISODate(&quot;2019-08-14T05:53:25.668Z&quot;),</span><br><span class="line">    &quot;lastHeartbeatRecv&quot;: ISODate(&quot;2019-08-</span><br><span class="line">     14 T05: 53: 26.702 Z &quot;),</span><br><span class="line">     &quot;pingMs&quot;: NumberLong(0),</span><br><span class="line">     &quot;lastHeartbeatMessage&quot;: &quot;&quot;,</span><br><span class="line">     &quot;syncingTo&quot;: &quot;180.76.159.126:27017&quot;,</span><br><span class="line">     &quot;syncSourceHost&quot;: &quot;180.76.159.126:27017&quot;,</span><br><span class="line">     &quot;syncSourceId&quot;: 0,</span><br><span class="line">     &quot;infoMessage&quot;: &quot;&quot;,</span><br><span class="line">     &quot;configVersion&quot;: 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">     &quot;_id&quot;: 2,</span><br><span class="line">     &quot;name&quot;: &quot;180.76.159.126:27019&quot;,</span><br><span class="line">     &quot;health&quot;: 1,</span><br><span class="line">     &quot;state&quot;: 7,</span><br><span class="line">     &quot;stateStr&quot;: &quot;ARBITER&quot;,</span><br><span class="line">     &quot;uptime&quot;: 47,</span><br><span class="line">     &quot;lastHeartbeat&quot;: ISODate(&quot;2019-08-14T05:53:25.668Z&quot;),</span><br><span class="line">     &quot;lastHeartbeatRecv&quot;: ISODate(&quot;2019-08-</span><br><span class="line">      14 T05: 53: 25.685 Z &quot;),</span><br><span class="line">      &quot;pingMs&quot;: NumberLong(0),</span><br><span class="line">      &quot;lastHeartbeatMessage&quot;: &quot;&quot;,</span><br><span class="line">      &quot;syncingTo&quot;: &quot;&quot;,</span><br><span class="line">      &quot;syncSourceHost&quot;: &quot;&quot;,</span><br><span class="line">      &quot;syncSourceId&quot;: -1,</span><br><span class="line">      &quot;infoMessage&quot;: &quot;&quot;,</span><br><span class="line">      &quot;configVersion&quot;: 3</span><br><span class="line">     &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ok&quot;: 1,</span><br><span class="line">    &quot;operationTime&quot;: Timestamp(1565761998, 1),</span><br><span class="line">    &quot;$clusterTime&quot;: &#123;</span><br><span class="line">     &quot;clusterTime&quot;: Timestamp(1565761998, 1),</span><br><span class="line">     &quot;signature&quot;: &#123;</span><br><span class="line">      &quot;hash&quot;: BinData(0, &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot;: NumberLong(0)</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;  </span><br></pre></td></tr></table></figure>
<h4 id="说明-9"><a href="#说明-9" class="headerlink" title="说明"></a>说明</h4><ul>
<li>1 ）”name” : “ 180. 76. 159. 126 : 27019 “是第二个节点的名字，其角色是”stateStr”^ :^ “ARBITER”</li>
</ul>
<h2 id="1-5-副本集的数据读写操作"><a href="#1-5-副本集的数据读写操作" class="headerlink" title="1.5 副本集的数据读写操作"></a>1.5 副本集的数据读写操作</h2><h4 id="目标：测试三个不同角色的节点的数据读写情况"><a href="#目标：测试三个不同角色的节点的数据读写情况" class="headerlink" title="目标：测试三个不同角色的节点的数据读写情况"></a>目标：测试三个不同角色的节点的数据读写情况</h4><h4 id="登录主节点-27017-，写入和读取数据"><a href="#登录主节点-27017-，写入和读取数据" class="headerlink" title="登录主节点 27017 ，写入和读取数据"></a>登录主节点 27017 ，写入和读取数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port</span><br><span class="line">27017</span><br><span class="line"></span><br><span class="line">myrs:PRIMARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">myrs:PRIMARY&gt; db</span><br><span class="line">articledb</span><br><span class="line">myrs:PRIMARY&gt; db.comment.insert(&#123;&quot;articleid&quot;:&quot;100000&quot;,&quot;content&quot;:&quot;今天天气真好，阳光明媚&quot;,&quot;userid&quot;:&quot;1001&quot;,&quot;nickname&quot;:&quot;Rose&quot;,&quot;createdatetime&quot;:new Date()&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line"></span><br><span class="line">myrs:PRIMARY&gt; db.comment.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d4d2ae3068138b4570f53bf&quot;), &quot;articleid&quot; : &quot;100000&quot;,</span><br><span class="line">&quot;content&quot; : &quot;今天天气真好，阳光明媚&quot;, &quot;userid&quot; : &quot;1001&quot;, &quot;nickname&quot; : &quot;Rose&quot;,</span><br><span class="line">&quot;createdatetime&quot; : ISODate(&quot;2019-08-09T08:12:19.427Z&quot;) &#125;</span><br></pre></td></tr></table></figure>
<h4 id="登录从节点-27018"><a href="#登录从节点-27018" class="headerlink" title="登录从节点 27018"></a>登录从节点 27018</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port</span><br><span class="line">27018</span><br><span class="line">myrs:SECONDARY&gt; show dbs;</span><br><span class="line">2019-09-10T10:56:51.953+0800 E QUERY [js] Error: listDatabases failed:&#123;</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1568084204, 1),</span><br><span class="line">  &quot;ok&quot; : 0,</span><br><span class="line">  &quot;errmsg&quot; : &quot;not master and slaveOk=false&quot;,</span><br><span class="line">  &quot;code&quot; : 13435,</span><br><span class="line">  &quot;codeName&quot; : &quot;NotMasterNoSlaveOk&quot;,</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1568084204, 1),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; :</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">Mongo.prototype.getDBs@src/mongo/shell/mongo.js:139:1</span><br><span class="line">shellHelper.show@src/mongo/shell/utils.js:882:13</span><br><span class="line">shellHelper@src/mongo/shell/utils.js:766:15</span><br><span class="line">@(shellhelp2):1:1</span><br></pre></td></tr></table></figure>
<h4 id="发现，不能读取集合的数据。当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行"><a href="#发现，不能读取集合的数据。当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行" class="headerlink" title="发现，不能读取集合的数据。当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行"></a>发现，不能读取集合的数据。当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行</h4><h4 id="因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置"><a href="#因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置" class="headerlink" title="因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置"></a>因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置</h4><h4 id="设置读操作权限"><a href="#设置读操作权限" class="headerlink" title="设置读操作权限"></a>设置读操作权限</h4><h4 id="说明-10"><a href="#说明-10" class="headerlink" title="说明"></a>说明</h4><h4 id="设置为奴隶节点，允许在从成员上运行读的操作"><a href="#设置为奴隶节点，允许在从成员上运行读的操作" class="headerlink" title="设置为奴隶节点，允许在从成员上运行读的操作"></a>设置为奴隶节点，允许在从成员上运行读的操作</h4><h4 id="语法-11"><a href="#语法-11" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rs.slaveOk()</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">或</span></span><br><span class="line">rs.slaveOk(true)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="提示-11"><a href="#提示-11" class="headerlink" title="提示"></a>提示</h4><h4 id="该命令是db-getMongo-setSlaveOk-的简化命令"><a href="#该命令是db-getMongo-setSlaveOk-的简化命令" class="headerlink" title="该命令是db.getMongo().setSlaveOk()的简化命令"></a>该命令是db.getMongo().setSlaveOk()的简化命令</h4><h4 id="【示例】-15"><a href="#【示例】-15" class="headerlink" title="【示例】"></a>【示例】</h4><h4 id="在-27018-上设置作为奴隶节点权限，具备读权限"><a href="#在-27018-上设置作为奴隶节点权限，具备读权限" class="headerlink" title="在 27018 上设置作为奴隶节点权限，具备读权限"></a>在 27018 上设置作为奴隶节点权限，具备读权限</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs:SECONDARY&gt; rs.slaveOk()</span><br></pre></td></tr></table></figure>
<h4 id="此时，在执行查询命令，运行成功"><a href="#此时，在执行查询命令，运行成功" class="headerlink" title="此时，在执行查询命令，运行成功"></a>此时，在执行查询命令，运行成功</h4><h4 id="但仍然不允许插入"><a href="#但仍然不允许插入" class="headerlink" title="但仍然不允许插入"></a>但仍然不允许插入</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">myrs:SECONDARY&gt; rs.slaveOk()</span><br><span class="line">myrs:SECONDARY&gt; show dbs;</span><br><span class="line">admin 0.000GB</span><br><span class="line">articledb 0.000GB</span><br><span class="line">config 0.000GB</span><br><span class="line">local 0.000GB</span><br><span class="line">myrs:SECONDARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">myrs:SECONDARY&gt; show collections</span><br><span class="line">comment</span><br><span class="line">myrs:SECONDARY&gt; db.comment.find()</span><br><span class="line">&#123; </span><br><span class="line">  &quot;_id&quot; : ObjectId(&quot;5d7710c04cfd7eee2e3cdabe&quot;), &quot;articleid&quot; : &quot;100000&quot;,</span><br><span class="line">  &quot;content&quot; : &quot;今天天气真好，阳光明媚&quot;, &quot;userid&quot; : &quot;1001&quot;, &quot;nickname&quot; : &quot;Rose&quot;,</span><br><span class="line">  &quot;createdatetime&quot; : ISODate(&quot;2019-09-10T02:56:00.467Z&quot;) &#125;</span><br><span class="line">  myrs:SECONDARY&gt; db.comment.insert(&#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，k一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(1000),&quot;state&quot;:&quot;1&quot;&#125;)</span><br><span class="line">  WriteCommandError(&#123;</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1568084434, 1),</span><br><span class="line">  &quot;ok&quot; : 0,</span><br><span class="line">  &quot;errmsg&quot; : &quot;not master&quot;,</span><br><span class="line">  &quot;code&quot; : 10107,</span><br><span class="line">  &quot;codeName&quot; : &quot;NotMaster&quot;,</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1568084434, 1),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="现在可实现了读写分离，让主插入数据，让从来读取数据"><a href="#现在可实现了读写分离，让主插入数据，让从来读取数据" class="headerlink" title="现在可实现了读写分离，让主插入数据，让从来读取数据"></a>现在可实现了读写分离，让主插入数据，让从来读取数据</h4><h4 id="如果要取消作为奴隶节点的读权限"><a href="#如果要取消作为奴隶节点的读权限" class="headerlink" title="如果要取消作为奴隶节点的读权限"></a>如果要取消作为奴隶节点的读权限</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">myrs:SECONDARY&gt; rs.slaveOk(false)</span><br><span class="line">myrs:SECONDARY&gt; db.comment.find()</span><br><span class="line">Error: error: &#123;</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1568084459, 1),</span><br><span class="line">  &quot;ok&quot; : 0,</span><br><span class="line">  &quot;errmsg&quot; : &quot;not master and slaveOk=false&quot;,</span><br><span class="line">  &quot;code&quot; : 13435,</span><br><span class="line">  &quot;codeName&quot; : &quot;NotMasterNoSlaveOk&quot;,</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1568084459, 1),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="仲裁者节点，不存放任何业务数据的，可以登录查看"><a href="#仲裁者节点，不存放任何业务数据的，可以登录查看" class="headerlink" title="仲裁者节点，不存放任何业务数据的，可以登录查看"></a>仲裁者节点，不存放任何业务数据的，可以登录查看</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port</span><br><span class="line">27019</span><br><span class="line"></span><br><span class="line">myrs:ARBITER&gt; rs.slaveOk()</span><br><span class="line">myrs:ARBITER&gt; show dbs</span><br><span class="line">local 0.000GB</span><br><span class="line">myrs:ARBITER&gt; use local</span><br><span class="line">switched to db local</span><br><span class="line">myrs:ARBITER&gt; show collections</span><br><span class="line">replset.minvalid</span><br><span class="line">replset.oplogTruncateAfterPoint</span><br><span class="line">startup_log</span><br><span class="line">system.replset</span><br><span class="line">system.rollback.id</span><br><span class="line">myrs:ARBITER&gt;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<h4 id="发现，只存放副本集配置等数据"><a href="#发现，只存放副本集配置等数据" class="headerlink" title="发现，只存放副本集配置等数据"></a><code>发现，只存放副本集配置等数据</code></h4><h2 id="1-6-主节点的选举原则"><a href="#1-6-主节点的选举原则" class="headerlink" title="1.6 主节点的选举原则"></a>1.6 主节点的选举原则</h2><h4 id="MongoDB在副本集中，会自动进行主节点的选举，主节点选举的触发条件"><a href="#MongoDB在副本集中，会自动进行主节点的选举，主节点选举的触发条件" class="headerlink" title="MongoDB在副本集中，会自动进行主节点的选举，主节点选举的触发条件"></a>MongoDB在副本集中，会自动进行主节点的选举，主节点选举的触发条件</h4><ul>
<li>1 ） 主节点故障</li>
<li>2 ） 主节点网络不可达（默认心跳信息为 10 秒）</li>
<li>3 ） 人工干预（rs.stepDown(600)）</li>
</ul>
<h4 id="一旦触发选举，就要根据一定规则来选主节点"><a href="#一旦触发选举，就要根据一定规则来选主节点" class="headerlink" title="一旦触发选举，就要根据一定规则来选主节点"></a>一旦触发选举，就要根据一定规则来选主节点</h4><h4 id="选举规则是根据票数来决定谁获胜"><a href="#选举规则是根据票数来决定谁获胜" class="headerlink" title="选举规则是根据票数来决定谁获胜"></a>选举规则是根据票数来决定谁获胜</h4><ul>
<li>票数最高，且获得了“大多数”成员的投票支持的节点获胜。“大多数”的定义为：假设复制集内投票成员数量为N，则大多数为 N/2 + 1。例如：<br>3 个投票成员，则大多数的值是 2 。当复制集内存活成员数量不足大多数时，整个复制集将无法选举出Primary，复制集将无法提供写服务，处于只读状态。</li>
<li>若票数相同，且都获得了“大多数”成员的投票支持的，数据新的节点获胜。数据的新旧是通过操作日志oplog来对比的。</li>
</ul>
<h4 id="在获得票数的时候，优先级（priority）参数影响重大"><a href="#在获得票数的时候，优先级（priority）参数影响重大" class="headerlink" title="在获得票数的时候，优先级（priority）参数影响重大"></a>在获得票数的时候，优先级（priority）参数影响重大</h4><blockquote>
<p>可以通过设置优先级（priority）来设置额外票数。优先级即权重，取值为0-1000，相当于可额外增加0-1000的票数，<br>优先级的值越大，就越可能获得多数成员的投票（votes）数。指定较高的值可使成员更有资格成为主要成员，更低的值可使成员更不符合条件。</p>
</blockquote>
<h4 id="默认情况下，优先级的值是-1"><a href="#默认情况下，优先级的值是-1" class="headerlink" title="默认情况下，优先级的值是 1"></a>默认情况下，优先级的值是 1</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt;rs.conf()</span><br><span class="line">&#123;</span><br><span class="line"> &quot;_id&quot;: &quot;myrs&quot;,</span><br><span class="line"> &quot;version&quot;: 3,</span><br><span class="line"> &quot;protocolVersion&quot;: NumberLong(1),</span><br><span class="line"> &quot;writeConcernMajorityJournalDefault&quot;: true,</span><br><span class="line"> &quot;members&quot;: [&#123;</span><br><span class="line">   &quot;_id&quot;: 0,</span><br><span class="line">   &quot;host&quot;: &quot;180.76.159.126:27017&quot;,</span><br><span class="line">   &quot;arbiterOnly&quot;: false,</span><br><span class="line">   &quot;buildIndexes&quot;: true,</span><br><span class="line">   &quot;hidden&quot;: false,</span><br><span class="line">   &quot;priority&quot;: 1,</span><br><span class="line">   &quot;tags&quot;: &#123;&#125;,</span><br><span class="line">   &quot;slaveDelay&quot;: NumberLong(0),</span><br><span class="line">   &quot;votes&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;_id&quot;: 1,</span><br><span class="line">   &quot;host&quot;: &quot;180.76.159.126:27018&quot;,</span><br><span class="line">   &quot;arbiterOnly&quot;: false,</span><br><span class="line">   &quot;buildIndexes&quot;: true,</span><br><span class="line">   &quot;hidden&quot;: false,</span><br><span class="line">   &quot;priority&quot;: 1,</span><br><span class="line">   &quot;tags&quot;: &#123;&#125;,</span><br><span class="line">   &quot;slaveDelay&quot;: NumberLong(0),</span><br><span class="line">   &quot;votes&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;_id&quot;: 2,</span><br><span class="line">   &quot;host&quot;: &quot;180.76.159.126:27019&quot;,</span><br><span class="line">   &quot;arbiterOnly&quot;: true,</span><br><span class="line">   &quot;buildIndexes&quot;: true,</span><br><span class="line">   &quot;hidden&quot;: false,</span><br><span class="line">   &quot;priority&quot;: 0,</span><br><span class="line">   &quot;tags&quot;: &#123;&#125;,</span><br><span class="line">   &quot;slaveDelay&quot;: NumberLong(0),</span><br><span class="line">   &quot;votes&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line"> ],</span><br><span class="line"> &quot;settings&quot;: &#123;</span><br><span class="line">  &quot;chainingAllowed&quot;: true,</span><br><span class="line">  &quot;heartbeatIntervalMillis&quot;: 2000,</span><br><span class="line">  &quot;heartbeatTimeoutSecs&quot;: 10,</span><br><span class="line">  &quot;electionTimeoutMillis&quot;: 10000,</span><br><span class="line">  &quot;catchUpTimeoutMillis&quot;: -1,</span><br><span class="line">  &quot;catchUpTakeoverDelayMillis&quot;: 30000,</span><br><span class="line">  &quot;getLastErrorModes&quot;: &#123;&#125;,</span><br><span class="line">  &quot;getLastErrorDefaults&quot;: &#123;</span><br><span class="line">   &quot;w&quot;: 1,</span><br><span class="line">   &quot;wtimeout&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;replicaSetId&quot;: ObjectId(&quot;5d539bdcd6a308e600d126bb&quot;)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看出，主节点和副本节点的优先级各为 1 ，即，默认可以认为都已经有了一票。但选举节点，优先级是 0 ，（要注意是，官方说了，选举节点的优先级必须是<br>0 ，不能是别的值。即不具备选举权，但具有投票权）</p>
</blockquote>
<h4 id="【了解】修改优先级"><a href="#【了解】修改优先级" class="headerlink" title="【了解】修改优先级"></a>【了解】修改优先级</h4><h4 id="比如，下面提升从节点的优先级"><a href="#比如，下面提升从节点的优先级" class="headerlink" title="比如，下面提升从节点的优先级"></a>比如，下面提升从节点的优先级</h4><ul>
<li>1 ）先将配置导入cfg变量</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; cfg=rs.conf()</span><br></pre></td></tr></table></figure>
<ul>
<li>2 ）然后修改值（ID号默认从 0 开始）：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; cfg.members[1].priority=2</span><br><span class="line">2</span><br></pre></td></tr></table></figure>
<ul>
<li>3 ）重新加载配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.reconfig(cfg)</span><br><span class="line">&#123; &quot;ok&quot; : 1 &#125;</span><br></pre></td></tr></table></figure>
<h4 id="稍等片刻会重新开始选举"><a href="#稍等片刻会重新开始选举" class="headerlink" title="稍等片刻会重新开始选举"></a>稍等片刻会重新开始选举</h4><h2 id="1-7-故障测试"><a href="#1-7-故障测试" class="headerlink" title="1.7 故障测试"></a>1.7 故障测试</h2><h3 id="1-7-1-副本节点故障测试"><a href="#1-7-1-副本节点故障测试" class="headerlink" title="1.7.1 副本节点故障测试"></a>1.7.1 副本节点故障测试</h3><h4 id="关闭-27018-副本节点"><a href="#关闭-27018-副本节点" class="headerlink" title="关闭 27018 副本节点"></a>关闭 27018 副本节点</h4><blockquote>
<p>发现，主节点和仲裁节点对 27018 的心跳失败。因为主节点还在，因此，没有触发投票选举。如果此时，在主节点写入数据。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insert(&#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(1000),&quot;state&quot;:&quot;1&quot;&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="再启动从节点，会发现，主节点写入的数据，会自动同步给从节点"><a href="#再启动从节点，会发现，主节点写入的数据，会自动同步给从节点" class="headerlink" title="再启动从节点，会发现，主节点写入的数据，会自动同步给从节点"></a>再启动从节点，会发现，主节点写入的数据，会自动同步给从节点</h4><h3 id="1-7-2主节点故障测试"><a href="#1-7-2主节点故障测试" class="headerlink" title="1.7.2主节点故障测试"></a>1.7.2主节点故障测试</h3><h4 id="关闭-27017-节点"><a href="#关闭-27017-节点" class="headerlink" title="关闭 27017 节点"></a>关闭 27017 节点</h4><blockquote>
<p>发现，从节点和仲裁节点对 27017 的心跳失败，当失败超过 10 秒，此时因为没有主节点了，会自动发起投票。<br><br>而副本节点只有 27018 ，因此，候选人只有一个就是 27018 ，开始投票。<br><br>27019 向 27018 投了一票， 27018 本身自带一票，因此共两票，超过了“大多数”<br><br>27019 是仲裁节点，没有选举权， 27018 不向其投票，其票数是0.<br><br>最终结果， 27018 成为主节点。具备读写功能。<br></p>
</blockquote>
<h4 id="在-27018-写入数据查看"><a href="#在-27018-写入数据查看" class="headerlink" title="在 27018 写入数据查看"></a>在 27018 写入数据查看</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insert(&#123;&quot;_id&quot;:&quot;2&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;,&quot;userid&quot;:&quot;1005&quot;,&quot;nickname&quot;:&quot;伊人憔悴&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T23:58:51.485Z&quot;),&quot;likenum&quot;:NumberInt(888),&quot;state&quot;:&quot;1&quot;&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="再启动-27017-节点，发现-27017-变成了从节点，-27018-仍保持主节点"><a href="#再启动-27017-节点，发现-27017-变成了从节点，-27018-仍保持主节点" class="headerlink" title="再启动 27017 节点，发现 27017 变成了从节点， 27018 仍保持主节点"></a>再启动 27017 节点，发现 27017 变成了从节点， 27018 仍保持主节点</h4><h4 id="登录-27017-节点，发现是从节点了，数据自动从-27018-同步"><a href="#登录-27017-节点，发现是从节点了，数据自动从-27018-同步" class="headerlink" title="登录 27017 节点，发现是从节点了，数据自动从 27018 同步"></a>登录 27017 节点，发现是从节点了，数据自动从 27018 同步</h4><h4 id="从而实现了高可用"><a href="#从而实现了高可用" class="headerlink" title="从而实现了高可用"></a>从而实现了高可用</h4><h3 id="1-7-3-仲裁节点和主节点故障"><a href="#1-7-3-仲裁节点和主节点故障" class="headerlink" title="1.7.3 仲裁节点和主节点故障"></a>1.7.3 仲裁节点和主节点故障</h3><h4 id="先关掉仲裁节点-27019"><a href="#先关掉仲裁节点-27019" class="headerlink" title="先关掉仲裁节点 27019"></a>先关掉仲裁节点 27019</h4><h4 id="关掉现在的主节点-27018"><a href="#关掉现在的主节点-27018" class="headerlink" title="关掉现在的主节点 27018"></a>关掉现在的主节点 27018</h4><h4 id="登录-27017-后，发现，-27017-仍然是从节点，副本集中没有主节点了，导致此时，副本集是只读状态，无法写入"><a href="#登录-27017-后，发现，-27017-仍然是从节点，副本集中没有主节点了，导致此时，副本集是只读状态，无法写入" class="headerlink" title="登录 27017 后，发现， 27017 仍然是从节点，副本集中没有主节点了，导致此时，副本集是只读状态，无法写入"></a>登录 27017 后，发现， 27017 仍然是从节点，副本集中没有主节点了，导致此时，副本集是只读状态，无法写入</h4><h4 id="为啥不选举了？因为-27017-的票数，没有获得大多数，即没有大于等于-2-，它只有默认的一票（优先级是-1-）"><a href="#为啥不选举了？因为-27017-的票数，没有获得大多数，即没有大于等于-2-，它只有默认的一票（优先级是-1-）" class="headerlink" title="为啥不选举了？因为 27017 的票数，没有获得大多数，即没有大于等于 2 ，它只有默认的一票（优先级是 1 ）"></a>为啥不选举了？因为 27017 的票数，没有获得大多数，即没有大于等于 2 ，它只有默认的一票（优先级是 1 ）</h4><h4 id="如果要触发选举，随便加入一个成员即可"><a href="#如果要触发选举，随便加入一个成员即可" class="headerlink" title="如果要触发选举，随便加入一个成员即可"></a>如果要触发选举，随便加入一个成员即可</h4><ul>
<li>如果只加入 27019 仲裁节点成员，则主节点一定是 27017 ，因为没得选了，仲裁节点不参与选举，但参与投票。（不演示）</li>
<li>如果只加入 27018 节点，会发起选举。因为 27017 和 27018 都是两票，则按照谁数据新，谁当主节点。</li>
</ul>
<h3 id="1-7-4-仲裁节点和从节点故障"><a href="#1-7-4-仲裁节点和从节点故障" class="headerlink" title="1.7.4 仲裁节点和从节点故障"></a>1.7.4 仲裁节点和从节点故障</h3><h4 id="先关掉仲裁节点-27019-1"><a href="#先关掉仲裁节点-27019-1" class="headerlink" title="先关掉仲裁节点 27019"></a>先关掉仲裁节点 27019</h4><h4 id="关掉现在的副本节点-27018"><a href="#关掉现在的副本节点-27018" class="headerlink" title="关掉现在的副本节点 27018"></a>关掉现在的副本节点 27018</h4><h4 id="10-秒后，-27017-主节点自动降级为副本节点。（服务降级）"><a href="#10-秒后，-27017-主节点自动降级为副本节点。（服务降级）" class="headerlink" title="10 秒后， 27017 主节点自动降级为副本节点。（服务降级）"></a>10 秒后， 27017 主节点自动降级为副本节点。（服务降级）</h4><h4 id="副本集不可写数据了，已经故障了"><a href="#副本集不可写数据了，已经故障了" class="headerlink" title="副本集不可写数据了，已经故障了"></a>副本集不可写数据了，已经故障了</h4><h2 id="1-8-Compass连接副本集"><a href="#1-8-Compass连接副本集" class="headerlink" title="1.8 Compass连接副本集"></a>1.8 Compass连接副本集</h2><h4 id="如果使用云服务器需要修改配置中的主节点ip"><a href="#如果使用云服务器需要修改配置中的主节点ip" class="headerlink" title="如果使用云服务器需要修改配置中的主节点ip"></a>如果使用云服务器需要修改配置中的主节点ip</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var config = rs.config();</span><br><span class="line">config.members[0].host=&quot;180.76.159.126:27017&quot;;</span><br><span class="line">rs.reconfig(config)</span><br></pre></td></tr></table></figure>
<h4 id="compass连接"><a href="#compass连接" class="headerlink" title="compass连接"></a>compass连接</h4><p><img src="QQ截图20240126203405.png&quot;" alt="输入图片说明"></p>
<p><img src="QQ截图20240126203415.png&quot;" alt="输入图片说明"></p>
<h2 id="1-9-SpringDataMongoDB连接副本集"><a href="#1-9-SpringDataMongoDB连接副本集" class="headerlink" title="1.9 SpringDataMongoDB连接副本集"></a>1.9 SpringDataMongoDB连接副本集</h2><h4 id="副本集语法"><a href="#副本集语法" class="headerlink" title="副本集语法"></a>副本集语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodb://host1,host2,host3/articledb?connect=replicaSet&amp;slaveOk=true&amp;replicaSet=副本集名字</span><br></pre></td></tr></table></figure>
<h4 id="其中"><a href="#其中" class="headerlink" title="其中"></a>其中</h4><ul>
<li>slaveOk=true：开启副本节点读的功能，可实现读写分离。</li>
<li>connect=replicaSet：自动到副本集中选择读写的主机。如果slaveOK是打开的，则实现了读写分离</li>
</ul>
<h4 id="【示例】-16"><a href="#【示例】-16" class="headerlink" title="【示例】"></a>【示例】</h4><blockquote>
<p>连接 replica set 三台服务器 (端口 27017, 27018, 和27019)，直接连接第一个服务器，无论是replicaset一部分或者主服务器或者从服务器，写入操作应用在主服务器<br>并且分布查询到从服务器。</p>
</blockquote>
<h4 id="修改配置文件application-yml"><a href="#修改配置文件application-yml" class="headerlink" title="修改配置文件application.yml"></a>修改配置文件application.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#数据源配置</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="comment"># 主机地址</span></span><br><span class="line">      <span class="comment"># host: 180.76.159.126</span></span><br><span class="line">      <span class="comment"># 数据库</span></span><br><span class="line">      <span class="comment"># database: articledb</span></span><br><span class="line">      <span class="comment"># 默认端口是27017</span></span><br><span class="line">      <span class="comment"># port: 27017</span></span><br><span class="line">      <span class="comment">#也可以使用uri连接</span></span><br><span class="line">      <span class="comment">#uri: mongodb://192.168.40.134:27017/articledb</span></span><br><span class="line">      <span class="comment"># 副本集的连接字符串</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">mongodb://180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019/articledb?connect=replicaSet&amp;slaveOk=true&amp;replicaSet=myrs</span></span><br></pre></td></tr></table></figure>
<h4 id="注意-2"><a href="#注意-2" class="headerlink" title="注意"></a>注意</h4><h4 id="主机必须是副本集中所有的主机，包括主节点、副本节点、仲裁节点"><a href="#主机必须是副本集中所有的主机，包括主节点、副本节点、仲裁节点" class="headerlink" title="主机必须是副本集中所有的主机，包括主节点、副本节点、仲裁节点"></a>主机必须是副本集中所有的主机，包括主节点、副本节点、仲裁节点</h4><h4 id="SpringDataMongoDB自动实现了读写分离"><a href="#SpringDataMongoDB自动实现了读写分离" class="headerlink" title="SpringDataMongoDB自动实现了读写分离"></a>SpringDataMongoDB自动实现了读写分离</h4><h4 id="写操作时，只打开主节点连接"><a href="#写操作时，只打开主节点连接" class="headerlink" title="写操作时，只打开主节点连接"></a>写操作时，只打开主节点连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2019-09-02 12:16:27.143 INFO 13336 --- [ main]</span><br><span class="line">org.mongodb.driver.connection : Opened connection</span><br><span class="line">[connectionId&#123;localValue:4, serverValue:60&#125;] to 180.76.159.126:27017</span><br><span class="line">2019-09-02 12:16:27.376 INFO 13336 --- [ main]</span><br><span class="line">c.i.article.service.CommentServiceTest : Started CommentServiceTest in 5.249</span><br><span class="line">seconds (JVM running for 6.16)</span><br><span class="line">2019-09-02 12:16:27.610 INFO 13336 --- [ Thread-2]</span><br><span class="line">org.mongodb.driver.connection : Closed connection</span><br><span class="line">[connectionId&#123;localValue:4, serverValue:60&#125;] to 180.76.159.126:27017 because the</span><br><span class="line">pool has been closed.</span><br></pre></td></tr></table></figure>
<h4 id="读操作是，同时打开主节点和从节点连接，但使用从节点获取数据"><a href="#读操作是，同时打开主节点和从节点连接，但使用从节点获取数据" class="headerlink" title="读操作是，同时打开主节点和从节点连接，但使用从节点获取数据"></a>读操作是，同时打开主节点和从节点连接，但使用从节点获取数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">2019-09-02 12:18:20.254 INFO 4168 --- [ main]</span><br><span class="line">org.mongodb.driver.connection : Opened connection</span><br><span class="line">[connectionId&#123;localValue:4, serverValue:62&#125;] to 180.76.159.126:27017</span><br><span class="line">2019-09-02 12:18:20.504 INFO 4168 --- [ main]</span><br><span class="line">c.i.article.service.CommentServiceTest : Started CommentServiceTest in 5.111</span><br><span class="line">seconds (JVM running for 5.95)</span><br><span class="line">2019-09-02 12:18:20.694 INFO 4168 --- [ main]</span><br><span class="line">org.mongodb.driver.connection : Opened connection</span><br><span class="line">[connectionId&#123;localValue:5, serverValue:39&#125;] to 180.76.159.126:27018</span><br><span class="line">[Comment&#123;id=&#x27;5d64930fd1c1dc4ccf71eeac&#x27;, content=&#x27;今天天气真好，阳光明媚&#x27;,</span><br><span class="line">publishtime=null, userid=&#x27;1001&#x27;, nickname=&#x27;Rose&#x27;, createdatetime=2019-08-</span><br><span class="line">27T10:18:55.768, likenum=null, replynum=null, state=&#x27;null&#x27;, parentid=&#x27;null&#x27;,</span><br><span class="line">articleid=&#x27;100000&#x27;&#125;, Comment&#123;id=&#x27;1&#x27;, content=&#x27;我们不应该把清晨浪费在手机上，健康很重</span><br><span class="line">要，一杯温水幸福你我他。&#x27;, publishtime=null, userid=&#x27;1002&#x27;, nickname=&#x27;相忘于江湖&#x27;,</span><br><span class="line">createdatetime=2019-08-06T06:08:15.522, likenum=1000, replynum=null, state=&#x27;1&#x27;,</span><br><span class="line">parentid=&#x27;null&#x27;, articleid=&#x27;100001&#x27;&#125;, Comment&#123;id=&#x27;2&#x27;, content=&#x27;我夏天空腹喝凉开水，</span><br><span class="line">冬天喝温开水&#x27;, publishtime=null, userid=&#x27;1005&#x27;, nickname=&#x27;伊人憔悴&#x27;,</span><br><span class="line">createdatetime=2019-08-06T07:58:51.485, likenum=888, replynum=null, state=&#x27;1&#x27;,</span><br><span class="line">parentid=&#x27;null&#x27;, articleid=&#x27;100001&#x27;&#125;, Comment&#123;id=&#x27;5d6c93a866ecc73210d7d600&#x27;,</span><br><span class="line">content=&#x27;测试添加的数据2&#x27;, publishtime=null, userid=&#x27;1003&#x27;, nickname=&#x27;凯撒大帝&#x27;,</span><br><span class="line">createdatetime=2019-09-02T11:59:36.525, likenum=0, replynum=0, state=&#x27;1&#x27;,</span><br><span class="line">parentid=&#x27;null&#x27;, articleid=&#x27;100000&#x27;&#125;]</span><br><span class="line">2019-09-02 12:18:20.740 INFO 4168 --- [ Thread-2]</span><br><span class="line">org.mongodb.driver.connection : Closed connection</span><br><span class="line">[connectionId&#123;localValue:4, serverValue:62&#125;] to 180.76.159.126:27017 because the</span><br><span class="line">pool has been closed.</span><br><span class="line">2019-09-02 12:18:20.740 INFO 4168 --- [ Thread-2]</span><br><span class="line">org.mongodb.driver.connection : Closed connection</span><br><span class="line">[connectionId&#123;localValue:5, serverValue:39&#125;] to 180.76.159.126:27018 because the</span><br><span class="line">pool has been closed.</span><br></pre></td></tr></table></figure>
<h4 id="完整的连接字符串的参考（了解）"><a href="#完整的连接字符串的参考（了解）" class="headerlink" title="完整的连接字符串的参考（了解）"></a>完整的连接字符串的参考（了解）</h4><h4 id="MongoDB客户端连接语法"><a href="#MongoDB客户端连接语法" class="headerlink" title="MongoDB客户端连接语法"></a>MongoDB客户端连接语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]</span><br></pre></td></tr></table></figure>
<ul>
<li>mongodb:// 这是固定的格式，必须要指定。</li>
<li>username:password@ 可选项，如果设置，在连接数据库服务器之后，驱动都会尝试登陆这个数据库</li>
<li>host1 必须的指定至少一个host, host1 是这个URI唯一要填写的。它指定了要连接服务器的地址。如果要连接复制集，请指定多个主机地址。</li>
<li>portX 可选的指定端口，如果不填，默认为 27017</li>
<li>/database 如果指定username:password@，连接并验证登陆指定数据库。若不指定，默认打开test 数据库。</li>
<li>?options 是连接选项。如果不使用/database，则前面需要加上/。所有连接选项都是键值对name=value，键值对之间通过&amp;或;（分号）隔开</li>
</ul>
<h4 id="标准的连接格式包含了多个选项-options-，如下所示"><a href="#标准的连接格式包含了多个选项-options-，如下所示" class="headerlink" title="标准的连接格式包含了多个选项(options)，如下所示"></a>标准的连接格式包含了多个选项(options)，如下所示</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">选项</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">replicaSet=name</td>
<td style="text-align:center">验证replica set的名称。 Impliesconnect=replicaSet.</td>
</tr>
<tr>
<td style="text-align:center">slaveOk=true</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">safe=true</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">w=n</td>
<td style="text-align:center">驱动添加 { w : n } 到getLastError命令. 应用于safe=true。</td>
</tr>
<tr>
<td style="text-align:center">wtimeoutMS=ms</td>
<td style="text-align:center">驱动添加 { wtimeout : ms } 到 getlasterror 命令. 应用于 safe=true.</td>
</tr>
<tr>
<td style="text-align:center">fsync=true\</td>
<td style="text-align:center">false</td>
<td>true: 驱动添加 { fsync : true } 到 getlasterror 命令.应用于safe=true.false: 驱动不会添加到getLastError命令中。</td>
</tr>
<tr>
<td style="text-align:center">journal=true    \</td>
<td style="text-align:center">false</td>
<td>如果设置为 true, 同步到 journal (在提交到数据库前写入到实体中).应用于 safe=true</td>
</tr>
<tr>
<td style="text-align:center">connectTimeoutMS=ms</td>
<td style="text-align:center">可以打开连接的时间。</td>
</tr>
<tr>
<td style="text-align:center">socketTimeoutMS=ms</td>
<td style="text-align:center">发送和接受sockets的时间。</td>
</tr>
</tbody>
</table>
</div>
<h1 id="2-分片集群-Sharded-Cluster"><a href="#2-分片集群-Sharded-Cluster" class="headerlink" title="2. 分片集群-Sharded Cluster"></a>2. 分片集群-Sharded Cluster</h1><h2 id="2-1-分片概念"><a href="#2-1-分片概念" class="headerlink" title="2.1 分片概念"></a>2.1 分片概念</h2><blockquote>
<p>分片（sharding）是一种跨多台机器分布数据的方法， MongoDB使用分片来支持具有非常大的数据集和高吞吐量操作的部署。</p>
<p>换句话说：分片(sharding)是指将数据拆分，将其分散存在不同的机器上的过程。有时也用分区(partitioning)<br>来表示这个概念。将数据分散到不同的机器上，不需要功能强大的大型计算机就可以储存更多的数据，处理更多的负载。</p>
<p>具有大型数据集或高吞吐量应用程序的数据库系统可以会挑战单个服务器的容量。例如，<br>高查询率会耗尽服务器的CPU容量。工作集大小大于系统的RAM会强调磁盘驱动器的I / O容量。</p>
<p>有两种解决系统增长的方法：垂直扩展和水平扩展。</p>
<p>垂直扩展意味着增加单个服务器的容量，例如使用更强大的CPU，添加更多RAM或增加存储空间量。<br>可用技术的局限性可能会限制单个机器对于给定工作负载而言足够强大。此外，基于云的提供商基于可用的硬件配置具有硬性上限。结果，垂直缩放有实际的最大值。</p>
<p>水平扩展意味着划分系统数据集并加载多个服务器，添加其他服务器以根据需要增加容量。虽然单个机器的总体速度或容量可能不高，<br>但每台机器处理整个工作负载的子集，可能提供比单个高速大容量服务器更高的效率。扩展部署容量只需要根据需要添加额外的服务器，这可能比单个机器的高端硬件的总体成本更低。权衡是基础架构和部署维护的复杂性增加。</p>
</blockquote>
<h4 id="MongoDB支持通过分片进行水平扩展"><a href="#MongoDB支持通过分片进行水平扩展" class="headerlink" title="MongoDB支持通过分片进行水平扩展"></a>MongoDB支持通过分片进行水平扩展</h4><h2 id="2-2-分片集群包含的组件"><a href="#2-2-分片集群包含的组件" class="headerlink" title="2.2 分片集群包含的组件"></a>2.2 分片集群包含的组件</h2><h4 id="MongoDB分片群集包含以下组件"><a href="#MongoDB分片群集包含以下组件" class="headerlink" title="MongoDB分片群集包含以下组件"></a>MongoDB分片群集包含以下组件</h4><ul>
<li>分片（存储）：每个分片包含分片数据的子集。 每个分片都可以部署为副本集。</li>
<li>mongos（路由）：mongos充当查询路由器，在客户端应用程序和分片集群之间提供接口。</li>
<li>config servers（“调度”的配置）：配置服务器存储群集的元数据和配置设置。 从MongoDB 3.4开始，必须将配置服务器部署为副本集（CSRS）。</li>
</ul>
<h4 id="下图描述了分片集群中组件的交互"><a href="#下图描述了分片集群中组件的交互" class="headerlink" title="下图描述了分片集群中组件的交互"></a>下图描述了分片集群中组件的交互</h4><p><img src="QQ截图20240126215010.png&quot;" alt="输入图片说明"></p>
<h4 id="MongoDB在集合级别对数据进行分片，将集合数据分布在集群中的分片上"><a href="#MongoDB在集合级别对数据进行分片，将集合数据分布在集群中的分片上" class="headerlink" title="MongoDB在集合级别对数据进行分片，将集合数据分布在集群中的分片上"></a>MongoDB在集合级别对数据进行分片，将集合数据分布在集群中的分片上</h4><ul>
<li>27018 if mongod is a shard member；</li>
<li>27019 if mongod is a config server member</li>
</ul>
<h2 id="2-3-分片集群架构目标"><a href="#2-3-分片集群架构目标" class="headerlink" title="2.3 分片集群架构目标"></a>2.3 分片集群架构目标</h2><h4 id="两个分片节点副本集（3-3）-一个配置节点副本集（-3-）-两个路由节点（-2-），共-11-个服务节点"><a href="#两个分片节点副本集（3-3）-一个配置节点副本集（-3-）-两个路由节点（-2-），共-11-个服务节点" class="headerlink" title="两个分片节点副本集（3+3）+一个配置节点副本集（ 3 ）+两个路由节点（ 2 ），共 11 个服务节点"></a>两个分片节点副本集（3+3）+一个配置节点副本集（ 3 ）+两个路由节点（ 2 ），共 11 个服务节点</h4><p><img src="QQ截图20240126215056.png&quot;" alt="输入图片说明"></p>
<h2 id="2-4-分片（存储）节点副本集的创建"><a href="#2-4-分片（存储）节点副本集的创建" class="headerlink" title="2.4 分片（存储）节点副本集的创建"></a>2.4 分片（存储）节点副本集的创建</h2><h4 id="所有的的配置文件都直接放到sharded-cluster的相应的子目录下面，默认配置文件名字：mongod-conf"><a href="#所有的的配置文件都直接放到sharded-cluster的相应的子目录下面，默认配置文件名字：mongod-conf" class="headerlink" title="所有的的配置文件都直接放到sharded_cluster的相应的子目录下面，默认配置文件名字：mongod.conf"></a>所有的的配置文件都直接放到sharded_cluster的相应的子目录下面，默认配置文件名字：mongod.conf</h4><h3 id="2-4-1-第一套副本集"><a href="#2-4-1-第一套副本集" class="headerlink" title="2.4.1 第一套副本集"></a>2.4.1 第一套副本集</h3><h4 id="准备存放数据和日志的目录"><a href="#准备存放数据和日志的目录" class="headerlink" title="准备存放数据和日志的目录"></a>准备存放数据和日志的目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-----------myshardrs01</span></span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs01_27018/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs01_27018/data/db \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs01_27118/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs01_27118/data/db \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs01_27218/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs01_27218/data/db</span><br></pre></td></tr></table></figure>
<h4 id="新建或修改配置文件-3"><a href="#新建或修改配置文件-3" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myshardrs01-27018"><a href="#myshardrs01-27018" class="headerlink" title="myshardrs01_27018"></a>myshardrs01_27018</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/sharded_cluster/myshardrs01_27018/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/sharded_cluster/myshardrs01_27018/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIp</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27018</span><br><span class="line">replication:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">副本集的名称</span></span><br><span class="line">  replSetName: myshardrs01</span><br><span class="line">sharding:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">分片角色</span></span><br><span class="line">  clusterRole: shardsvr</span><br></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Value</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">configsvr</td>
<td style="text-align:center">Start this instance as a config server. The instance starts on port 27019 by default.</td>
</tr>
<tr>
<td style="text-align:center">shardsvr</td>
<td style="text-align:center">Start this instance as a shard. The instance starts on port 27018 by default.</td>
</tr>
</tbody>
</table>
</div>
<h4 id="注意-3"><a href="#注意-3" class="headerlink" title="注意"></a>注意</h4><h4 id="设置sharding-clusterRole需要mongod实例运行复制。-要将实例部署为副本集成员，请使用replSetName设置并指定副本集的名称"><a href="#设置sharding-clusterRole需要mongod实例运行复制。-要将实例部署为副本集成员，请使用replSetName设置并指定副本集的名称" class="headerlink" title="设置sharding.clusterRole需要mongod实例运行复制。 要将实例部署为副本集成员，请使用replSetName设置并指定副本集的名称"></a>设置sharding.clusterRole需要mongod实例运行复制。 要将实例部署为副本集成员，请使用replSetName设置并指定副本集的名称</h4><h4 id="新建或修改配置文件-4"><a href="#新建或修改配置文件-4" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myshardrs01-27118"><a href="#myshardrs01-27118" class="headerlink" title="myshardrs01_27118"></a>myshardrs01_27118</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/sharded_cluster/myshardrs01_27118/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/sharded_cluster/myshardrs01_27118/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27118</span><br><span class="line">replication:</span><br><span class="line">  replSetName: myshardrs01</span><br><span class="line">sharding:</span><br><span class="line">  clusterRole: shardsvr</span><br></pre></td></tr></table></figure>
<h4 id="新建或修改配置文件-5"><a href="#新建或修改配置文件-5" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myshardrs01-27218"><a href="#myshardrs01-27218" class="headerlink" title="myshardrs01_27218"></a>myshardrs01_27218</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/sharded_cluster/myshardrs01_27218/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/sharded_cluster/myshardrs01_27218/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27218</span><br><span class="line">replication:</span><br><span class="line">  replSetName: myshardrs01</span><br><span class="line">sharding:</span><br><span class="line">  clusterRole: shardsvr</span><br></pre></td></tr></table></figure>
<h4 id="启动第一套副本集：一主一副本一仲裁"><a href="#启动第一套副本集：一主一副本一仲裁" class="headerlink" title="启动第一套副本集：一主一副本一仲裁"></a>启动第一套副本集：一主一副本一仲裁</h4><h4 id="依次启动三个mongod服务"><a href="#依次启动三个mongod服务" class="headerlink" title="依次启动三个mongod服务"></a>依次启动三个mongod服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123223</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123292</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123326</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>
<h4 id="查看服务是否启动"><a href="#查看服务是否启动" class="headerlink" title="查看服务是否启动"></a>查看服务是否启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# ps -ef |grep mongod</span><br><span class="line">polkitd 61622 61604 0 7月31 ? 00:04:29 mongod --bind_ip_all</span><br><span class="line">root 123223 1 1 01:10 ? 00:00:01 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</span><br><span class="line">root 123292 1 4 01:11 ? 00:00:00 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</span><br><span class="line">root 123326 1 6 01:11 ? 00:00:00 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 1 ）初始化副本集和创建主节点：</li>
</ul>
<h4 id="使用客户端命令连接任意一个节点，但这里尽量要连接主节点"><a href="#使用客户端命令连接任意一个节点，但这里尽量要连接主节点" class="headerlink" title="使用客户端命令连接任意一个节点，但这里尽量要连接主节点"></a>使用客户端命令连接任意一个节点，但这里尽量要连接主节点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27018</span><br></pre></td></tr></table></figure>
<h4 id="执行初始化副本集命令"><a href="#执行初始化副本集命令" class="headerlink" title="执行初始化副本集命令"></a>执行初始化副本集命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">rs.initiate()</span></span><br><span class="line">&#123;</span><br><span class="line"> &quot;info2&quot;: &quot;no configuration specified. Using a default configuration for the set &quot;,</span><br><span class="line"> &quot;me&quot;: &quot;180.76.159.126:27018&quot;,</span><br><span class="line"> &quot;ok&quot;: 1,</span><br><span class="line"> &quot;operationTime&quot;: Timestamp(1564593349, 1),</span><br><span class="line"> &quot;$clusterTime&quot;: &#123;</span><br><span class="line">  &quot;clusterTime&quot;: Timestamp(1564593349, 1),</span><br><span class="line">  &quot;signature&quot;: &#123;</span><br><span class="line">   &quot;hash&quot;: BinData(0, &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">   &quot;keyId&quot;: NumberLong(0)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;me&quot; : &quot;bobohost.localdomain:27018&quot;,</span><br></pre></td></tr></table></figure>
<h4 id="查看副本集情况-节选内容"><a href="#查看副本集情况-节选内容" class="headerlink" title="查看副本集情况(节选内容)"></a>查看副本集情况(节选内容)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:SECONDARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line">&quot;set&quot; : &quot;myshardrs01&quot;,</span><br><span class="line">......  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 2 ）主节点配置查看：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.conf()</span><br><span class="line">&#123;</span><br><span class="line"> &quot;_id&quot;: &quot;myshardrs01&quot;,</span><br><span class="line"> &quot;version&quot;: 1,</span><br><span class="line"> &quot;protocolVersion&quot;: NumberLong(1),</span><br><span class="line"> &quot;writeConcernMajorityJournalDefault&quot;: true,</span><br><span class="line"> &quot;members&quot;: [&#123;</span><br><span class="line">  &quot;_id&quot;: 0,</span><br><span class="line">  &quot;host&quot;: &quot;180.76.159.126:27018&quot;,</span><br><span class="line">  &quot;arbiterOnly&quot;: false,</span><br><span class="line">  &quot;buildIndexes&quot;: true,</span><br><span class="line">  &quot;hidden&quot;: false,</span><br><span class="line">  &quot;priority&quot;: 1,</span><br><span class="line">  &quot;tags&quot;: &#123;&#125;,</span><br><span class="line">  &quot;slaveDelay&quot;: NumberLong(0),</span><br><span class="line">  &quot;votes&quot;: 1</span><br><span class="line"> &#125;],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 3 ）添加副本节点：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.add(&quot;180.76.159.126:27118&quot;)</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ok&quot; : 1,</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1564593626, 1),</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1564593626, 1),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 4 ）添加仲裁节点：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.addArb(&quot;180.76.159.126:27218&quot;)</span><br><span class="line">&#123;</span><br><span class="line"> &quot;ok&quot;: 1,</span><br><span class="line"> &quot;operationTime&quot;: Timestamp(1564593675, 1),</span><br><span class="line"> &quot;$clusterTime&quot;: &#123;</span><br><span class="line">  &quot;clusterTime&quot;: Timestamp(1564593675, 1),</span><br><span class="line">  &quot;signature&quot;: &#123;</span><br><span class="line">   &quot;hash&quot;: BinData(0, &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">   &quot;keyId&quot;: NumberLong(0)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="查看副本集的配置情况"><a href="#查看副本集的配置情况" class="headerlink" title="查看副本集的配置情况"></a>查看副本集的配置情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01: PRIMARY &gt; rs.conf() &#123;</span><br><span class="line"> &quot;_id&quot;: &quot;myshardrs01&quot;,</span><br><span class="line"> &quot;version&quot;: 3,</span><br><span class="line"> &quot;protocolVersion&quot;: NumberLong(1),</span><br><span class="line"> &quot;writeConcernMajorityJournalDefault&quot;: true,</span><br><span class="line"> &quot;members&quot;: [&#123;</span><br><span class="line">   &quot;_id&quot;: 0,</span><br><span class="line">   &quot;host&quot;: &quot;180.76.159.126:27018&quot;,</span><br><span class="line">   &quot;arbiterOnly&quot;: false,</span><br><span class="line">   &quot;buildIndexes&quot;: true,</span><br><span class="line">   &quot;hidden&quot;: false,</span><br><span class="line">   &quot;priority&quot;: 1,</span><br><span class="line">   &quot;tags&quot;: &#123;&#125;,</span><br><span class="line">   &quot;slaveDelay&quot;: NumberLong(0),</span><br><span class="line">   &quot;votes&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;_id&quot;: 1,</span><br><span class="line">   &quot;host&quot;: &quot;180.76.159.126:27118&quot;,</span><br><span class="line">   &quot;arbiterOnly&quot;: false,</span><br><span class="line">   &quot;buildIndexes&quot;: true,</span><br><span class="line">   &quot;hidden&quot;: false,</span><br><span class="line">   &quot;priority&quot;: 1,</span><br><span class="line">   &quot;tags&quot;: &#123;&#125;,</span><br><span class="line">   &quot;slaveDelay&quot;: NumberLong(0),</span><br><span class="line">   &quot;votes&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;_id&quot;: 2,</span><br><span class="line">   &quot;host&quot;: &quot;180.76.159.126:27218&quot;,</span><br><span class="line">   &quot;arbiterOnly&quot;: true,</span><br><span class="line">   &quot;buildIndexes&quot;: true,</span><br><span class="line">   &quot;hidden&quot;: false,</span><br><span class="line">   &quot;priority&quot;: 0,</span><br><span class="line">   &quot;tags&quot;: &#123;&#125;,</span><br><span class="line">   &quot;slaveDelay&quot;: NumberLong(0),</span><br><span class="line">   &quot;votes&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line"> ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-2-第二套副本集"><a href="#2-4-2-第二套副本集" class="headerlink" title="2.4.2 第二套副本集"></a>2.4.2 第二套副本集</h3><h4 id="准备存放数据和日志的目录-1"><a href="#准备存放数据和日志的目录-1" class="headerlink" title="准备存放数据和日志的目录"></a>准备存放数据和日志的目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-----------myshardrs02</span></span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs02_27318/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs02_27318/data/db \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs02_27418/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs02_27418/data/db \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs02_27518/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myshardrs02_27518/data/db</span><br></pre></td></tr></table></figure>
<h4 id="新建或修改配置文件-6"><a href="#新建或修改配置文件-6" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/sharded_cluster/myshardrs02_27318/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myshardrs02-27318"><a href="#myshardrs02-27318" class="headerlink" title="myshardrs02_27318"></a>myshardrs02_27318</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/sharded_cluster/myshardrs02_27318/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/sharded_cluster/myshardrs02_27318/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/sharded_cluster/myshardrs02_27318/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27318</span><br><span class="line">replication:</span><br><span class="line">  replSetName: myshardrs02</span><br><span class="line">sharding:</span><br><span class="line">  clusterRole: shardsvr</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="新建或修改配置文件-7"><a href="#新建或修改配置文件-7" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/sharded_cluster/myshardrs02_27418/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myshardrs02-27418"><a href="#myshardrs02-27418" class="headerlink" title="myshardrs02_27418"></a>myshardrs02_27418</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/sharded_cluster/myshardrs02_27418/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/sharded_cluster/myshardrs02_27418/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/sharded_cluster/myshardrs02_27418/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27418</span><br><span class="line">replication:</span><br><span class="line">  replSetName: myshardrs02</span><br><span class="line">sharding:</span><br><span class="line">  clusterRole: shardsvr</span><br></pre></td></tr></table></figure>
<h4 id="新建或修改配置文件-8"><a href="#新建或修改配置文件-8" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/sharded_cluster/myshardrs02_27518/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myshardrs02-27518"><a href="#myshardrs02-27518" class="headerlink" title="myshardrs02_27518"></a>myshardrs02_27518</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/sharded_cluster/myshardrs02_27518/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/sharded_cluster/myshardrs02_27518/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/sharded_cluster/myshardrs02_27518/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27518</span><br><span class="line">replication:</span><br><span class="line">  replSetName: myshardrs02</span><br><span class="line">sharding:</span><br><span class="line">  clusterRole: shardsvr</span><br></pre></td></tr></table></figure>
<h4 id="启动第二套副本集：一主一副本一仲裁"><a href="#启动第二套副本集：一主一副本一仲裁" class="headerlink" title="启动第二套副本集：一主一副本一仲裁"></a>启动第二套副本集：一主一副本一仲裁</h4><h4 id="依次启动三个mongod服务-1"><a href="#依次启动三个mongod服务-1" class="headerlink" title="依次启动三个mongod服务"></a>依次启动三个mongod服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27318/mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123223</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line"></span><br><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27418/mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123292</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line"></span><br><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27518/mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123326</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>
<h4 id="查看服务是否启动-1"><a href="#查看服务是否启动-1" class="headerlink" title="查看服务是否启动"></a>查看服务是否启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# ps -ef |grep mongod</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 1 ）初始化副本集和创建主节点：</li>
</ul>
<h4 id="使用客户端命令连接任意一个节点，但这里尽量要连接主节点-1"><a href="#使用客户端命令连接任意一个节点，但这里尽量要连接主节点-1" class="headerlink" title="使用客户端命令连接任意一个节点，但这里尽量要连接主节点"></a>使用客户端命令连接任意一个节点，但这里尽量要连接主节点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27318</span><br></pre></td></tr></table></figure>
<h4 id="执行初始化副本集命令-1"><a href="#执行初始化副本集命令-1" class="headerlink" title="执行初始化副本集命令"></a>执行初始化副本集命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">rs.initiate()</span></span><br></pre></td></tr></table></figure>
<h4 id="查看副本集情况-节选内容-1"><a href="#查看副本集情况-节选内容-1" class="headerlink" title="查看副本集情况(节选内容)"></a>查看副本集情况(节选内容)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:SECONDARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line">&quot;set&quot; : &quot;myshardrs01&quot;,</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 2 ）主节点配置查看：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.conf()</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 3 ）添加副本节点：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.add(&quot;180.76.159.126:27418&quot;)</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ok&quot; : 1,</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1564593626, 1),</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1564593626, 1),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 4 ）添加仲裁节点：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.addArb(&quot;180.76.159.126:27518&quot;)</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ok&quot; : 1,</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1564593675, 1),</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1564593675, 1),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="查看副本集的配置情况-1"><a href="#查看副本集的配置情况-1" class="headerlink" title="查看副本集的配置情况"></a>查看副本集的配置情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.conf()</span><br><span class="line">myshardrs01:PRIMARY&gt; rs.status()</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">myshardrs02:PRIMARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line"> &quot;set&quot;: &quot;myshardrs02&quot;,</span><br><span class="line"> &quot;date&quot;: ISODate(&quot;2019-07-31T21:38:22.463Z&quot;),</span><br><span class="line"> &quot;myState&quot;: 1,</span><br><span class="line"> &quot;term&quot;: NumberLong(1),</span><br><span class="line"> &quot;syncingTo&quot;: &quot;&quot;,</span><br><span class="line"> &quot;syncSourceHost&quot;: &quot;&quot;,</span><br><span class="line"> &quot;syncSourceId&quot;: -1,</span><br><span class="line"> &quot;heartbeatIntervalMillis&quot;: NumberLong(2000),</span><br><span class="line"> &quot;optimes&quot;: &#123;</span><br><span class="line">  &quot;lastCommittedOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1564609094, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;readConcernMajorityOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1564609094, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;appliedOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1564609094, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;durableOpTime&quot;: &#123;</span><br><span class="line">   &quot;ts&quot;: Timestamp(1564609094, 1),</span><br><span class="line">   &quot;t&quot;: NumberLong(1)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;lastStableCheckpointTimestamp&quot;: Timestamp(1564609074, 1),</span><br><span class="line"> &quot;members&quot;: [&#123;</span><br><span class="line">    &quot;_id&quot;: 0,</span><br><span class="line">    &quot;name&quot;: &quot;180.76.159.126:27318&quot;,</span><br><span class="line">    &quot;health&quot;: 1,</span><br><span class="line">    &quot;state&quot;: 1,</span><br><span class="line">    &quot;stateStr&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">    &quot;uptime&quot;: 5086,</span><br><span class="line">    &quot;optime&quot;: &#123;</span><br><span class="line">     &quot;ts&quot;: Timestamp(1564609094, 1),</span><br><span class="line">     &quot;t&quot;: NumberLong(1)</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;optimeDate&quot;: ISODate(&quot;2019-07-31T21:38:14Z&quot;),</span><br><span class="line">    &quot;syncingTo&quot;: &quot;&quot;,</span><br><span class="line">    &quot;syncSourceHost&quot;: &quot;&quot;,</span><br><span class="line">    &quot;syncSourceId&quot;: -1,</span><br><span class="line">    &quot;infoMessage&quot;: &quot;&quot;,</span><br><span class="line">    &quot;electionTime&quot;: Timestamp(1564604032, 2),</span><br><span class="line">    &quot;electionDate&quot;: ISODate(&quot;2019-07-31T20:13:52Z&quot;),</span><br><span class="line">    &quot;configVersion&quot;: 3,</span><br><span class="line">    &quot;self&quot;: true,</span><br><span class="line">    &quot;lastHeartbeatMessage&quot;: &quot;&quot;</span><br><span class="line">   &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">    &quot;_id&quot;: 1,</span><br><span class="line">    &quot;name&quot;: &quot;180.76.159.126:27418&quot;,</span><br><span class="line">    &quot;health&quot;: 1,</span><br><span class="line">    &quot;state&quot;: 2,</span><br><span class="line">    &quot;stateStr&quot;: &quot;SECONDARY&quot;,</span><br><span class="line">    &quot;uptime&quot;: 4452,</span><br><span class="line">    &quot;optime&quot;: &#123;</span><br><span class="line">     &quot;ts&quot;: Timestamp(1564609094, 1),</span><br><span class="line">     &quot;t&quot;: NumberLong(1)</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;optimeDurable&quot;: &#123;</span><br><span class="line">     &quot;ts&quot;: Timestamp(1564609094, 1),</span><br><span class="line">     &quot;t&quot;: NumberLong(1)</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;optimeDate&quot;: ISODate(&quot;2019-07-31T21:38:14Z&quot;),</span><br><span class="line">    &quot;optimeDurableDate&quot;: ISODate(&quot;2019-07-31T21:38:14Z&quot;),</span><br><span class="line">    &quot;lastHeartbeat&quot;: ISODate(&quot;2019-07-31T21:38:21.178Z&quot;),</span><br><span class="line">    &quot;lastHeartbeatRecv&quot;: ISODate(&quot;2019-07-</span><br><span class="line">     31 T21: 38: 20.483 Z &quot;),</span><br><span class="line">     &quot;pingMs&quot;: NumberLong(0),</span><br><span class="line">     &quot;lastHeartbeatMessage&quot;: &quot;&quot;,</span><br><span class="line">     &quot;syncingTo&quot;: &quot;180.76.159.126:27518&quot;,</span><br><span class="line">     &quot;syncSourceHost&quot;: &quot;180.76.159.126:27518&quot;,</span><br><span class="line">     &quot;syncSourceId&quot;: 2,</span><br><span class="line">     &quot;infoMessage&quot;: &quot;&quot;,</span><br><span class="line">     &quot;configVersion&quot;: 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">     &quot;_id&quot;: 2,</span><br><span class="line">     &quot;name&quot;: &quot;180.76.159.126:27518&quot;,</span><br><span class="line">     &quot;health&quot;: 1,</span><br><span class="line">     &quot;state&quot;: 2,</span><br><span class="line">     &quot;stateStr&quot;: &quot;SECONDARY&quot;,</span><br><span class="line">     &quot;uptime&quot;: 4448,</span><br><span class="line">     &quot;optime&quot;: &#123;</span><br><span class="line">      &quot;ts&quot;: Timestamp(1564609094, 1),</span><br><span class="line">      &quot;t&quot;: NumberLong(1)</span><br><span class="line">     &#125;,</span><br><span class="line">     &quot;optimeDurable&quot;: &#123;</span><br><span class="line">      &quot;ts&quot;: Timestamp(1564609094, 1),</span><br><span class="line">      &quot;t&quot;: NumberLong(1)</span><br><span class="line">     &#125;,</span><br><span class="line">     &quot;optimeDate&quot;: ISODate(&quot;2019-07-31T21:38:14Z&quot;),</span><br><span class="line">     &quot;optimeDurableDate&quot;: ISODate(&quot;2019-07-31T21:38:14Z&quot;),</span><br><span class="line">     &quot;lastHeartbeat&quot;: ISODate(&quot;2019-07-31T21:38:21.178Z&quot;),</span><br><span class="line">     &quot;lastHeartbeatRecv&quot;: ISODate(&quot;2019-07-</span><br><span class="line">      31 T21: 38: 22.096 Z &quot;),</span><br><span class="line">      &quot;pingMs&quot;: NumberLong(0),</span><br><span class="line">      &quot;lastHeartbeatMessage&quot;: &quot;&quot;,</span><br><span class="line">      &quot;syncingTo&quot;: &quot;180.76.159.126:27318&quot;,</span><br><span class="line">      &quot;syncSourceHost&quot;: &quot;180.76.159.126:27318&quot;,</span><br><span class="line">      &quot;syncSourceId&quot;: 0,</span><br><span class="line">      &quot;infoMessage&quot;: &quot;&quot;,</span><br><span class="line">      &quot;configVersion&quot;: 3</span><br><span class="line">     &#125;</span><br><span class="line">    ],</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-配置节点副本集的创建"><a href="#2-5-配置节点副本集的创建" class="headerlink" title="2.5 配置节点副本集的创建"></a>2.5 配置节点副本集的创建</h2><h4 id="第一步：准备存放数据和日志的目录"><a href="#第一步：准备存放数据和日志的目录" class="headerlink" title="第一步：准备存放数据和日志的目录"></a>第一步：准备存放数据和日志的目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-----------configrs</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">建立数据节点data和日志目录</span></span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myconfigrs_27019/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myconfigrs_27019/data/db \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myconfigrs_27119/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myconfigrs_27119/data/db \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myconfigrs_27219/log \ &amp;</span><br><span class="line">mkdir -p /mongodb/sharded_cluster/myconfigrs_27219/data/db</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="新建或修改配置文件-9"><a href="#新建或修改配置文件-9" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myconfigrs-27019"><a href="#myconfigrs-27019" class="headerlink" title="myconfigrs_27019"></a>myconfigrs_27019</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/sharded_cluster/myconfigrs_27019/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/sharded_cluster/myconfigrs_27019/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/sharded_cluster/myconfigrs_27019/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27019</span><br><span class="line">replication:</span><br><span class="line">  replSetName: myconfigrs</span><br><span class="line">sharding:</span><br><span class="line">  clusterRole: configsvr</span><br></pre></td></tr></table></figure>
<h4 id="新建或修改配置文件-10"><a href="#新建或修改配置文件-10" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/sharded_cluster/myconfigrs_27119/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myconfigrs-27119"><a href="#myconfigrs-27119" class="headerlink" title="myconfigrs_27119"></a>myconfigrs_27119</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/sharded_cluster/myconfigrs_27119/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/sharded_cluster/myconfigrs_27119/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/sharded_cluster/myconfigrs_27119/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27119</span><br><span class="line">replication:</span><br><span class="line">  replSetName: myconfigrs</span><br><span class="line">sharding:</span><br><span class="line">  clusterRole: configsvr</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="新建或修改配置文件-11"><a href="#新建或修改配置文件-11" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/sharded_cluster/myconfigrs_27219/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="myconfigrs-27219"><a href="#myconfigrs-27219" class="headerlink" title="myconfigrs_27219"></a>myconfigrs_27219</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/sharded_cluster/myconfigrs_27219/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/sharded_cluster/myconfigrs_27219/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/sharded_cluster/myconfigrs_27219/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27219</span><br><span class="line">replication:</span><br><span class="line">  replSetName: myconfigrs</span><br><span class="line">sharding:</span><br><span class="line">  clusterRole: configsvr</span><br></pre></td></tr></table></figure>
<h4 id="启动配置副本集：一主两副本"><a href="#启动配置副本集：一主两副本" class="headerlink" title="启动配置副本集：一主两副本"></a>启动配置副本集：一主两副本</h4><h4 id="依次启动三个mongod服务-2"><a href="#依次启动三个mongod服务-2" class="headerlink" title="依次启动三个mongod服务"></a>依次启动三个mongod服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27019/mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123223</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line"></span><br><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27119/mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123292</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line"></span><br><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27219/mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123326</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="查看服务是否启动-2"><a href="#查看服务是否启动-2" class="headerlink" title="查看服务是否启动"></a>查看服务是否启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# ps -ef |grep mongod</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 1 ）初始化副本集和创建主节点：</li>
</ul>
<h4 id="使用客户端命令连接任意一个节点，但这里尽量要连接主节点-2"><a href="#使用客户端命令连接任意一个节点，但这里尽量要连接主节点-2" class="headerlink" title="使用客户端命令连接任意一个节点，但这里尽量要连接主节点"></a>使用客户端命令连接任意一个节点，但这里尽量要连接主节点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27019</span><br></pre></td></tr></table></figure>
<h4 id="执行初始化副本集命令-2"><a href="#执行初始化副本集命令-2" class="headerlink" title="执行初始化副本集命令"></a>执行初始化副本集命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">rs.initiate()</span></span><br></pre></td></tr></table></figure>
<h4 id="查看副本集情况-节选内容-2"><a href="#查看副本集情况-节选内容-2" class="headerlink" title="查看副本集情况(节选内容)"></a>查看副本集情况(节选内容)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:SECONDARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line">&quot;set&quot; : &quot;myshardrs01&quot;,</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 2 ）主节点配置查看：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.conf()</span><br><span class="line">&#123;</span><br><span class="line"> &quot;_id&quot;: &quot;myshardrs01&quot;,</span><br><span class="line"> &quot;version&quot;: 1,</span><br><span class="line"> &quot;protocolVersion&quot;: NumberLong(1),</span><br><span class="line"> &quot;writeConcernMajorityJournalDefault&quot;: true,</span><br><span class="line"> &quot;members&quot;: [&#123;</span><br><span class="line">  &quot;_id&quot;: 0,</span><br><span class="line">  &quot;host&quot;: &quot;bobohost.localdomain:27018&quot;,</span><br><span class="line">  &quot;arbiterOnly&quot;: false,</span><br><span class="line">  &quot;buildIndexes&quot;: true,</span><br><span class="line">  &quot;hidden&quot;: false,</span><br><span class="line">  &quot;priority&quot;: 1,</span><br><span class="line">  &quot;tags&quot;: &#123;&#125;,</span><br><span class="line">  &quot;slaveDelay&quot;: NumberLong(0),</span><br><span class="line">  &quot;votes&quot;: 1</span><br><span class="line"> &#125;],</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 3 ）添加两个副本节点：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.add(&quot;180.76.159.126:27119&quot;)</span><br><span class="line">myshardrs01:PRIMARY&gt; rs.add(&quot;180.76.159.126:27219&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="查看副本集的配置情况-2"><a href="#查看副本集的配置情况-2" class="headerlink" title="查看副本集的配置情况"></a>查看副本集的配置情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.conf()</span><br><span class="line">myshardrs01:PRIMARY&gt; rs.status()</span><br></pre></td></tr></table></figure>
<h2 id="2-6-路由节点的创建和操作"><a href="#2-6-路由节点的创建和操作" class="headerlink" title="2.6 路由节点的创建和操作"></a>2.6 路由节点的创建和操作</h2><h3 id="2-6-1-第一个路由节点的创建和连接"><a href="#2-6-1-第一个路由节点的创建和连接" class="headerlink" title="2.6.1 第一个路由节点的创建和连接"></a>2.6.1 第一个路由节点的创建和连接</h3><h4 id="第一步：准备存放数据和日志的目录-1"><a href="#第一步：准备存放数据和日志的目录-1" class="headerlink" title="第一步：准备存放数据和日志的目录"></a>第一步：准备存放数据和日志的目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-----------mongos01</span></span><br><span class="line">mkdir -p /mongodb/sharded_cluster/mymongos_27017/log</span><br></pre></td></tr></table></figure>
<h4 id="mymongos-27017节点"><a href="#mymongos-27017节点" class="headerlink" title="mymongos_27017节点"></a>mymongos_27017节点</h4><h4 id="新建或修改配置文件-12"><a href="#新建或修改配置文件-12" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /mongodb/sharded_cluster/mymongos_27017/mongos.conf</span><br></pre></td></tr></table></figure>
<h4 id="mongos-conf"><a href="#mongos-conf" class="headerlink" title="mongos.conf"></a>mongos.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/sharded_cluster/mymongos_27017/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: /mongodb/sharded_cluster/mymongos_27017/log/mongod.pid</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIp</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27017</span><br><span class="line">sharding:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定配置节点副本集</span></span><br><span class="line">  configDB: myconfigrs/180.76.159.126:27019,180.76.159.126:27119,180.76.159.126:27219</span><br></pre></td></tr></table></figure>
<h4 id="启动mongos"><a href="#启动mongos" class="headerlink" title="启动mongos"></a>启动mongos</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongos -f</span><br><span class="line">/mongodb/sharded_cluster/mymongos_27017/mongos.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 129874</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>
<h4 id="提示：启动如果失败，可以查看log目录下的日志，查看失败原因"><a href="#提示：启动如果失败，可以查看log目录下的日志，查看失败原因" class="headerlink" title="提示：启动如果失败，可以查看log目录下的日志，查看失败原因"></a>提示：启动如果失败，可以查看log目录下的日志，查看失败原因</h4><h4 id="客户端登录mongos"><a href="#客户端登录mongos" class="headerlink" title="客户端登录mongos"></a>客户端登录mongos</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27017</span><br></pre></td></tr></table></figure>
<h4 id="此时，写不进去数据，如果写数据会报错"><a href="#此时，写不进去数据，如果写数据会报错" class="headerlink" title="此时，写不进去数据，如果写数据会报错"></a>此时，写不进去数据，如果写数据会报错</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">use aadb</span></span><br><span class="line">switched to db aadb</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.aa.insert(&#123;aa:<span class="string">&quot;aa&quot;</span>&#125;)</span></span><br><span class="line">WriteCommandError(&#123;</span><br><span class="line">  &quot;ok&quot; : 0,</span><br><span class="line">  &quot;errmsg&quot; : &quot;unable to initialize targeter for write op for collection aa.aa :: caused by :: Database aa not found :: caused by :: No shards found&quot;,</span><br><span class="line">  &quot;code&quot; : 70,</span><br><span class="line">  &quot;codeName&quot; : &quot;ShardNotFound&quot;,</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1564600123, 2),</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1564600123, 2),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><h4 id="通过路由节点操作，现在只是连接了配置节点，还没有连接分片数据节点，因此无法写入业务数据"><a href="#通过路由节点操作，现在只是连接了配置节点，还没有连接分片数据节点，因此无法写入业务数据" class="headerlink" title="通过路由节点操作，现在只是连接了配置节点，还没有连接分片数据节点，因此无法写入业务数据"></a>通过路由节点操作，现在只是连接了配置节点，还没有连接分片数据节点，因此无法写入业务数据</h4><h4 id="properties配置文件参考"><a href="#properties配置文件参考" class="headerlink" title="properties配置文件参考"></a>properties配置文件参考</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">logpath=/mongodb/sharded_cluster/mymongos_27017/log/mongos.log</span><br><span class="line">logappend=true</span><br><span class="line">bind_ip_all=true</span><br><span class="line">port=27017</span><br><span class="line">fork=true</span><br><span class="line">configdb=myconfigrs/180.76.159.126:27019,180.76.159.126:27119,180.76.159.126:27219</span><br></pre></td></tr></table></figure>
<h3 id="2-6-2-在路由节点上进行分片配置操作"><a href="#2-6-2-在路由节点上进行分片配置操作" class="headerlink" title="2.6.2 在路由节点上进行分片配置操作"></a>2.6.2 在路由节点上进行分片配置操作</h3><h4 id="使用命令添加分片"><a href="#使用命令添加分片" class="headerlink" title="使用命令添加分片"></a>使用命令添加分片</h4><ul>
<li>（ 1 ）添加分片：</li>
</ul>
<h4 id="语法-12"><a href="#语法-12" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh.addShard(&quot;IP:Port&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="将第一套分片副本集添加进来"><a href="#将第一套分片副本集添加进来" class="headerlink" title="将第一套分片副本集添加进来"></a>将第一套分片副本集添加进来</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">sh.addShard(<span class="string">&quot;myshardrs01/192.168.0.2:27018,180.76.159.126:27118,180.76.159.126:27218&quot;</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">  &quot;shardAdded&quot; : &quot;myshardrs01&quot;,</span><br><span class="line">  &quot;ok&quot; : 1,</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1564611970, 4),</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1564611970, 4),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="查看分片状态情况"><a href="#查看分片状态情况" class="headerlink" title="查看分片状态情况"></a>查看分片状态情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">sh.status()</span></span><br><span class="line">--- Sharding Status ---</span><br><span class="line">sharding version: &#123;</span><br><span class="line">  &quot;_id&quot; : 1,</span><br><span class="line">  &quot;minCompatibleVersion&quot; : 5,</span><br><span class="line">  &quot;currentVersion&quot; : 6,</span><br><span class="line">  &quot;clusterId&quot; : ObjectId(&quot;5d4211b798f3f9a48522c68b&quot;)</span><br><span class="line">&#125;</span><br><span class="line">shards: &#123;</span><br><span class="line">  &quot;_id&quot;:&quot;myshardrs01&quot;,</span><br><span class="line">  &quot;host&quot;:&quot;myshardrs01/180.76.159.126:27018,180.76.159.126:27118&quot;,</span><br><span class="line">  &quot;state&quot; : 1 </span><br><span class="line">&#125;</span><br><span class="line">active mongoses:&quot;4.0.10&quot; : 1</span><br><span class="line">autosplit:</span><br><span class="line">  Currently enabled: yes</span><br><span class="line">balancer:</span><br><span class="line">  Currently enabled: yes</span><br><span class="line">  Currently running: no</span><br><span class="line">  Failed balancer rounds in last 5 attempts: 0</span><br><span class="line">  Migration Results for the last 24 hours:</span><br><span class="line">    No recent migrations</span><br><span class="line">databases:&#123;&quot;_id&quot;:&quot;config&quot;,&quot;primary&quot;:&quot;config&quot;,&quot;partitioned&quot;:true&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="继续将第二套分片副本集添加进来"><a href="#继续将第二套分片副本集添加进来" class="headerlink" title="继续将第二套分片副本集添加进来"></a>继续将第二套分片副本集添加进来</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">sh.addShard(<span class="string">&quot;myshardrs02/192.168.0.2:27318,180.76.159.126:27418,180.76.159.126:27518&quot;</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;shardAdded&quot; : &quot;myshardrs02&quot;,</span><br><span class="line">  &quot;ok&quot; : 1,</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1564612147, 5),</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1564612147, 5),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="查看分片状态"><a href="#查看分片状态" class="headerlink" title="查看分片状态"></a>查看分片状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">sh.status()</span></span><br><span class="line">--- Sharding Status ---</span><br><span class="line">sharding version: &#123;</span><br><span class="line">  &quot;_id&quot; : 1,</span><br><span class="line">  &quot;minCompatibleVersion&quot; : 5,</span><br><span class="line">  &quot;currentVersion&quot; : 6,</span><br><span class="line">  &quot;clusterId&quot; : ObjectId(&quot;5d4211b798f3f9a48522c68b&quot;)</span><br><span class="line">&#125;</span><br><span class="line">shards:&#123; &quot;_id&quot;:&quot;myshardrs01&quot;,&quot;host&quot;:&quot;myshardrs01/180.76.159.126:27018,180.76.159.126:27118&quot;,&quot;state&quot;:1&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot;:&quot;myshardrs02&quot;, </span><br><span class="line">  &quot;host&quot;:&quot;myshardrs02/180.76.159.126:27318,180.76.159.126:27418&quot;,</span><br><span class="line">  &quot;state&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line">active mongoses:</span><br><span class="line">&quot;4.0.10&quot; : 1</span><br><span class="line">autosplit:</span><br><span class="line">  Currently enabled: yes</span><br><span class="line">balancer:</span><br><span class="line">  Currently enabled: yes</span><br><span class="line">  Currently running: no</span><br><span class="line">  Failed balancer rounds in last 5 attempts: 0</span><br><span class="line">  Migration Results for the last 24 hours:</span><br><span class="line">  No recent migrations</span><br><span class="line">databases:&#123; &quot;_id&quot; : &quot;config&quot;, &quot;primary&quot; : &quot;config&quot;, &quot;partitioned&quot; : true &#125;</span><br></pre></td></tr></table></figure>
<h4 id="提示：如果添加分片失败，需要先手动移除分片，检查添加分片的信息的正确性后，再次添加分片"><a href="#提示：如果添加分片失败，需要先手动移除分片，检查添加分片的信息的正确性后，再次添加分片" class="headerlink" title="提示：如果添加分片失败，需要先手动移除分片，检查添加分片的信息的正确性后，再次添加分片"></a>提示：如果添加分片失败，需要先手动移除分片，检查添加分片的信息的正确性后，再次添加分片</h4><h4 id="移除分片参考-了解"><a href="#移除分片参考-了解" class="headerlink" title="移除分片参考(了解)"></a>移除分片参考(了解)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line">db.runCommand( &#123; removeShard: &quot;myshardrs02&quot; &#125; )</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="注意：如果只剩下最后一个shard，是无法删除的"><a href="#注意：如果只剩下最后一个shard，是无法删除的" class="headerlink" title="注意：如果只剩下最后一个shard，是无法删除的"></a>注意：如果只剩下最后一个shard，是无法删除的</h4><h4 id="移除时会自动转移分片数据，需要一个时间过程"><a href="#移除时会自动转移分片数据，需要一个时间过程" class="headerlink" title="移除时会自动转移分片数据，需要一个时间过程"></a>移除时会自动转移分片数据，需要一个时间过程</h4><h4 id="完成后，再次执行删除分片命令才能真正删除"><a href="#完成后，再次执行删除分片命令才能真正删除" class="headerlink" title="完成后，再次执行删除分片命令才能真正删除"></a>完成后，再次执行删除分片命令才能真正删除</h4><ul>
<li>（ 2 ）开启分片功能：sh.enableSharding(“库名”)、sh.shardCollection(“库名.集合名”,{“key”:1})<br>在mongos上的articledb数据库配置sharding:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">sh.enableSharding(<span class="string">&quot;articledb&quot;</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;ok&quot; : 1,</span><br><span class="line">  &quot;operationTime&quot; : Timestamp(1564612296, 5),</span><br><span class="line">  &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1564612296, 5),</span><br><span class="line">    &quot;signature&quot; : &#123;</span><br><span class="line">      &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">      &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="查看分片状态-1"><a href="#查看分片状态-1" class="headerlink" title="查看分片状态"></a>查看分片状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">mongos &gt; sh.status()</span><br><span class="line"> -- - Sharding Status-- -</span><br><span class="line"> sharding version: &#123;</span><br><span class="line">  &quot;_id&quot;: 1,</span><br><span class="line">  &quot;minCompatibleVersion&quot;: 5,</span><br><span class="line">  &quot;currentVersion&quot;: 6,</span><br><span class="line">  &quot;clusterId&quot;: ObjectId(&quot;5d4211b798f3f9a48522c68b&quot;)</span><br><span class="line"> &#125;</span><br><span class="line">shards: &#123;</span><br><span class="line"> &quot;_id&quot;: &quot;myshardrs01&quot;,</span><br><span class="line"> &quot;host&quot;: &quot;myshardrs01/180.76.159.126:27018,180.76.159.126:27118&quot;,</span><br><span class="line"> &quot;state&quot;: 1</span><br><span class="line">&#125; &#123;</span><br><span class="line"> &quot;_id&quot;: &quot;myshardrs02&quot;,</span><br><span class="line"> &quot;host&quot;: &quot;myshardrs02/180.76.159.126:27318,180.76.159.126:27418&quot;,</span><br><span class="line"> &quot;state&quot;: 1</span><br><span class="line">&#125;</span><br><span class="line">active mongoses:</span><br><span class="line"> &quot;4.0.10&quot;: 1</span><br><span class="line">autosplit:</span><br><span class="line"> Currently enabled: yes</span><br><span class="line">balancer:</span><br><span class="line"> Currently enabled: yes</span><br><span class="line">Currently running: no</span><br><span class="line">Failed balancer rounds in last 5 attempts: 0</span><br><span class="line">Migration Results</span><br><span class="line">for the last 24 hours:</span><br><span class="line"> No recent migrations</span><br><span class="line">databases: &#123;</span><br><span class="line"> &quot;_id&quot;: &quot;articledb&quot;,</span><br><span class="line"> &quot;primary&quot;: &quot;myshardrs02&quot;,</span><br><span class="line"> &quot;partitioned&quot;: true,</span><br><span class="line"> &quot;version&quot;: &#123;</span><br><span class="line">  &quot;uuid&quot;: UUID(&quot;788c9a3b-bb6a-4cc2-a597-974694772986&quot;),</span><br><span class="line">  &quot;lastMod&quot;: 1</span><br><span class="line"> &#125;</span><br><span class="line">&#125; &#123;</span><br><span class="line"> &quot;_id&quot;: &quot;config&quot;,</span><br><span class="line"> &quot;primary&quot;: &quot;config&quot;,</span><br><span class="line"> &quot;partitioned&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">config.system.sessions</span><br><span class="line">shard key: &#123;</span><br><span class="line"> &quot;_id&quot;: 1</span><br><span class="line">&#125;</span><br><span class="line">unique: false</span><br><span class="line">balancing: true</span><br><span class="line">chunks:</span><br><span class="line"> myshardrs01 1 &#123;</span><br><span class="line">  &quot;_id&quot;: &#123;</span><br><span class="line">   &quot;$minKey&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;-- &gt;&gt; &#123;</span><br><span class="line">  &quot;_id&quot;: &#123;</span><br><span class="line">   &quot;$maxKey&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">on: myshardrs01 Timestamp(1, 0)</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 3 ）集合分片</li>
</ul>
<h4 id="对集合分片，你必须使用-sh-shardCollection-方法指定集合和分片键"><a href="#对集合分片，你必须使用-sh-shardCollection-方法指定集合和分片键" class="headerlink" title="对集合分片，你必须使用 sh.shardCollection() 方法指定集合和分片键"></a>对集合分片，你必须使用 sh.shardCollection() 方法指定集合和分片键</h4><h4 id="语法-13"><a href="#语法-13" class="headerlink" title="语法"></a>语法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.shardCollection(namespace, key, unique)</span><br></pre></td></tr></table></figure>
<h4 id="参数-6"><a href="#参数-6" class="headerlink" title="参数"></a>参数</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">namespace</td>
<td style="text-align:center">string</td>
<td style="text-align:center">要（分片）共享的目标集合的命名空间，格式： <database>.<collection></td>
</tr>
<tr>
<td style="text-align:center">key</td>
<td style="text-align:center">document</td>
<td style="text-align:center">用作分片键的索引规范文档。shard键决定MongoDB如何在shard之间分发文档。除非集合为空，否则索引必须在shard collection命令之前存在。如果集合为空，则MongoDB在对集合 进行分片之前创建索引，前提是支持分片键的索引不存在。简单 的说：由包含字段和该字段的索引遍历方向的文档组成。</td>
</tr>
<tr>
<td style="text-align:center">unique</td>
<td style="text-align:center">boolean</td>
<td style="text-align:center">当值为true情况下，片键字段上会限制为确保是唯一索引。哈希策略片键不支持唯一索引。默认是false。</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>对集合进行分片时,你需要选择一个 片键（Shard Key） , shard key 是每条记录都必须包含的,且建立了索引的单个字段或复合字段,MongoDB按照片键将数据划分到不同的<br>数据块 中,并将 数据块 均衡地分布到所有分片中.为了按照片键划分数据块,MongoDB使用<br>基于哈希的分片方式（随机平均分配）或者基于范围的分片方式（数值大小分配） 。</p>
<p>用什么字段当片键都可以，如：nickname作为片键，但一定是必填字段。</p>
</blockquote>
<h4 id="分片规则一：哈希策略"><a href="#分片规则一：哈希策略" class="headerlink" title="分片规则一：哈希策略"></a>分片规则一：哈希策略</h4><blockquote>
<p>对于 基于哈希的分片 ,MongoDB计算一个字段的哈希值,并用这个哈希值来创建数据块.</p>
<p>在使用基于哈希分片的系统中,拥有”相近”片键的文档 很可能不会 存储在同一个数据块中,因此数据的分离性更好一些.</p>
</blockquote>
<h4 id="使用nickname作为片键，根据其值的哈希值进行数据分片"><a href="#使用nickname作为片键，根据其值的哈希值进行数据分片" class="headerlink" title="使用nickname作为片键，根据其值的哈希值进行数据分片"></a>使用nickname作为片键，根据其值的哈希值进行数据分片</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mongos &gt; sh.shardCollection(&quot;articledb.comment&quot;, &#123;</span><br><span class="line"> &quot;nickname&quot;: &quot;hashed&quot;</span><br><span class="line">&#125;) &#123;</span><br><span class="line"> &quot;collectionsharded&quot;: &quot;articledb.comment&quot;,</span><br><span class="line"> &quot;collectionUUID&quot;: UUID(&quot;ddea6ed8-ee61-4693-bd16-196acc3a45e8&quot;),</span><br><span class="line"> &quot;ok&quot;: 1,</span><br><span class="line"> &quot;operationTime&quot;: Timestamp(1564612840, 28),</span><br><span class="line"> &quot;$clusterTime&quot;: &#123;</span><br><span class="line">  &quot;clusterTime&quot;: Timestamp(1564612840, 28),</span><br><span class="line">  &quot;signature&quot;: &#123;</span><br><span class="line">   &quot;hash&quot;: BinData(0, &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">   &quot;keyId&quot;: NumberLong(0)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="查看分片状态：sh-status"><a href="#查看分片状态：sh-status" class="headerlink" title="查看分片状态：sh.status()"></a>查看分片状态：sh.status()</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">databases: &#123;</span><br><span class="line"> &quot;_id&quot;: &quot;articledb&quot;,</span><br><span class="line"> &quot;primary&quot;: &quot;myshardrs02&quot;,</span><br><span class="line"> &quot;partitioned&quot;: true,</span><br><span class="line"> &quot;version&quot;: &#123;</span><br><span class="line">  &quot;uuid&quot;: UUID(&quot;251436b7-86c2-4cd8-9a88-70874af29364&quot;),</span><br><span class="line">  &quot;lastMod&quot;: 1</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">articledb.comment</span><br><span class="line">shard key: &#123;</span><br><span class="line"> &quot;nickname&quot;: &quot;hashed&quot;</span><br><span class="line">&#125;</span><br><span class="line">unique: false</span><br><span class="line">balancing: true</span><br><span class="line">chunks:</span><br><span class="line"> myshardrs01 2</span><br><span class="line">myshardrs02 2 &#123;</span><br><span class="line"> &quot;nickname&quot;: &#123;</span><br><span class="line">  &quot;$minKey&quot;: 1</span><br><span class="line"> &#125;</span><br><span class="line">&#125;-- &gt;&gt; &#123;</span><br><span class="line"> &quot;nickname&quot;: NumberLong(&quot;-4611686018427387902&quot;)</span><br><span class="line">&#125;</span><br><span class="line">on: myshardrs01 Timestamp(1, 0) &#123;</span><br><span class="line"> &quot;nickname&quot;: NumberLong(&quot;-4611686018427387902&quot;)</span><br><span class="line">&#125;-- &gt;&gt; &#123;</span><br><span class="line"> &quot;nickname&quot;: NumberLong(0)</span><br><span class="line">&#125;</span><br><span class="line">on: myshardrs01 Timestamp(1, 1) &#123;</span><br><span class="line"> &quot;nickname&quot;: NumberLong(0)</span><br><span class="line">&#125;-- &gt;&gt; &#123;</span><br><span class="line"> &quot;nickname&quot;: NumberLong(&quot;4611686018427387902&quot;)</span><br><span class="line">&#125;</span><br><span class="line">on: myshardrs02 Timestamp(1, 2) &#123;</span><br><span class="line"> &quot;nickname&quot;: NumberLong(&quot;4611686018427387902&quot;)</span><br><span class="line">&#125;-- &gt;&gt; &#123;</span><br><span class="line"> &quot;nickname&quot;: &#123;</span><br><span class="line">  &quot;$maxKey&quot;: 1</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">on: myshardrs02 Timestamp(1, 3) &#123;</span><br><span class="line"> &quot;_id&quot;: &quot;config&quot;,</span><br><span class="line"> &quot;primary&quot;: &quot;config&quot;,</span><br><span class="line"> &quot;partitioned&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">config.system.sessions</span><br><span class="line">shard key: &#123;</span><br><span class="line"> &quot;_id&quot;: 1</span><br><span class="line">&#125;</span><br><span class="line">unique: false</span><br><span class="line">balancing: true</span><br><span class="line">chunks:</span><br><span class="line"> myshardrs01 1 &#123;</span><br><span class="line">  &quot;_id&quot;: &#123;</span><br><span class="line">   &quot;$minKey&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;-- &gt;&gt; &#123;</span><br><span class="line">  &quot;_id&quot;: &#123;</span><br><span class="line">   &quot;$maxKey&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">on: myshardrs01 Timestamp(1, 0)</span><br></pre></td></tr></table></figure>
<h4 id="分片规则二：范围策略"><a href="#分片规则二：范围策略" class="headerlink" title="分片规则二：范围策略"></a>分片规则二：范围策略</h4><blockquote>
<p>对于 基于范围的分片 ,MongoDB按照片键的范围把数据分成不同部分.假设有一个数字的片键:<br>想象一个从负无穷到正无穷的直线,每一个片键的值都在直线上画了一个点.MongoDB把这条直线划分为更短的不重叠的片段,并称之为<br>数据块<br>,每个数据块包含了片键在一定范围内的数据.</p>
<p>在使用片键做范围划分的系统中,拥有”相近”片键的文档很可能存储在同一个数据块中,因此也会存储在同一个分片中.</p>
</blockquote>
<h4 id="如使用作者年龄字段作为片键，按照点赞数的值进行分片"><a href="#如使用作者年龄字段作为片键，按照点赞数的值进行分片" class="headerlink" title="如使用作者年龄字段作为片键，按照点赞数的值进行分片"></a>如使用作者年龄字段作为片键，按照点赞数的值进行分片</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mongos &gt; sh.shardCollection(&quot;articledb.author&quot;, &#123;&quot;age&quot;: 1&#125;) </span><br><span class="line">&#123;</span><br><span class="line"> &quot;collectionsharded&quot;: &quot;articledb.author&quot;,</span><br><span class="line"> &quot;collectionUUID&quot;: UUID(&quot;9a47bdaa-213a-4039-9c18-e70bfc369df7&quot;),</span><br><span class="line"> &quot;ok&quot;: 1,</span><br><span class="line"> &quot;operationTime&quot;: Timestamp(1567512803, 13),</span><br><span class="line"></span><br><span class="line"> &quot;$clusterTime&quot;: &#123;</span><br><span class="line">  &quot;clusterTime&quot;: Timestamp(1567512803, 13),</span><br><span class="line">  &quot;signature&quot;: &#123;</span><br><span class="line">   &quot;hash&quot;: BinData(0, &quot;eE9QT5yE5sL1Tyr7+3U8GRy5+5Q=&quot;),</span><br><span class="line">   &quot;keyId&quot;: NumberLong(&quot;6732061237309341726&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="注意的是"><a href="#注意的是" class="headerlink" title="注意的是"></a>注意的是</h4><ul>
<li>1 ）一个集合只能指定一个片键，否则报错。</li>
<li>2 ）一旦对一个集合分片，分片键和分片值就不可改变。 如：不能给集合选择不同的分片键、不能更新分片键的值。</li>
<li>3 ）根据age索引进行分配数据。</li>
</ul>
<h4 id="查看分片状态-2"><a href="#查看分片状态-2" class="headerlink" title="查看分片状态"></a>查看分片状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">articledb.author</span><br><span class="line">shard key: &#123;</span><br><span class="line"> &quot;age&quot;: 1</span><br><span class="line">&#125;</span><br><span class="line">unique: false</span><br><span class="line">balancing: true</span><br><span class="line">chunks:</span><br><span class="line"> myshardrs01 1 &#123;</span><br><span class="line">  &quot;age&quot;: &#123;</span><br><span class="line">   &quot;$minKey&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;-- &gt;&gt; &#123;</span><br><span class="line">  &quot;age&quot;: &#123;</span><br><span class="line">   &quot;$maxKey&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">on: myshardrs01 Timestamp(1, 0)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>基于范围的分片方式与基于哈希的分片方式性能对比：</p>
<p>基于范围的分片方式提供了更高效的范围查询,给定一个片键的范围,分发路由可以很简单地确定哪个数据块存储了请求需要的数据,并将请求转发到相应的分片中.</p>
<p>不过,基于范围的分片会导致数据在不同分片上的不均衡,有时候,带来的消极作用会大于查询性能的积极<br>作用.比如,如果片键所在的字段是线性增长的,一定时间内的所有请求都会落到某个固定的数据块中,最终导致分布在同一个分片中.在这种情况下,一小部分分片承载了集群大部分的数据,系统并不能很好地进行扩展.</p>
<p>与此相比,基于哈希的分片方式以范围查询性能的损失为代价,保证了集群中数据的均衡.哈希值的随机性使数据随机分布在每个数据块中,<br>因此也随机分布在不同分片中.但是也正由于随机性,一个范围查询很难确定应该请求哪些分片,通常为了返回需要的结果,需要请求所有分片.</p>
<p>如无特殊情况，一般推荐使用 Hash Sharding。</p>
<p>而使用_id作为片键是一个不错的选择，因为它是必有的，你可以使用数据文档_id的哈希作为片键。这个方案能够是的读和写都能够平均分布，并且它能够保证每个文档都有不同的片键所以数据块能够很精细。</p>
<p>似乎还是不够完美，因为这样的话对多个文档的查询必将命中所有的分片。虽说如此，这也是一种比较好的方案了。</p>
</blockquote>
<h4 id="理想化的-shard-key-可以让-documents-均匀地在集群中分布"><a href="#理想化的-shard-key-可以让-documents-均匀地在集群中分布" class="headerlink" title="理想化的 shard key 可以让 documents 均匀地在集群中分布"></a>理想化的 shard key 可以让 documents 均匀地在集群中分布</h4><p><img src="QQ截图20240126223343.png&quot;" alt="输入图片说明"></p>
<h4 id="显示集群的详细信息"><a href="#显示集群的详细信息" class="headerlink" title="显示集群的详细信息"></a>显示集群的详细信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.printShardingStatus()</span></span><br></pre></td></tr></table></figure>
<h4 id="查看均衡器是否工作（需要重新均衡时系统才会自动启动，不用管它）"><a href="#查看均衡器是否工作（需要重新均衡时系统才会自动启动，不用管它）" class="headerlink" title="查看均衡器是否工作（需要重新均衡时系统才会自动启动，不用管它）"></a>查看均衡器是否工作（需要重新均衡时系统才会自动启动，不用管它）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">sh.isBalancerRunning()</span></span><br><span class="line">false</span><br></pre></td></tr></table></figure>
<h4 id="查看当前Balancer状态"><a href="#查看当前Balancer状态" class="headerlink" title="查看当前Balancer状态"></a>查看当前Balancer状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">sh.getBalancerState()</span></span><br><span class="line">true</span><br></pre></td></tr></table></figure>
<h3 id="2-6-3-分片后插入数据测试"><a href="#2-6-3-分片后插入数据测试" class="headerlink" title="2.6.3 分片后插入数据测试"></a>2.6.3 分片后插入数据测试</h3><h4 id="测试一（哈希规则）：登录mongs后，向comment循环插入-1000-条数据做测试"><a href="#测试一（哈希规则）：登录mongs后，向comment循环插入-1000-条数据做测试" class="headerlink" title="测试一（哈希规则）：登录mongs后，向comment循环插入 1000 条数据做测试"></a>测试一（哈希规则）：登录mongs后，向comment循环插入 1000 条数据做测试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">use articledb</span></span><br><span class="line">switched to db articledb</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash"><span class="keyword">for</span>(var i=1;i&lt;=1000;i++)&#123;db.comment.insert(&#123;_id:i+<span class="string">&quot;&quot;</span>,nickname:<span class="string">&quot;BoBo&quot;</span>+i&#125;)&#125;</span></span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.comment.count()</span></span><br><span class="line">1000</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="提示：js的语法，因为mongo的shell是一个JavaScript的shell"><a href="#提示：js的语法，因为mongo的shell是一个JavaScript的shell" class="headerlink" title="提示：js的语法，因为mongo的shell是一个JavaScript的shell"></a>提示：js的语法，因为mongo的shell是一个JavaScript的shell</h4><h4 id="注意：从路由上插入的数据，必须包含片键，否则无法插入"><a href="#注意：从路由上插入的数据，必须包含片键，否则无法插入" class="headerlink" title="注意：从路由上插入的数据，必须包含片键，否则无法插入"></a>注意：从路由上插入的数据，必须包含片键，否则无法插入</h4><h4 id="分别登陆两个片的主节点，统计文档数量"><a href="#分别登陆两个片的主节点，统计文档数量" class="headerlink" title="分别登陆两个片的主节点，统计文档数量"></a>分别登陆两个片的主节点，统计文档数量</h4><h4 id="第一个分片副本集"><a href="#第一个分片副本集" class="headerlink" title="第一个分片副本集"></a>第一个分片副本集</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27018</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">myshardrs01:PRIMARY&gt; db.comment.count()</span><br><span class="line">508</span><br></pre></td></tr></table></figure>
<h4 id="第二个分片副本集"><a href="#第二个分片副本集" class="headerlink" title="第二个分片副本集"></a>第二个分片副本集</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27318</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">myshardrs02:PRIMARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">myshardrs02:PRIMARY&gt; db.comment.count()</span><br><span class="line">493</span><br></pre></td></tr></table></figure>
<h4 id="可以看到，-1000-条数据近似均匀的分布到了-2-个shard上。是根据片键的哈希值分配的"><a href="#可以看到，-1000-条数据近似均匀的分布到了-2-个shard上。是根据片键的哈希值分配的" class="headerlink" title="可以看到， 1000 条数据近似均匀的分布到了 2 个shard上。是根据片键的哈希值分配的"></a>可以看到， 1000 条数据近似均匀的分布到了 2 个shard上。是根据片键的哈希值分配的</h4><h4 id="这种分配方式非常易于水平扩展：一旦数据存储需要更大空间，可以直接再增加分片即可，同时提升了性能"><a href="#这种分配方式非常易于水平扩展：一旦数据存储需要更大空间，可以直接再增加分片即可，同时提升了性能" class="headerlink" title="这种分配方式非常易于水平扩展：一旦数据存储需要更大空间，可以直接再增加分片即可，同时提升了性能"></a>这种分配方式非常易于水平扩展：一旦数据存储需要更大空间，可以直接再增加分片即可，同时提升了性能</h4><h4 id="使用db-comment-stats-查看单个集合的完整情况，mongos执行该命令可以查看该集合的数据分片的情况"><a href="#使用db-comment-stats-查看单个集合的完整情况，mongos执行该命令可以查看该集合的数据分片的情况" class="headerlink" title="使用db.comment.stats()查看单个集合的完整情况，mongos执行该命令可以查看该集合的数据分片的情况"></a>使用db.comment.stats()查看单个集合的完整情况，mongos执行该命令可以查看该集合的数据分片的情况</h4><h4 id="使用sh-status-查看本库内所有集合的分片信息"><a href="#使用sh-status-查看本库内所有集合的分片信息" class="headerlink" title="使用sh.status()查看本库内所有集合的分片信息"></a>使用sh.status()查看本库内所有集合的分片信息</h4><h4 id="测试二（范围规则）：登录mongs后，向comment循环插入-1000-条数据做测试"><a href="#测试二（范围规则）：登录mongs后，向comment循环插入-1000-条数据做测试" class="headerlink" title="测试二（范围规则）：登录mongs后，向comment循环插入 1000 条数据做测试"></a>测试二（范围规则）：登录mongs后，向comment循环插入 1000 条数据做测试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">use articledb</span></span><br><span class="line">switched to db articledb</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash"><span class="keyword">for</span>(var i=1;i&lt;=20000;i++)&#123;db.author.save(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo&quot;</span>+i,<span class="string">&quot;age&quot;</span>:NumberInt(i%120)&#125;)&#125;</span></span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.comment.count()</span></span><br><span class="line">20000</span><br></pre></td></tr></table></figure>
<h4 id="插入成功后，仍然要分别查看两个分片副本集的数据情况"><a href="#插入成功后，仍然要分别查看两个分片副本集的数据情况" class="headerlink" title="插入成功后，仍然要分别查看两个分片副本集的数据情况"></a>插入成功后，仍然要分别查看两个分片副本集的数据情况</h4><h4 id="分片效果"><a href="#分片效果" class="headerlink" title="分片效果"></a>分片效果</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">articledb.author</span><br><span class="line">shard key: &#123;</span><br><span class="line"> &quot;age&quot;: 1</span><br><span class="line">&#125;</span><br><span class="line">unique: false</span><br><span class="line">balancing: true</span><br><span class="line">chunks:</span><br><span class="line"> myshardrs01 2</span><br><span class="line">myshardrs02 1 &#123;</span><br><span class="line"> &quot;age&quot;: &#123;</span><br><span class="line">  &quot;$minKey&quot;: 1</span><br><span class="line"> &#125;</span><br><span class="line">&#125;-- &gt;&gt; &#123;</span><br><span class="line"> &quot;age&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">on:</span><br><span class="line"> myshardrs02 Timestamp(2, 0) &#123;</span><br><span class="line">  &quot;age&quot;: 0</span><br><span class="line"> &#125;-- &gt;&gt; &#123;</span><br><span class="line">  &quot;age&quot;: 112</span><br><span class="line"> &#125;</span><br><span class="line">on: myshardrs01</span><br><span class="line">Timestamp(2, 1) &#123;</span><br><span class="line"> &quot;age&quot;: 112</span><br><span class="line">&#125;-- &gt;&gt; &#123;</span><br><span class="line"> &quot;age&quot;: &#123;</span><br><span class="line">  &quot;$maxKey&quot;: 1</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">on:</span><br><span class="line"> myshardrs01 Timestamp(1, 3)</span><br></pre></td></tr></table></figure>
<h4 id="提示-12"><a href="#提示-12" class="headerlink" title="提示"></a>提示</h4><h4 id="如果查看状态发现没有分片，则可能是由于以下原因造成了"><a href="#如果查看状态发现没有分片，则可能是由于以下原因造成了" class="headerlink" title="如果查看状态发现没有分片，则可能是由于以下原因造成了"></a>如果查看状态发现没有分片，则可能是由于以下原因造成了</h4><ul>
<li>1 ）系统繁忙，正在分片中。</li>
<li>2 ）数据块（chunk）没有填满，默认的数据块尺寸（chunksize）是64M，填满后才会考虑向其他片的数据块填充数据，因此，为了测试，可以将其改小，这里改为1M，操作如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use config</span><br><span class="line">db.settings.save( &#123; _id:&quot;chunksize&quot;, value: 1 &#125; )</span><br></pre></td></tr></table></figure>
<h4 id="测试完改回来"><a href="#测试完改回来" class="headerlink" title="测试完改回来"></a>测试完改回来</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.settings.save( &#123; _id:&quot;chunksize&quot;, value: 64 &#125; )</span><br></pre></td></tr></table></figure>
<h4 id="注意：要先改小，再设置分片。为了测试，可以先删除集合，重新建立集合的分片策略，再插入数据测试即可"><a href="#注意：要先改小，再设置分片。为了测试，可以先删除集合，重新建立集合的分片策略，再插入数据测试即可" class="headerlink" title="注意：要先改小，再设置分片。为了测试，可以先删除集合，重新建立集合的分片策略，再插入数据测试即可"></a>注意：要先改小，再设置分片。为了测试，可以先删除集合，重新建立集合的分片策略，再插入数据测试即可</h4><h3 id="2-6-4-再增加一个路由节点"><a href="#2-6-4-再增加一个路由节点" class="headerlink" title="2.6.4 再增加一个路由节点"></a>2.6.4 再增加一个路由节点</h3><h4 id="文件夹"><a href="#文件夹" class="headerlink" title="文件夹"></a>文件夹</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-----------mongos02</span></span><br><span class="line">mkdir -p /mongodb/sharded_cluster/mymongos_27117/log</span><br></pre></td></tr></table></figure>
<h4 id="新建或修改配置文件-13"><a href="#新建或修改配置文件-13" class="headerlink" title="新建或修改配置文件"></a>新建或修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /mongodb/sharded_cluster/mymongos_27117/mongos.conf</span><br></pre></td></tr></table></figure>
<h4 id="mongos-conf-1"><a href="#mongos-conf-1" class="headerlink" title="mongos.conf"></a>mongos.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/sharded_cluster/mymongos_27117/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/sharded_cluster/mymongos_27117/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIpAll: <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">bindIp</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27117</span><br><span class="line">sharding:</span><br><span class="line">  configDB: myconfigrs/180.76.159.126:27019,180.76.159.126:27119,180.76.159.126:27219</span><br></pre></td></tr></table></figure>
<h4 id="启动mongos2"><a href="#启动mongos2" class="headerlink" title="启动mongos2"></a>启动mongos2</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongos -f</span><br><span class="line">/mongodb/sharded_cluster/mymongos_27117/mongos.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 129874</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>
<h4 id="使用mongo客户端登录-27117-，发现，第二个路由无需配置，因为分片配置都保存到了配置服务器中了"><a href="#使用mongo客户端登录-27117-，发现，第二个路由无需配置，因为分片配置都保存到了配置服务器中了" class="headerlink" title="使用mongo客户端登录 27117 ，发现，第二个路由无需配置，因为分片配置都保存到了配置服务器中了"></a>使用mongo客户端登录 27117 ，发现，第二个路由无需配置，因为分片配置都保存到了配置服务器中了</h4><h2 id="2-7-Compass连接分片集群"><a href="#2-7-Compass连接分片集群" class="headerlink" title="2.7 Compass连接分片集群"></a>2.7 Compass连接分片集群</h2><h4 id="compass连接-1"><a href="#compass连接-1" class="headerlink" title="compass连接"></a>compass连接</h4><p><img src="QQ截图20240126224029.png&quot;" alt="输入图片说明"></p>
<h4 id="提示：和连接单机mongod一样"><a href="#提示：和连接单机mongod一样" class="headerlink" title="提示：和连接单机mongod一样"></a>提示：和连接单机mongod一样</h4><h4 id="连接成功后，上方有mongos和分片集群的提示"><a href="#连接成功后，上方有mongos和分片集群的提示" class="headerlink" title="连接成功后，上方有mongos和分片集群的提示"></a>连接成功后，上方有mongos和分片集群的提示</h4><p><img src="QQ截图20240126224101.png&quot;" alt="输入图片说明"></p>
<h2 id="2-8-SpringDataMongDB连接分片集群"><a href="#2-8-SpringDataMongDB连接分片集群" class="headerlink" title="2.8 SpringDataMongDB连接分片集群"></a>2.8 SpringDataMongDB连接分片集群</h2><h4 id="Java客户端常用的是SpringDataMongoDB，其连接的是mongs路由，配置和单机mongod的配置是一样的"><a href="#Java客户端常用的是SpringDataMongoDB，其连接的是mongs路由，配置和单机mongod的配置是一样的" class="headerlink" title="Java客户端常用的是SpringDataMongoDB，其连接的是mongs路由，配置和单机mongod的配置是一样的"></a>Java客户端常用的是SpringDataMongoDB，其连接的是mongs路由，配置和单机mongod的配置是一样的</h4><h4 id="多个路由的时候的SpringDataMongoDB的客户端配置参考如下"><a href="#多个路由的时候的SpringDataMongoDB的客户端配置参考如下" class="headerlink" title="多个路由的时候的SpringDataMongoDB的客户端配置参考如下"></a>多个路由的时候的SpringDataMongoDB的客户端配置参考如下</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#数据源配置</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="comment"># 主机地址</span></span><br><span class="line">      <span class="comment"># host: 180.76.159.126</span></span><br><span class="line">      <span class="comment"># 数据库</span></span><br><span class="line">      <span class="comment"># database: articledb</span></span><br><span class="line">      <span class="comment"># 默认端口是27017</span></span><br><span class="line">      <span class="comment"># port: 27017</span></span><br><span class="line">      <span class="comment">#也可以使用uri连接</span></span><br><span class="line">      <span class="comment"># uri: mongodb://192.168.40.134:28017/articledb</span></span><br><span class="line">      <span class="comment"># 连接副本集字符串</span></span><br><span class="line">      <span class="comment"># uri: mongodb://180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019/articledb?connect=replicaSet&amp;slaveOk=true&amp;replicaSet=myrs</span></span><br><span class="line">      <span class="comment">#连接路由字符串</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">mongodb://180.76.159.126:27017,180.76.159.126:27117/articledb</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="通过日志发现，写入数据的时候，会选择一个路由写入"><a href="#通过日志发现，写入数据的时候，会选择一个路由写入" class="headerlink" title="通过日志发现，写入数据的时候，会选择一个路由写入"></a>通过日志发现，写入数据的时候，会选择一个路由写入</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2019-09-03 11:04:09.166 INFO 11816 --- [68.40.141:27117]</span><br><span class="line">org.mongodb.driver.connection : Opened connection</span><br><span class="line">[connectionId&#123;localValue:2&#125;] to 180.76.159.126:27117</span><br><span class="line">2019-09-03 11:04:09.166 INFO 11816 --- [68.40.141:27017]</span><br><span class="line">org.mongodb.driver.connection : Opened connection</span><br><span class="line">[connectionId&#123;localValue:1&#125;] to 180.76.159.126:27017</span><br><span class="line">2019-09-03 11:04:09.529 INFO 11816 --- [ main]</span><br><span class="line">org.mongodb.driver.connection : Opened connection</span><br><span class="line">[connectionId&#123;localValue:3&#125;] to 180.76.159.126:27117</span><br><span class="line">2019-09-03 11:04:09.826 INFO 11816 --- [ main]</span><br><span class="line">c.i.article.service.CommentServiceTest : Started CommentServiceTest in 7.009</span><br><span class="line">seconds (JVM running for 8.043)</span><br><span class="line">2019-09-03 11:04:10.173 INFO 11816 --- [ Thread-2]</span><br><span class="line">org.mongodb.driver.connection : Closed connection</span><br><span class="line">[connectionId&#123;localValue:3&#125;] to 180.76.159.126:27117 because the</span><br></pre></td></tr></table></figure>
<h2 id="2-9-清除所有的节点数据（备用）"><a href="#2-9-清除所有的节点数据（备用）" class="headerlink" title="2.9 清除所有的节点数据（备用）"></a>2.9 清除所有的节点数据（备用）</h2><h4 id="如果在搭建分片的时候有操作失败或配置有问题，需要重新来过的，可以进行如下操作"><a href="#如果在搭建分片的时候有操作失败或配置有问题，需要重新来过的，可以进行如下操作" class="headerlink" title="如果在搭建分片的时候有操作失败或配置有问题，需要重新来过的，可以进行如下操作"></a>如果在搭建分片的时候有操作失败或配置有问题，需要重新来过的，可以进行如下操作</h4><h4 id="第一步：查询出所有的测试服务节点的进程"><a href="#第一步：查询出所有的测试服务节点的进程" class="headerlink" title="第一步：查询出所有的测试服务节点的进程"></a>第一步：查询出所有的测试服务节点的进程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost sharded_cluster]# ps -ef |grep mongo</span><br><span class="line">root 10184 1 0 06:04 ? 00:01:25 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</span><br><span class="line">root 10219 1 0 06:04 ? 00:01:25 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</span><br><span class="line">root 10253 1 0 06:04 ? 00:00:46 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</span><br><span class="line">root 10312 1 0 06:04 ? 00:01:23 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myshardrs02_27318/mongod.conf</span><br><span class="line">root 10346 1 0 06:05 ? 00:01:23 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myshardrs02_27418/mongod.conf</span><br><span class="line">root 10380 1 0 06:05 ? 00:00:44 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myshardrs02_27518/mongod.conf</span><br><span class="line">root 10414 1 1 06:05 ? 00:01:36 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myconfigrs_27019/mongod.conf</span><br><span class="line">root 10453 1 1 06:05 ? 00:01:37 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myconfigrs_27119/mongod.conf</span><br><span class="line">root 10492 1 1 06:05 ? 00:01:38 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/sharded_cluster/myconfigrs_27219/mongod.conf</span><br><span class="line">root 11392 1 0 06:15 ? 00:00:24 /usr/local/mongodb/bin/mongos</span><br><span class="line">--config /mongodb/sharded_cluster/mymongos_27017/mongos.cfg</span><br><span class="line">root 14829 1 0 07:15 ? 00:00:13 /usr/local/mongodb/bin/mongos</span><br><span class="line">--config /mongodb/sharded_cluster/mymongos_27117/mongos.cfg</span><br></pre></td></tr></table></figure>
<h4 id="根据上述的进程编号，依次中断进程"><a href="#根据上述的进程编号，依次中断进程" class="headerlink" title="根据上述的进程编号，依次中断进程"></a>根据上述的进程编号，依次中断进程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kill -2 进程编号</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="第二步：清除所有的节点的数据"><a href="#第二步：清除所有的节点的数据" class="headerlink" title="第二步：清除所有的节点的数据"></a>第二步：清除所有的节点的数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /mongodb/sharded_cluster/myconfigrs_27019/data/db/*.* \ &amp;</span><br><span class="line">rm -rf /mongodb/sharded_cluster/myconfigrs_27119/data/db/*.* \ &amp;</span><br><span class="line">rm -rf /mongodb/sharded_cluster/myconfigrs_27219/data/db/*.* \ &amp;</span><br><span class="line">rm -rf /mongodb/sharded_cluster/myshardrs01_27018/data/db/*.* \ &amp;</span><br><span class="line">rm -rf /mongodb/sharded_cluster/myshardrs01_27118/data/db/*.* \ &amp;</span><br><span class="line">rm -rf /mongodb/sharded_cluster/myshardrs01_27218/data/db/*.* \ &amp;</span><br><span class="line">rm -rf /mongodb/sharded_cluster/myshardrs02_27318/data/db/*.* \ &amp;</span><br><span class="line">rm -rf /mongodb/sharded_cluster/myshardrs02_27418/data/db/*.* \ &amp;</span><br><span class="line">rm -rf /mongodb/sharded_cluster/myshardrs02_27518/data/db/*.* \ &amp;</span><br><span class="line">rm -rf /mongodb/sharded_cluster/mymongos_27017/data/db/*.* \ &amp;</span><br><span class="line">rm -rf /mongodb/sharded_cluster/mymongos_27117/data/db/*.*</span><br></pre></td></tr></table></figure>
<h4 id="第三步：查看或修改有问题的配置"><a href="#第三步：查看或修改有问题的配置" class="headerlink" title="第三步：查看或修改有问题的配置"></a>第三步：查看或修改有问题的配置</h4><h4 id="第四步：依次启动所有节点，不包括路由节点"><a href="#第四步：依次启动所有节点，不包括路由节点" class="headerlink" title="第四步：依次启动所有节点，不包括路由节点"></a>第四步：依次启动所有节点，不包括路由节点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27318/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27418/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27518/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27019/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27119/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27219/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="第五步：对两个数据分片副本集和一个配置副本集进行初始化和相关配置"><a href="#第五步：对两个数据分片副本集和一个配置副本集进行初始化和相关配置" class="headerlink" title="第五步：对两个数据分片副本集和一个配置副本集进行初始化和相关配置"></a>第五步：对两个数据分片副本集和一个配置副本集进行初始化和相关配置</h4><h4 id="第六步：检查路由mongos的配置，并启动mongos"><a href="#第六步：检查路由mongos的配置，并启动mongos" class="headerlink" title="第六步：检查路由mongos的配置，并启动mongos"></a>第六步：检查路由mongos的配置，并启动mongos</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/mymongos_27017/mongos.cfg</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/mymongos_27017/mongos.cfg</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="第七步：mongo登录mongos，在其上进行相关操作"><a href="#第七步：mongo登录mongos，在其上进行相关操作" class="headerlink" title="第七步：mongo登录mongos，在其上进行相关操作"></a>第七步：mongo登录mongos，在其上进行相关操作</h4><h1 id="3-安全认证"><a href="#3-安全认证" class="headerlink" title="3. 安全认证"></a>3. 安全认证</h1><h2 id="3-1-MongoDB的用户和角色权限简介"><a href="#3-1-MongoDB的用户和角色权限简介" class="headerlink" title="3.1 MongoDB的用户和角色权限简介"></a>3.1 MongoDB的用户和角色权限简介</h2><blockquote>
<p>默认情况下，MongoDB实例启动运行时是没有启用用户访问权限控制的，也就是说，在实例本机服务器上都可以随意连接到实例进行各种操作，MongoDB不会对连接客户端进行用户验证，这是非常危险的。</p>
<p>mongodb官网上说，为了能保障mongodb的安全可以做以下几个步骤：</p>
</blockquote>
<ul>
<li>1 ）使用新的端口，默认的 27017 端口如果一旦知道了ip就能连接上，不太安全。</li>
<li>2 ）设置mongodb的网络环境，最好将mongodb部署到公司服务器内网，这样外网是访问不到的。公司内部访问使用vpn等。</li>
<li>3 ）开启安全认证。认证要同时设置服务器之间的内部认证方式，同时要设置客户端连接到集群的账号密码认证方式。</li>
</ul>
<blockquote>
<p>为了强制开启用户访问控制(用户验证)，则需要在MongoDB实例启动时使用选项—auth或在指定启动配置文件中添加选项auth=true。</p>
</blockquote>
<h4 id="在开始之前需要了解一下概念"><a href="#在开始之前需要了解一下概念" class="headerlink" title="在开始之前需要了解一下概念"></a>在开始之前需要了解一下概念</h4><ul>
<li>1 ）启用访问控制：MongoDB使用的是基于角色的访问控制(Role-Based Access Control,RBAC)<br>来管理用户对实例的访问通过对用户授予一个或多个角色来控制用户访问数据库资源的权限和数据库操作的权限，在对用户分配角色之前，用户无法访问实例。在实例启动时添加选项—auth或指定启动配置文件中添加选项auth=true。</li>
<li>2 ）角色：在MongoDB中通过角色对用户授予相应数据库资源的操作权限，每个角色当中的权限可以显式指定，也可以通过继承其他角色的权限，或者两都都存在的权限。</li>
<li>3 ）权限：权限由指定的数据库资源(resource)以及允许在指定资源上进行的操作(action)组成。<ul>
<li>1.资源(resource)包括：数据库、集合、部分集合和集群；</li>
<li>2.操作(action)包括：对资源进行的增、删、改、查(CRUD)操作。</li>
</ul>
</li>
</ul>
<blockquote>
<p>在角色定义时可以包含一个或多个已存在的角色，新创建的角色会继承包含的角色所有的权限。在同一个数据库中，新创建角色可以继承其他角色的权限，在admin数据库中创建的角色可以继承在其它任意数据库中角色的权限。</p>
</blockquote>
<h4 id="关于角色权限的查看，可以通过如下命令查询（了解）"><a href="#关于角色权限的查看，可以通过如下命令查询（了解）" class="headerlink" title="关于角色权限的查看，可以通过如下命令查询（了解）"></a>关于角色权限的查看，可以通过如下命令查询（了解）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 查询所有角色权限(仅用户自定义角色)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.runCommand(&#123; rolesInfo: 1 &#125;)</span></span><br><span class="line">// 查询所有角色权限(包含内置角色)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.runCommand(&#123; rolesInfo: 1, showBuiltinRoles: <span class="literal">true</span> &#125;)</span></span><br><span class="line">// 查询当前数据库中的某角色的权限</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.runCommand(&#123; rolesInfo: <span class="string">&quot;&lt;rolename&gt;&quot;</span> &#125;)</span></span><br><span class="line">// 查询其它数据库中指定的角色权限</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.runCommand(&#123; rolesInfo: &#123; role: <span class="string">&quot;&lt;rolename&gt;&quot;</span>, db: <span class="string">&quot;&lt;database&gt;&quot;</span> &#125; &#125;</span></span><br><span class="line">// 查询多个角色权限</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.runCommand(</span></span><br><span class="line">  &#123;</span><br><span class="line">    rolesInfo: [</span><br><span class="line">    &quot;&lt;rolename&gt;&quot;,</span><br><span class="line">    &#123; role: &quot;&lt;rolename&gt;&quot;, db: &quot;&lt;database&gt;&quot; &#125;,</span><br><span class="line">    ...</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><h4 id="查看所有内置角色"><a href="#查看所有内置角色" class="headerlink" title="查看所有内置角色"></a>查看所有内置角色</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.runCommand(&#123;rolesInfo: 1,showBuiltinRoles: <span class="literal">true</span>&#125;)</span> </span><br><span class="line">&#123;</span><br><span class="line"> &quot;roles&quot;: [&#123;</span><br><span class="line">   &quot;role&quot;: &quot;__queryableBackup&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;__system&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;backup&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;clusterAdmin&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;clusterManager&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;clusterMonitor&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;dbAdmin&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;dbAdminAnyDatabase&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;dbOwner&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;enableSharding&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;hostManager&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;read&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;readAnyDatabase&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;readWrite&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;readWriteAnyDatabase&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;restore&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;root&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;userAdmin&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;role&quot;: &quot;userAdminAnyDatabase&quot;,</span><br><span class="line">   &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line">   &quot;isBuiltin&quot;: true,</span><br><span class="line">   &quot;roles&quot;: [],</span><br><span class="line">   &quot;inheritedRoles&quot;: []</span><br><span class="line">  &#125;</span><br><span class="line"> ],</span><br><span class="line"> &quot;ok&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="常用的内置角色"><a href="#常用的内置角色" class="headerlink" title="常用的内置角色"></a>常用的内置角色</h4><ul>
<li>数据库用户角色：read、readWrite;</li>
<li>所有数据库用户角色：readAnyDatabase、readWriteAnyDatabase、userAdminAnyDatabase、dbAdminAnyDatabase</li>
<li>数据库管理角色：dbAdmin、dbOwner、userAdmin；</li>
<li>集群管理角色：clusterAdmin、clusterManager、clusterMonitor、hostManager；</li>
<li>备份恢复角色：backup、restore；</li>
<li>超级用户角色：root</li>
<li>内部角色：system</li>
</ul>
<h4 id="角色说明"><a href="#角色说明" class="headerlink" title="角色说明"></a>角色说明</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">角色</th>
<th style="text-align:center">权限描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">read</td>
<td style="text-align:center">可以读取指定数据库中任何数据。</td>
</tr>
<tr>
<td style="text-align:center">readWrite</td>
<td style="text-align:center">可以读写指定数据库中任何数据，包括创建、重命名、删除集合。</td>
</tr>
<tr>
<td style="text-align:center">readAnyDatabase</td>
<td style="text-align:center">可以读取所有数据库中任何数据(除了数据库config和local之外)。</td>
</tr>
<tr>
<td style="text-align:center">readWriteAnyDatabase</td>
<td style="text-align:center">可以读写所有数据库中任何数据(除了数据库config和local之外)。</td>
</tr>
<tr>
<td style="text-align:center">userAdminAnyDatabase</td>
<td style="text-align:center">可以在指定数据库创建和修改用户(除了数据库config和local之外)。</td>
</tr>
<tr>
<td style="text-align:center">dbAdminAnyDatabase</td>
<td style="text-align:center">可以读取任何数据库以及对数据库进行清理、修改、压缩、获取统计信息、执行检查等操作(除了数据库config和local之外)。</td>
</tr>
<tr>
<td style="text-align:center">dbAdmin</td>
<td style="text-align:center">可以读取指定数据库以及对数据库进行清理、修改、压缩、获取统计信息、执行检查等操作。</td>
</tr>
<tr>
<td style="text-align:center">userAdmin</td>
<td style="text-align:center">可以在指定数据库创建和修改用户。</td>
</tr>
<tr>
<td style="text-align:center">clusterAdmin</td>
<td style="text-align:center">可以对整个集群或数据库系统进行管理操作。</td>
</tr>
<tr>
<td style="text-align:center">backup</td>
<td style="text-align:center">备份MongoDB数据最小的权限。</td>
</tr>
<tr>
<td style="text-align:center">restore</td>
<td style="text-align:center">从备份文件中还原恢复MongoDB数据(除了system.profile集合)的权限。</td>
</tr>
<tr>
<td style="text-align:center">root</td>
<td style="text-align:center">超级账号，超级权限</td>
</tr>
</tbody>
</table>
</div>
<h2 id="3-2-单实例环境"><a href="#3-2-单实例环境" class="headerlink" title="3.2 单实例环境"></a>3.2 单实例环境</h2><blockquote>
<p>目标：对单实例的MongoDB服务开启安全认证，这里的单实例指的是未开启副本集或分片的MongoDB实例。</p>
</blockquote>
<h3 id="3-2-1-关闭已开启的服务（可选）"><a href="#3-2-1-关闭已开启的服务（可选）" class="headerlink" title="3.2.1 关闭已开启的服务（可选）"></a>3.2.1 关闭已开启的服务（可选）</h3><h4 id="增加mongod的单实例的安全认证功能，可以在服务搭建的时候直接添加，也可以在之前搭建好的服务上添加"><a href="#增加mongod的单实例的安全认证功能，可以在服务搭建的时候直接添加，也可以在之前搭建好的服务上添加" class="headerlink" title="增加mongod的单实例的安全认证功能，可以在服务搭建的时候直接添加，也可以在之前搭建好的服务上添加"></a>增加mongod的单实例的安全认证功能，可以在服务搭建的时候直接添加，也可以在之前搭建好的服务上添加</h4><h4 id="本文使用之前搭建好的服务，因此，先停止之前的服务"><a href="#本文使用之前搭建好的服务，因此，先停止之前的服务" class="headerlink" title="本文使用之前搭建好的服务，因此，先停止之前的服务"></a>本文使用之前搭建好的服务，因此，先停止之前的服务</h4><h4 id="停止服务的方式有两种：快速关闭和标准关闭，下面依次说明-1"><a href="#停止服务的方式有两种：快速关闭和标准关闭，下面依次说明-1" class="headerlink" title="停止服务的方式有两种：快速关闭和标准关闭，下面依次说明"></a>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明</h4><ul>
<li>（ 1 ）快速关闭方法（快速，简单，数据可能会出错）</li>
</ul>
<h4 id="目标：通过系统的kill命令直接杀死进程"><a href="#目标：通过系统的kill命令直接杀死进程" class="headerlink" title="目标：通过系统的kill命令直接杀死进程"></a>目标：通过系统的kill命令直接杀死进程</h4><h4 id="杀完要检查一下，避免有的没有杀掉"><a href="#杀完要检查一下，避免有的没有杀掉" class="headerlink" title="杀完要检查一下，避免有的没有杀掉"></a>杀完要检查一下，避免有的没有杀掉</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通过进程编号关闭节点</span></span><br><span class="line">kill -2 54410</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="【补充】-1"><a href="#【补充】-1" class="headerlink" title="【补充】"></a>【补充】</h4><h4 id="如果一旦是因为数据损坏，则需要进行如下操作（了解）"><a href="#如果一旦是因为数据损坏，则需要进行如下操作（了解）" class="headerlink" title="如果一旦是因为数据损坏，则需要进行如下操作（了解）"></a>如果一旦是因为数据损坏，则需要进行如下操作（了解）</h4><ul>
<li>1 ）删除lock文件：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f /mongodb/single/data/db/*.lock</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>2 ）修复数据：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod --repair --dbpath=/mongodb/single/data/db</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 2 ）标准的关闭方法（数据不容易出错，但麻烦）：</li>
</ul>
<h4 id="目标：通过mongo客户端中的shutdownServer命令来关闭服务"><a href="#目标：通过mongo客户端中的shutdownServer命令来关闭服务" class="headerlink" title="目标：通过mongo客户端中的shutdownServer命令来关闭服务"></a>目标：通过mongo客户端中的shutdownServer命令来关闭服务</h4><h4 id="主要的操作步骤参考如下"><a href="#主要的操作步骤参考如下" class="headerlink" title="主要的操作步骤参考如下"></a>主要的操作步骤参考如下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27017</span><br><span class="line"><span class="meta prompt_">//#</span><span class="language-bash">切换到admin库</span></span><br><span class="line">use admin</span><br><span class="line">//关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure>
<h3 id="3-2-2-添加用户和权限"><a href="#3-2-2-添加用户和权限" class="headerlink" title="3.2.2 添加用户和权限"></a>3.2.2 添加用户和权限</h3><ul>
<li>（ 1 ）先按照普通无授权认证的配置，来配置服务端的配置文件/mongodb/single/mongod.conf：</li>
</ul>
<h4 id="（参考，复用之前课程的）"><a href="#（参考，复用之前课程的）" class="headerlink" title="（参考，复用之前课程的）"></a>（参考，复用之前课程的）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">MongoDB发送所有日志输出的目标指定为文件</span></span><br><span class="line">  destination: file</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span></span><br><span class="line">  path: &quot;/mongodb/single/log/mongod.log&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span></span><br><span class="line">  logAppend: true</span><br><span class="line">storage:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span></span><br><span class="line">  dbPath: &quot;/mongodb/single/data/db&quot;</span><br><span class="line">  journal:</span><br><span class="line">    #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">    enabled: true</span><br><span class="line">processManagement:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">启用在后台运行mongos或mongod进程的守护进程模式。</span></span><br><span class="line">  fork: true</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span></span><br><span class="line">  pidFilePath: &quot;/mongodb/single/log/mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">服务实例绑定的IP</span></span><br><span class="line">  bindIp: localhost,192.168.0.2</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">绑定的端口</span></span><br><span class="line">  port: 27017</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 2 ）按之前未开启认证的方式（不添加—auth参数）来启动MongoDB服务：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="提示-13"><a href="#提示-13" class="headerlink" title="提示"></a>提示</h4><h4 id="在操作用户时，启动mongod服务时尽量不要开启授权"><a href="#在操作用户时，启动mongod服务时尽量不要开启授权" class="headerlink" title="在操作用户时，启动mongod服务时尽量不要开启授权"></a>在操作用户时，启动mongod服务时尽量不要开启授权</h4><ul>
<li>（ 3 ）使用Mongo客户端登录：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongo --host 180.76.159.126 --port 27017</span><br></pre></td></tr></table></figure>
<ul>
<li>（ 4 ）创建两个管理员用户，一个是系统的超级管理员myroot，一个是admin库的管理用户 myadmin：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">//切换到admin库</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">use admin</span></span><br><span class="line">//创建系统超级用户 myroot,设置密码123456，设置角色root</span><br><span class="line"><span class="meta prompt_">//&gt; </span><span class="language-bash">db.createUser(&#123;user:<span class="string">&quot;myroot&quot;</span>,<span class="built_in">pwd</span>:<span class="string">&quot;123456&quot;</span>,roles:[ &#123; <span class="string">&quot;role&quot;</span> : <span class="string">&quot;root&quot;</span>, <span class="string">&quot;db&quot;</span> :</span></span><br><span class="line">&quot;admin&quot; &#125; ]&#125;)</span><br><span class="line">//或</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.createUser(&#123;user:<span class="string">&quot;myroot&quot;</span>,<span class="built_in">pwd</span>:<span class="string">&quot;123456&quot;</span>,roles:[<span class="string">&quot;root&quot;</span>]&#125;)</span></span><br><span class="line">Successfully added user: &#123; &quot;user&quot; : &quot;myroot&quot;, &quot;roles&quot; : [ &quot;root&quot; ] &#125;</span><br><span class="line">//创建专门用来管理admin库的账号myadmin，只用来作为用户权限的管理</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.createUser(&#123;</span></span><br><span class="line"> user: &quot;myroot&quot;,</span><br><span class="line"> pwd: &quot;123456&quot;,</span><br><span class="line"> roles: [&quot;root&quot;]</span><br><span class="line">&#125;)</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">  &quot;user&quot;: &quot;myroot&quot;,</span><br><span class="line">  &quot;roles&quot;: [&quot;root&quot;]</span><br><span class="line"> &#125;</span><br><span class="line"> //创建专门用来管理admin库的账号myadmin，只用来作为用户权限的管理</span><br><span class="line"><span class="meta prompt_"> &gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"> db.createUser(&#123;</span></span><br><span class="line">  user: &quot;myadmin&quot;,</span><br><span class="line">  pwd: &quot;123456&quot;,</span><br><span class="line">  roles: [&#123;</span><br><span class="line">   role: &quot;userAdminAnyDatabase&quot;,</span><br><span class="line">   db: &quot;admin&quot;</span><br><span class="line">  &#125;]</span><br><span class="line"> &#125;)</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line"> &quot;user&quot;: &quot;myadmin&quot;,</span><br><span class="line"> &quot;roles&quot;: [&#123;</span><br><span class="line">  &quot;role&quot;: &quot;userAdminAnyDatabase&quot;,</span><br><span class="line">  &quot;db&quot;: &quot;admin&quot;</span><br><span class="line"> &#125;]</span><br><span class="line">&#125; &#123;</span><br><span class="line"> &quot;_id&quot;: &quot;admin.myroot&quot;,</span><br><span class="line"> &quot;userId&quot;: UUID(&quot;9a0a698c-73ad-4c45-8f33-</span><br><span class="line">  e8a90d3ad689 &quot;), &quot;</span><br><span class="line">  user &quot; : &quot;</span><br><span class="line">  myroot &quot;, &quot;</span><br><span class="line">  db &quot; : &quot;</span><br><span class="line">  admin &quot;, &quot;</span><br><span class="line">  credentials &quot; : &#123; &quot;</span><br><span class="line">  SCRAM - SHA 1 &quot; : &#123; &quot;</span><br><span class="line">  iterationCount &quot; : 10000, &quot;</span><br><span class="line">  salt &quot; : &quot;</span><br><span class="line">  4 tXXi9g9wMlrR32e + NleyA == &quot;,</span><br><span class="line">  &quot;storedKey&quot;: &quot;78EXQoWeA6lLYTTzcQrtJuWLcmg=&quot;, &quot;serverKey&quot;:</span><br><span class="line">  &quot;xwze/lGcQ7FI5cSFoilY4CW4Wks=&quot;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;SCRAM-SHA-256&quot;: &#123;</span><br><span class="line">  &quot;iterationCount&quot;: 15000,</span><br><span class="line">  &quot;salt&quot;: &quot;+Hq2Y6PiNFkDEBYFertTaZSWI9FqbkYGdHaFkg==&quot;,</span><br><span class="line">  &quot;storedKey&quot;: &quot;gUZ5Wyl7dsjtu77Isw2dsJ+Ck4fKiKZteUh/CuJoQj4=&quot;,</span><br><span class="line">  &quot;serverKey&quot;: &quot;4WiBApuB435LNPP49DxKwJ+YGcRaWZNvEq/Ibkr5Lxo=&quot;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;, &quot;roles&quot;: [&#123;</span><br><span class="line"> &quot;role&quot;: &quot;root&quot;,</span><br><span class="line"> &quot;db&quot;: &quot;admin&quot;</span><br><span class="line">&#125;]</span><br><span class="line">&#125; &#123;</span><br><span class="line"> &quot;_id&quot;: &quot;admin.myadmin&quot;,</span><br><span class="line"> &quot;userId&quot;: UUID(&quot;be9c832e-f894-4ffd-b76b62940707aab2&quot;),</span><br><span class="line"> &quot;user&quot;: &quot;myadmin&quot;,</span><br><span class="line"> &quot;db&quot;: &quot;admin&quot;,</span><br><span class="line"> &quot;credentials&quot;: &#123;</span><br><span class="line">  &quot;SCRAMSHA-1&quot;: &#123;</span><br><span class="line">   &quot;iterationCount&quot;: 10000,</span><br><span class="line">   &quot;salt&quot;: &quot;KIIoSNfp5kTgpUExtTKDTA==&quot;,</span><br><span class="line">   &quot;storedKey&quot;: &quot;39509XHQiWi8HWLc6qMDf13WcSs=&quot;,</span><br><span class="line">   &quot;serverKey&quot;: &quot;zKkJAKH3HgPL35/a6hkhBaCD1WE=&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;SCRAM-SHA-256&quot;: &#123;</span><br><span class="line">   &quot;iterationCount&quot;: 15000,</span><br><span class="line">   &quot;salt&quot;: &quot;v76GZgBAKsWNewB7mo6dhSE59ME3HFJ5T9UXlQ==&quot;,</span><br><span class="line">   &quot;storedKey&quot;: &quot;CwHtBiww04Y0hycHKqq4VIS5QnnuAne59+iPFooIhkk=&quot;,</span><br><span class="line">   &quot;serverKey&quot;: &quot;HQk3RTSWDABGwxYPEiEC2+iK/rGTL6ROAD0HQEJI0F8=&quot;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;roles&quot;: [&#123;</span><br><span class="line">  &quot;role&quot;: &quot;userAdminAnyDatabase&quot;,</span><br><span class="line">  &quot;db&quot;: &quot;admin&quot;</span><br><span class="line"> &#125;]</span><br><span class="line">&#125;</span><br><span class="line">//删除用户</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.dropUser(<span class="string">&quot;myadmin&quot;</span>)</span></span><br><span class="line">true</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.system.users.find()</span></span><br><span class="line">//修改密码</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.changeUserPassword(<span class="string">&quot;myroot&quot;</span>, <span class="string">&quot;123456&quot;</span>)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="提示-14"><a href="#提示-14" class="headerlink" title="提示"></a>提示</h4><ul>
<li>1 ）本案例创建了两个用户，分别对应超管和专门用来管理用户的角色，事实上，你只需要一个用户即可。如果你对安全要求很高，防止超管泄漏，则不要创建超管用户。</li>
<li>2 ）和其它数据库（MySQL）一样，权限的管理都差不多一样，也是将用户和权限信息保存到数据库对应的表中。Mongodb存储所有的用户信息在admin数据库的集合system.users中，保存用户名、密码和数据库信息。</li>
<li><p>3 ）如果不指定数据库，则创建的指定的权限的用户在所有的数据库上有效，如{role:”userAdminAnyDatabase”, db:””}</p>
</li>
<li><p>（ 5 ）认证测试</p>
</li>
</ul>
<h4 id="测试添加的用户是否正确"><a href="#测试添加的用户是否正确" class="headerlink" title="测试添加的用户是否正确"></a>测试添加的用户是否正确</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//切换到admin</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">use admin</span></span><br><span class="line">//密码输错</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.auth(<span class="string">&quot;myroot&quot;</span>,<span class="string">&quot;12345&quot;</span>)</span></span><br><span class="line">Error: Authentication failed.</span><br><span class="line">0</span><br><span class="line">//密码正确</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.auth(<span class="string">&quot;myroot&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<h4 id="（-6-）创建普通用户"><a href="#（-6-）创建普通用户" class="headerlink" title="（ 6 ）创建普通用户"></a>（ 6 ）创建普通用户</h4><blockquote>
<p>创建普通用户可以在没有开启认证的时候添加，也可以在开启认证之后添加，但开启认证之后，必须使用有操作admin库的用户登录认证后才能操作。底层都是将用户信息保存在了admin数据库的集合system.users中。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//创建(切换)将来要操作的数据库articledb,</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">use articledb</span></span><br><span class="line">switched to db articledb</span><br><span class="line">//创建用户，拥有articledb数据库的读写权限readWrite，密码是123456</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.createUser(&#123;user: <span class="string">&quot;bobo&quot;</span>, <span class="built_in">pwd</span>: <span class="string">&quot;123456&quot;</span>, roles: [&#123; role: <span class="string">&quot;readWrite&quot;</span>, db:</span></span><br><span class="line">&quot;articledb&quot; &#125;]&#125;)</span><br><span class="line"><span class="meta prompt_">//&gt; </span><span class="language-bash">db.createUser(&#123;user: <span class="string">&quot;bobo&quot;</span>, <span class="built_in">pwd</span>: <span class="string">&quot;123456&quot;</span>, roles: [<span class="string">&quot;readWrite&quot;</span>]&#125;)</span></span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">  &quot;user&quot; : &quot;bobo&quot;,</span><br><span class="line">  &quot;roles&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;role&quot; : &quot;readWrite&quot;,</span><br><span class="line">      &quot;db&quot; : &quot;articledb&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">//测试是否可用</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.auth(<span class="string">&quot;bobo&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span></span><br><span class="line">1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="提示-15"><a href="#提示-15" class="headerlink" title="提示"></a>提示</h4><h4 id="如果开启了认证后，登录的客户端的用户必须使用admin库的角色，如拥有root角色的myadmin用户，再通过myadmin用户去创建其他角色的用户"><a href="#如果开启了认证后，登录的客户端的用户必须使用admin库的角色，如拥有root角色的myadmin用户，再通过myadmin用户去创建其他角色的用户" class="headerlink" title="如果开启了认证后，登录的客户端的用户必须使用admin库的角色，如拥有root角色的myadmin用户，再通过myadmin用户去创建其他角色的用户"></a>如果开启了认证后，登录的客户端的用户必须使用admin库的角色，如拥有root角色的myadmin用户，再通过myadmin用户去创建其他角色的用户</h4><h3 id="3-2-3-服务端开启认证和客户端连接登录"><a href="#3-2-3-服务端开启认证和客户端连接登录" class="headerlink" title="3.2.3 服务端开启认证和客户端连接登录"></a>3.2.3 服务端开启认证和客户端连接登录</h3><h4 id="（-1-）关闭已经启动的服务"><a href="#（-1-）关闭已经启动的服务" class="headerlink" title="（ 1 ）关闭已经启动的服务"></a>（ 1 ）关闭已经启动的服务</h4><ul>
<li>1 ）使用linux命令杀死进程：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost single]# ps -ef |grep mongo</span><br><span class="line">root 23482 1 0 08:08 ? 00:00:55 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/single/mongod.conf</span><br><span class="line">[root@bobohost single]# kill -2 23482</span><br></pre></td></tr></table></figure>
<ul>
<li>2 ）在mongo客户端中使用shutdownServer命令来关闭。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.shutdownServer()</span></span><br><span class="line">shutdown command only works with the admin database;</span><br><span class="line">try &#x27;use admin&#x27; &gt;</span><br><span class="line">use admin</span><br><span class="line">switched to db admin</span><br><span class="line"><span class="meta prompt_"> &gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"> db.shutdownServer()</span></span><br><span class="line">2019 - 08 - 14 T11: 20: 16.450 + 0800 E QUERY[js] Error: shutdownServer failed: &#123;</span><br><span class="line">  &quot;ok&quot;: 0,</span><br><span class="line">  &quot;errmsg&quot;: &quot;shutdown must run from localhost when running db without</span><br><span class="line">  auth &quot;,</span><br><span class="line">  &quot;code&quot;: 13,</span><br><span class="line">  &quot;codeName&quot;: &quot;Unauthorized&quot;</span><br><span class="line"></span><br><span class="line"> &#125;:</span><br><span class="line"> _getErrorWithCode @src / mongo / shell / utils.js: 25: 13</span><br><span class="line">DB.prototype.shutdownServer @src / mongo / shell / db.js: 453: 1</span><br><span class="line">@(shell): 1: 1</span><br></pre></td></tr></table></figure>
<h4 id="需要几个条件"><a href="#需要几个条件" class="headerlink" title="需要几个条件"></a>需要几个条件</h4><ul>
<li>必须是在admin库下执行该关闭服务命令。</li>
<li>如果没有开启认证，必须是从localhost登陆的，才能执行关闭服务命令。</li>
<li>非localhost的、通过远程登录的，必须有登录且必须登录用户有对admin操作权限才可以。</li>
</ul>
<h4 id="（-2-）以开启认证的方式启动服务"><a href="#（-2-）以开启认证的方式启动服务" class="headerlink" title="（ 2 ）以开启认证的方式启动服务"></a>（ 2 ）以开启认证的方式启动服务</h4><h4 id="有两种方式开启权限认证启动服务：一种是参数方式，一种是配置文件方式"><a href="#有两种方式开启权限认证启动服务：一种是参数方式，一种是配置文件方式" class="headerlink" title="有两种方式开启权限认证启动服务：一种是参数方式，一种是配置文件方式"></a>有两种方式开启权限认证启动服务：一种是参数方式，一种是配置文件方式</h4><ul>
<li>1 ）参数方式</li>
</ul>
<h4 id="在启动时指定参数—auth，如"><a href="#在启动时指定参数—auth，如" class="headerlink" title="在启动时指定参数—auth，如"></a>在启动时指定参数—auth，如</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf --auth</span><br></pre></td></tr></table></figure>
<ul>
<li>2 ）配置文件方式</li>
</ul>
<h4 id="在mongod-conf配置文件中加入"><a href="#在mongod-conf配置文件中加入" class="headerlink" title="在mongod.conf配置文件中加入"></a>在mongod.conf配置文件中加入</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mongodb/single/mongod.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">#开启授权认证</span><br><span class="line">authorization: enabled</span><br></pre></td></tr></table></figure>
<h4 id="启动时可不加—auth参数"><a href="#启动时可不加—auth参数" class="headerlink" title="启动时可不加—auth参数"></a>启动时可不加—auth参数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="（-3-）开启了认证的情况下的客户端登录"><a href="#（-3-）开启了认证的情况下的客户端登录" class="headerlink" title="（ 3 ）开启了认证的情况下的客户端登录"></a>（ 3 ）开启了认证的情况下的客户端登录</h4><h4 id="有两种认证方式，一种是先登录，在mongo-shell中认证；一种是登录时直接认证"><a href="#有两种认证方式，一种是先登录，在mongo-shell中认证；一种是登录时直接认证" class="headerlink" title="有两种认证方式，一种是先登录，在mongo shell中认证；一种是登录时直接认证"></a>有两种认证方式，一种是先登录，在mongo shell中认证；一种是登录时直接认证</h4><ul>
<li>1 ）先连接再认证</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port</span><br><span class="line">27017</span><br><span class="line">MongoDB shell version v4.0.10</span><br><span class="line">connecting to: mongodb://180.76.159.126:27017/?gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;53fef661-35d6-4d29-b07c-020291d62e1a&quot;)</span><br><span class="line">&#125;</span><br><span class="line">MongoDB server version: 4.0.10</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"></span></span><br></pre></td></tr></table></figure>
<h4 id="提示-16"><a href="#提示-16" class="headerlink" title="提示"></a>提示</h4><h4 id="开启认证后再登录，发现打印的日志比较少了"><a href="#开启认证后再登录，发现打印的日志比较少了" class="headerlink" title="开启认证后再登录，发现打印的日志比较少了"></a>开启认证后再登录，发现打印的日志比较少了</h4><h4 id="相关操作需要认证才可以"><a href="#相关操作需要认证才可以" class="headerlink" title="相关操作需要认证才可以"></a>相关操作需要认证才可以</h4><h4 id="查询admin库中的system-users集合的用户"><a href="#查询admin库中的system-users集合的用户" class="headerlink" title="查询admin库中的system.users集合的用户"></a>查询admin库中的system.users集合的用户</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">use admin</span></span><br><span class="line">switched to db admin</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.system.users.find()</span></span><br><span class="line">Error: error: &#123;</span><br><span class="line">  &quot;ok&quot; : 0,</span><br><span class="line">  &quot;errmsg&quot; : &quot;command find requires authentication&quot;,</span><br><span class="line">  &quot;code&quot; : 13,</span><br><span class="line">  &quot;codeName&quot; : &quot;Unauthorized&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.auth(<span class="string">&quot;myroot&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span></span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.system.users.find()</span></span><br></pre></td></tr></table></figure>
<h4 id="查询articledb库中的comment集合的内容"><a href="#查询articledb库中的comment集合的内容" class="headerlink" title="查询articledb库中的comment集合的内容"></a>查询articledb库中的comment集合的内容</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">use articledb</span></span><br><span class="line">switched to db articledb</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.comment.find()</span></span><br><span class="line">Error: error: &#123;</span><br><span class="line">  &quot;ok&quot; : 0,</span><br><span class="line">  &quot;errmsg&quot; : &quot;not authorized on articledb to execute command &#123; find:</span><br><span class="line">  \&quot;comment\&quot;, filter: &#123;&#125;, lsid: &#123; id: UUID(\&quot;53fef661-35d6-4d29-b07c020291d62e1a\&quot;) &#125;, $db: \&quot;articledb\&quot; &#125;&quot;,</span><br><span class="line">  &quot;code&quot; : 13,</span><br><span class="line">  &quot;codeName&quot; : &quot;Unauthorized&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.auth(<span class="string">&quot;bobo&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span></span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.comment.find()</span></span><br><span class="line">Error: error: &#123;</span><br><span class="line">  &quot;ok&quot; : 0,</span><br><span class="line">  &quot;errmsg&quot; : &quot;too many users are authenticated&quot;,</span><br><span class="line">  &quot;code&quot; : 13,</span><br><span class="line">  &quot;codeName&quot; : &quot;Unauthorized&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="提示-17"><a href="#提示-17" class="headerlink" title="提示"></a>提示</h4><h4 id="这里可能出现错误，说是太多的用户正在认证了。因为我们确实连续登录了两个用户了"><a href="#这里可能出现错误，说是太多的用户正在认证了。因为我们确实连续登录了两个用户了" class="headerlink" title="这里可能出现错误，说是太多的用户正在认证了。因为我们确实连续登录了两个用户了"></a>这里可能出现错误，说是太多的用户正在认证了。因为我们确实连续登录了两个用户了</h4><h4 id="解决方案：退出shell，重新进来登录认证"><a href="#解决方案：退出shell，重新进来登录认证" class="headerlink" title="解决方案：退出shell，重新进来登录认证"></a>解决方案：退出shell，重新进来登录认证</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line">bye</span><br><span class="line">[root@bobohost bin]# ./mongo --host 180.76.159.126 --port 27017</span><br><span class="line">MongoDB shell version v4.0.10</span><br><span class="line">connecting to: mongodb://180.76.159.126:27017/?gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;329c1897-566d-4231-bcb3-b2acda301863&quot;)</span><br><span class="line">&#125;</span><br><span class="line">MongoDB server version: 4.0.10</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.auth(<span class="string">&quot;bobo&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span></span><br><span class="line">Error: Authentication failed.</span><br><span class="line">0</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">use articledb</span></span><br><span class="line">switched to db articledb</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.auth(<span class="string">&quot;bobo&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span></span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.comment.find()</span></span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>2 ）连接时直接认证</li>
</ul>
<h4 id="对admin数据库进行登录认证和相关操作"><a href="#对admin数据库进行登录认证和相关操作" class="headerlink" title="对admin数据库进行登录认证和相关操作"></a>对admin数据库进行登录认证和相关操作</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port</span><br><span class="line">27017 --authenticationDatabase admin -u myroot -p 123456</span><br><span class="line">MongoDB shell version v4.0.10</span><br><span class="line">connecting to: mongodb://180.76.159.126:27017/?</span><br><span class="line">authSource=admin&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;f959b8d6-6994-44bc-9d35-09fc7cd00ba6&quot;)</span><br><span class="line">&#125;</span><br><span class="line">MongoDB server version: 4.0.10</span><br><span class="line">Server has startup warnings:</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] ** WARNING: You are</span><br><span class="line">running this process as the root user, which is not recommended.</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] ** WARNING:</span><br><span class="line">/sys/kernel/mm/transparent_hugepage/enabled is &#x27;always&#x27;.</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] ** We suggest</span><br><span class="line">setting it to &#x27;never&#x27;</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] ** WARNING:</span><br><span class="line">/sys/kernel/mm/transparent_hugepage/defrag is &#x27;always&#x27;.</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] ** We suggest</span><br><span class="line">setting it to &#x27;never&#x27;</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">show dbs;</span></span><br><span class="line">admin 0.000GB</span><br><span class="line">articledb 0.000GB</span><br><span class="line">config 0.000GB</span><br><span class="line">local 0.000GB</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="对articledb数据库进行登录认证和相关操作"><a href="#对articledb数据库进行登录认证和相关操作" class="headerlink" title="对articledb数据库进行登录认证和相关操作"></a>对articledb数据库进行登录认证和相关操作</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port</span><br><span class="line">27017 --authenticationDatabase articledb -u bobo -p 123456</span><br><span class="line">MongoDB shell version v4.0.10</span><br><span class="line">connecting to: mongodb://180.76.159.126:27017/?</span><br><span class="line">authSource=articledb&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;e5d4148f-373b-45b8-9cff-a927ce617100&quot;)</span><br><span class="line">&#125;</span><br><span class="line">MongoDB server version: 4.0.10</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">use articledb</span></span><br><span class="line">switched to db articledb</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.comment.find()</span></span><br></pre></td></tr></table></figure>
<h4 id="提示-18"><a href="#提示-18" class="headerlink" title="提示"></a>提示</h4><ul>
<li>u：用户名</li>
<li>p：密码</li>
<li>-authenticationDatabase：指定连接到哪个库。当登录是指定用户名密码时，必须指定对应的数据库！</li>
</ul>
<h3 id="3-2-4-SpringDataMongoDB连接认证"><a href="#3-2-4-SpringDataMongoDB连接认证" class="headerlink" title="3.2.4 SpringDataMongoDB连接认证"></a>3.2.4 SpringDataMongoDB连接认证</h3><blockquote>
<p>使用用户名和密码连接到 MongoDB 服务器，你必须使用’username:password@hostname/dbname’ 格式，’username’为用户名，’password’<br>为密码。</p>
</blockquote>
<h4 id="目标：使用用户bobo使用密码-123456-连接到MongoDB-服务上"><a href="#目标：使用用户bobo使用密码-123456-连接到MongoDB-服务上" class="headerlink" title="目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上"></a>目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上</h4><h4 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment">#数据源配置</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="comment"># 主机地址</span></span><br><span class="line">      <span class="comment"># host: 180.76.159.126</span></span><br><span class="line">      <span class="comment"># 数据库</span></span><br><span class="line">      <span class="comment"># database: articledb</span></span><br><span class="line">      <span class="comment"># 默认端口是27017</span></span><br><span class="line">      <span class="comment"># port: 27017</span></span><br><span class="line">      <span class="comment">#帐号</span></span><br><span class="line">      <span class="comment"># username: bobo</span></span><br><span class="line">      <span class="comment">#密码</span></span><br><span class="line">      <span class="comment"># password: 123456</span></span><br><span class="line">      <span class="comment">#单机有认证的情况下，也使用字符串连接</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">mongodb://bobo:123456@180.76.159.126:27017/articledb</span></span><br></pre></td></tr></table></figure>
<h4 id="提示-19"><a href="#提示-19" class="headerlink" title="提示"></a>提示</h4><h4 id="分别测试用户名密码正确以及不正确的情况"><a href="#分别测试用户名密码正确以及不正确的情况" class="headerlink" title="分别测试用户名密码正确以及不正确的情况"></a>分别测试用户名密码正确以及不正确的情况</h4><h2 id="3-3-副本集环境"><a href="#3-3-副本集环境" class="headerlink" title="3.3 副本集环境"></a>3.3 副本集环境</h2><h3 id="3-3-1-前言"><a href="#3-3-1-前言" class="headerlink" title="3.3.1 前言"></a>3.3.1 前言</h3><h4 id="对于搭建好的mongodb副本集，为了安全，启动安全认证，使用账号密码登录"><a href="#对于搭建好的mongodb副本集，为了安全，启动安全认证，使用账号密码登录" class="headerlink" title="对于搭建好的mongodb副本集，为了安全，启动安全认证，使用账号密码登录"></a>对于搭建好的mongodb副本集，为了安全，启动安全认证，使用账号密码登录</h4><h4 id="副本集环境使用之前搭建好的，架构如下"><a href="#副本集环境使用之前搭建好的，架构如下" class="headerlink" title="副本集环境使用之前搭建好的，架构如下"></a>副本集环境使用之前搭建好的，架构如下</h4><p><img src="QQ截图20240126231041.png&quot;" alt="输入图片说明"></p>
<h4 id="对副本集执行访问控制需要配置两个方面"><a href="#对副本集执行访问控制需要配置两个方面" class="headerlink" title="对副本集执行访问控制需要配置两个方面"></a>对副本集执行访问控制需要配置两个方面</h4><ul>
<li>1 ）副本集和共享集群的各个节点成员之间使用内部身份验证，可以使用密钥文件或x.509证书。密钥文<br>件比较简单，本文使用密钥文件，官方推荐如果是测试环境可以使用密钥文件，但是正式环境，官方推荐x.509证书。原理就是，集群中每一个实例彼此连接的时候都检验彼此使用的证书的内容是否相同。只有证书相同的实例彼此才可以访问</li>
<li>2 ）使用客户端连接到mongodb集群时，开启访问授权。对于集群外部的访问。如通过可视化客户端，或者通过代码连接的时候，需要开启授权。</li>
</ul>
<blockquote>
<p>在keyfile身份验证中，副本集中的每个mongod实例都使用keyfile的内容作为共享密码，只有具有正确密钥文件的mongod或者mongos实例可以连接到副本集。密钥文件的内容必须在<br>6 到 1024 个字符之间，并且在unix/linux系统中文件所有者必须有对文件至少有读的权限。</p>
</blockquote>
<h3 id="3-3-2-关闭已开启的副本集服务（可选）"><a href="#3-3-2-关闭已开启的副本集服务（可选）" class="headerlink" title="3.3.2 关闭已开启的副本集服务（可选）"></a>3.3.2 关闭已开启的副本集服务（可选）</h3><h4 id="增加副本集的安全认证和服务鉴权功能，可以在副本集搭建的时候直接添加，也可以在之前搭建好的副本集服务上添加"><a href="#增加副本集的安全认证和服务鉴权功能，可以在副本集搭建的时候直接添加，也可以在之前搭建好的副本集服务上添加" class="headerlink" title="增加副本集的安全认证和服务鉴权功能，可以在副本集搭建的时候直接添加，也可以在之前搭建好的副本集服务上添加"></a>增加副本集的安全认证和服务鉴权功能，可以在副本集搭建的时候直接添加，也可以在之前搭建好的副本集服务上添加</h4><h4 id="本文使用之前搭建好的副本集服务，因此，先停止之前的集群服务"><a href="#本文使用之前搭建好的副本集服务，因此，先停止之前的集群服务" class="headerlink" title="本文使用之前搭建好的副本集服务，因此，先停止之前的集群服务"></a>本文使用之前搭建好的副本集服务，因此，先停止之前的集群服务</h4><h4 id="停止服务的方式有两种：快速关闭和标准关闭，下面依次说明-2"><a href="#停止服务的方式有两种：快速关闭和标准关闭，下面依次说明-2" class="headerlink" title="停止服务的方式有两种：快速关闭和标准关闭，下面依次说明"></a>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明</h4><h4 id="（-1-）快速关闭方法（快速，简单，数据可能会出错）"><a href="#（-1-）快速关闭方法（快速，简单，数据可能会出错）" class="headerlink" title="（ 1 ）快速关闭方法（快速，简单，数据可能会出错）"></a>（ 1 ）快速关闭方法（快速，简单，数据可能会出错）</h4><h4 id="目标：通过系统的kill命令直接杀死进程-1"><a href="#目标：通过系统的kill命令直接杀死进程-1" class="headerlink" title="目标：通过系统的kill命令直接杀死进程"></a>目标：通过系统的kill命令直接杀死进程</h4><h4 id="依次杀死仲裁者、副本节点、主节点，直到所有成员都离线。建议主节点最后kill，以避免潜在的回滚。杀完要检查一下，避免有的没有杀掉"><a href="#依次杀死仲裁者、副本节点、主节点，直到所有成员都离线。建议主节点最后kill，以避免潜在的回滚。杀完要检查一下，避免有的没有杀掉" class="headerlink" title="依次杀死仲裁者、副本节点、主节点，直到所有成员都离线。建议主节点最后kill，以避免潜在的回滚。杀完要检查一下，避免有的没有杀掉"></a>依次杀死仲裁者、副本节点、主节点，直到所有成员都离线。建议主节点最后kill，以避免潜在的回滚。杀完要检查一下，避免有的没有杀掉</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通过进程编号关闭节点</span></span><br><span class="line">kill -2 54410</span><br></pre></td></tr></table></figure>
<h4 id="【补充】-2"><a href="#【补充】-2" class="headerlink" title="【补充】"></a>【补充】</h4><h4 id="如果一旦是因为数据损坏，则需要进行如下操作（了解）-1"><a href="#如果一旦是因为数据损坏，则需要进行如下操作（了解）-1" class="headerlink" title="如果一旦是因为数据损坏，则需要进行如下操作（了解）"></a>如果一旦是因为数据损坏，则需要进行如下操作（了解）</h4><ul>
<li>1 ）删除lock文件：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm -f /mongodb/replica_sets/myrs_27017/data/db/*.lock \</span><br><span class="line">/mongodb/replica_sets/myrs_27018/data/db/*.lock \</span><br><span class="line">/mongodb/replica_sets/myrs_27019/data/db/mongod.lock \</span><br></pre></td></tr></table></figure>
<ul>
<li>2 ）依次修复数据：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/replica_sets/myrs_27017/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/replica_sets/myrs_27018/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/replica_sets/myrs_27019/data/db</span><br></pre></td></tr></table></figure>
<h4 id="（-2-）标准的关闭方法（数据不容易出错，但麻烦）"><a href="#（-2-）标准的关闭方法（数据不容易出错，但麻烦）" class="headerlink" title="（ 2 ）标准的关闭方法（数据不容易出错，但麻烦）"></a>（ 2 ）标准的关闭方法（数据不容易出错，但麻烦）</h4><blockquote>
<p>目标：通过mongo客户端中的shutdownServer命令来依次关闭各个服务关闭副本集中的服务，建议依次关闭仲裁节点、副本节点、主节点。主要的操作步骤参考如下：</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27017</span><br><span class="line">//告知副本集说本机要下线</span><br><span class="line">rs.stepDown()</span><br><span class="line"><span class="meta prompt_">//#</span><span class="language-bash">切换到admin库</span></span><br><span class="line">use admin</span><br><span class="line">//关闭服务</span><br><span class="line">db.shutdownServer()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-3-3-通过主节点添加一个管理员帐号"><a href="#3-3-3-通过主节点添加一个管理员帐号" class="headerlink" title="3.3.3 通过主节点添加一个管理员帐号"></a>3.3.3 通过主节点添加一个管理员帐号</h3><h4 id="只需要在主节点上添加用户，副本集会自动同步"><a href="#只需要在主节点上添加用户，副本集会自动同步" class="headerlink" title="只需要在主节点上添加用户，副本集会自动同步"></a>只需要在主节点上添加用户，副本集会自动同步</h4><h4 id="开启认证之前，创建超管用户：myroot，密码：-123456"><a href="#开启认证之前，创建超管用户：myroot，密码：-123456" class="headerlink" title="开启认证之前，创建超管用户：myroot，密码： 123456"></a>开启认证之前，创建超管用户：myroot，密码： 123456</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">myrs:PRIMARY&gt; db.createUser(&#123;user:&quot;myroot&quot;,pwd:&quot;123456&quot;,roles:[&quot;root&quot;]&#125;)</span><br><span class="line">Successfully added user: &#123; &quot;user&quot; : &quot;myroot&quot;, &quot;roles&quot; : [ &quot;root&quot; ] &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="详细操作详见单实例环境的添加用户和权限的相关操作"><a href="#详细操作详见单实例环境的添加用户和权限的相关操作" class="headerlink" title="详细操作详见单实例环境的添加用户和权限的相关操作"></a>详细操作详见单实例环境的添加用户和权限的相关操作</h4><h4 id="提示-20"><a href="#提示-20" class="headerlink" title="提示"></a>提示</h4><h4 id="该步骤也可以在开启认证之后，但需要通过localhost登录才允许添加用户，用户数据也会自动同步到副本集"><a href="#该步骤也可以在开启认证之后，但需要通过localhost登录才允许添加用户，用户数据也会自动同步到副本集" class="headerlink" title="该步骤也可以在开启认证之后，但需要通过localhost登录才允许添加用户，用户数据也会自动同步到副本集"></a>该步骤也可以在开启认证之后，但需要通过localhost登录才允许添加用户，用户数据也会自动同步到副本集</h4><h4 id="后续再创建其他用户，都可以使用该超管用户创建"><a href="#后续再创建其他用户，都可以使用该超管用户创建" class="headerlink" title="后续再创建其他用户，都可以使用该超管用户创建"></a>后续再创建其他用户，都可以使用该超管用户创建</h4><h3 id="3-3-4-创建副本集认证的key文件"><a href="#3-3-4-创建副本集认证的key文件" class="headerlink" title="3.3.4 创建副本集认证的key文件"></a>3.3.4 创建副本集认证的key文件</h3><h4 id="第一步：生成一个key文件到当前文件夹中"><a href="#第一步：生成一个key文件到当前文件夹中" class="headerlink" title="第一步：生成一个key文件到当前文件夹中"></a>第一步：生成一个key文件到当前文件夹中</h4><h4 id="可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限"><a href="#可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限" class="headerlink" title="可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限"></a>可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# openssl rand -base64 90 -out ./mongo.keyfile</span><br><span class="line">[root@bobohost ~]# chmod 400 ./mongo.keyfile</span><br><span class="line">[root@bobohost ~]# ll mongo.keyfile</span><br><span class="line">-r--------. 1 root root 122 8月 14 14:23 mongo.keyfile</span><br></pre></td></tr></table></figure>
<h4 id="提示-21"><a href="#提示-21" class="headerlink" title="提示"></a>提示</h4><blockquote>
<p>所有副本集节点都必须要用同一份keyfile，一般是在一台机器上生成，然后拷贝到其他机器上，且必须有读的权限，否则将来会报错：permissions<br>on /mongodb/replica_sets/myrs_ 27017 /mongo.keyfile are too open</p>
<p>一定要保证密钥文件一致，文件位置随便。但是为了方便查找，建议每台机器都放到一个固定的位置，都放到和配置文件一起的目录中。</p>
</blockquote>
<h4 id="这里将该文件分别拷贝到多个目录中"><a href="#这里将该文件分别拷贝到多个目录中" class="headerlink" title="这里将该文件分别拷贝到多个目录中"></a>这里将该文件分别拷贝到多个目录中</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# cp mongo.keyfile /mongodb/replica_sets/myrs_27017</span><br><span class="line">[root@bobohost ~]# cp mongo.keyfile /mongodb/replica_sets/myrs_27018</span><br><span class="line">[root@bobohost ~]# cp mongo.keyfile /mongodb/replica_sets/myrs_27019</span><br></pre></td></tr></table></figure>
<h3 id="3-3-5-修改配置文件指定keyfile"><a href="#3-3-5-修改配置文件指定keyfile" class="headerlink" title="3.3.5 修改配置文件指定keyfile"></a>3.3.5 修改配置文件指定keyfile</h3><h4 id="分别编辑几个服务的mongod-conf文件，添加相关内容"><a href="#分别编辑几个服务的mongod-conf文件，添加相关内容" class="headerlink" title="分别编辑几个服务的mongod.conf文件，添加相关内容"></a>分别编辑几个服务的mongod.conf文件，添加相关内容</h4><p><code>/mongodb/replica_sets/myrs_27017/mongod.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/replica_sets/myrs_27017/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>/mongodb/replica_sets/myrs_27018/mongod.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/replica_sets/myrs_27018/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>/mongodb/replica_sets/myrs_27019/mongod.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/replica_sets/myrs_27018/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-3-6-重新启动副本集"><a href="#3-3-6-重新启动副本集" class="headerlink" title="3.3.6 重新启动副本集"></a>3.3.6 重新启动副本集</h3><blockquote>
<p>如果副本集是开启状态，则先分别关闭关闭复本集中的每个mongod，从次节点开始。直到副本集的所有成员都离线，包括任何仲裁者。主节点必须是最后一个成员关闭以避免潜在的回滚。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通过进程编号关闭三个节点</span></span><br><span class="line">kill -2 54410 54361 54257</span><br></pre></td></tr></table></figure>
<h4 id="分别启动副本集节点"><a href="#分别启动副本集节点" class="headerlink" title="分别启动副本集节点"></a>分别启动副本集节点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27017/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27018/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f /mongodb/replica_sets/myrs_27019/mongod.conf</span><br></pre></td></tr></table></figure>
<h4 id="查看进程情况"><a href="#查看进程情况" class="headerlink" title="查看进程情况"></a>查看进程情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost replica_sets]# ps -ef |grep mongod</span><br><span class="line">root 62425 1 5 14:43 ? 00:00:01 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/replica_sets/myrs_27017/mongod.conf</span><br><span class="line">root 62495 1 7 14:43 ? 00:00:01 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/replica_sets/myrs_27018/mongod.conf</span><br><span class="line">root 62567 1 11 14:43 ? 00:00:01 /usr/local/mongodb/bin/mongod</span><br><span class="line">-f /mongodb/replica_sets/myrs_27019/mongod.conf</span><br></pre></td></tr></table></figure>
<h3 id="3-3-7-在主节点上添加普通账号"><a href="#3-3-7-在主节点上添加普通账号" class="headerlink" title="3.3.7 在主节点上添加普通账号"></a>3.3.7 在主节点上添加普通账号</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">先用管理员账号登录</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">切换到admin库</span></span><br><span class="line">use admin</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">管理员账号认证</span></span><br><span class="line">db.auth(&quot;myroot&quot;,&quot;123456&quot;)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">切换到要认证的库</span></span><br><span class="line">use articledb</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加普通用户</span></span><br><span class="line">db.createUser(&#123;user: &quot;bobo&quot;, pwd: &quot;123456&quot;, roles: [&quot;readWrite&quot;]&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="重新连接，使用普通用户bobo重新登录，查看数据"><a href="#重新连接，使用普通用户bobo重新登录，查看数据" class="headerlink" title="重新连接，使用普通用户bobo重新登录，查看数据"></a>重新连接，使用普通用户bobo重新登录，查看数据</h4><h4 id="注意：也要使用rs-status-命令查看副本集是否健康"><a href="#注意：也要使用rs-status-命令查看副本集是否健康" class="headerlink" title="注意：也要使用rs.status()命令查看副本集是否健康"></a>注意：也要使用rs.status()命令查看副本集是否健康</h4><h3 id="3-3-8-SpringDataMongoDB连接副本集"><a href="#3-3-8-SpringDataMongoDB连接副本集" class="headerlink" title="3.3.8 SpringDataMongoDB连接副本集"></a>3.3.8 SpringDataMongoDB连接副本集</h3><blockquote>
<p>使用用户名和密码连接到 MongoDB 服务器，你必须使用’username:password@hostname/dbname’ 格式，’username’为用户名，’password’<br>为密码。</p>
</blockquote>
<h4 id="目标：使用用户bobo使用密码-123456-连接到MongoDB-服务上-1"><a href="#目标：使用用户bobo使用密码-123456-连接到MongoDB-服务上-1" class="headerlink" title="目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上"></a>目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上</h4><h4 id="application-yml-1"><a href="#application-yml-1" class="headerlink" title="application.yml"></a>application.yml</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">数据源配置</span></span><br><span class="line">  data:</span><br><span class="line">    mongodb:</span><br><span class="line">      #副本集有认证的情况下，字符串连接</span><br><span class="line">      uri: mongodb://bobo:123456@180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019/articledb?connect=replicaSet&amp;slaveOk=true&amp;replicaSet=myrs</span><br></pre></td></tr></table></figure>
<h2 id="3-4-分片集群环境-扩展"><a href="#3-4-分片集群环境-扩展" class="headerlink" title="3.4 分片集群环境(扩展)"></a>3.4 分片集群环境(扩展)</h2><h3 id="3-3-1-关闭已开启的集群服务（可选）"><a href="#3-3-1-关闭已开启的集群服务（可选）" class="headerlink" title="3.3.1 关闭已开启的集群服务（可选）"></a>3.3.1 关闭已开启的集群服务（可选）</h3><blockquote>
<p>分片集群环境下的安全认证和副本集环境下基本上一样。</p>
<p>但分片集群的服务器环境和架构较为复杂，建议在搭建分片集群的时候，直接加入安全认证和服务器间的鉴权，如果之前有数据，可先将之前的数据备份出来，再还原回去。</p>
<p>本文使用之前搭建好的集群服务，因此，先停止之前的集群服务</p>
<p>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：</p>
</blockquote>
<ul>
<li>（ 1 ）快速关闭方法（快速，简单，数据可能会出错）</li>
</ul>
<h4 id="目标：通过系统的kill命令直接杀死进程-2"><a href="#目标：通过系统的kill命令直接杀死进程-2" class="headerlink" title="目标：通过系统的kill命令直接杀死进程"></a>目标：通过系统的kill命令直接杀死进程</h4><blockquote>
<p>依次杀死mongos路由、配置副本集服务，分片副本集服务，从次节点开始。直到所有成员都离线。副<br>本集杀的时候，建议先杀仲裁者，再杀副本节点，最后是主节点，以避免潜在的回滚。杀完要检查一下，避免有的没有杀掉。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通过进程编号关闭节点</span></span><br><span class="line">kill -2 54410</span><br></pre></td></tr></table></figure>
<h4 id="【补充】-3"><a href="#【补充】-3" class="headerlink" title="【补充】"></a>【补充】</h4><h4 id="如果一旦是因为数据损坏，则需要进行如下操作（了解）-2"><a href="#如果一旦是因为数据损坏，则需要进行如下操作（了解）-2" class="headerlink" title="如果一旦是因为数据损坏，则需要进行如下操作（了解）"></a>如果一旦是因为数据损坏，则需要进行如下操作（了解）</h4><ul>
<li>1 ）删除lock文件：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rm -f /mongodb/sharded_cluster/myshardrs01_27018/data/db/*.lock \</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27118/data/db/*.lock \</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27218/data/db/mongod.lock \</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27318/data/db/mongod.lock \</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27418/data/db/mongod.lock \</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27518/data/db/mongod.lock \</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27019/data/db/mongod.lock \</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27119/data/db/mongod.lock \</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27219/data/db/mongod.lock</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>2 ）依次修复数据：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/sharded_cluster/myshardrs01_27018/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/sharded_cluster/myshardrs01_27118/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/sharded_cluster/myshardrs01_27218/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/sharded_cluster/myshardrs02_27318/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/sharded_cluster/myshardrs02_27418/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/sharded_cluster/myshardrs02_27518/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/sharded_cluster/myconfigrs_27019/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/sharded_cluster/myconfigrs_27119/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/sharded_cluster/myconfigrs_27219/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/sharded_cluster/mymongos_27017/data/db</span><br><span class="line">/usr/local/mongodb/bin/mongod --repair --</span><br><span class="line">dbpath=/mongodb/sharded_cluster/mymongos_27117/data/db</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="（-2-）标准的关闭方法（数据不容易出错，但麻烦）-1"><a href="#（-2-）标准的关闭方法（数据不容易出错，但麻烦）-1" class="headerlink" title="（ 2 ）标准的关闭方法（数据不容易出错，但麻烦）"></a>（ 2 ）标准的关闭方法（数据不容易出错，但麻烦）</h4><h4 id="目标：通过mongo客户端中的shutdownServer命令来依次关闭各个服务"><a href="#目标：通过mongo客户端中的shutdownServer命令来依次关闭各个服务" class="headerlink" title="目标：通过mongo客户端中的shutdownServer命令来依次关闭各个服务"></a>目标：通过mongo客户端中的shutdownServer命令来依次关闭各个服务</h4><h4 id="关闭分片服务器副本集中的服务，建议依次关闭仲裁节点、副本节点、主节点。主要的操作步骤参考如下"><a href="#关闭分片服务器副本集中的服务，建议依次关闭仲裁节点、副本节点、主节点。主要的操作步骤参考如下" class="headerlink" title="关闭分片服务器副本集中的服务，建议依次关闭仲裁节点、副本节点、主节点。主要的操作步骤参考如下"></a>关闭分片服务器副本集中的服务，建议依次关闭仲裁节点、副本节点、主节点。主要的操作步骤参考如下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27018</span><br><span class="line">//告知副本集说本机要下线</span><br><span class="line">rs.stepDown()</span><br><span class="line"><span class="meta prompt_">//#</span><span class="language-bash">切换到admin库</span></span><br><span class="line">use admin</span><br><span class="line">//关闭服务</span><br><span class="line">db.shutdownServer()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="关闭配置服务器副本集的服务，建议依次关闭副本节点、主节点。主要的操作步骤参考如下"><a href="#关闭配置服务器副本集的服务，建议依次关闭副本节点、主节点。主要的操作步骤参考如下" class="headerlink" title="关闭配置服务器副本集的服务，建议依次关闭副本节点、主节点。主要的操作步骤参考如下"></a>关闭配置服务器副本集的服务，建议依次关闭副本节点、主节点。主要的操作步骤参考如下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27019</span><br><span class="line">//告知副本集说本机要下线</span><br><span class="line">rs.stepDown()</span><br><span class="line"><span class="meta prompt_">//#</span><span class="language-bash">切换到admin库</span></span><br><span class="line">use admin</span><br><span class="line">//关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure>
<h4 id="关闭路由服务器的服务，建议依次关闭两个路由节点。主要的操作步骤参考如下"><a href="#关闭路由服务器的服务，建议依次关闭两个路由节点。主要的操作步骤参考如下" class="headerlink" title="关闭路由服务器的服务，建议依次关闭两个路由节点。主要的操作步骤参考如下"></a>关闭路由服务器的服务，建议依次关闭两个路由节点。主要的操作步骤参考如下</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27017</span><br><span class="line">//告知副本集说本机要下线</span><br><span class="line">rs.stepDown()</span><br><span class="line"><span class="meta prompt_">//#</span><span class="language-bash">切换到admin库</span></span><br><span class="line">use admin</span><br><span class="line">//关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure>
<h3 id="3-3-2-创建副本集认证的key文件"><a href="#3-3-2-创建副本集认证的key文件" class="headerlink" title="3.3.2 创建副本集认证的key文件"></a>3.3.2 创建副本集认证的key文件</h3><h4 id="第一步：生成一个key文件到当前文件夹中-1"><a href="#第一步：生成一个key文件到当前文件夹中-1" class="headerlink" title="第一步：生成一个key文件到当前文件夹中"></a>第一步：生成一个key文件到当前文件夹中</h4><h4 id="可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限-1"><a href="#可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限-1" class="headerlink" title="可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限"></a>可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# openssl rand -base64 90 -out ./mongo.keyfile</span><br><span class="line">[root@bobohost ~]# chmod 400 ./mongo.keyfile</span><br><span class="line">[root@bobohost ~]# ll mongo.keyfile</span><br><span class="line">-r--------. 1 root root 122 8月 14 14:23 mongo.keyfile</span><br></pre></td></tr></table></figure>
<h4 id="提示-22"><a href="#提示-22" class="headerlink" title="提示"></a>提示</h4><blockquote>
<p>所有副本集节点都必须要用同一份keyfile，一般是在一台机器上生成，然后拷贝到其他机器上，且必须有读的权限，否则将来会报错：permissions<br>on /mongodb/replica_sets/myrs_ 27017 /mongo.keyfile are too open</p>
<p>一定要保证密钥文件一致，文件位置随便。但是为了方便查找，建议每台机器都放到一个固定的位置都放到和配置文件一起的目录中。</p>
</blockquote>
<h4 id="这里将该文件分别拷贝到多个目录中-1"><a href="#这里将该文件分别拷贝到多个目录中-1" class="headerlink" title="这里将该文件分别拷贝到多个目录中"></a>这里将该文件分别拷贝到多个目录中</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;/mongodb/sharded_cluster/myshardrs01_27018/mongo.keyfile</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27118/mongo.keyfile</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27218/mongo.keyfile</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27318/mongo.keyfile</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27418/mongo.keyfile</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27518/mongo.keyfile</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27019/mongo.keyfile</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27119/mongo.keyfile</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27219/mongo.keyfile</span><br><span class="line">/mongodb/sharded_cluster/mymongos_27017/mongo.keyfile</span><br><span class="line">/mongodb/sharded_cluster/mymongos_27117/mongo.keyfile&#x27; | xargs -n 1 cp -v</span><br><span class="line">/root/mongo.keyfile</span><br></pre></td></tr></table></figure>
<h3 id="3-3-3-修改配置文件指定keyfile"><a href="#3-3-3-修改配置文件指定keyfile" class="headerlink" title="3.3.3 修改配置文件指定keyfile"></a>3.3.3 修改配置文件指定keyfile</h3><h4 id="分别编辑几个服务的mongod-conf文件，添加相关内容-1"><a href="#分别编辑几个服务的mongod-conf文件，添加相关内容-1" class="headerlink" title="分别编辑几个服务的mongod.conf文件，添加相关内容"></a>分别编辑几个服务的mongod.conf文件，添加相关内容</h4><h4 id="mongodb-sharded-cluster-myshardrs01-27018-mongod-conf"><a href="#mongodb-sharded-cluster-myshardrs01-27018-mongod-conf" class="headerlink" title="/mongodb/sharded_cluster/myshardrs01_27018/mongod.conf"></a>/mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/sharded_cluster/myshardrs01_27018/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure>
<h4 id="mongodb-sharded-cluster-myshardrs01-27118-mongod-conf"><a href="#mongodb-sharded-cluster-myshardrs01-27118-mongod-conf" class="headerlink" title="/mongodb/sharded_cluster/myshardrs01_27118/mongod.conf"></a>/mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/sharded_cluster/myshardrs01_27118/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure>
<h4 id="mongodb-sharded-cluster-myshardrs01-27218-mongod-conf"><a href="#mongodb-sharded-cluster-myshardrs01-27218-mongod-conf" class="headerlink" title="/mongodb/sharded_cluster/myshardrs01_27218/mongod.conf"></a>/mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/sharded_cluster/myshardrs01_27218/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="mongodb-sharded-cluster-myshardrs02-27318-mongod-conf"><a href="#mongodb-sharded-cluster-myshardrs02-27318-mongod-conf" class="headerlink" title="/mongodb/sharded_cluster/myshardrs02_27318/mongod.conf"></a>/mongodb/sharded_cluster/myshardrs02_27318/mongod.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/sharded_cluster/myshardrs02_27318/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="mongodb-sharded-cluster-myshardrs02-27418-mongod-conf"><a href="#mongodb-sharded-cluster-myshardrs02-27418-mongod-conf" class="headerlink" title="/mongodb/sharded_cluster/myshardrs02_27418/mongod.conf"></a>/mongodb/sharded_cluster/myshardrs02_27418/mongod.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/sharded_cluster/myshardrs02_27418/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="mongodb-sharded-cluster-myshardrs02-27518-mongod-conf"><a href="#mongodb-sharded-cluster-myshardrs02-27518-mongod-conf" class="headerlink" title="/mongodb/sharded_cluster/myshardrs02_27518/mongod.conf"></a>/mongodb/sharded_cluster/myshardrs02_27518/mongod.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/sharded_cluster/myshardrs02_27518/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure>
<h4 id="mongodb-sharded-cluster-myconfigrs-27019-mongod-conf"><a href="#mongodb-sharded-cluster-myconfigrs-27019-mongod-conf" class="headerlink" title="/mongodb/sharded_cluster/myconfigrs_27019/mongod.conf"></a>/mongodb/sharded_cluster/myconfigrs_27019/mongod.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/sharded_cluster/myconfigrs_27019/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure>
<h4 id="mongodb-sharded-cluster-myconfigrs-27119-mongod-conf"><a href="#mongodb-sharded-cluster-myconfigrs-27119-mongod-conf" class="headerlink" title="/mongodb/sharded_cluster/myconfigrs_27119/mongod.conf"></a>/mongodb/sharded_cluster/myconfigrs_27119/mongod.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/sharded_cluster/myconfigrs_27119/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="mongodb-sharded-cluster-myconfigrs-27219-mongod-conf"><a href="#mongodb-sharded-cluster-myconfigrs-27219-mongod-conf" class="headerlink" title="/mongodb/sharded_cluster/myconfigrs_27219/mongod.conf"></a>/mongodb/sharded_cluster/myconfigrs_27219/mongod.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/sharded_cluster/myconfigrs_27219/mongo.keyfile</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">开启认证方式运行</span></span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure>
<h4 id="mongodb-sharded-cluster-mymongos-27017-mongos-conf"><a href="#mongodb-sharded-cluster-mymongos-27017-mongos-conf" class="headerlink" title="/mongodb/sharded_cluster/mymongos_27017/mongos.conf"></a>/mongodb/sharded_cluster/mymongos_27017/mongos.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/sharded_cluster/mymongos_27017/mongo.keyfile</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="mongodb-sharded-cluster-mymongos-27117-mongos-conf"><a href="#mongodb-sharded-cluster-mymongos-27117-mongos-conf" class="headerlink" title="/mongodb/sharded_cluster/mymongos_27117/mongos.conf"></a>/mongodb/sharded_cluster/mymongos_27117/mongos.conf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">KeyFile鉴权文件</span></span><br><span class="line">  keyFile: /mongodb/sharded_cluster/mymongos_27117/mongo.keyfile</span><br></pre></td></tr></table></figure>
<blockquote>
<p>mongos比mongod少了authorization：enabled的配置。原因是，副本集加分片的安全认证需要配置两方面的，副本集各个节点之间使用内部身份验证，<br>用于内部各个mongo实例的通信，只有相同keyfile才能相互访问。所以都要开启keyFile:<br>/mongodb/sharded_cluster/mymongos_ 27117 /mongo.keyfile。</p>
<p>然而对于所有的mongod，才是真正的保存数据的分片。mongos只做路由，不保存数据。所以所有的mongod开启访问数据的授权<br>authorization:enabled。这样用户只有账号密码正确才能访问到数据。</p>
</blockquote>
<h3 id="3-3-4-重新启动节点"><a href="#3-3-4-重新启动节点" class="headerlink" title="3.3.4 重新启动节点"></a>3.3.4 重新启动节点</h3><h4 id="必须依次启动配置节点、分片节点、路由节点"><a href="#必须依次启动配置节点、分片节点、路由节点" class="headerlink" title="必须依次启动配置节点、分片节点、路由节点"></a>必须依次启动配置节点、分片节点、路由节点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27019/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27119/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myconfigrs_27219/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27318/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27418/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongod -f</span><br><span class="line">/mongodb/sharded_cluster/myshardrs02_27518/mongod.conf</span><br><span class="line">/usr/local/mongodb/bin/mongos -f</span><br><span class="line">/mongodb/sharded_cluster/mymongos_27017/mongos.conf</span><br><span class="line">/usr/local/mongodb/bin/mongos -f</span><br><span class="line">/mongodb/sharded_cluster/mymongos_27117/mongos.conf</span><br></pre></td></tr></table></figure>
<h4 id="注意-4"><a href="#注意-4" class="headerlink" title="注意"></a>注意</h4><h4 id="这里有个非常特别的情况，就是启动顺序。先启动配置节点，再启动分片节点，最后启动路由节点"><a href="#这里有个非常特别的情况，就是启动顺序。先启动配置节点，再启动分片节点，最后启动路由节点" class="headerlink" title="这里有个非常特别的情况，就是启动顺序。先启动配置节点，再启动分片节点，最后启动路由节点"></a>这里有个非常特别的情况，就是启动顺序。先启动配置节点，再启动分片节点，最后启动路由节点</h4><h4 id="如果先启动分片节点，会卡住，提示"><a href="#如果先启动分片节点，会卡住，提示" class="headerlink" title="如果先启动分片节点，会卡住，提示"></a>如果先启动分片节点，会卡住，提示</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">about to fork child process, waiting until server is ready for connections</span><br></pre></td></tr></table></figure>
<h4 id="这也许是个bug。原因未知"><a href="#这也许是个bug。原因未知" class="headerlink" title="这也许是个bug。原因未知"></a>这也许是个bug。原因未知</h4><h3 id="3-3-5-创建帐号和认证"><a href="#3-3-5-创建帐号和认证" class="headerlink" title="3.3.5 创建帐号和认证"></a>3.3.5 创建帐号和认证</h3><h4 id="客户端mongo，通过localhost登录任意一个mongos路由"><a href="#客户端mongo，通过localhost登录任意一个mongos路由" class="headerlink" title="客户端mongo，通过localhost登录任意一个mongos路由"></a>客户端mongo，通过localhost登录任意一个mongos路由</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost db]# /usr/local/mongodb/bin/mongo --port 27017</span><br></pre></td></tr></table></figure>
<h4 id="提示：相当于一个后门，只能在admin下添加用户"><a href="#提示：相当于一个后门，只能在admin下添加用户" class="headerlink" title="提示：相当于一个后门，只能在admin下添加用户"></a>提示：相当于一个后门，只能在admin下添加用户</h4><h4 id="创建一个管理员帐号"><a href="#创建一个管理员帐号" class="headerlink" title="创建一个管理员帐号"></a>创建一个管理员帐号</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">use admin</span></span><br><span class="line">switched to db admin</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.createUser(&#123;user:<span class="string">&quot;myroot&quot;</span>,<span class="built_in">pwd</span>:<span class="string">&quot;123456&quot;</span>,roles:[<span class="string">&quot;root&quot;</span>]&#125;)</span></span><br><span class="line">Successfully added user: &#123; &quot;user&quot; : &quot;myroot&quot;, &quot;roles&quot; : [ &quot;root&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<h4 id="提示：如果在开启认证之前已经创建了管理员账号，这里可以忽略"><a href="#提示：如果在开启认证之前已经创建了管理员账号，这里可以忽略" class="headerlink" title="提示：如果在开启认证之前已经创建了管理员账号，这里可以忽略"></a>提示：如果在开启认证之前已经创建了管理员账号，这里可以忽略</h4><h4 id="创建一个普通权限帐号"><a href="#创建一个普通权限帐号" class="headerlink" title="创建一个普通权限帐号"></a>创建一个普通权限帐号</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">use admin</span></span><br><span class="line">switched to db admin</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.auth(<span class="string">&quot;myroot&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span></span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">use articledb</span></span><br><span class="line">switched to db articledb</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.createUser(&#123;user: <span class="string">&quot;bobo&quot;</span>, <span class="built_in">pwd</span>: <span class="string">&quot;123456&quot;</span>, roles: [&#123; role: <span class="string">&quot;readWrite&quot;</span>,db: <span class="string">&quot;articledb&quot;</span> &#125;]&#125;)</span></span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">&quot;user&quot; : &quot;bobo&quot;,</span><br><span class="line">&quot;roles&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;role&quot; : &quot;readWrite&quot;,</span><br><span class="line">      &quot;db&quot; : &quot;articledb&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.auth(<span class="string">&quot;bobo&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<h4 id="提示-23"><a href="#提示-23" class="headerlink" title="提示"></a>提示</h4><p><code>通过mongos添加的账号信息，只会保存到配置节点的服务中，具体的数据节点不保存账号信息，因此，分片中的账号信息不涉及到同步问题。</code></p>
<h4 id="mongo客户端登录mongos路由，用管理员帐号登录可查看分片情况"><a href="#mongo客户端登录mongos路由，用管理员帐号登录可查看分片情况" class="headerlink" title="mongo客户端登录mongos路由，用管理员帐号登录可查看分片情况"></a>mongo客户端登录mongos路由，用管理员帐号登录可查看分片情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">use admin</span></span><br><span class="line">switched to db admin</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.auth(<span class="string">&quot;myroot&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span></span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">sh.status()</span></span><br></pre></td></tr></table></figure>
<h4 id="退出连接，重新连接服务，使用普通权限帐号访问数据"><a href="#退出连接，重新连接服务，使用普通权限帐号访问数据" class="headerlink" title="退出连接，重新连接服务，使用普通权限帐号访问数据"></a>退出连接，重新连接服务，使用普通权限帐号访问数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost db]# /usr/local/mongodb/bin/mongo --host 180.76.159.126 --port</span><br><span class="line">27017</span><br><span class="line">MongoDB shell version v4.0.10</span><br><span class="line">connecting to: mongodb://180.76.159.126:27017/?gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;6f84fa91-2414-407e-b3ab-c0b7eedde825&quot;)</span><br><span class="line">&#125;</span><br><span class="line">MongoDB server version: 4.0.10</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">use articledb</span></span><br><span class="line">switched to db articledb</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.auth(<span class="string">&quot;bobo&quot;</span>,<span class="string">&quot;123456&quot;</span>)</span></span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">show collections</span></span><br><span class="line">comment</span><br><span class="line">comment2</span><br><span class="line"><span class="meta prompt_">mongos&gt; </span><span class="language-bash">db.comment.count()</span></span><br><span class="line">10001</span><br></pre></td></tr></table></figure>
<h3 id="3-3-6-SpringDataMongoDB连接认证"><a href="#3-3-6-SpringDataMongoDB连接认证" class="headerlink" title="3.3.6 SpringDataMongoDB连接认证"></a>3.3.6 SpringDataMongoDB连接认证</h3><blockquote>
<p>使用用户名和密码连接到 MongoDB 服务器，你必须使用’username:password@hostname/dbname’ 格式，’username’为用户名，’password’<br>为密码。</p>
</blockquote>
<h4 id="目标：使用用户bobo使用密码-123456-连接到MongoDB-服务上-2"><a href="#目标：使用用户bobo使用密码-123456-连接到MongoDB-服务上-2" class="headerlink" title="目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上"></a>目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上</h4><h4 id="application-yml-2"><a href="#application-yml-2" class="headerlink" title="application.yml"></a>application.yml</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">数据源配置</span></span><br><span class="line">  data:</span><br><span class="line">    mongodb:</span><br><span class="line">      # 分片集群有认证的情况下，字符串连接</span><br><span class="line">      uri: mongodb://bobo:123456@180.76.159.126:27017,180.76.159.126:27117/articledb</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" rel="tag"># 快速入门</a>
              <a href="/tags/mongodb/" rel="tag"># mongodb</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/02/05/Kafka%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" rel="prev" title="Kafka快速入门">
      <i class="fa fa-chevron-left"></i> Kafka快速入门
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/02/05/k8s%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" rel="next" title="k8s快速入门">
      k8s快速入门 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%BE%E7%A8%8B%E7%9B%AE%E6%A0%87"><span class="nav-number">1.</span> <span class="nav-text">课程目标</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-MongoDB%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">2.</span> <span class="nav-text">1 MongoDB相关概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E4%B8%9A%E5%8A%A1%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 业务应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%80%8CMongoDB%E5%8F%AF%E5%BA%94%E5%AF%B9%E2%80%9C%E4%B8%89%E9%AB%98%E2%80%9D%E9%9C%80%E6%B1%82"><span class="nav-number">2.1.0.0.0.1.</span> <span class="nav-text">而MongoDB可应对“三高”需求</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E9%80%89%E6%8B%A9MongoDB"><span class="nav-number">2.1.0.0.0.2.</span> <span class="nav-text">什么时候选择MongoDB</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%9C%A8%E6%9E%B6%E6%9E%84%E9%80%89%E5%9E%8B%E4%B8%8A%EF%BC%8C%E9%99%A4%E4%BA%86%E4%B8%8A%E8%BF%B0%E7%9A%84%E4%B8%89%E4%B8%AA%E7%89%B9%E7%82%B9%E5%A4%96%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%BD%A0%E8%BF%98%E7%8A%B9%E8%B1%AB%E6%98%AF%E5%90%A6%E8%A6%81%E9%80%89%E6%8B%A9%E5%AE%83%EF%BC%9F%E5%8F%AF%E4%BB%A5%E8%80%83%E8%99%91%E4%BB%A5%E4%B8%8B%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="nav-number">2.1.0.0.0.3.</span> <span class="nav-text">在架构选型上，除了上述的三个特点外，如果你还犹豫是否要选择它？可以考虑以下的一些问题</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-MongoDB%E7%AE%80%E4%BB%8B"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 MongoDB简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 体系结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MySQL%E5%92%8CMongoDB%E5%AF%B9%E6%AF%94"><span class="nav-number">2.3.0.1.</span> <span class="nav-text">MySQL和MongoDB对比</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.4.</span> <span class="nav-text">1.4 数据模型</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#BSON%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%8F%82%E8%80%83%E5%88%97%E8%A1%A8"><span class="nav-number">2.4.0.0.0.1.</span> <span class="nav-text">BSON数据类型参考列表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA"><span class="nav-number">2.4.0.0.0.2.</span> <span class="nav-text">提示</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-MongoDB%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-number">2.5.</span> <span class="nav-text">1.5 MongoDB的特点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB%E4%B8%BB%E8%A6%81%E6%9C%89%E5%A6%82%E4%B8%8B%E7%89%B9%E7%82%B9"><span class="nav-number">2.5.0.1.</span> <span class="nav-text">MongoDB主要有如下特点</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2"><span class="nav-number">3.</span> <span class="nav-text">2 单机部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-Windows%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 Windows系统中的安装启动</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85"><span class="nav-number">3.1.0.1.</span> <span class="nav-text">第一步：下载安装包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E4%B8%8A%E5%9B%BE%E6%89%80%E7%A4%BA%E4%B8%8B%E8%BD%BDzip%E5%8C%85"><span class="nav-number">3.1.0.2.</span> <span class="nav-text">根据上图所示下载zip包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9A%E7%89%88%E6%9C%AC%E7%9A%84%E9%80%89%E6%8B%A9"><span class="nav-number">3.1.0.3.</span> <span class="nav-text">提示：版本的选择</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB%E7%9A%84%E7%89%88%E6%9C%AC%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%E5%A6%82%EF%BC%9Ax-y-z"><span class="nav-number">3.1.0.4.</span> <span class="nav-text">MongoDB的版本命名规范如：x.y.z</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E8%A7%A3%E5%8E%8B%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8"><span class="nav-number">3.1.0.5.</span> <span class="nav-text">第二步：解压安装启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E5%BC%8F-1-%EF%BC%9A%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E6%96%B9%E5%BC%8F%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.1.0.6.</span> <span class="nav-text">方式 1 ：命令行参数方式启动服务</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%88%91%E4%BB%AC%E5%9C%A8%E5%90%AF%E5%8A%A8%E4%BF%A1%E6%81%AF%E4%B8%AD%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8CmongoDB%E7%9A%84%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3%E6%98%AF-27017-%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E6%83%B3%E6%94%B9%E5%8F%98%E9%BB%98%E8%AE%A4%E7%9A%84%E5%90%AF%E5%8A%A8%E7%AB%AF%E5%8F%A3%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E2%80%94port%E6%9D%A5%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3%E3%80%82%E4%B8%BA%E4%BA%86%E6%96%B9%E4%BE%BF%E6%88%91%E4%BB%AC%E6%AF%8F%E6%AC%A1%E5%90%AF%E5%8A%A8%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%B0%86%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95%E7%9A%84bin%E7%9B%AE%E5%BD%95%E8%AE%BE%E7%BD%AE%E5%88%B0%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84path%E4%B8%AD%EF%BC%8Cbin%E7%9B%AE%E5%BD%95%E4%B8%8B%E6%98%AF%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%EF%BC%8C%E6%AF%94%E5%A6%82mongod%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E7%94%A8%E7%9A%84%EF%BC%8Cmongo%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E7%94%A8%E7%9A%84"><span class="nav-number">3.1.0.6.0.1.</span> <span class="nav-text">我们在启动信息中可以看到，mongoDB的默认端口是 27017 ，如果我们想改变默认的启动端口，可以通过—port来指定端口。为了方便我们每次启动，可以将安装目录的bin目录设置到环境变量的path中，bin目录下是一些常用命令，比如mongod启动服务用的，mongo客户端连接服务用的</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E5%BC%8F-2-%EF%BC%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.1.0.7.</span> <span class="nav-text">方式 2 ：配置文件方式启动服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E6%B3%A8%E6%84%8F%E3%80%91"><span class="nav-number">3.1.0.8.</span> <span class="nav-text">【注意】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3"><span class="nav-number">3.1.0.9.</span> <span class="nav-text">解决</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-1"><span class="nav-number">3.1.0.10.</span> <span class="nav-text">解决</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">3.1.0.11.</span> <span class="nav-text">启动方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E5%A4%9A%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.0.12.</span> <span class="nav-text">更多参数配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Shell%E8%BF%9E%E6%8E%A5-mongo%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 Shell连接(mongo命令)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E5%91%BD%E4%BB%A4%E6%8F%90%E7%A4%BA%E7%AC%A6%E8%BE%93%E5%85%A5%E4%BB%A5%E4%B8%8Bshell%E5%91%BD%E4%BB%A4%E5%8D%B3%E5%8F%AF%E5%AE%8C%E6%88%90%E7%99%BB%E9%99%86"><span class="nav-number">3.2.0.1.</span> <span class="nav-text">在命令提示符输入以下shell命令即可完成登陆</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E6%9C%89%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">3.2.0.2.</span> <span class="nav-text">查看已经有的数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%80%E5%87%BAmongodb"><span class="nav-number">3.2.0.3.</span> <span class="nav-text">退出mongodb</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E5%A4%9A%E5%8F%82%E6%95%B0%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%B8%AE%E5%8A%A9%E6%9F%A5%E7%9C%8B"><span class="nav-number">3.2.0.4.</span> <span class="nav-text">更多参数可以通过帮助查看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-1"><span class="nav-number">3.2.0.5.</span> <span class="nav-text">提示</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-Compass-%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%95%8C%E9%9D%A2%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 Compass-图形化界面客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-Linux%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8%E5%92%8C%E8%BF%9E%E6%8E%A5"><span class="nav-number">3.4.</span> <span class="nav-text">2.4 Linux系统中的安装启动和连接</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A%E5%9C%A8Linux%E4%B8%AD%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AA%E5%8D%95%E6%9C%BA%E7%9A%84MongoDB%EF%BC%8C%E4%BD%9C%E4%B8%BA%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%8B%E4%BD%BF%E7%94%A8"><span class="nav-number">3.4.0.1.</span> <span class="nav-text">目标：在Linux中部署一个单机的MongoDB，作为生产环境下使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9A%E5%92%8CWindows%E4%B8%8B%E6%93%8D%E4%BD%9C%E5%B7%AE%E4%B8%8D%E5%A4%9A"><span class="nav-number">3.4.0.2.</span> <span class="nav-text">提示：和Windows下操作差不多</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E5%A6%82%E4%B8%8B"><span class="nav-number">3.4.0.3.</span> <span class="nav-text">步骤如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F"><span class="nav-number">3.4.0.4.</span> <span class="nav-text">注意</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E8%BF%9B%E7%A8%8B%E6%9D%A5%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8%E4%BA%86"><span class="nav-number">3.4.0.5.</span> <span class="nav-text">通过进程来查看服务是否启动了</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9A%E5%A6%82%E6%9E%9C%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%E4%B8%8D%E4%B8%8A%EF%BC%8C%E9%9C%80%E8%A6%81%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99%E6%94%BE%E8%A1%8C%EF%BC%8C%E6%88%96%E7%9B%B4%E6%8E%A5%E5%85%B3%E9%97%ADlinux%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-number">3.4.0.6.</span> <span class="nav-text">提示：如果远程连接不上，需要配置防火墙放行，或直接关闭linux防火墙</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E4%B8%A4%E7%A7%8D%EF%BC%9A%E5%BF%AB%E9%80%9F%E5%85%B3%E9%97%AD%E5%92%8C%E6%A0%87%E5%87%86%E5%85%B3%E9%97%AD%EF%BC%8C%E4%B8%8B%E9%9D%A2%E4%BE%9D%E6%AC%A1%E8%AF%B4%E6%98%8E"><span class="nav-number">3.4.0.7.</span> <span class="nav-text">停止服务的方式有两种：快速关闭和标准关闭，下面依次说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E8%A1%A5%E5%85%85%E3%80%91"><span class="nav-number">3.4.0.8.</span> <span class="nav-text">【补充】</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E5%9F%BA%E6%9C%AC%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">4.</span> <span class="nav-text">3 基本常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E6%A1%88%E4%BE%8B%E9%9C%80%E6%B1%82"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 案例需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 数据库操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-1-%E9%80%89%E6%8B%A9%E5%92%8C%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">4.3.</span> <span class="nav-text">3.2.1 选择和创建数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E5%92%8C%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F"><span class="nav-number">4.3.0.1.</span> <span class="nav-text">选择和创建数据库的语法格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8D%E5%AD%98%E5%9C%A8%E5%88%99%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%EF%BC%8C%E4%BE%8B%E5%A6%82%EF%BC%8C%E4%BB%A5%E4%B8%8B%E8%AF%AD%E5%8F%A5%E5%88%9B%E5%BB%BAspitdb%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">4.3.0.2.</span> <span class="nav-text">如果数据库不存在则自动创建，例如，以下语句创建spitdb数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%89%E6%9D%83%E9%99%90%E6%9F%A5%E7%9C%8B%E7%9A%84%E6%89%80%E6%9C%89%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E5%91%BD%E4%BB%A4"><span class="nav-number">4.3.0.3.</span> <span class="nav-text">查看有权限查看的所有的数据库命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E6%AD%A3%E5%9C%A8%E4%BD%BF%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E5%91%BD%E4%BB%A4"><span class="nav-number">4.3.0.4.</span> <span class="nav-text">查看当前正在使用的数据库命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%A6%E5%A4%96"><span class="nav-number">4.3.0.5.</span> <span class="nav-text">另外</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%88%A0%E9%99%A4"><span class="nav-number">4.4.</span> <span class="nav-text">3.2.2 数据库的删除</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F%E5%A6%82%E4%B8%8B"><span class="nav-number">4.4.0.1.</span> <span class="nav-text">MongoDB 删除数据库的语法格式如下</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C"><span class="nav-number">4.5.</span> <span class="nav-text">3.3 集合操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-%E9%9B%86%E5%90%88%E7%9A%84%E6%98%BE%E5%BC%8F%E5%88%9B%E5%BB%BA%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">4.5.1.</span> <span class="nav-text">3.3.1 集合的显式创建（了解）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F"><span class="nav-number">4.5.1.1.</span> <span class="nav-text">基本语法格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="nav-number">4.5.1.2.</span> <span class="nav-text">参数说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B%E5%A6%82%EF%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%90%8D%E4%B8%BAmycollection%E7%9A%84%E6%99%AE%E9%80%9A%E9%9B%86%E5%90%88"><span class="nav-number">4.5.1.3.</span> <span class="nav-text">例如：创建一个名为mycollection的普通集合</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E5%BA%93%E4%B8%AD%E7%9A%84%E8%A1%A8%EF%BC%9Ashow-tables%E5%91%BD%E4%BB%A4"><span class="nav-number">4.5.1.4.</span> <span class="nav-text">查看当前库中的表：show tables命令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-%E9%9B%86%E5%90%88%E7%9A%84%E9%9A%90%E5%BC%8F%E5%88%9B%E5%BB%BA"><span class="nav-number">4.5.2.</span> <span class="nav-text">3.3.2 集合的隐式创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3-%E9%9B%86%E5%90%88%E7%9A%84%E5%88%A0%E9%99%A4"><span class="nav-number">4.5.3.</span> <span class="nav-text">3.3.3 集合的删除</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E5%88%A0%E9%99%A4%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F%E5%A6%82%E4%B8%8B"><span class="nav-number">4.5.3.1.</span> <span class="nav-text">集合删除语法格式如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">4.5.3.2.</span> <span class="nav-text">返回值</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E6%96%87%E6%A1%A3%E5%9F%BA%E6%9C%ACCRUD"><span class="nav-number">4.6.</span> <span class="nav-text">3.4 文档基本CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-1-%E6%96%87%E6%A1%A3%E7%9A%84%E6%8F%92%E5%85%A5"><span class="nav-number">4.6.1.</span> <span class="nav-text">3.4.1 文档的插入</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0"><span class="nav-number">4.6.1.1.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91"><span class="nav-number">4.6.1.2.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A6%81%E5%90%91comment%E7%9A%84%E9%9B%86%E5%90%88-%E8%A1%A8-%E4%B8%AD%E6%8F%92%E5%85%A5%E4%B8%80%E6%9D%A1%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="nav-number">4.6.1.3.</span> <span class="nav-text">要向comment的集合(表)中插入一条测试数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-2"><span class="nav-number">4.6.1.4.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%90%8E%EF%BC%8C%E5%A6%82%E4%B8%8B%EF%BC%8C%E8%AF%B4%E6%98%8E%E6%8F%92%E5%85%A5%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%88%90%E5%8A%9F%E4%BA%86"><span class="nav-number">4.6.1.5.</span> <span class="nav-text">执行后，如下，说明插入一个数据成功了</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F-1"><span class="nav-number">4.6.1.6.</span> <span class="nav-text">注意</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E9%94%AE%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="nav-number">4.6.1.7.</span> <span class="nav-text">文档键命名规范</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95"><span class="nav-number">4.6.1.8.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0-1"><span class="nav-number">4.6.1.9.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-1"><span class="nav-number">4.6.1.10.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-3"><span class="nav-number">4.6.1.11.</span> <span class="nav-text">提示</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-2-%E6%96%87%E6%A1%A3%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.6.2.</span> <span class="nav-text">3.4.2 文档的基本查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F%E5%A6%82%E4%B8%8B"><span class="nav-number">4.6.2.1.</span> <span class="nav-text">查询数据的语法格式如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0-2"><span class="nav-number">4.6.2.2.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-2"><span class="nav-number">4.6.2.3.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4-id%E4%BC%9A%E6%98%BE%E7%A4%BA"><span class="nav-number">4.6.2.4.</span> <span class="nav-text">默认_id会显示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%8D%E4%BE%8B%E5%A6%82%EF%BC%9A%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BD%86%E5%8F%AA%E6%98%BE%E7%A4%BA-id%E3%80%81userid%E3%80%81nickname"><span class="nav-number">4.6.2.5.</span> <span class="nav-text">再例如：查询所有数据，但只显示_id、userid、nickname</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-3-%E6%96%87%E6%A1%A3%E7%9A%84%E6%9B%B4%E6%96%B0"><span class="nav-number">4.6.3.</span> <span class="nav-text">3.4.3 文档的更新</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3%E7%9A%84%E8%AF%AD%E6%B3%95"><span class="nav-number">4.6.3.1.</span> <span class="nav-text">更新文档的语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0-3"><span class="nav-number">4.6.3.2.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-4"><span class="nav-number">4.6.3.3.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E5%85%B3%E6%B3%A8%E5%89%8D%E5%9B%9B%E4%B8%AA%E5%8F%82%E6%95%B0%E5%8D%B3%E5%8F%AF"><span class="nav-number">4.6.3.4.</span> <span class="nav-text">主要关注前四个参数即可</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-3"><span class="nav-number">4.6.3.5.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E6%83%B3%E4%BF%AE%E6%94%B9-id%E4%B8%BA-1-%E7%9A%84%E8%AE%B0%E5%BD%95%EF%BC%8C%E7%82%B9%E8%B5%9E%E9%87%8F%E4%B8%BA-1001-%EF%BC%8C%E8%BE%93%E5%85%A5%E4%BB%A5%E4%B8%8B%E8%AF%AD%E5%8F%A5"><span class="nav-number">4.6.3.6.</span> <span class="nav-text">如果我们想修改_id为 1 的记录，点赞量为 1001 ，输入以下语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%90%8E%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BC%9A%E5%8F%91%E7%8E%B0%EF%BC%8C%E8%BF%99%E6%9D%A1%E6%96%87%E6%A1%A3%E9%99%A4%E4%BA%86likenum%E5%AD%97%E6%AE%B5%E5%85%B6%E5%AE%83%E5%AD%97%E6%AE%B5%E9%83%BD%E4%B8%8D%E8%A7%81%E4%BA%86"><span class="nav-number">4.6.3.7.</span> <span class="nav-text">执行后，我们会发现，这条文档除了likenum字段其它字段都不见了</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%89%80%E6%9C%89%E7%94%A8%E6%88%B7%E4%B8%BA-1003-%E7%9A%84%E7%94%A8%E6%88%B7%E7%9A%84%E6%98%B5%E7%A7%B0%E4%B8%BA%E5%87%AF%E6%92%92%E5%A4%A7%E5%B8%9D"><span class="nav-number">4.6.3.8.</span> <span class="nav-text">更新所有用户为 1003 的用户的昵称为凯撒大帝</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E6%83%B3%E5%AE%9E%E7%8E%B0%E5%AF%B9%E6%9F%90%E5%88%97%E5%80%BC%E5%9C%A8%E5%8E%9F%E6%9C%89%E5%80%BC%E7%9A%84%E5%9F%BA%E7%A1%80%E4%B8%8A%E8%BF%9B%E8%A1%8C%E5%A2%9E%E5%8A%A0%E6%88%96%E5%87%8F%E5%B0%91%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8-inc%E8%BF%90%E7%AE%97%E7%AC%A6%E6%9D%A5%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.6.3.9.</span> <span class="nav-text">如果我们想实现对某列值在原有值的基础上进行增加或减少，可以使用$inc运算符来实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%EF%BC%9A%E5%AF%B9-3-%E5%8F%B7%E6%95%B0%E6%8D%AE%E7%9A%84%E7%82%B9%E8%B5%9E%E6%95%B0%EF%BC%8C%E6%AF%8F%E6%AC%A1%E9%80%92%E5%A2%9E-1"><span class="nav-number">4.6.3.10.</span> <span class="nav-text">需求：对 3 号数据的点赞数，每次递增 1</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-4-%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="nav-number">4.6.4.</span> <span class="nav-text">3.4.4 删除文档</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3%E7%9A%84%E8%AF%AD%E6%B3%95%E7%BB%93%E6%9E%84"><span class="nav-number">4.6.4.1.</span> <span class="nav-text">删除文档的语法结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A5%E4%B8%8B%E8%AF%AD%E5%8F%A5%E5%8F%AF%E4%BB%A5%E5%B0%86%E6%95%B0%E6%8D%AE%E5%85%A8%E9%83%A8%E5%88%A0%E9%99%A4%EF%BC%8C%E8%AF%B7%E6%85%8E%E7%94%A8"><span class="nav-number">4.6.4.2.</span> <span class="nav-text">以下语句可以将数据全部删除，请慎用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E5%88%A0%E9%99%A4-id-1%E7%9A%84%E8%AE%B0%E5%BD%95%EF%BC%8C%E8%BE%93%E5%85%A5%E4%BB%A5%E4%B8%8B%E8%AF%AD%E5%8F%A5"><span class="nav-number">4.6.4.3.</span> <span class="nav-text">如果删除_id&#x3D;1的记录，输入以下语句</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-%E6%96%87%E6%A1%A3%E7%9A%84%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.7.</span> <span class="nav-text">3.5 文档的分页查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-1-%E7%BB%9F%E8%AE%A1%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.7.1.</span> <span class="nav-text">3.5.1 统计查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%9F%E8%AE%A1%E6%9F%A5%E8%AF%A2%E4%BD%BF%E7%94%A8count-%E6%96%B9%E6%B3%95%EF%BC%8C%E8%AF%AD%E6%B3%95%E5%A6%82%E4%B8%8B"><span class="nav-number">4.7.1.1.</span> <span class="nav-text">统计查询使用count()方法，语法如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0-4"><span class="nav-number">4.7.1.2.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-5"><span class="nav-number">4.7.1.3.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-4"><span class="nav-number">4.7.1.4.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%9F%E8%AE%A1comment%E9%9B%86%E5%90%88%E7%9A%84%E6%89%80%E6%9C%89%E7%9A%84%E8%AE%B0%E5%BD%95%E6%95%B0"><span class="nav-number">4.7.1.5.</span> <span class="nav-text">统计comment集合的所有的记录数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B%E5%A6%82%EF%BC%9A%E7%BB%9F%E8%AE%A1userid%E4%B8%BA-1003-%E7%9A%84%E8%AE%B0%E5%BD%95%E6%9D%A1%E6%95%B0"><span class="nav-number">4.7.1.6.</span> <span class="nav-text">例如：统计userid为 1003 的记录条数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-6"><span class="nav-number">4.7.1.7.</span> <span class="nav-text">提示</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-2-%E5%88%86%E9%A1%B5%E5%88%97%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.7.2.</span> <span class="nav-text">3.5.2 分页列表查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8limit-%E6%96%B9%E6%B3%95%E6%9D%A5%E8%AF%BB%E5%8F%96%E6%8C%87%E5%AE%9A%E6%95%B0%E9%87%8F%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BD%BF%E7%94%A8skip-%E6%96%B9%E6%B3%95%E6%9D%A5%E8%B7%B3%E8%BF%87%E6%8C%87%E5%AE%9A%E6%95%B0%E9%87%8F%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="nav-number">4.7.2.1.</span> <span class="nav-text">可以使用limit()方法来读取指定数量的数据，使用skip()方法来跳过指定数量的数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95%E5%A6%82%E4%B8%8B%E6%89%80%E7%A4%BA"><span class="nav-number">4.7.2.2.</span> <span class="nav-text">基本语法如下所示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E4%BD%A0%E6%83%B3%E8%BF%94%E5%9B%9E%E6%8C%87%E5%AE%9A%E6%9D%A1%E6%95%B0%E7%9A%84%E8%AE%B0%E5%BD%95%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8find%E6%96%B9%E6%B3%95%E5%90%8E%E8%B0%83%E7%94%A8limit%E6%9D%A5%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C-TopN-%EF%BC%8C%E9%BB%98%E8%AE%A4%E5%80%BC-20-%EF%BC%8C%E4%BE%8B%E5%A6%82"><span class="nav-number">4.7.2.3.</span> <span class="nav-text">如果你想返回指定条数的记录，可以在find方法后调用limit来返回结果(TopN)，默认值 20 ，例如</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#skip%E6%96%B9%E6%B3%95%E5%90%8C%E6%A0%B7%E6%8E%A5%E5%8F%97%E4%B8%80%E4%B8%AA%E6%95%B0%E5%AD%97%E5%8F%82%E6%95%B0%E4%BD%9C%E4%B8%BA%E8%B7%B3%E8%BF%87%E7%9A%84%E8%AE%B0%E5%BD%95%E6%9D%A1%E6%95%B0%E3%80%82%EF%BC%88%E5%89%8DN%E4%B8%AA%E4%B8%8D%E8%A6%81%EF%BC%89-%E9%BB%98%E8%AE%A4%E5%80%BC%E6%98%AF-0"><span class="nav-number">4.7.2.4.</span> <span class="nav-text">skip方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）,默认值是 0</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%EF%BC%9A%E9%9C%80%E6%B1%82%EF%BC%9A%E6%AF%8F%E9%A1%B5-2-%E4%B8%AA%EF%BC%8C%E7%AC%AC%E4%BA%8C%E9%A1%B5%E5%BC%80%E5%A7%8B%EF%BC%9A%E8%B7%B3%E8%BF%87%E5%89%8D%E4%B8%A4%E6%9D%A1%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%8E%A5%E7%9D%80%E5%80%BC%E6%98%BE%E7%A4%BA-3-%E5%92%8C-4-%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="nav-number">4.7.2.5.</span> <span class="nav-text">分页查询：需求：每页 2 个，第二页开始：跳过前两条数据，接着值显示 3 和 4 条数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-3-%E6%8E%92%E5%BA%8F%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.7.3.</span> <span class="nav-text">3.5.3 排序查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sort-%E6%96%B9%E6%B3%95%E5%AF%B9%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F%EF%BC%8Csort-%E6%96%B9%E6%B3%95%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%8F%82%E6%95%B0%E6%8C%87%E5%AE%9A%E6%8E%92%E5%BA%8F%E7%9A%84%E5%AD%97%E6%AE%B5%EF%BC%8C%E5%B9%B6%E4%BD%BF%E7%94%A8-1-%E5%92%8C-1-%E6%9D%A5%E6%8C%87%E5%AE%9A%E6%8E%92%E5%BA%8F%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E5%85%B6%E4%B8%AD-1-%E4%B8%BA%E5%8D%87%E5%BA%8F%E6%8E%92%E5%88%97%EF%BC%8C%E8%80%8C-1-%E6%98%AF%E7%94%A8%E4%BA%8E%E9%99%8D%E5%BA%8F%E6%8E%92%E5%88%97"><span class="nav-number">4.7.3.1.</span> <span class="nav-text">sort() 方法对数据进行排序，sort() 方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而 -1 是用于降序排列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95%E5%A6%82%E4%B8%8B%E6%89%80%E7%A4%BA"><span class="nav-number">4.7.3.2.</span> <span class="nav-text">语法如下所示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B%E5%A6%82"><span class="nav-number">4.7.3.3.</span> <span class="nav-text">例如</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9userid%E9%99%8D%E5%BA%8F%E6%8E%92%E5%88%97%EF%BC%8C%E5%B9%B6%E5%AF%B9%E8%AE%BF%E9%97%AE%E9%87%8F%E8%BF%9B%E8%A1%8C%E5%8D%87%E5%BA%8F%E6%8E%92%E5%88%97"><span class="nav-number">4.7.3.4.</span> <span class="nav-text">对userid降序排列，并对访问量进行升序排列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-7"><span class="nav-number">4.7.3.5.</span> <span class="nav-text">提示</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-%E6%96%87%E6%A1%A3%E7%9A%84%E6%9B%B4%E5%A4%9A%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.8.</span> <span class="nav-text">3.6 文档的更多查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-1-%E6%AD%A3%E5%88%99%E7%9A%84%E5%A4%8D%E6%9D%82%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.8.1.</span> <span class="nav-text">3.6.1 正则的复杂条件查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB%E7%9A%84%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E6%98%AF%E9%80%9A%E8%BF%87%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0%E7%9A%84%E3%80%82%E6%A0%BC%E5%BC%8F%E4%B8%BA"><span class="nav-number">4.8.1.1.</span> <span class="nav-text">MongoDB的模糊查询是通过正则表达式的方式实现的。格式为</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9A%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%98%AFjs%E7%9A%84%E8%AF%AD%E6%B3%95%EF%BC%8C%E7%9B%B4%E6%8E%A5%E9%87%8F%E7%9A%84%E5%86%99%E6%B3%95"><span class="nav-number">4.8.1.2.</span> <span class="nav-text">提示：正则表达式是js的语法，直接量的写法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B%E5%A6%82%EF%BC%8C%E6%88%91%E8%A6%81%E6%9F%A5%E8%AF%A2%E8%AF%84%E8%AE%BA%E5%86%85%E5%AE%B9%E5%8C%85%E5%90%AB%E2%80%9C%E5%BC%80%E6%B0%B4%E2%80%9D%E7%9A%84%E6%89%80%E6%9C%89%E6%96%87%E6%A1%A3%EF%BC%8C%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B"><span class="nav-number">4.8.1.3.</span> <span class="nav-text">例如，我要查询评论内容包含“开水”的所有文档，代码如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E8%A6%81%E6%9F%A5%E8%AF%A2%E8%AF%84%E8%AE%BA%E7%9A%84%E5%86%85%E5%AE%B9%E4%B8%AD%E4%BB%A5%E2%80%9C%E4%B8%93%E5%AE%B6%E2%80%9D%E5%BC%80%E5%A4%B4%E7%9A%84%EF%BC%8C%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B"><span class="nav-number">4.8.1.4.</span> <span class="nav-text">如果要查询评论的内容中以“专家”开头的，代码如下</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-2-%E6%AF%94%E8%BE%83%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.8.2.</span> <span class="nav-text">3.6.2 比较查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#lt-lt-gt-gt-%E8%BF%99%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%AC%A6%E4%B9%9F%E6%98%AF%E5%BE%88%E5%B8%B8%E7%94%A8%E7%9A%84%EF%BC%8C%E6%A0%BC%E5%BC%8F%E5%A6%82%E4%B8%8B"><span class="nav-number">4.8.2.1.</span> <span class="nav-text">&lt;, &lt;&#x3D;, &gt;, &gt;&#x3D; 这个操作符也是很常用的，格式如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%9F%A5%E8%AF%A2%E8%AF%84%E8%AE%BA%E7%82%B9%E8%B5%9E%E6%95%B0%E9%87%8F%E5%A4%A7%E4%BA%8E-700-%E7%9A%84%E8%AE%B0%E5%BD%95"><span class="nav-number">4.8.2.2.</span> <span class="nav-text">示例：查询评论点赞数量大于 700 的记录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-3-%E5%8C%85%E5%90%AB%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.8.3.</span> <span class="nav-text">3.6.3 包含查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8C%85%E5%90%AB%E4%BD%BF%E7%94%A8-in%E6%93%8D%E4%BD%9C%E7%AC%A6%E3%80%82-%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%9F%A5%E8%AF%A2%E8%AF%84%E8%AE%BA%E7%9A%84%E9%9B%86%E5%90%88%E4%B8%ADuserid%E5%AD%97%E6%AE%B5%E5%8C%85%E5%90%AB-1003-%E6%88%96-1004-%E7%9A%84%E6%96%87%E6%A1%A3"><span class="nav-number">4.8.3.1.</span> <span class="nav-text">包含使用$in操作符。 示例：查询评论的集合中userid字段包含 1003 或 1004 的文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8D%E5%8C%85%E5%90%AB%E4%BD%BF%E7%94%A8-nin%E6%93%8D%E4%BD%9C%E7%AC%A6%E3%80%82-%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%9F%A5%E8%AF%A2%E8%AF%84%E8%AE%BA%E9%9B%86%E5%90%88%E4%B8%ADuserid%E5%AD%97%E6%AE%B5%E4%B8%8D%E5%8C%85%E5%90%AB-1003-%E5%92%8C-1004-%E7%9A%84%E6%96%87%E6%A1%A3"><span class="nav-number">4.8.3.2.</span> <span class="nav-text">不包含使用$nin操作符。 示例：查询评论集合中userid字段不包含 1003 和 1004 的文档</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-4-%E6%9D%A1%E4%BB%B6%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.8.4.</span> <span class="nav-text">3.6.4 条件连接查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%88%91%E4%BB%AC%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E6%9F%A5%E8%AF%A2%E5%90%8C%E6%97%B6%E6%BB%A1%E8%B6%B3%E4%B8%A4%E4%B8%AA%E4%BB%A5%E4%B8%8A%E6%9D%A1%E4%BB%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8-and%E6%93%8D%E4%BD%9C%E7%AC%A6%E5%B0%86%E6%9D%A1%E4%BB%B6%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%E3%80%82%EF%BC%88%E7%9B%B8-%E5%BD%93%E4%BA%8ESQL%E7%9A%84and%EF%BC%89-%E6%A0%BC%E5%BC%8F%E4%B8%BA"><span class="nav-number">4.8.4.1.</span> <span class="nav-text">我们如果需要查询同时满足两个以上条件，需要使用$and操作符将条件进行关联。（相 当于SQL的and） 格式为</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%9F%A5%E8%AF%A2%E8%AF%84%E8%AE%BA%E9%9B%86%E5%90%88%E4%B8%ADlikenum%E5%A4%A7%E4%BA%8E%E7%AD%89%E4%BA%8E-700-%E5%B9%B6%E4%B8%94%E5%B0%8F%E4%BA%8E-2000-%E7%9A%84%E6%96%87%E6%A1%A3"><span class="nav-number">4.8.4.2.</span> <span class="nav-text">示例：查询评论集合中likenum大于等于 700 并且小于 2000 的文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E4%B8%A4%E4%B8%AA%E4%BB%A5%E4%B8%8A%E6%9D%A1%E4%BB%B6%E4%B9%8B%E9%97%B4%E6%98%AF%E6%88%96%E8%80%85%E7%9A%84%E5%85%B3%E7%B3%BB%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BD%BF%E7%94%A8-%E6%93%8D%E4%BD%9C%E7%AC%A6%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%EF%BC%8C%E4%B8%8E%E5%89%8D%E9%9D%A2-and%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%E7%9B%B8%E5%90%8C-%E6%A0%BC%E5%BC%8F%E4%B8%BA"><span class="nav-number">4.8.4.3.</span> <span class="nav-text">如果两个以上条件之间是或者的关系，我们使用 操作符进行关联，与前面 and的使用方式相同 格式为</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%9F%A5%E8%AF%A2%E8%AF%84%E8%AE%BA%E9%9B%86%E5%90%88%E4%B8%ADuserid%E4%B8%BA-1003-%EF%BC%8C%E6%88%96%E8%80%85%E7%82%B9%E8%B5%9E%E6%95%B0%E5%B0%8F%E4%BA%8E-1000-%E7%9A%84%E6%96%87%E6%A1%A3%E8%AE%B0%E5%BD%95"><span class="nav-number">4.8.4.4.</span> <span class="nav-text">示例：查询评论集合中userid为 1003 ，或者点赞数小于 1000 的文档记录</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%B0%8F%E7%BB%93"><span class="nav-number">4.9.</span> <span class="nav-text">3.7 常用命令小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E7%B4%A2%E5%BC%95-Index"><span class="nav-number">5.</span> <span class="nav-text">4 索引-Index</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E6%A6%82%E8%BF%B0"><span class="nav-number">5.1.</span> <span class="nav-text">4.1 概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%98%E7%BD%91%E6%96%87%E6%A1%A3%EF%BC%9Ahttps-docs-mongodb-com-manual-indexes"><span class="nav-number">5.1.0.1.</span> <span class="nav-text">官网文档：https:&#x2F;&#x2F;docs.mongodb.com&#x2F;manual&#x2F;indexes&#x2F;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%86%E8%A7%A3"><span class="nav-number">5.1.0.2.</span> <span class="nav-text">了解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8B%E6%A0%91%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%88%E7%A1%AE%E5%88%87%E7%9A%84%E8%AF%B4%E6%98%AFB-Tree%EF%BC%8CMySQL%E6%98%AFB-Tree%EF%BC%89"><span class="nav-number">5.1.0.3.</span> <span class="nav-text">MongoDB索引使用B树数据结构（确切的说是B-Tree，MySQL是B+Tree）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E7%B4%A2%E5%BC%95%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.2.</span> <span class="nav-text">4.2 索引的类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-1-%E5%8D%95%E5%AD%97%E6%AE%B5%E7%B4%A2%E5%BC%95"><span class="nav-number">5.3.</span> <span class="nav-text">4.2.1 单字段索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-2-%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95"><span class="nav-number">5.4.</span> <span class="nav-text">4.2.2 复合索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-3-%E5%85%B6%E4%BB%96%E7%B4%A2%E5%BC%95"><span class="nav-number">5.4.1.</span> <span class="nav-text">4.2.3 其他索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%B0%E7%90%86%E7%A9%BA%E9%97%B4%E7%B4%A2%E5%BC%95%EF%BC%88Geospatial-Index%EF%BC%89"><span class="nav-number">5.4.1.1.</span> <span class="nav-text">地理空间索引（Geospatial Index）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E6%9C%AC%E7%B4%A2%E5%BC%95%EF%BC%88Text-Indexes%EF%BC%89"><span class="nav-number">5.4.1.2.</span> <span class="nav-text">文本索引（Text Indexes）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E7%B4%A2%E5%BC%95%EF%BC%88Hashed-Indexes%EF%BC%89"><span class="nav-number">5.4.1.3.</span> <span class="nav-text">哈希索引（Hashed Indexes）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E7%B4%A2%E5%BC%95%E7%9A%84%E7%AE%A1%E7%90%86%E6%93%8D%E4%BD%9C"><span class="nav-number">5.5.</span> <span class="nav-text">4.3 索引的管理操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-%E7%B4%A2%E5%BC%95%E7%9A%84%E6%9F%A5%E7%9C%8B"><span class="nav-number">5.5.1.</span> <span class="nav-text">4.3.1 索引的查看</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E"><span class="nav-number">5.5.1.1.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E9%9B%86%E5%90%88%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E7%B4%A2%E5%BC%95%E7%9A%84%E6%95%B0%E7%BB%84"><span class="nav-number">5.5.1.2.</span> <span class="nav-text">返回一个集合中的所有索引的数组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-1"><span class="nav-number">5.5.1.3.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9A%E8%AF%A5%E8%AF%AD%E6%B3%95%E5%91%BD%E4%BB%A4%E8%BF%90%E8%A1%8C%E8%A6%81%E6%B1%82%E6%98%AFMongoDB-3-0"><span class="nav-number">5.5.1.4.</span> <span class="nav-text">提示：该语法命令运行要求是MongoDB 3.0+</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-5"><span class="nav-number">5.5.1.5.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8Bcomment%E9%9B%86%E5%90%88%E4%B8%AD%E6%89%80%E6%9C%89%E7%9A%84%E7%B4%A2%E5%BC%95%E6%83%85%E5%86%B5"><span class="nav-number">5.5.1.6.</span> <span class="nav-text">查看comment集合中所有的索引情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C%E4%B8%AD%E6%98%BE%E7%A4%BA%E7%9A%84%E6%98%AF%E9%BB%98%E8%AE%A4-id%E7%B4%A2%E5%BC%95"><span class="nav-number">5.5.1.7.</span> <span class="nav-text">结果中显示的是默认_id索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4-id%E7%B4%A2%E5%BC%95"><span class="nav-number">5.5.1.8.</span> <span class="nav-text">默认_id索引</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">5.5.2.</span> <span class="nav-text">4.3.2 索引的创建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E-1"><span class="nav-number">5.5.2.1.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E9%9B%86%E5%90%88%E4%B8%8A%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">5.5.2.2.</span> <span class="nav-text">在集合上创建索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-2"><span class="nav-number">5.5.2.3.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#options%EF%BC%88%E6%9B%B4%E5%A4%9A%E9%80%89%E9%A1%B9%EF%BC%89%E5%88%97%E8%A1%A8"><span class="nav-number">5.5.2.4.</span> <span class="nav-text">options（更多选项）列表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-8"><span class="nav-number">5.5.2.5.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-6"><span class="nav-number">5.5.2.6.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0-1-%EF%BC%9A%E6%8C%89%E5%8D%87%E5%BA%8F%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">5.5.2.7.</span> <span class="nav-text">参数 1 ：按升序创建索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8B%E4%B8%80%E4%B8%8B"><span class="nav-number">5.5.2.8.</span> <span class="nav-text">可以查看一下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E4%B8%80%E4%B8%8B%E7%B4%A2%E5%BC%95"><span class="nav-number">5.5.2.9.</span> <span class="nav-text">查看一下索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#compass%E4%B8%AD"><span class="nav-number">5.5.2.10.</span> <span class="nav-text">compass中</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-3-%E7%B4%A2%E5%BC%95%E7%9A%84%E7%A7%BB%E9%99%A4"><span class="nav-number">5.5.3.</span> <span class="nav-text">4.3.3 索引的移除</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E%EF%BC%9A%E5%8F%AF%E4%BB%A5%E7%A7%BB%E9%99%A4%E6%8C%87%E5%AE%9A%E7%9A%84%E7%B4%A2%E5%BC%95%EF%BC%8C%E6%88%96%E7%A7%BB%E9%99%A4%E6%89%80%E6%9C%89%E7%B4%A2%E5%BC%95"><span class="nav-number">5.5.3.1.</span> <span class="nav-text">说明：可以移除指定的索引，或移除所有索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%8C%87%E5%AE%9A%E7%B4%A2%E5%BC%95%E7%9A%84%E7%A7%BB%E9%99%A4"><span class="nav-number">5.5.3.2.</span> <span class="nav-text">一、指定索引的移除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-3"><span class="nav-number">5.5.3.3.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0-5"><span class="nav-number">5.5.3.4.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-7"><span class="nav-number">5.5.3.5.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4comment%E9%9B%86%E5%90%88%E4%B8%ADuserid%E5%AD%97%E6%AE%B5%E4%B8%8A%E7%9A%84%E5%8D%87%E5%BA%8F%E7%B4%A2%E5%BC%95"><span class="nav-number">5.5.3.6.</span> <span class="nav-text">删除comment集合中userid字段上的升序索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%88%A0%E9%99%A4%E4%BA%86"><span class="nav-number">5.5.3.7.</span> <span class="nav-text">查看已经删除了</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%89%80%E6%9C%89%E7%B4%A2%E5%BC%95%E7%9A%84%E7%A7%BB%E9%99%A4"><span class="nav-number">5.5.3.8.</span> <span class="nav-text">二、所有索引的移除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-4"><span class="nav-number">5.5.3.9.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-8"><span class="nav-number">5.5.3.10.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4spit%E9%9B%86%E5%90%88%E4%B8%AD%E6%89%80%E6%9C%89%E7%B4%A2%E5%BC%95"><span class="nav-number">5.5.3.11.</span> <span class="nav-text">删除spit集合中所有索引</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">5.6.</span> <span class="nav-text">4.4 索引的使用^</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="nav-number">5.6.1.</span> <span class="nav-text">4.4.1 执行计划</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-5"><span class="nav-number">5.6.1.1.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-9"><span class="nav-number">5.6.1.2.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%A0%B9%E6%8D%AEuserid%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">5.6.1.3.</span> <span class="nav-text">查看根据userid查询数据的情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E7%82%B9%E7%9C%8B%EF%BC%9A%E2%80%9Dstage%E2%80%9D-%E2%80%9CCOLLSCAN%E2%80%9D-%E8%A1%A8%E7%A4%BA%E5%85%A8%E9%9B%86%E5%90%88%E6%89%AB%E6%8F%8F"><span class="nav-number">5.6.1.4.</span> <span class="nav-text">关键点看：”stage” : “COLLSCAN”,表示全集合扫描</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E9%9D%A2%E5%AF%B9userid%E5%BB%BA%E7%AB%8B%E7%B4%A2%E5%BC%95"><span class="nav-number">5.6.1.5.</span> <span class="nav-text">下面对userid建立索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%8D%E6%AC%A1%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="nav-number">5.6.1.6.</span> <span class="nav-text">再次查看执行计划</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E7%82%B9%E7%9C%8B%EF%BC%9A%E2%80%9Dstage%E2%80%9D-%E2%80%9CIXSCAN%E2%80%9D-%E5%9F%BA%E4%BA%8E%E7%B4%A2%E5%BC%95%E7%9A%84%E6%89%AB%E6%8F%8F"><span class="nav-number">5.6.1.7.</span> <span class="nav-text">关键点看：”stage” : “IXSCAN”,基于索引的扫描</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#compass%E6%9F%A5%E7%9C%8B"><span class="nav-number">5.6.1.8.</span> <span class="nav-text">compass查看</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-2-%E6%B6%B5%E7%9B%96%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.6.2.</span> <span class="nav-text">4.4.2 涵盖的查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Covered-Queries"><span class="nav-number">5.6.2.1.</span> <span class="nav-text">Covered Queries</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E5%A4%9A%EF%BC%9Ahttps-docs-mongodb-com-manual-core-query-optimization-read-operations-covered-query"><span class="nav-number">5.6.2.2.</span> <span class="nav-text">更多：https:&#x2F;&#x2F;docs.mongodb.com&#x2F;manual&#x2F;core&#x2F;query-optimization&#x2F;#read-operations-covered-query</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-10"><span class="nav-number">5.6.2.3.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Compass%E4%B8%AD"><span class="nav-number">5.6.2.4.</span> <span class="nav-text">Compass中</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E6%96%87%E7%AB%A0%E8%AF%84%E8%AE%BA"><span class="nav-number">6.</span> <span class="nav-text">5 文章评论</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-number">6.1.</span> <span class="nav-text">5.1 需求分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%90%E5%A4%B4%E6%9D%A1%E7%9A%84%E6%96%87%E7%AB%A0%E8%AF%84%E8%AE%BA%E4%B8%9A%E5%8A%A1%E5%A6%82%E4%B8%8B"><span class="nav-number">6.1.0.1.</span> <span class="nav-text">某头条的文章评论业务如下</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-%E8%A1%A8%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90"><span class="nav-number">6.2.</span> <span class="nav-text">5.2 表结构分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%9Aarticledb"><span class="nav-number">6.2.0.1.</span> <span class="nav-text">数据库：articledb</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="nav-number">6.3.</span> <span class="nav-text">5.3 技术选型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-mongodb-driver%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">6.3.1.</span> <span class="nav-text">5.3.1 mongodb-driver（了解）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-SpringDataMongoDB"><span class="nav-number">6.3.2.</span> <span class="nav-text">5.3.2 SpringDataMongoDB</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-%E6%96%87%E7%AB%A0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97%E6%90%AD%E5%BB%BA"><span class="nav-number">6.4.</span> <span class="nav-text">5.4 文章微服务模块搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cn-itcast-article-ArticleApplication"><span class="nav-number">6.4.0.1.</span> <span class="nav-text">cn.itcast.article.ArticleApplication</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-%E6%96%87%E7%AB%A0%E8%AF%84%E8%AE%BA%E5%AE%9E%E4%BD%93%E7%B1%BB%E7%9A%84%E7%BC%96%E5%86%99"><span class="nav-number">6.5.</span> <span class="nav-text">5.5 文章评论实体类的编写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93%E7%B1%BB-%E5%88%9B%E5%BB%BA%E5%8C%85cn-itcast-article%EF%BC%8C%E5%8C%85%E4%B8%8B%E5%BB%BA%E5%8C%85po%E7%94%A8%E4%BA%8E%E5%AD%98%E6%94%BE%E5%AE%9E%E4%BD%93%E7%B1%BB%EF%BC%8C%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-number">6.5.0.1.</span> <span class="nav-text">创建实体类 创建包cn.itcast.article，包下建包po用于存放实体类，创建实体类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cn-itcast-article-po-Comment"><span class="nav-number">6.5.0.2.</span> <span class="nav-text">cn.itcast.article.po.Comment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E-2"><span class="nav-number">6.5.0.3.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mongo%E5%91%BD%E4%BB%A4%E5%8F%82%E8%80%83"><span class="nav-number">6.5.0.4.</span> <span class="nav-text">Mongo命令参考</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mongo%E5%91%BD%E4%BB%A4%E5%8F%82%E8%80%83-1"><span class="nav-number">6.5.0.5.</span> <span class="nav-text">Mongo命令参考</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-6-%E6%96%87%E7%AB%A0%E8%AF%84%E8%AE%BA%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="nav-number">6.6.</span> <span class="nav-text">5.6 文章评论的基本增删改查</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cn-itcast-article-dao-CommentRepository"><span class="nav-number">6.6.0.1.</span> <span class="nav-text">cn.itcast.article.dao.CommentRepository</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cn-itcast-article-service-CommentService"><span class="nav-number">6.6.0.2.</span> <span class="nav-text">cn.itcast.article.service.CommentService</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cn-itcast-article-service-CommentServiceTest"><span class="nav-number">6.6.0.3.</span> <span class="nav-text">cn.itcast.article.service.CommentServiceTest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E7%BB%93%E6%9E%9C"><span class="nav-number">6.6.0.4.</span> <span class="nav-text">添加结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-7-%E6%A0%B9%E6%8D%AE%E4%B8%8A%E7%BA%A7ID%E6%9F%A5%E8%AF%A2%E6%96%87%E7%AB%A0%E8%AF%84%E8%AE%BA%E7%9A%84%E5%88%86%E9%A1%B5%E5%88%97%E8%A1%A8"><span class="nav-number">6.7.</span> <span class="nav-text">5.7 根据上级ID查询文章评论的分页列表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%88-3-%EF%BC%89junit%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="nav-number">6.7.0.1.</span> <span class="nav-text">（ 3 ）junit测试用例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cn-itcast-article-service-CommentServiceTest-1"><span class="nav-number">6.7.0.2.</span> <span class="nav-text">cn.itcast.article.service.CommentServiceTest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%88-4-%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="nav-number">6.7.0.3.</span> <span class="nav-text">（ 4 ）测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8compass%E5%BF%AB%E9%80%9F%E6%8F%92%E5%85%A5%E4%B8%80%E6%9D%A1%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%95%B0%E6%8D%AE%E7%9A%84%E5%86%85%E5%AE%B9%E6%98%AF%E5%AF%B9-3-%E5%8F%B7%E8%AF%84%E8%AE%BA%E5%86%85%E5%AE%B9%E8%BF%9B%E8%A1%8C%E8%AF%84%E8%AE%BA"><span class="nav-number">6.7.0.4.</span> <span class="nav-text">使用compass快速插入一条测试数据，数据的内容是对 3 号评论内容进行评论</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%8B%E8%AF%95%EF%BC%8C%E7%BB%93%E6%9E%9C"><span class="nav-number">6.7.0.5.</span> <span class="nav-text">执行测试，结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-8-MongoTemplate%E5%AE%9E%E7%8E%B0%E8%AF%84%E8%AE%BA%E7%82%B9%E8%B5%9E"><span class="nav-number">6.8.</span> <span class="nav-text">5.8 MongoTemplate实现评论点赞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%88%91%E4%BB%AC%E7%9C%8B%E4%B8%80%E4%B8%8B%E4%BB%A5%E4%B8%8B%E7%82%B9%E8%B5%9E%E7%9A%84%E4%B8%B4%E6%97%B6%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%EF%BC%9A-CommentService-%E6%96%B0%E5%A2%9EupdateThumbup%E6%96%B9%E6%B3%95"><span class="nav-number">6.8.0.1.</span> <span class="nav-text">我们看一下以下点赞的临时示例代码： CommentService 新增updateThumbup方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8MongoTemplate%E7%B1%BB%E6%9D%A5%E5%AE%9E%E7%8E%B0%E5%AF%B9%E6%9F%90%E5%88%97%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-number">6.8.0.2.</span> <span class="nav-text">我们可以使用MongoTemplate类来实现对某列的操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cn-itcast-article-service-CommentServiceTest-2"><span class="nav-number">6.8.0.3.</span> <span class="nav-text">cn.itcast.article.service.CommentServiceTest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E5%90%8E%EF%BC%8C%E5%8F%91%E7%8E%B0%E7%82%B9%E8%B5%9E%E6%95%B0-1%E4%BA%86"><span class="nav-number">6.8.0.4.</span> <span class="nav-text">执行测试用例后，发现点赞数+1了</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MongoDB%E9%9B%86%E7%BE%A4%E5%92%8C%E5%AE%89%E5%85%A8"><span class="nav-number">7.</span> <span class="nav-text">MongoDB集群和安全</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E5%89%AF%E6%9C%AC%E9%9B%86-Replica-Sets"><span class="nav-number">8.</span> <span class="nav-text">1. 副本集-Replica Sets</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E7%AE%80%E4%BB%8B"><span class="nav-number">8.1.</span> <span class="nav-text">1.1 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E4%B8%89%E4%B8%AA%E8%A7%92%E8%89%B2"><span class="nav-number">8.2.</span> <span class="nav-text">1.2 副本集的三个角色</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E6%9C%89%E4%B8%A4%E7%A7%8D%E7%B1%BB%E5%9E%8B%E4%B8%89%E7%A7%8D%E8%A7%92%E8%89%B2"><span class="nav-number">8.2.0.1.</span> <span class="nav-text">副本集有两种类型三种角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E7%B1%BB%E5%9E%8B"><span class="nav-number">8.2.0.2.</span> <span class="nav-text">两种类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E8%A7%92%E8%89%B2"><span class="nav-number">8.2.0.3.</span> <span class="nav-text">三种角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E4%BB%B2%E8%A3%81%E8%80%85%E7%9A%84%E9%A2%9D%E5%A4%96%E8%AF%B4%E6%98%8E"><span class="nav-number">8.2.0.4.</span> <span class="nav-text">关于仲裁者的额外说明</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E5%89%AF%E6%9C%AC%E9%9B%86%E6%9E%B6%E6%9E%84%E7%9B%AE%E6%A0%87"><span class="nav-number">8.3.</span> <span class="nav-text">1.3 副本集架构目标</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E4%B8%BB%E4%B8%80%E5%89%AF%E6%9C%AC%E4%B8%80%E4%BB%B2%E8%A3%81"><span class="nav-number">8.3.0.1.</span> <span class="nav-text">一主一副本一仲裁</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">8.4.</span> <span class="nav-text">1.4 副本集的创建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-1-%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="nav-number">8.4.1.</span> <span class="nav-text">1.4.1 第一步：创建主节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%AD%98%E6%94%BE%E6%95%B0%E6%8D%AE%E5%92%8C%E6%97%A5%E5%BF%97%E7%9A%84%E7%9B%AE%E5%BD%95"><span class="nav-number">8.4.1.1.</span> <span class="nav-text">建立存放数据和日志的目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">8.4.1.2.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myrs-27017"><span class="nav-number">8.4.1.3.</span> <span class="nav-text">myrs_27017</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1"><span class="nav-number">8.4.1.4.</span> <span class="nav-text">启动节点服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-2-%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9"><span class="nav-number">8.4.2.</span> <span class="nav-text">1.4.2 第二步：创建副本节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%AD%98%E6%94%BE%E6%95%B0%E6%8D%AE%E5%92%8C%E6%97%A5%E5%BF%97%E7%9A%84%E7%9B%AE%E5%BD%95-1"><span class="nav-number">8.4.2.1.</span> <span class="nav-text">建立存放数据和日志的目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="nav-number">8.4.2.2.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myrs-27018"><span class="nav-number">8.4.2.3.</span> <span class="nav-text">myrs_27018</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1-1"><span class="nav-number">8.4.2.4.</span> <span class="nav-text">启动节点服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-3-%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9"><span class="nav-number">8.4.3.</span> <span class="nav-text">1.4.3 第三步：创建仲裁节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%AD%98%E6%94%BE%E6%95%B0%E6%8D%AE%E5%92%8C%E6%97%A5%E5%BF%97%E7%9A%84%E7%9B%AE%E5%BD%95-2"><span class="nav-number">8.4.3.1.</span> <span class="nav-text">建立存放数据和日志的目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9"><span class="nav-number">8.4.3.2.</span> <span class="nav-text">仲裁节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="nav-number">8.4.3.3.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myrs-27019"><span class="nav-number">8.4.3.4.</span> <span class="nav-text">myrs_27019</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1-2"><span class="nav-number">8.4.3.5.</span> <span class="nav-text">启动节点服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-5-%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE%E5%89%AF%E6%9C%AC%E9%9B%86%E5%92%8C%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="nav-number">8.4.4.</span> <span class="nav-text">1.4.5 第四步：初始化配置副本集和主节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E8%BF%9E%E6%8E%A5%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%8C%E4%BD%86%E8%BF%99%E9%87%8C%E5%B0%BD%E9%87%8F%E8%A6%81%E8%BF%9E%E6%8E%A5%E4%B8%BB%E8%8A%82%E7%82%B9-27017%E8%8A%82%E7%82%B9"><span class="nav-number">8.4.4.1.</span> <span class="nav-text">使用客户端命令连接任意一个节点，但这里尽量要连接主节点(27017节点)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C%EF%BC%8C%E8%BF%9E%E6%8E%A5%E4%B8%8A%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%BE%88%E5%A4%9A%E5%91%BD%E4%BB%A4%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8%EF%BC%8C%EF%BC%8C%E6%AF%94%E5%A6%82show-dbs%E7%AD%89%EF%BC%8C%E5%BF%85%E9%A1%BB%E5%88%9D%E5%A7%8B%E5%8C%96%E5%89%AF%E6%9C%AC%E9%9B%86%E6%89%8D%E8%A1%8C"><span class="nav-number">8.4.4.2.</span> <span class="nav-text">结果，连接上之后，很多命令无法使用，，比如show dbs等，必须初始化副本集才行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B0%E7%9A%84%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">8.4.4.3.</span> <span class="nav-text">准备初始化新的副本集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-6"><span class="nav-number">8.4.4.4.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E9%A1%B9"><span class="nav-number">8.4.4.5.</span> <span class="nav-text">选项</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-11"><span class="nav-number">8.4.4.6.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E7%9A%84%E9%85%8D%E7%BD%AE%E6%9D%A5%E5%88%9D%E5%A7%8B%E5%8C%96%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">8.4.4.7.</span> <span class="nav-text">使用默认的配置来初始化副本集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="nav-number">8.4.4.8.</span> <span class="nav-text">执行结果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-9"><span class="nav-number">8.4.4.9.</span> <span class="nav-text">提示</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-6-%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E9%85%8D%E7%BD%AE%E5%86%85%E5%AE%B9"><span class="nav-number">8.4.5.</span> <span class="nav-text">1.4.6 第五步：查看副本集的配置内容</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E-3"><span class="nav-number">8.4.5.1.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%8C%85%E5%90%AB%E5%BD%93%E5%89%8D%E5%89%AF%E6%9C%AC%E9%9B%86%E9%85%8D%E7%BD%AE%E7%9A%84%E6%96%87%E6%A1%A3"><span class="nav-number">8.4.5.2.</span> <span class="nav-text">返回包含当前副本集配置的文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-7"><span class="nav-number">8.4.5.3.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-10"><span class="nav-number">8.4.5.4.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rs-config-%E6%98%AF%E8%AF%A5%E6%96%B9%E6%B3%95%E7%9A%84%E5%88%AB%E5%90%8D"><span class="nav-number">8.4.5.5.</span> <span class="nav-text">rs.config()是该方法的别名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#configuration%EF%BC%9A%E5%8F%AF%E9%80%89%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%88%99%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E4%B8%BB%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">8.4.5.6.</span> <span class="nav-text">configuration：可选，如果没有配置，则使用默认主节点配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-12"><span class="nav-number">8.4.5.7.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8-27017-%E4%B8%8A%E6%89%A7%E8%A1%8C%E5%89%AF%E6%9C%AC%E9%9B%86%E4%B8%AD%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E7%9A%84%E9%BB%98%E8%AE%A4%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">8.4.5.8.</span> <span class="nav-text">在 27017 上执行副本集中当前节点的默认节点配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E-4"><span class="nav-number">8.4.5.9.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9A%E5%89%AF%E6%9C%AC%E9%9B%86%E9%85%8D%E7%BD%AE%E7%9A%84%E6%9F%A5%E7%9C%8B%E5%91%BD%E4%BB%A4%EF%BC%8C%E6%9C%AC%E8%B4%A8%E6%98%AF%E6%9F%A5%E8%AF%A2%E7%9A%84%E6%98%AFsystem-replset%E7%9A%84%E8%A1%A8%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="nav-number">8.4.5.10.</span> <span class="nav-text">提示：副本集配置的查看命令，本质是查询的是system.replset的表中的数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-7-%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%8A%B6%E6%80%81"><span class="nav-number">8.4.6.</span> <span class="nav-text">1.4.7 第六步：查看副本集状态</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E5%89%AF%E6%9C%AC%E9%9B%86%E7%8A%B6%E6%80%81"><span class="nav-number">8.4.6.1.</span> <span class="nav-text">检查副本集状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E-5"><span class="nav-number">8.4.6.2.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%8C%85%E5%90%AB%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%E7%9A%84%E6%96%87%E6%A1%A3%E3%80%82%E6%AD%A4%E8%BE%93%E5%87%BA%E4%BD%BF%E7%94%A8%E4%BB%8E%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%85%B6%E4%BB%96%E6%88%90%E5%91%98%E5%8F%91%E9%80%81%E7%9A%84%E5%BF%83%E8%B7%B3%E5%8C%85%E4%B8%AD%E8%8E%B7%E5%BE%97%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8F%8D%E6%98%A0%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%BD%93%E5%89%8D%E7%8A%B6%E6%80%81"><span class="nav-number">8.4.6.3.</span> <span class="nav-text">返回包含状态信息的文档。此输出使用从副本集的其他成员发送的心跳包中获得的数据反映副本集的当前状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-8"><span class="nav-number">8.4.6.4.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-13"><span class="nav-number">8.4.6.5.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8-27017-%E4%B8%8A%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%8A%B6%E6%80%81"><span class="nav-number">8.4.6.6.</span> <span class="nav-text">在 27017 上查看副本集状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E-6"><span class="nav-number">8.4.6.7.</span> <span class="nav-text">说明</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-8-%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E6%B7%BB%E5%8A%A0%E5%89%AF%E6%9C%AC%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="nav-number">8.4.7.</span> <span class="nav-text">1.4.8 第四步：添加副本从节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E4%B8%BB%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0%E4%BB%8E%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B0%86%E5%85%B6%E4%BB%96%E6%88%90%E5%91%98%E5%8A%A0%E5%85%A5%E5%88%B0%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">8.4.7.1.</span> <span class="nav-text">在主节点添加从节点，将其他成员加入到副本集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-9"><span class="nav-number">8.4.7.2.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E9%A1%B9-1"><span class="nav-number">8.4.7.3.</span> <span class="nav-text">选项</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E6%88%90%E5%91%98%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3"><span class="nav-number">8.4.7.4.</span> <span class="nav-text">主机成员的配置文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-14"><span class="nav-number">8.4.7.5.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%86-27018-%E7%9A%84%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%89%AF%E6%9C%AC%E9%9B%86%E4%B8%AD"><span class="nav-number">8.4.7.6.</span> <span class="nav-text">将 27018 的副本节点添加到副本集中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E-7"><span class="nav-number">8.4.7.7.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%8A%B6%E6%80%81"><span class="nav-number">8.4.7.8.</span> <span class="nav-text">查看副本集状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-9-%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E6%B7%BB%E5%8A%A0%E4%BB%B2%E8%A3%81%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="nav-number">8.4.8.</span> <span class="nav-text">1.4.9 第五步：添加仲裁从节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9%E5%88%B0%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">8.4.8.1.</span> <span class="nav-text">添加一个仲裁节点到副本集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-10"><span class="nav-number">8.4.8.2.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%86-27019-%E7%9A%84%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%89%AF%E6%9C%AC%E9%9B%86%E4%B8%AD"><span class="nav-number">8.4.8.3.</span> <span class="nav-text">将 27019 的仲裁节点添加到副本集中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E-8"><span class="nav-number">8.4.8.4.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%8A%B6%E6%80%81-1"><span class="nav-number">8.4.8.5.</span> <span class="nav-text">查看副本集状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E-9"><span class="nav-number">8.4.8.6.</span> <span class="nav-text">说明</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C"><span class="nav-number">8.5.</span> <span class="nav-text">1.5 副本集的数据读写操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A%E6%B5%8B%E8%AF%95%E4%B8%89%E4%B8%AA%E4%B8%8D%E5%90%8C%E8%A7%92%E8%89%B2%E7%9A%84%E8%8A%82%E7%82%B9%E7%9A%84%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%86%99%E6%83%85%E5%86%B5"><span class="nav-number">8.5.0.1.</span> <span class="nav-text">目标：测试三个不同角色的节点的数据读写情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E4%B8%BB%E8%8A%82%E7%82%B9-27017-%EF%BC%8C%E5%86%99%E5%85%A5%E5%92%8C%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="nav-number">8.5.0.2.</span> <span class="nav-text">登录主节点 27017 ，写入和读取数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E4%BB%8E%E8%8A%82%E7%82%B9-27018"><span class="nav-number">8.5.0.3.</span> <span class="nav-text">登录从节点 27018</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E7%8E%B0%EF%BC%8C%E4%B8%8D%E8%83%BD%E8%AF%BB%E5%8F%96%E9%9B%86%E5%90%88%E7%9A%84%E6%95%B0%E6%8D%AE%E3%80%82%E5%BD%93%E5%89%8D%E4%BB%8E%E8%8A%82%E7%82%B9%E5%8F%AA%E6%98%AF%E4%B8%80%E4%B8%AA%E5%A4%87%E4%BB%BD%EF%BC%8C%E4%B8%8D%E6%98%AF%E5%A5%B4%E9%9A%B6%E8%8A%82%E7%82%B9%EF%BC%8C%E6%97%A0%E6%B3%95%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%86%99%E5%BD%93%E7%84%B6%E6%9B%B4%E4%B8%8D%E8%A1%8C"><span class="nav-number">8.5.0.4.</span> <span class="nav-text">发现，不能读取集合的数据。当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%A0%E4%B8%BA%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E4%BB%8E%E8%8A%82%E7%82%B9%E6%98%AF%E6%B2%A1%E6%9C%89%E8%AF%BB%E5%86%99%E6%9D%83%E9%99%90%E7%9A%84%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%A2%9E%E5%8A%A0%E8%AF%BB%E7%9A%84%E6%9D%83%E9%99%90%EF%BC%8C%E4%BD%86%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8C%E8%AE%BE%E7%BD%AE"><span class="nav-number">8.5.0.5.</span> <span class="nav-text">因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E8%AF%BB%E6%93%8D%E4%BD%9C%E6%9D%83%E9%99%90"><span class="nav-number">8.5.0.6.</span> <span class="nav-text">设置读操作权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B4%E6%98%8E-10"><span class="nav-number">8.5.0.7.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E4%B8%BA%E5%A5%B4%E9%9A%B6%E8%8A%82%E7%82%B9%EF%BC%8C%E5%85%81%E8%AE%B8%E5%9C%A8%E4%BB%8E%E6%88%90%E5%91%98%E4%B8%8A%E8%BF%90%E8%A1%8C%E8%AF%BB%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-number">8.5.0.8.</span> <span class="nav-text">设置为奴隶节点，允许在从成员上运行读的操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-11"><span class="nav-number">8.5.0.9.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-11"><span class="nav-number">8.5.0.10.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%A5%E5%91%BD%E4%BB%A4%E6%98%AFdb-getMongo-setSlaveOk-%E7%9A%84%E7%AE%80%E5%8C%96%E5%91%BD%E4%BB%A4"><span class="nav-number">8.5.0.11.</span> <span class="nav-text">该命令是db.getMongo().setSlaveOk()的简化命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-15"><span class="nav-number">8.5.0.12.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8-27018-%E4%B8%8A%E8%AE%BE%E7%BD%AE%E4%BD%9C%E4%B8%BA%E5%A5%B4%E9%9A%B6%E8%8A%82%E7%82%B9%E6%9D%83%E9%99%90%EF%BC%8C%E5%85%B7%E5%A4%87%E8%AF%BB%E6%9D%83%E9%99%90"><span class="nav-number">8.5.0.13.</span> <span class="nav-text">在 27018 上设置作为奴隶节点权限，具备读权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A4%E6%97%B6%EF%BC%8C%E5%9C%A8%E6%89%A7%E8%A1%8C%E6%9F%A5%E8%AF%A2%E5%91%BD%E4%BB%A4%EF%BC%8C%E8%BF%90%E8%A1%8C%E6%88%90%E5%8A%9F"><span class="nav-number">8.5.0.14.</span> <span class="nav-text">此时，在执行查询命令，运行成功</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%86%E4%BB%8D%E7%84%B6%E4%B8%8D%E5%85%81%E8%AE%B8%E6%8F%92%E5%85%A5"><span class="nav-number">8.5.0.15.</span> <span class="nav-text">但仍然不允许插入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8E%B0%E5%9C%A8%E5%8F%AF%E5%AE%9E%E7%8E%B0%E4%BA%86%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%EF%BC%8C%E8%AE%A9%E4%B8%BB%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%EF%BC%8C%E8%AE%A9%E4%BB%8E%E6%9D%A5%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="nav-number">8.5.0.16.</span> <span class="nav-text">现在可实现了读写分离，让主插入数据，让从来读取数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E8%A6%81%E5%8F%96%E6%B6%88%E4%BD%9C%E4%B8%BA%E5%A5%B4%E9%9A%B6%E8%8A%82%E7%82%B9%E7%9A%84%E8%AF%BB%E6%9D%83%E9%99%90"><span class="nav-number">8.5.0.17.</span> <span class="nav-text">如果要取消作为奴隶节点的读权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%B2%E8%A3%81%E8%80%85%E8%8A%82%E7%82%B9%EF%BC%8C%E4%B8%8D%E5%AD%98%E6%94%BE%E4%BB%BB%E4%BD%95%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E7%9A%84%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%99%BB%E5%BD%95%E6%9F%A5%E7%9C%8B"><span class="nav-number">8.5.0.18.</span> <span class="nav-text">仲裁者节点，不存放任何业务数据的，可以登录查看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E7%8E%B0%EF%BC%8C%E5%8F%AA%E5%AD%98%E6%94%BE%E5%89%AF%E6%9C%AC%E9%9B%86%E9%85%8D%E7%BD%AE%E7%AD%89%E6%95%B0%E6%8D%AE"><span class="nav-number">8.5.0.19.</span> <span class="nav-text">发现，只存放副本集配置等数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-%E4%B8%BB%E8%8A%82%E7%82%B9%E7%9A%84%E9%80%89%E4%B8%BE%E5%8E%9F%E5%88%99"><span class="nav-number">8.6.</span> <span class="nav-text">1.6 主节点的选举原则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB%E5%9C%A8%E5%89%AF%E6%9C%AC%E9%9B%86%E4%B8%AD%EF%BC%8C%E4%BC%9A%E8%87%AA%E5%8A%A8%E8%BF%9B%E8%A1%8C%E4%B8%BB%E8%8A%82%E7%82%B9%E7%9A%84%E9%80%89%E4%B8%BE%EF%BC%8C%E4%B8%BB%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%BE%E7%9A%84%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="nav-number">8.6.0.1.</span> <span class="nav-text">MongoDB在副本集中，会自动进行主节点的选举，主节点选举的触发条件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E6%97%A6%E8%A7%A6%E5%8F%91%E9%80%89%E4%B8%BE%EF%BC%8C%E5%B0%B1%E8%A6%81%E6%A0%B9%E6%8D%AE%E4%B8%80%E5%AE%9A%E8%A7%84%E5%88%99%E6%9D%A5%E9%80%89%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="nav-number">8.6.0.2.</span> <span class="nav-text">一旦触发选举，就要根据一定规则来选主节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E4%B8%BE%E8%A7%84%E5%88%99%E6%98%AF%E6%A0%B9%E6%8D%AE%E7%A5%A8%E6%95%B0%E6%9D%A5%E5%86%B3%E5%AE%9A%E8%B0%81%E8%8E%B7%E8%83%9C"><span class="nav-number">8.6.0.3.</span> <span class="nav-text">选举规则是根据票数来决定谁获胜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E8%8E%B7%E5%BE%97%E7%A5%A8%E6%95%B0%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%BC%98%E5%85%88%E7%BA%A7%EF%BC%88priority%EF%BC%89%E5%8F%82%E6%95%B0%E5%BD%B1%E5%93%8D%E9%87%8D%E5%A4%A7"><span class="nav-number">8.6.0.4.</span> <span class="nav-text">在获得票数的时候，优先级（priority）参数影响重大</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E4%BC%98%E5%85%88%E7%BA%A7%E7%9A%84%E5%80%BC%E6%98%AF-1"><span class="nav-number">8.6.0.5.</span> <span class="nav-text">默认情况下，优先级的值是 1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E4%BA%86%E8%A7%A3%E3%80%91%E4%BF%AE%E6%94%B9%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">8.6.0.6.</span> <span class="nav-text">【了解】修改优先级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AF%94%E5%A6%82%EF%BC%8C%E4%B8%8B%E9%9D%A2%E6%8F%90%E5%8D%87%E4%BB%8E%E8%8A%82%E7%82%B9%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">8.6.0.7.</span> <span class="nav-text">比如，下面提升从节点的优先级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A8%8D%E7%AD%89%E7%89%87%E5%88%BB%E4%BC%9A%E9%87%8D%E6%96%B0%E5%BC%80%E5%A7%8B%E9%80%89%E4%B8%BE"><span class="nav-number">8.6.0.8.</span> <span class="nav-text">稍等片刻会重新开始选举</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7-%E6%95%85%E9%9A%9C%E6%B5%8B%E8%AF%95"><span class="nav-number">8.7.</span> <span class="nav-text">1.7 故障测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-1-%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C%E6%B5%8B%E8%AF%95"><span class="nav-number">8.7.1.</span> <span class="nav-text">1.7.1 副本节点故障测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%97%AD-27018-%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9"><span class="nav-number">8.7.1.1.</span> <span class="nav-text">关闭 27018 副本节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%8D%E5%90%AF%E5%8A%A8%E4%BB%8E%E8%8A%82%E7%82%B9%EF%BC%8C%E4%BC%9A%E5%8F%91%E7%8E%B0%EF%BC%8C%E4%B8%BB%E8%8A%82%E7%82%B9%E5%86%99%E5%85%A5%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%90%8C%E6%AD%A5%E7%BB%99%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="nav-number">8.7.1.2.</span> <span class="nav-text">再启动从节点，会发现，主节点写入的数据，会自动同步给从节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-2%E4%B8%BB%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C%E6%B5%8B%E8%AF%95"><span class="nav-number">8.7.2.</span> <span class="nav-text">1.7.2主节点故障测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%97%AD-27017-%E8%8A%82%E7%82%B9"><span class="nav-number">8.7.2.1.</span> <span class="nav-text">关闭 27017 节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8-27018-%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E6%9F%A5%E7%9C%8B"><span class="nav-number">8.7.2.2.</span> <span class="nav-text">在 27018 写入数据查看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%8D%E5%90%AF%E5%8A%A8-27017-%E8%8A%82%E7%82%B9%EF%BC%8C%E5%8F%91%E7%8E%B0-27017-%E5%8F%98%E6%88%90%E4%BA%86%E4%BB%8E%E8%8A%82%E7%82%B9%EF%BC%8C-27018-%E4%BB%8D%E4%BF%9D%E6%8C%81%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="nav-number">8.7.2.3.</span> <span class="nav-text">再启动 27017 节点，发现 27017 变成了从节点， 27018 仍保持主节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BB%E5%BD%95-27017-%E8%8A%82%E7%82%B9%EF%BC%8C%E5%8F%91%E7%8E%B0%E6%98%AF%E4%BB%8E%E8%8A%82%E7%82%B9%E4%BA%86%EF%BC%8C%E6%95%B0%E6%8D%AE%E8%87%AA%E5%8A%A8%E4%BB%8E-27018-%E5%90%8C%E6%AD%A5"><span class="nav-number">8.7.2.4.</span> <span class="nav-text">登录 27017 节点，发现是从节点了，数据自动从 27018 同步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8E%E8%80%8C%E5%AE%9E%E7%8E%B0%E4%BA%86%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">8.7.2.5.</span> <span class="nav-text">从而实现了高可用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-3-%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9%E5%92%8C%E4%B8%BB%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C"><span class="nav-number">8.7.3.</span> <span class="nav-text">1.7.3 仲裁节点和主节点故障</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%88%E5%85%B3%E6%8E%89%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9-27019"><span class="nav-number">8.7.3.1.</span> <span class="nav-text">先关掉仲裁节点 27019</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E6%8E%89%E7%8E%B0%E5%9C%A8%E7%9A%84%E4%B8%BB%E8%8A%82%E7%82%B9-27018"><span class="nav-number">8.7.3.2.</span> <span class="nav-text">关掉现在的主节点 27018</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BB%E5%BD%95-27017-%E5%90%8E%EF%BC%8C%E5%8F%91%E7%8E%B0%EF%BC%8C-27017-%E4%BB%8D%E7%84%B6%E6%98%AF%E4%BB%8E%E8%8A%82%E7%82%B9%EF%BC%8C%E5%89%AF%E6%9C%AC%E9%9B%86%E4%B8%AD%E6%B2%A1%E6%9C%89%E4%B8%BB%E8%8A%82%E7%82%B9%E4%BA%86%EF%BC%8C%E5%AF%BC%E8%87%B4%E6%AD%A4%E6%97%B6%EF%BC%8C%E5%89%AF%E6%9C%AC%E9%9B%86%E6%98%AF%E5%8F%AA%E8%AF%BB%E7%8A%B6%E6%80%81%EF%BC%8C%E6%97%A0%E6%B3%95%E5%86%99%E5%85%A5"><span class="nav-number">8.7.3.3.</span> <span class="nav-text">登录 27017 后，发现， 27017 仍然是从节点，副本集中没有主节点了，导致此时，副本集是只读状态，无法写入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E5%95%A5%E4%B8%8D%E9%80%89%E4%B8%BE%E4%BA%86%EF%BC%9F%E5%9B%A0%E4%B8%BA-27017-%E7%9A%84%E7%A5%A8%E6%95%B0%EF%BC%8C%E6%B2%A1%E6%9C%89%E8%8E%B7%E5%BE%97%E5%A4%A7%E5%A4%9A%E6%95%B0%EF%BC%8C%E5%8D%B3%E6%B2%A1%E6%9C%89%E5%A4%A7%E4%BA%8E%E7%AD%89%E4%BA%8E-2-%EF%BC%8C%E5%AE%83%E5%8F%AA%E6%9C%89%E9%BB%98%E8%AE%A4%E7%9A%84%E4%B8%80%E7%A5%A8%EF%BC%88%E4%BC%98%E5%85%88%E7%BA%A7%E6%98%AF-1-%EF%BC%89"><span class="nav-number">8.7.3.4.</span> <span class="nav-text">为啥不选举了？因为 27017 的票数，没有获得大多数，即没有大于等于 2 ，它只有默认的一票（优先级是 1 ）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E8%A6%81%E8%A7%A6%E5%8F%91%E9%80%89%E4%B8%BE%EF%BC%8C%E9%9A%8F%E4%BE%BF%E5%8A%A0%E5%85%A5%E4%B8%80%E4%B8%AA%E6%88%90%E5%91%98%E5%8D%B3%E5%8F%AF"><span class="nav-number">8.7.3.5.</span> <span class="nav-text">如果要触发选举，随便加入一个成员即可</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-4-%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9%E5%92%8C%E4%BB%8E%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C"><span class="nav-number">8.7.4.</span> <span class="nav-text">1.7.4 仲裁节点和从节点故障</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%88%E5%85%B3%E6%8E%89%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9-27019-1"><span class="nav-number">8.7.4.1.</span> <span class="nav-text">先关掉仲裁节点 27019</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E6%8E%89%E7%8E%B0%E5%9C%A8%E7%9A%84%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9-27018"><span class="nav-number">8.7.4.2.</span> <span class="nav-text">关掉现在的副本节点 27018</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-%E7%A7%92%E5%90%8E%EF%BC%8C-27017-%E4%B8%BB%E8%8A%82%E7%82%B9%E8%87%AA%E5%8A%A8%E9%99%8D%E7%BA%A7%E4%B8%BA%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9%E3%80%82%EF%BC%88%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%EF%BC%89"><span class="nav-number">8.7.4.3.</span> <span class="nav-text">10 秒后， 27017 主节点自动降级为副本节点。（服务降级）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E4%B8%8D%E5%8F%AF%E5%86%99%E6%95%B0%E6%8D%AE%E4%BA%86%EF%BC%8C%E5%B7%B2%E7%BB%8F%E6%95%85%E9%9A%9C%E4%BA%86"><span class="nav-number">8.7.4.4.</span> <span class="nav-text">副本集不可写数据了，已经故障了</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-8-Compass%E8%BF%9E%E6%8E%A5%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">8.8.</span> <span class="nav-text">1.8 Compass连接副本集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E4%BD%BF%E7%94%A8%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%9C%80%E8%A6%81%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E4%B8%AD%E7%9A%84%E4%B8%BB%E8%8A%82%E7%82%B9ip"><span class="nav-number">8.8.0.1.</span> <span class="nav-text">如果使用云服务器需要修改配置中的主节点ip</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#compass%E8%BF%9E%E6%8E%A5"><span class="nav-number">8.8.0.2.</span> <span class="nav-text">compass连接</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-9-SpringDataMongoDB%E8%BF%9E%E6%8E%A5%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">8.9.</span> <span class="nav-text">1.9 SpringDataMongoDB连接副本集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E8%AF%AD%E6%B3%95"><span class="nav-number">8.9.0.1.</span> <span class="nav-text">副本集语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%B8%AD"><span class="nav-number">8.9.0.2.</span> <span class="nav-text">其中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E7%A4%BA%E4%BE%8B%E3%80%91-16"><span class="nav-number">8.9.0.3.</span> <span class="nav-text">【示例】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6application-yml"><span class="nav-number">8.9.0.4.</span> <span class="nav-text">修改配置文件application.yml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F-2"><span class="nav-number">8.9.0.5.</span> <span class="nav-text">注意</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E5%BF%85%E9%A1%BB%E6%98%AF%E5%89%AF%E6%9C%AC%E9%9B%86%E4%B8%AD%E6%89%80%E6%9C%89%E7%9A%84%E4%B8%BB%E6%9C%BA%EF%BC%8C%E5%8C%85%E6%8B%AC%E4%B8%BB%E8%8A%82%E7%82%B9%E3%80%81%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9%E3%80%81%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9"><span class="nav-number">8.9.0.6.</span> <span class="nav-text">主机必须是副本集中所有的主机，包括主节点、副本节点、仲裁节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringDataMongoDB%E8%87%AA%E5%8A%A8%E5%AE%9E%E7%8E%B0%E4%BA%86%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-number">8.9.0.7.</span> <span class="nav-text">SpringDataMongoDB自动实现了读写分离</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%99%E6%93%8D%E4%BD%9C%E6%97%B6%EF%BC%8C%E5%8F%AA%E6%89%93%E5%BC%80%E4%B8%BB%E8%8A%82%E7%82%B9%E8%BF%9E%E6%8E%A5"><span class="nav-number">8.9.0.8.</span> <span class="nav-text">写操作时，只打开主节点连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BB%E6%93%8D%E4%BD%9C%E6%98%AF%EF%BC%8C%E5%90%8C%E6%97%B6%E6%89%93%E5%BC%80%E4%B8%BB%E8%8A%82%E7%82%B9%E5%92%8C%E4%BB%8E%E8%8A%82%E7%82%B9%E8%BF%9E%E6%8E%A5%EF%BC%8C%E4%BD%86%E4%BD%BF%E7%94%A8%E4%BB%8E%E8%8A%82%E7%82%B9%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="nav-number">8.9.0.9.</span> <span class="nav-text">读操作是，同时打开主节点和从节点连接，但使用从节点获取数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84%E8%BF%9E%E6%8E%A5%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E5%8F%82%E8%80%83%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">8.9.0.10.</span> <span class="nav-text">完整的连接字符串的参考（了解）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5%E8%AF%AD%E6%B3%95"><span class="nav-number">8.9.0.11.</span> <span class="nav-text">MongoDB客户端连接语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%87%E5%87%86%E7%9A%84%E8%BF%9E%E6%8E%A5%E6%A0%BC%E5%BC%8F%E5%8C%85%E5%90%AB%E4%BA%86%E5%A4%9A%E4%B8%AA%E9%80%89%E9%A1%B9-options-%EF%BC%8C%E5%A6%82%E4%B8%8B%E6%89%80%E7%A4%BA"><span class="nav-number">8.9.0.12.</span> <span class="nav-text">标准的连接格式包含了多个选项(options)，如下所示</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4-Sharded-Cluster"><span class="nav-number">9.</span> <span class="nav-text">2. 分片集群-Sharded Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E5%88%86%E7%89%87%E6%A6%82%E5%BF%B5"><span class="nav-number">9.1.</span> <span class="nav-text">2.1 分片概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB%E6%94%AF%E6%8C%81%E9%80%9A%E8%BF%87%E5%88%86%E7%89%87%E8%BF%9B%E8%A1%8C%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95"><span class="nav-number">9.1.0.1.</span> <span class="nav-text">MongoDB支持通过分片进行水平扩展</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E5%8C%85%E5%90%AB%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="nav-number">9.2.</span> <span class="nav-text">2.2 分片集群包含的组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB%E5%88%86%E7%89%87%E7%BE%A4%E9%9B%86%E5%8C%85%E5%90%AB%E4%BB%A5%E4%B8%8B%E7%BB%84%E4%BB%B6"><span class="nav-number">9.2.0.1.</span> <span class="nav-text">MongoDB分片群集包含以下组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E5%9B%BE%E6%8F%8F%E8%BF%B0%E4%BA%86%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BA%A4%E4%BA%92"><span class="nav-number">9.2.0.2.</span> <span class="nav-text">下图描述了分片集群中组件的交互</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB%E5%9C%A8%E9%9B%86%E5%90%88%E7%BA%A7%E5%88%AB%E5%AF%B9%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%88%86%E7%89%87%EF%BC%8C%E5%B0%86%E9%9B%86%E5%90%88%E6%95%B0%E6%8D%AE%E5%88%86%E5%B8%83%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%9A%84%E5%88%86%E7%89%87%E4%B8%8A"><span class="nav-number">9.2.0.3.</span> <span class="nav-text">MongoDB在集合级别对数据进行分片，将集合数据分布在集群中的分片上</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E7%9B%AE%E6%A0%87"><span class="nav-number">9.3.</span> <span class="nav-text">2.3 分片集群架构目标</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A4%E4%B8%AA%E5%88%86%E7%89%87%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%EF%BC%883-3%EF%BC%89-%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%EF%BC%88-3-%EF%BC%89-%E4%B8%A4%E4%B8%AA%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%EF%BC%88-2-%EF%BC%89%EF%BC%8C%E5%85%B1-11-%E4%B8%AA%E6%9C%8D%E5%8A%A1%E8%8A%82%E7%82%B9"><span class="nav-number">9.3.0.1.</span> <span class="nav-text">两个分片节点副本集（3+3）+一个配置节点副本集（ 3 ）+两个路由节点（ 2 ），共 11 个服务节点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E5%88%86%E7%89%87%EF%BC%88%E5%AD%98%E5%82%A8%EF%BC%89%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">9.4.</span> <span class="nav-text">2.4 分片（存储）节点副本集的创建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%80%E6%9C%89%E7%9A%84%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%83%BD%E7%9B%B4%E6%8E%A5%E6%94%BE%E5%88%B0sharded-cluster%E7%9A%84%E7%9B%B8%E5%BA%94%E7%9A%84%E5%AD%90%E7%9B%AE%E5%BD%95%E4%B8%8B%E9%9D%A2%EF%BC%8C%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%90%8D%E5%AD%97%EF%BC%9Amongod-conf"><span class="nav-number">9.4.0.1.</span> <span class="nav-text">所有的的配置文件都直接放到sharded_cluster的相应的子目录下面，默认配置文件名字：mongod.conf</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-%E7%AC%AC%E4%B8%80%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">9.4.1.</span> <span class="nav-text">2.4.1 第一套副本集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%AD%98%E6%94%BE%E6%95%B0%E6%8D%AE%E5%92%8C%E6%97%A5%E5%BF%97%E7%9A%84%E7%9B%AE%E5%BD%95"><span class="nav-number">9.4.1.1.</span> <span class="nav-text">准备存放数据和日志的目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-3"><span class="nav-number">9.4.1.2.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myshardrs01-27018"><span class="nav-number">9.4.1.3.</span> <span class="nav-text">myshardrs01_27018</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F-3"><span class="nav-number">9.4.1.4.</span> <span class="nav-text">注意</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEsharding-clusterRole%E9%9C%80%E8%A6%81mongod%E5%AE%9E%E4%BE%8B%E8%BF%90%E8%A1%8C%E5%A4%8D%E5%88%B6%E3%80%82-%E8%A6%81%E5%B0%86%E5%AE%9E%E4%BE%8B%E9%83%A8%E7%BD%B2%E4%B8%BA%E5%89%AF%E6%9C%AC%E9%9B%86%E6%88%90%E5%91%98%EF%BC%8C%E8%AF%B7%E4%BD%BF%E7%94%A8replSetName%E8%AE%BE%E7%BD%AE%E5%B9%B6%E6%8C%87%E5%AE%9A%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%90%8D%E7%A7%B0"><span class="nav-number">9.4.1.5.</span> <span class="nav-text">设置sharding.clusterRole需要mongod实例运行复制。 要将实例部署为副本集成员，请使用replSetName设置并指定副本集的名称</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-4"><span class="nav-number">9.4.1.6.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myshardrs01-27118"><span class="nav-number">9.4.1.7.</span> <span class="nav-text">myshardrs01_27118</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-5"><span class="nav-number">9.4.1.8.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myshardrs01-27218"><span class="nav-number">9.4.1.9.</span> <span class="nav-text">myshardrs01_27218</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E7%AC%AC%E4%B8%80%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86%EF%BC%9A%E4%B8%80%E4%B8%BB%E4%B8%80%E5%89%AF%E6%9C%AC%E4%B8%80%E4%BB%B2%E8%A3%81"><span class="nav-number">9.4.1.10.</span> <span class="nav-text">启动第一套副本集：一主一副本一仲裁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%9D%E6%AC%A1%E5%90%AF%E5%8A%A8%E4%B8%89%E4%B8%AAmongod%E6%9C%8D%E5%8A%A1"><span class="nav-number">9.4.1.11.</span> <span class="nav-text">依次启动三个mongod服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8"><span class="nav-number">9.4.1.12.</span> <span class="nav-text">查看服务是否启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E8%BF%9E%E6%8E%A5%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%8C%E4%BD%86%E8%BF%99%E9%87%8C%E5%B0%BD%E9%87%8F%E8%A6%81%E8%BF%9E%E6%8E%A5%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="nav-number">9.4.1.13.</span> <span class="nav-text">使用客户端命令连接任意一个节点，但这里尽量要连接主节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E5%89%AF%E6%9C%AC%E9%9B%86%E5%91%BD%E4%BB%A4"><span class="nav-number">9.4.1.14.</span> <span class="nav-text">执行初始化副本集命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E6%83%85%E5%86%B5-%E8%8A%82%E9%80%89%E5%86%85%E5%AE%B9"><span class="nav-number">9.4.1.15.</span> <span class="nav-text">查看副本集情况(节选内容)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E9%85%8D%E7%BD%AE%E6%83%85%E5%86%B5"><span class="nav-number">9.4.1.16.</span> <span class="nav-text">查看副本集的配置情况</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-%E7%AC%AC%E4%BA%8C%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">9.4.2.</span> <span class="nav-text">2.4.2 第二套副本集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%AD%98%E6%94%BE%E6%95%B0%E6%8D%AE%E5%92%8C%E6%97%A5%E5%BF%97%E7%9A%84%E7%9B%AE%E5%BD%95-1"><span class="nav-number">9.4.2.1.</span> <span class="nav-text">准备存放数据和日志的目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-6"><span class="nav-number">9.4.2.2.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myshardrs02-27318"><span class="nav-number">9.4.2.3.</span> <span class="nav-text">myshardrs02_27318</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-7"><span class="nav-number">9.4.2.4.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myshardrs02-27418"><span class="nav-number">9.4.2.5.</span> <span class="nav-text">myshardrs02_27418</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-8"><span class="nav-number">9.4.2.6.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myshardrs02-27518"><span class="nav-number">9.4.2.7.</span> <span class="nav-text">myshardrs02_27518</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E7%AC%AC%E4%BA%8C%E5%A5%97%E5%89%AF%E6%9C%AC%E9%9B%86%EF%BC%9A%E4%B8%80%E4%B8%BB%E4%B8%80%E5%89%AF%E6%9C%AC%E4%B8%80%E4%BB%B2%E8%A3%81"><span class="nav-number">9.4.2.8.</span> <span class="nav-text">启动第二套副本集：一主一副本一仲裁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%9D%E6%AC%A1%E5%90%AF%E5%8A%A8%E4%B8%89%E4%B8%AAmongod%E6%9C%8D%E5%8A%A1-1"><span class="nav-number">9.4.2.9.</span> <span class="nav-text">依次启动三个mongod服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8-1"><span class="nav-number">9.4.2.10.</span> <span class="nav-text">查看服务是否启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E8%BF%9E%E6%8E%A5%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%8C%E4%BD%86%E8%BF%99%E9%87%8C%E5%B0%BD%E9%87%8F%E8%A6%81%E8%BF%9E%E6%8E%A5%E4%B8%BB%E8%8A%82%E7%82%B9-1"><span class="nav-number">9.4.2.11.</span> <span class="nav-text">使用客户端命令连接任意一个节点，但这里尽量要连接主节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E5%89%AF%E6%9C%AC%E9%9B%86%E5%91%BD%E4%BB%A4-1"><span class="nav-number">9.4.2.12.</span> <span class="nav-text">执行初始化副本集命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E6%83%85%E5%86%B5-%E8%8A%82%E9%80%89%E5%86%85%E5%AE%B9-1"><span class="nav-number">9.4.2.13.</span> <span class="nav-text">查看副本集情况(节选内容)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E9%85%8D%E7%BD%AE%E6%83%85%E5%86%B5-1"><span class="nav-number">9.4.2.14.</span> <span class="nav-text">查看副本集的配置情况</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">9.5.</span> <span class="nav-text">2.5 配置节点副本集的创建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%87%86%E5%A4%87%E5%AD%98%E6%94%BE%E6%95%B0%E6%8D%AE%E5%92%8C%E6%97%A5%E5%BF%97%E7%9A%84%E7%9B%AE%E5%BD%95"><span class="nav-number">9.5.0.1.</span> <span class="nav-text">第一步：准备存放数据和日志的目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-9"><span class="nav-number">9.5.0.2.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myconfigrs-27019"><span class="nav-number">9.5.0.3.</span> <span class="nav-text">myconfigrs_27019</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-10"><span class="nav-number">9.5.0.4.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myconfigrs-27119"><span class="nav-number">9.5.0.5.</span> <span class="nav-text">myconfigrs_27119</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-11"><span class="nav-number">9.5.0.6.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#myconfigrs-27219"><span class="nav-number">9.5.0.7.</span> <span class="nav-text">myconfigrs_27219</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%89%AF%E6%9C%AC%E9%9B%86%EF%BC%9A%E4%B8%80%E4%B8%BB%E4%B8%A4%E5%89%AF%E6%9C%AC"><span class="nav-number">9.5.0.8.</span> <span class="nav-text">启动配置副本集：一主两副本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%9D%E6%AC%A1%E5%90%AF%E5%8A%A8%E4%B8%89%E4%B8%AAmongod%E6%9C%8D%E5%8A%A1-2"><span class="nav-number">9.5.0.9.</span> <span class="nav-text">依次启动三个mongod服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8-2"><span class="nav-number">9.5.0.10.</span> <span class="nav-text">查看服务是否启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E8%BF%9E%E6%8E%A5%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%8C%E4%BD%86%E8%BF%99%E9%87%8C%E5%B0%BD%E9%87%8F%E8%A6%81%E8%BF%9E%E6%8E%A5%E4%B8%BB%E8%8A%82%E7%82%B9-2"><span class="nav-number">9.5.0.11.</span> <span class="nav-text">使用客户端命令连接任意一个节点，但这里尽量要连接主节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E5%89%AF%E6%9C%AC%E9%9B%86%E5%91%BD%E4%BB%A4-2"><span class="nav-number">9.5.0.12.</span> <span class="nav-text">执行初始化副本集命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E6%83%85%E5%86%B5-%E8%8A%82%E9%80%89%E5%86%85%E5%AE%B9-2"><span class="nav-number">9.5.0.13.</span> <span class="nav-text">查看副本集情况(节选内容)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E9%85%8D%E7%BD%AE%E6%83%85%E5%86%B5-2"><span class="nav-number">9.5.0.14.</span> <span class="nav-text">查看副本集的配置情况</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E6%93%8D%E4%BD%9C"><span class="nav-number">9.6.</span> <span class="nav-text">2.6 路由节点的创建和操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-1-%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E8%BF%9E%E6%8E%A5"><span class="nav-number">9.6.1.</span> <span class="nav-text">2.6.1 第一个路由节点的创建和连接</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%87%86%E5%A4%87%E5%AD%98%E6%94%BE%E6%95%B0%E6%8D%AE%E5%92%8C%E6%97%A5%E5%BF%97%E7%9A%84%E7%9B%AE%E5%BD%95-1"><span class="nav-number">9.6.1.1.</span> <span class="nav-text">第一步：准备存放数据和日志的目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mymongos-27017%E8%8A%82%E7%82%B9"><span class="nav-number">9.6.1.2.</span> <span class="nav-text">mymongos_27017节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-12"><span class="nav-number">9.6.1.3.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongos-conf"><span class="nav-number">9.6.1.4.</span> <span class="nav-text">mongos.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8mongos"><span class="nav-number">9.6.1.5.</span> <span class="nav-text">启动mongos</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9A%E5%90%AF%E5%8A%A8%E5%A6%82%E6%9E%9C%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8Blog%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84%E6%97%A5%E5%BF%97%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%A4%B1%E8%B4%A5%E5%8E%9F%E5%9B%A0"><span class="nav-number">9.6.1.6.</span> <span class="nav-text">提示：启动如果失败，可以查看log目录下的日志，查看失败原因</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%99%BB%E5%BD%95mongos"><span class="nav-number">9.6.1.7.</span> <span class="nav-text">客户端登录mongos</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A4%E6%97%B6%EF%BC%8C%E5%86%99%E4%B8%8D%E8%BF%9B%E5%8E%BB%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%86%99%E6%95%B0%E6%8D%AE%E4%BC%9A%E6%8A%A5%E9%94%99"><span class="nav-number">9.6.1.8.</span> <span class="nav-text">此时，写不进去数据，如果写数据会报错</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E5%9B%A0"><span class="nav-number">9.6.1.9.</span> <span class="nav-text">原因</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C%EF%BC%8C%E7%8E%B0%E5%9C%A8%E5%8F%AA%E6%98%AF%E8%BF%9E%E6%8E%A5%E4%BA%86%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%EF%BC%8C%E8%BF%98%E6%B2%A1%E6%9C%89%E8%BF%9E%E6%8E%A5%E5%88%86%E7%89%87%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9%EF%BC%8C%E5%9B%A0%E6%AD%A4%E6%97%A0%E6%B3%95%E5%86%99%E5%85%A5%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE"><span class="nav-number">9.6.1.10.</span> <span class="nav-text">通过路由节点操作，现在只是连接了配置节点，还没有连接分片数据节点，因此无法写入业务数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#properties%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8F%82%E8%80%83"><span class="nav-number">9.6.1.11.</span> <span class="nav-text">properties配置文件参考</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-2-%E5%9C%A8%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E4%B8%8A%E8%BF%9B%E8%A1%8C%E5%88%86%E7%89%87%E9%85%8D%E7%BD%AE%E6%93%8D%E4%BD%9C"><span class="nav-number">9.6.2.</span> <span class="nav-text">2.6.2 在路由节点上进行分片配置操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E6%B7%BB%E5%8A%A0%E5%88%86%E7%89%87"><span class="nav-number">9.6.2.1.</span> <span class="nav-text">使用命令添加分片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-12"><span class="nav-number">9.6.2.2.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%86%E7%AC%AC%E4%B8%80%E5%A5%97%E5%88%86%E7%89%87%E5%89%AF%E6%9C%AC%E9%9B%86%E6%B7%BB%E5%8A%A0%E8%BF%9B%E6%9D%A5"><span class="nav-number">9.6.2.3.</span> <span class="nav-text">将第一套分片副本集添加进来</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87%E7%8A%B6%E6%80%81%E6%83%85%E5%86%B5"><span class="nav-number">9.6.2.4.</span> <span class="nav-text">查看分片状态情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%A7%E7%BB%AD%E5%B0%86%E7%AC%AC%E4%BA%8C%E5%A5%97%E5%88%86%E7%89%87%E5%89%AF%E6%9C%AC%E9%9B%86%E6%B7%BB%E5%8A%A0%E8%BF%9B%E6%9D%A5"><span class="nav-number">9.6.2.5.</span> <span class="nav-text">继续将第二套分片副本集添加进来</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87%E7%8A%B6%E6%80%81"><span class="nav-number">9.6.2.6.</span> <span class="nav-text">查看分片状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%B7%BB%E5%8A%A0%E5%88%86%E7%89%87%E5%A4%B1%E8%B4%A5%EF%BC%8C%E9%9C%80%E8%A6%81%E5%85%88%E6%89%8B%E5%8A%A8%E7%A7%BB%E9%99%A4%E5%88%86%E7%89%87%EF%BC%8C%E6%A3%80%E6%9F%A5%E6%B7%BB%E5%8A%A0%E5%88%86%E7%89%87%E7%9A%84%E4%BF%A1%E6%81%AF%E7%9A%84%E6%AD%A3%E7%A1%AE%E6%80%A7%E5%90%8E%EF%BC%8C%E5%86%8D%E6%AC%A1%E6%B7%BB%E5%8A%A0%E5%88%86%E7%89%87"><span class="nav-number">9.6.2.7.</span> <span class="nav-text">提示：如果添加分片失败，需要先手动移除分片，检查添加分片的信息的正确性后，再次添加分片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4%E5%88%86%E7%89%87%E5%8F%82%E8%80%83-%E4%BA%86%E8%A7%A3"><span class="nav-number">9.6.2.8.</span> <span class="nav-text">移除分片参考(了解)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9A%E5%A6%82%E6%9E%9C%E5%8F%AA%E5%89%A9%E4%B8%8B%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AAshard%EF%BC%8C%E6%98%AF%E6%97%A0%E6%B3%95%E5%88%A0%E9%99%A4%E7%9A%84"><span class="nav-number">9.6.2.9.</span> <span class="nav-text">注意：如果只剩下最后一个shard，是无法删除的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4%E6%97%B6%E4%BC%9A%E8%87%AA%E5%8A%A8%E8%BD%AC%E7%A7%BB%E5%88%86%E7%89%87%E6%95%B0%E6%8D%AE%EF%BC%8C%E9%9C%80%E8%A6%81%E4%B8%80%E4%B8%AA%E6%97%B6%E9%97%B4%E8%BF%87%E7%A8%8B"><span class="nav-number">9.6.2.10.</span> <span class="nav-text">移除时会自动转移分片数据，需要一个时间过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E5%86%8D%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%88%A0%E9%99%A4%E5%88%86%E7%89%87%E5%91%BD%E4%BB%A4%E6%89%8D%E8%83%BD%E7%9C%9F%E6%AD%A3%E5%88%A0%E9%99%A4"><span class="nav-number">9.6.2.11.</span> <span class="nav-text">完成后，再次执行删除分片命令才能真正删除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87%E7%8A%B6%E6%80%81-1"><span class="nav-number">9.6.2.12.</span> <span class="nav-text">查看分片状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E9%9B%86%E5%90%88%E5%88%86%E7%89%87%EF%BC%8C%E4%BD%A0%E5%BF%85%E9%A1%BB%E4%BD%BF%E7%94%A8-sh-shardCollection-%E6%96%B9%E6%B3%95%E6%8C%87%E5%AE%9A%E9%9B%86%E5%90%88%E5%92%8C%E5%88%86%E7%89%87%E9%94%AE"><span class="nav-number">9.6.2.13.</span> <span class="nav-text">对集合分片，你必须使用 sh.shardCollection() 方法指定集合和分片键</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-13"><span class="nav-number">9.6.2.14.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E6%95%B0-6"><span class="nav-number">9.6.2.15.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E7%89%87%E8%A7%84%E5%88%99%E4%B8%80%EF%BC%9A%E5%93%88%E5%B8%8C%E7%AD%96%E7%95%A5"><span class="nav-number">9.6.2.16.</span> <span class="nav-text">分片规则一：哈希策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8nickname%E4%BD%9C%E4%B8%BA%E7%89%87%E9%94%AE%EF%BC%8C%E6%A0%B9%E6%8D%AE%E5%85%B6%E5%80%BC%E7%9A%84%E5%93%88%E5%B8%8C%E5%80%BC%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87"><span class="nav-number">9.6.2.17.</span> <span class="nav-text">使用nickname作为片键，根据其值的哈希值进行数据分片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87%E7%8A%B6%E6%80%81%EF%BC%9Ash-status"><span class="nav-number">9.6.2.18.</span> <span class="nav-text">查看分片状态：sh.status()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E7%89%87%E8%A7%84%E5%88%99%E4%BA%8C%EF%BC%9A%E8%8C%83%E5%9B%B4%E7%AD%96%E7%95%A5"><span class="nav-number">9.6.2.19.</span> <span class="nav-text">分片规则二：范围策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E4%BD%BF%E7%94%A8%E4%BD%9C%E8%80%85%E5%B9%B4%E9%BE%84%E5%AD%97%E6%AE%B5%E4%BD%9C%E4%B8%BA%E7%89%87%E9%94%AE%EF%BC%8C%E6%8C%89%E7%85%A7%E7%82%B9%E8%B5%9E%E6%95%B0%E7%9A%84%E5%80%BC%E8%BF%9B%E8%A1%8C%E5%88%86%E7%89%87"><span class="nav-number">9.6.2.20.</span> <span class="nav-text">如使用作者年龄字段作为片键，按照点赞数的值进行分片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF"><span class="nav-number">9.6.2.21.</span> <span class="nav-text">注意的是</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87%E7%8A%B6%E6%80%81-2"><span class="nav-number">9.6.2.22.</span> <span class="nav-text">查看分片状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%90%86%E6%83%B3%E5%8C%96%E7%9A%84-shard-key-%E5%8F%AF%E4%BB%A5%E8%AE%A9-documents-%E5%9D%87%E5%8C%80%E5%9C%B0%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%88%86%E5%B8%83"><span class="nav-number">9.6.2.23.</span> <span class="nav-text">理想化的 shard key 可以让 documents 均匀地在集群中分布</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%98%BE%E7%A4%BA%E9%9B%86%E7%BE%A4%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="nav-number">9.6.2.24.</span> <span class="nav-text">显示集群的详细信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%9D%87%E8%A1%A1%E5%99%A8%E6%98%AF%E5%90%A6%E5%B7%A5%E4%BD%9C%EF%BC%88%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E5%9D%87%E8%A1%A1%E6%97%B6%E7%B3%BB%E7%BB%9F%E6%89%8D%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8%EF%BC%8C%E4%B8%8D%E7%94%A8%E7%AE%A1%E5%AE%83%EF%BC%89"><span class="nav-number">9.6.2.25.</span> <span class="nav-text">查看均衡器是否工作（需要重新均衡时系统才会自动启动，不用管它）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8DBalancer%E7%8A%B6%E6%80%81"><span class="nav-number">9.6.2.26.</span> <span class="nav-text">查看当前Balancer状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-3-%E5%88%86%E7%89%87%E5%90%8E%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E6%B5%8B%E8%AF%95"><span class="nav-number">9.6.3.</span> <span class="nav-text">2.6.3 分片后插入数据测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E4%B8%80%EF%BC%88%E5%93%88%E5%B8%8C%E8%A7%84%E5%88%99%EF%BC%89%EF%BC%9A%E7%99%BB%E5%BD%95mongs%E5%90%8E%EF%BC%8C%E5%90%91comment%E5%BE%AA%E7%8E%AF%E6%8F%92%E5%85%A5-1000-%E6%9D%A1%E6%95%B0%E6%8D%AE%E5%81%9A%E6%B5%8B%E8%AF%95"><span class="nav-number">9.6.3.1.</span> <span class="nav-text">测试一（哈希规则）：登录mongs后，向comment循环插入 1000 条数据做测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9Ajs%E7%9A%84%E8%AF%AD%E6%B3%95%EF%BC%8C%E5%9B%A0%E4%B8%BAmongo%E7%9A%84shell%E6%98%AF%E4%B8%80%E4%B8%AAJavaScript%E7%9A%84shell"><span class="nav-number">9.6.3.2.</span> <span class="nav-text">提示：js的语法，因为mongo的shell是一个JavaScript的shell</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9A%E4%BB%8E%E8%B7%AF%E7%94%B1%E4%B8%8A%E6%8F%92%E5%85%A5%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%BF%85%E9%A1%BB%E5%8C%85%E5%90%AB%E7%89%87%E9%94%AE%EF%BC%8C%E5%90%A6%E5%88%99%E6%97%A0%E6%B3%95%E6%8F%92%E5%85%A5"><span class="nav-number">9.6.3.3.</span> <span class="nav-text">注意：从路由上插入的数据，必须包含片键，否则无法插入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E5%88%AB%E7%99%BB%E9%99%86%E4%B8%A4%E4%B8%AA%E7%89%87%E7%9A%84%E4%B8%BB%E8%8A%82%E7%82%B9%EF%BC%8C%E7%BB%9F%E8%AE%A1%E6%96%87%E6%A1%A3%E6%95%B0%E9%87%8F"><span class="nav-number">9.6.3.4.</span> <span class="nav-text">分别登陆两个片的主节点，统计文档数量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%88%86%E7%89%87%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">9.6.3.5.</span> <span class="nav-text">第一个分片副本集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%88%86%E7%89%87%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">9.6.3.6.</span> <span class="nav-text">第二个分片副本集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C-1000-%E6%9D%A1%E6%95%B0%E6%8D%AE%E8%BF%91%E4%BC%BC%E5%9D%87%E5%8C%80%E7%9A%84%E5%88%86%E5%B8%83%E5%88%B0%E4%BA%86-2-%E4%B8%AAshard%E4%B8%8A%E3%80%82%E6%98%AF%E6%A0%B9%E6%8D%AE%E7%89%87%E9%94%AE%E7%9A%84%E5%93%88%E5%B8%8C%E5%80%BC%E5%88%86%E9%85%8D%E7%9A%84"><span class="nav-number">9.6.3.7.</span> <span class="nav-text">可以看到， 1000 条数据近似均匀的分布到了 2 个shard上。是根据片键的哈希值分配的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%99%E7%A7%8D%E5%88%86%E9%85%8D%E6%96%B9%E5%BC%8F%E9%9D%9E%E5%B8%B8%E6%98%93%E4%BA%8E%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95%EF%BC%9A%E4%B8%80%E6%97%A6%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E9%9C%80%E8%A6%81%E6%9B%B4%E5%A4%A7%E7%A9%BA%E9%97%B4%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E5%86%8D%E5%A2%9E%E5%8A%A0%E5%88%86%E7%89%87%E5%8D%B3%E5%8F%AF%EF%BC%8C%E5%90%8C%E6%97%B6%E6%8F%90%E5%8D%87%E4%BA%86%E6%80%A7%E8%83%BD"><span class="nav-number">9.6.3.8.</span> <span class="nav-text">这种分配方式非常易于水平扩展：一旦数据存储需要更大空间，可以直接再增加分片即可，同时提升了性能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8db-comment-stats-%E6%9F%A5%E7%9C%8B%E5%8D%95%E4%B8%AA%E9%9B%86%E5%90%88%E7%9A%84%E5%AE%8C%E6%95%B4%E6%83%85%E5%86%B5%EF%BC%8Cmongos%E6%89%A7%E8%A1%8C%E8%AF%A5%E5%91%BD%E4%BB%A4%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8B%E8%AF%A5%E9%9B%86%E5%90%88%E7%9A%84%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">9.6.3.9.</span> <span class="nav-text">使用db.comment.stats()查看单个集合的完整情况，mongos执行该命令可以查看该集合的数据分片的情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8sh-status-%E6%9F%A5%E7%9C%8B%E6%9C%AC%E5%BA%93%E5%86%85%E6%89%80%E6%9C%89%E9%9B%86%E5%90%88%E7%9A%84%E5%88%86%E7%89%87%E4%BF%A1%E6%81%AF"><span class="nav-number">9.6.3.10.</span> <span class="nav-text">使用sh.status()查看本库内所有集合的分片信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E4%BA%8C%EF%BC%88%E8%8C%83%E5%9B%B4%E8%A7%84%E5%88%99%EF%BC%89%EF%BC%9A%E7%99%BB%E5%BD%95mongs%E5%90%8E%EF%BC%8C%E5%90%91comment%E5%BE%AA%E7%8E%AF%E6%8F%92%E5%85%A5-1000-%E6%9D%A1%E6%95%B0%E6%8D%AE%E5%81%9A%E6%B5%8B%E8%AF%95"><span class="nav-number">9.6.3.11.</span> <span class="nav-text">测试二（范围规则）：登录mongs后，向comment循环插入 1000 条数据做测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%92%E5%85%A5%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8C%E4%BB%8D%E7%84%B6%E8%A6%81%E5%88%86%E5%88%AB%E6%9F%A5%E7%9C%8B%E4%B8%A4%E4%B8%AA%E5%88%86%E7%89%87%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E6%95%B0%E6%8D%AE%E6%83%85%E5%86%B5"><span class="nav-number">9.6.3.12.</span> <span class="nav-text">插入成功后，仍然要分别查看两个分片副本集的数据情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E7%89%87%E6%95%88%E6%9E%9C"><span class="nav-number">9.6.3.13.</span> <span class="nav-text">分片效果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-12"><span class="nav-number">9.6.3.14.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%9F%A5%E7%9C%8B%E7%8A%B6%E6%80%81%E5%8F%91%E7%8E%B0%E6%B2%A1%E6%9C%89%E5%88%86%E7%89%87%EF%BC%8C%E5%88%99%E5%8F%AF%E8%83%BD%E6%98%AF%E7%94%B1%E4%BA%8E%E4%BB%A5%E4%B8%8B%E5%8E%9F%E5%9B%A0%E9%80%A0%E6%88%90%E4%BA%86"><span class="nav-number">9.6.3.15.</span> <span class="nav-text">如果查看状态发现没有分片，则可能是由于以下原因造成了</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%AE%8C%E6%94%B9%E5%9B%9E%E6%9D%A5"><span class="nav-number">9.6.3.16.</span> <span class="nav-text">测试完改回来</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9A%E8%A6%81%E5%85%88%E6%94%B9%E5%B0%8F%EF%BC%8C%E5%86%8D%E8%AE%BE%E7%BD%AE%E5%88%86%E7%89%87%E3%80%82%E4%B8%BA%E4%BA%86%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%85%88%E5%88%A0%E9%99%A4%E9%9B%86%E5%90%88%EF%BC%8C%E9%87%8D%E6%96%B0%E5%BB%BA%E7%AB%8B%E9%9B%86%E5%90%88%E7%9A%84%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5%EF%BC%8C%E5%86%8D%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E6%B5%8B%E8%AF%95%E5%8D%B3%E5%8F%AF"><span class="nav-number">9.6.3.17.</span> <span class="nav-text">注意：要先改小，再设置分片。为了测试，可以先删除集合，重新建立集合的分片策略，再插入数据测试即可</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-4-%E5%86%8D%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AA%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9"><span class="nav-number">9.6.4.</span> <span class="nav-text">2.6.4 再增加一个路由节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="nav-number">9.6.4.1.</span> <span class="nav-text">文件夹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%88%96%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-13"><span class="nav-number">9.6.4.2.</span> <span class="nav-text">新建或修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongos-conf-1"><span class="nav-number">9.6.4.3.</span> <span class="nav-text">mongos.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8mongos2"><span class="nav-number">9.6.4.4.</span> <span class="nav-text">启动mongos2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8mongo%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%99%BB%E5%BD%95-27117-%EF%BC%8C%E5%8F%91%E7%8E%B0%EF%BC%8C%E7%AC%AC%E4%BA%8C%E4%B8%AA%E8%B7%AF%E7%94%B1%E6%97%A0%E9%9C%80%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%88%86%E7%89%87%E9%85%8D%E7%BD%AE%E9%83%BD%E4%BF%9D%E5%AD%98%E5%88%B0%E4%BA%86%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%E4%BA%86"><span class="nav-number">9.6.4.5.</span> <span class="nav-text">使用mongo客户端登录 27117 ，发现，第二个路由无需配置，因为分片配置都保存到了配置服务器中了</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-7-Compass%E8%BF%9E%E6%8E%A5%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4"><span class="nav-number">9.7.</span> <span class="nav-text">2.7 Compass连接分片集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#compass%E8%BF%9E%E6%8E%A5-1"><span class="nav-number">9.7.0.1.</span> <span class="nav-text">compass连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9A%E5%92%8C%E8%BF%9E%E6%8E%A5%E5%8D%95%E6%9C%BAmongod%E4%B8%80%E6%A0%B7"><span class="nav-number">9.7.0.2.</span> <span class="nav-text">提示：和连接单机mongod一样</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8C%E4%B8%8A%E6%96%B9%E6%9C%89mongos%E5%92%8C%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E7%9A%84%E6%8F%90%E7%A4%BA"><span class="nav-number">9.7.0.3.</span> <span class="nav-text">连接成功后，上方有mongos和分片集群的提示</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-8-SpringDataMongDB%E8%BF%9E%E6%8E%A5%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4"><span class="nav-number">9.8.</span> <span class="nav-text">2.8 SpringDataMongDB连接分片集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Java%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B8%B8%E7%94%A8%E7%9A%84%E6%98%AFSpringDataMongoDB%EF%BC%8C%E5%85%B6%E8%BF%9E%E6%8E%A5%E7%9A%84%E6%98%AFmongs%E8%B7%AF%E7%94%B1%EF%BC%8C%E9%85%8D%E7%BD%AE%E5%92%8C%E5%8D%95%E6%9C%BAmongod%E7%9A%84%E9%85%8D%E7%BD%AE%E6%98%AF%E4%B8%80%E6%A0%B7%E7%9A%84"><span class="nav-number">9.8.0.1.</span> <span class="nav-text">Java客户端常用的是SpringDataMongoDB，其连接的是mongs路由，配置和单机mongod的配置是一样的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA%E8%B7%AF%E7%94%B1%E7%9A%84%E6%97%B6%E5%80%99%E7%9A%84SpringDataMongoDB%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E5%8F%82%E8%80%83%E5%A6%82%E4%B8%8B"><span class="nav-number">9.8.0.2.</span> <span class="nav-text">多个路由的时候的SpringDataMongoDB的客户端配置参考如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E6%97%A5%E5%BF%97%E5%8F%91%E7%8E%B0%EF%BC%8C%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%BC%9A%E9%80%89%E6%8B%A9%E4%B8%80%E4%B8%AA%E8%B7%AF%E7%94%B1%E5%86%99%E5%85%A5"><span class="nav-number">9.8.0.3.</span> <span class="nav-text">通过日志发现，写入数据的时候，会选择一个路由写入</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-9-%E6%B8%85%E9%99%A4%E6%89%80%E6%9C%89%E7%9A%84%E8%8A%82%E7%82%B9%E6%95%B0%E6%8D%AE%EF%BC%88%E5%A4%87%E7%94%A8%EF%BC%89"><span class="nav-number">9.9.</span> <span class="nav-text">2.9 清除所有的节点数据（备用）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E5%9C%A8%E6%90%AD%E5%BB%BA%E5%88%86%E7%89%87%E7%9A%84%E6%97%B6%E5%80%99%E6%9C%89%E6%93%8D%E4%BD%9C%E5%A4%B1%E8%B4%A5%E6%88%96%E9%85%8D%E7%BD%AE%E6%9C%89%E9%97%AE%E9%A2%98%EF%BC%8C%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E6%9D%A5%E8%BF%87%E7%9A%84%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%BF%9B%E8%A1%8C%E5%A6%82%E4%B8%8B%E6%93%8D%E4%BD%9C"><span class="nav-number">9.9.0.1.</span> <span class="nav-text">如果在搭建分片的时候有操作失败或配置有问题，需要重新来过的，可以进行如下操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E6%9F%A5%E8%AF%A2%E5%87%BA%E6%89%80%E6%9C%89%E7%9A%84%E6%B5%8B%E8%AF%95%E6%9C%8D%E5%8A%A1%E8%8A%82%E7%82%B9%E7%9A%84%E8%BF%9B%E7%A8%8B"><span class="nav-number">9.9.0.2.</span> <span class="nav-text">第一步：查询出所有的测试服务节点的进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E4%B8%8A%E8%BF%B0%E7%9A%84%E8%BF%9B%E7%A8%8B%E7%BC%96%E5%8F%B7%EF%BC%8C%E4%BE%9D%E6%AC%A1%E4%B8%AD%E6%96%AD%E8%BF%9B%E7%A8%8B"><span class="nav-number">9.9.0.3.</span> <span class="nav-text">根据上述的进程编号，依次中断进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E6%B8%85%E9%99%A4%E6%89%80%E6%9C%89%E7%9A%84%E8%8A%82%E7%82%B9%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="nav-number">9.9.0.4.</span> <span class="nav-text">第二步：清除所有的节点的数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E6%9F%A5%E7%9C%8B%E6%88%96%E4%BF%AE%E6%94%B9%E6%9C%89%E9%97%AE%E9%A2%98%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">9.9.0.5.</span> <span class="nav-text">第三步：查看或修改有问题的配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E4%BE%9D%E6%AC%A1%E5%90%AF%E5%8A%A8%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%EF%BC%8C%E4%B8%8D%E5%8C%85%E6%8B%AC%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9"><span class="nav-number">9.9.0.6.</span> <span class="nav-text">第四步：依次启动所有节点，不包括路由节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E5%AF%B9%E4%B8%A4%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87%E5%89%AF%E6%9C%AC%E9%9B%86%E5%92%8C%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E5%89%AF%E6%9C%AC%E9%9B%86%E8%BF%9B%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="nav-number">9.9.0.7.</span> <span class="nav-text">第五步：对两个数据分片副本集和一个配置副本集进行初始化和相关配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A%E6%A3%80%E6%9F%A5%E8%B7%AF%E7%94%B1mongos%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%B9%B6%E5%90%AF%E5%8A%A8mongos"><span class="nav-number">9.9.0.8.</span> <span class="nav-text">第六步：检查路由mongos的配置，并启动mongos</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5%EF%BC%9Amongo%E7%99%BB%E5%BD%95mongos%EF%BC%8C%E5%9C%A8%E5%85%B6%E4%B8%8A%E8%BF%9B%E8%A1%8C%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="nav-number">9.9.0.9.</span> <span class="nav-text">第七步：mongo登录mongos，在其上进行相关操作</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81"><span class="nav-number">10.</span> <span class="nav-text">3. 安全认证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-MongoDB%E7%9A%84%E7%94%A8%E6%88%B7%E5%92%8C%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E7%AE%80%E4%BB%8B"><span class="nav-number">10.1.</span> <span class="nav-text">3.1 MongoDB的用户和角色权限简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E5%BC%80%E5%A7%8B%E4%B9%8B%E5%89%8D%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3%E4%B8%80%E4%B8%8B%E6%A6%82%E5%BF%B5"><span class="nav-number">10.1.0.1.</span> <span class="nav-text">在开始之前需要了解一下概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E7%9A%84%E6%9F%A5%E7%9C%8B%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%A6%82%E4%B8%8B%E5%91%BD%E4%BB%A4%E6%9F%A5%E8%AF%A2%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">10.1.0.2.</span> <span class="nav-text">关于角色权限的查看，可以通过如下命令查询（了解）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">10.1.0.3.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E5%86%85%E7%BD%AE%E8%A7%92%E8%89%B2"><span class="nav-number">10.1.0.4.</span> <span class="nav-text">查看所有内置角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E5%86%85%E7%BD%AE%E8%A7%92%E8%89%B2"><span class="nav-number">10.1.0.5.</span> <span class="nav-text">常用的内置角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%92%E8%89%B2%E8%AF%B4%E6%98%8E"><span class="nav-number">10.1.0.6.</span> <span class="nav-text">角色说明</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%8D%95%E5%AE%9E%E4%BE%8B%E7%8E%AF%E5%A2%83"><span class="nav-number">10.2.</span> <span class="nav-text">3.2 单实例环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-%E5%85%B3%E9%97%AD%E5%B7%B2%E5%BC%80%E5%90%AF%E7%9A%84%E6%9C%8D%E5%8A%A1%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-number">10.2.1.</span> <span class="nav-text">3.2.1 关闭已开启的服务（可选）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0mongod%E7%9A%84%E5%8D%95%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA%E7%9A%84%E6%97%B6%E5%80%99%E7%9B%B4%E6%8E%A5%E6%B7%BB%E5%8A%A0%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%9C%A8%E4%B9%8B%E5%89%8D%E6%90%AD%E5%BB%BA%E5%A5%BD%E7%9A%84%E6%9C%8D%E5%8A%A1%E4%B8%8A%E6%B7%BB%E5%8A%A0"><span class="nav-number">10.2.1.1.</span> <span class="nav-text">增加mongod的单实例的安全认证功能，可以在服务搭建的时候直接添加，也可以在之前搭建好的服务上添加</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%AC%E6%96%87%E4%BD%BF%E7%94%A8%E4%B9%8B%E5%89%8D%E6%90%AD%E5%BB%BA%E5%A5%BD%E7%9A%84%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%9B%A0%E6%AD%A4%EF%BC%8C%E5%85%88%E5%81%9C%E6%AD%A2%E4%B9%8B%E5%89%8D%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="nav-number">10.2.1.2.</span> <span class="nav-text">本文使用之前搭建好的服务，因此，先停止之前的服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E4%B8%A4%E7%A7%8D%EF%BC%9A%E5%BF%AB%E9%80%9F%E5%85%B3%E9%97%AD%E5%92%8C%E6%A0%87%E5%87%86%E5%85%B3%E9%97%AD%EF%BC%8C%E4%B8%8B%E9%9D%A2%E4%BE%9D%E6%AC%A1%E8%AF%B4%E6%98%8E-1"><span class="nav-number">10.2.1.3.</span> <span class="nav-text">停止服务的方式有两种：快速关闭和标准关闭，下面依次说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A%E9%80%9A%E8%BF%87%E7%B3%BB%E7%BB%9F%E7%9A%84kill%E5%91%BD%E4%BB%A4%E7%9B%B4%E6%8E%A5%E6%9D%80%E6%AD%BB%E8%BF%9B%E7%A8%8B"><span class="nav-number">10.2.1.4.</span> <span class="nav-text">目标：通过系统的kill命令直接杀死进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9D%80%E5%AE%8C%E8%A6%81%E6%A3%80%E6%9F%A5%E4%B8%80%E4%B8%8B%EF%BC%8C%E9%81%BF%E5%85%8D%E6%9C%89%E7%9A%84%E6%B2%A1%E6%9C%89%E6%9D%80%E6%8E%89"><span class="nav-number">10.2.1.5.</span> <span class="nav-text">杀完要检查一下，避免有的没有杀掉</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E8%A1%A5%E5%85%85%E3%80%91-1"><span class="nav-number">10.2.1.6.</span> <span class="nav-text">【补充】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E4%B8%80%E6%97%A6%E6%98%AF%E5%9B%A0%E4%B8%BA%E6%95%B0%E6%8D%AE%E6%8D%9F%E5%9D%8F%EF%BC%8C%E5%88%99%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8C%E5%A6%82%E4%B8%8B%E6%93%8D%E4%BD%9C%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">10.2.1.7.</span> <span class="nav-text">如果一旦是因为数据损坏，则需要进行如下操作（了解）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A%E9%80%9A%E8%BF%87mongo%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%AD%E7%9A%84shutdownServer%E5%91%BD%E4%BB%A4%E6%9D%A5%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1"><span class="nav-number">10.2.1.8.</span> <span class="nav-text">目标：通过mongo客户端中的shutdownServer命令来关闭服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E7%9A%84%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4%E5%8F%82%E8%80%83%E5%A6%82%E4%B8%8B"><span class="nav-number">10.2.1.9.</span> <span class="nav-text">主要的操作步骤参考如下</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%92%8C%E6%9D%83%E9%99%90"><span class="nav-number">10.2.2.</span> <span class="nav-text">3.2.2 添加用户和权限</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%88%E5%8F%82%E8%80%83%EF%BC%8C%E5%A4%8D%E7%94%A8%E4%B9%8B%E5%89%8D%E8%AF%BE%E7%A8%8B%E7%9A%84%EF%BC%89"><span class="nav-number">10.2.2.1.</span> <span class="nav-text">（参考，复用之前课程的）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-13"><span class="nav-number">10.2.2.2.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E6%93%8D%E4%BD%9C%E7%94%A8%E6%88%B7%E6%97%B6%EF%BC%8C%E5%90%AF%E5%8A%A8mongod%E6%9C%8D%E5%8A%A1%E6%97%B6%E5%B0%BD%E9%87%8F%E4%B8%8D%E8%A6%81%E5%BC%80%E5%90%AF%E6%8E%88%E6%9D%83"><span class="nav-number">10.2.2.3.</span> <span class="nav-text">在操作用户时，启动mongod服务时尽量不要开启授权</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-14"><span class="nav-number">10.2.2.4.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E6%B7%BB%E5%8A%A0%E7%9A%84%E7%94%A8%E6%88%B7%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE"><span class="nav-number">10.2.2.5.</span> <span class="nav-text">测试添加的用户是否正确</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%88-6-%EF%BC%89%E5%88%9B%E5%BB%BA%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7"><span class="nav-number">10.2.2.6.</span> <span class="nav-text">（ 6 ）创建普通用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-15"><span class="nav-number">10.2.2.7.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E5%BC%80%E5%90%AF%E4%BA%86%E8%AE%A4%E8%AF%81%E5%90%8E%EF%BC%8C%E7%99%BB%E5%BD%95%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E7%94%A8%E6%88%B7%E5%BF%85%E9%A1%BB%E4%BD%BF%E7%94%A8admin%E5%BA%93%E7%9A%84%E8%A7%92%E8%89%B2%EF%BC%8C%E5%A6%82%E6%8B%A5%E6%9C%89root%E8%A7%92%E8%89%B2%E7%9A%84myadmin%E7%94%A8%E6%88%B7%EF%BC%8C%E5%86%8D%E9%80%9A%E8%BF%87myadmin%E7%94%A8%E6%88%B7%E5%8E%BB%E5%88%9B%E5%BB%BA%E5%85%B6%E4%BB%96%E8%A7%92%E8%89%B2%E7%9A%84%E7%94%A8%E6%88%B7"><span class="nav-number">10.2.2.8.</span> <span class="nav-text">如果开启了认证后，登录的客户端的用户必须使用admin库的角色，如拥有root角色的myadmin用户，再通过myadmin用户去创建其他角色的用户</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%80%E5%90%AF%E8%AE%A4%E8%AF%81%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5%E7%99%BB%E5%BD%95"><span class="nav-number">10.2.3.</span> <span class="nav-text">3.2.3 服务端开启认证和客户端连接登录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%88-1-%EF%BC%89%E5%85%B3%E9%97%AD%E5%B7%B2%E7%BB%8F%E5%90%AF%E5%8A%A8%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="nav-number">10.2.3.1.</span> <span class="nav-text">（ 1 ）关闭已经启动的服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9C%80%E8%A6%81%E5%87%A0%E4%B8%AA%E6%9D%A1%E4%BB%B6"><span class="nav-number">10.2.3.2.</span> <span class="nav-text">需要几个条件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%88-2-%EF%BC%89%E4%BB%A5%E5%BC%80%E5%90%AF%E8%AE%A4%E8%AF%81%E7%9A%84%E6%96%B9%E5%BC%8F%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="nav-number">10.2.3.3.</span> <span class="nav-text">（ 2 ）以开启认证的方式启动服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%89%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%BC%80%E5%90%AF%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%EF%BC%9A%E4%B8%80%E7%A7%8D%E6%98%AF%E5%8F%82%E6%95%B0%E6%96%B9%E5%BC%8F%EF%BC%8C%E4%B8%80%E7%A7%8D%E6%98%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F"><span class="nav-number">10.2.3.4.</span> <span class="nav-text">有两种方式开启权限认证启动服务：一种是参数方式，一种是配置文件方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8C%87%E5%AE%9A%E5%8F%82%E6%95%B0%E2%80%94auth%EF%BC%8C%E5%A6%82"><span class="nav-number">10.2.3.5.</span> <span class="nav-text">在启动时指定参数—auth，如</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8mongod-conf%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E5%8A%A0%E5%85%A5"><span class="nav-number">10.2.3.6.</span> <span class="nav-text">在mongod.conf配置文件中加入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%97%B6%E5%8F%AF%E4%B8%8D%E5%8A%A0%E2%80%94auth%E5%8F%82%E6%95%B0"><span class="nav-number">10.2.3.7.</span> <span class="nav-text">启动时可不加—auth参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%88-3-%EF%BC%89%E5%BC%80%E5%90%AF%E4%BA%86%E8%AE%A4%E8%AF%81%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%99%BB%E5%BD%95"><span class="nav-number">10.2.3.8.</span> <span class="nav-text">（ 3 ）开启了认证的情况下的客户端登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%89%E4%B8%A4%E7%A7%8D%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F%EF%BC%8C%E4%B8%80%E7%A7%8D%E6%98%AF%E5%85%88%E7%99%BB%E5%BD%95%EF%BC%8C%E5%9C%A8mongo-shell%E4%B8%AD%E8%AE%A4%E8%AF%81%EF%BC%9B%E4%B8%80%E7%A7%8D%E6%98%AF%E7%99%BB%E5%BD%95%E6%97%B6%E7%9B%B4%E6%8E%A5%E8%AE%A4%E8%AF%81"><span class="nav-number">10.2.3.9.</span> <span class="nav-text">有两种认证方式，一种是先登录，在mongo shell中认证；一种是登录时直接认证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-16"><span class="nav-number">10.2.3.10.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E8%AE%A4%E8%AF%81%E5%90%8E%E5%86%8D%E7%99%BB%E5%BD%95%EF%BC%8C%E5%8F%91%E7%8E%B0%E6%89%93%E5%8D%B0%E7%9A%84%E6%97%A5%E5%BF%97%E6%AF%94%E8%BE%83%E5%B0%91%E4%BA%86"><span class="nav-number">10.2.3.11.</span> <span class="nav-text">开启认证后再登录，发现打印的日志比较少了</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%E9%9C%80%E8%A6%81%E8%AE%A4%E8%AF%81%E6%89%8D%E5%8F%AF%E4%BB%A5"><span class="nav-number">10.2.3.12.</span> <span class="nav-text">相关操作需要认证才可以</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2admin%E5%BA%93%E4%B8%AD%E7%9A%84system-users%E9%9B%86%E5%90%88%E7%9A%84%E7%94%A8%E6%88%B7"><span class="nav-number">10.2.3.13.</span> <span class="nav-text">查询admin库中的system.users集合的用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2articledb%E5%BA%93%E4%B8%AD%E7%9A%84comment%E9%9B%86%E5%90%88%E7%9A%84%E5%86%85%E5%AE%B9"><span class="nav-number">10.2.3.14.</span> <span class="nav-text">查询articledb库中的comment集合的内容</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-17"><span class="nav-number">10.2.3.15.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%99%E9%87%8C%E5%8F%AF%E8%83%BD%E5%87%BA%E7%8E%B0%E9%94%99%E8%AF%AF%EF%BC%8C%E8%AF%B4%E6%98%AF%E5%A4%AA%E5%A4%9A%E7%9A%84%E7%94%A8%E6%88%B7%E6%AD%A3%E5%9C%A8%E8%AE%A4%E8%AF%81%E4%BA%86%E3%80%82%E5%9B%A0%E4%B8%BA%E6%88%91%E4%BB%AC%E7%A1%AE%E5%AE%9E%E8%BF%9E%E7%BB%AD%E7%99%BB%E5%BD%95%E4%BA%86%E4%B8%A4%E4%B8%AA%E7%94%A8%E6%88%B7%E4%BA%86"><span class="nav-number">10.2.3.16.</span> <span class="nav-text">这里可能出现错误，说是太多的用户正在认证了。因为我们确实连续登录了两个用户了</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A%E9%80%80%E5%87%BAshell%EF%BC%8C%E9%87%8D%E6%96%B0%E8%BF%9B%E6%9D%A5%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81"><span class="nav-number">10.2.3.17.</span> <span class="nav-text">解决方案：退出shell，重新进来登录认证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9admin%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8C%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E5%92%8C%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="nav-number">10.2.3.18.</span> <span class="nav-text">对admin数据库进行登录认证和相关操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9articledb%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9B%E8%A1%8C%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E5%92%8C%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="nav-number">10.2.3.19.</span> <span class="nav-text">对articledb数据库进行登录认证和相关操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-18"><span class="nav-number">10.2.3.20.</span> <span class="nav-text">提示</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-4-SpringDataMongoDB%E8%BF%9E%E6%8E%A5%E8%AE%A4%E8%AF%81"><span class="nav-number">10.2.4.</span> <span class="nav-text">3.2.4 SpringDataMongoDB连接认证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A%E4%BD%BF%E7%94%A8%E7%94%A8%E6%88%B7bobo%E4%BD%BF%E7%94%A8%E5%AF%86%E7%A0%81-123456-%E8%BF%9E%E6%8E%A5%E5%88%B0MongoDB-%E6%9C%8D%E5%8A%A1%E4%B8%8A"><span class="nav-number">10.2.4.1.</span> <span class="nav-text">目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#application-yml"><span class="nav-number">10.2.4.2.</span> <span class="nav-text">application.yml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-19"><span class="nav-number">10.2.4.3.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E5%88%AB%E6%B5%8B%E8%AF%95%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81%E6%AD%A3%E7%A1%AE%E4%BB%A5%E5%8F%8A%E4%B8%8D%E6%AD%A3%E7%A1%AE%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">10.2.4.4.</span> <span class="nav-text">分别测试用户名密码正确以及不正确的情况</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%89%AF%E6%9C%AC%E9%9B%86%E7%8E%AF%E5%A2%83"><span class="nav-number">10.3.</span> <span class="nav-text">3.3 副本集环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-%E5%89%8D%E8%A8%80"><span class="nav-number">10.3.1.</span> <span class="nav-text">3.3.1 前言</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E4%BA%8E%E6%90%AD%E5%BB%BA%E5%A5%BD%E7%9A%84mongodb%E5%89%AF%E6%9C%AC%E9%9B%86%EF%BC%8C%E4%B8%BA%E4%BA%86%E5%AE%89%E5%85%A8%EF%BC%8C%E5%90%AF%E5%8A%A8%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%EF%BC%8C%E4%BD%BF%E7%94%A8%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95"><span class="nav-number">10.3.1.1.</span> <span class="nav-text">对于搭建好的mongodb副本集，为了安全，启动安全认证，使用账号密码登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%AF%E6%9C%AC%E9%9B%86%E7%8E%AF%E5%A2%83%E4%BD%BF%E7%94%A8%E4%B9%8B%E5%89%8D%E6%90%AD%E5%BB%BA%E5%A5%BD%E7%9A%84%EF%BC%8C%E6%9E%B6%E6%9E%84%E5%A6%82%E4%B8%8B"><span class="nav-number">10.3.1.2.</span> <span class="nav-text">副本集环境使用之前搭建好的，架构如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E6%89%A7%E8%A1%8C%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E9%9C%80%E8%A6%81%E9%85%8D%E7%BD%AE%E4%B8%A4%E4%B8%AA%E6%96%B9%E9%9D%A2"><span class="nav-number">10.3.1.3.</span> <span class="nav-text">对副本集执行访问控制需要配置两个方面</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-%E5%85%B3%E9%97%AD%E5%B7%B2%E5%BC%80%E5%90%AF%E7%9A%84%E5%89%AF%E6%9C%AC%E9%9B%86%E6%9C%8D%E5%8A%A1%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-number">10.3.2.</span> <span class="nav-text">3.3.2 关闭已开启的副本集服务（可选）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%E5%92%8C%E6%9C%8D%E5%8A%A1%E9%89%B4%E6%9D%83%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8%E5%89%AF%E6%9C%AC%E9%9B%86%E6%90%AD%E5%BB%BA%E7%9A%84%E6%97%B6%E5%80%99%E7%9B%B4%E6%8E%A5%E6%B7%BB%E5%8A%A0%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%9C%A8%E4%B9%8B%E5%89%8D%E6%90%AD%E5%BB%BA%E5%A5%BD%E7%9A%84%E5%89%AF%E6%9C%AC%E9%9B%86%E6%9C%8D%E5%8A%A1%E4%B8%8A%E6%B7%BB%E5%8A%A0"><span class="nav-number">10.3.2.1.</span> <span class="nav-text">增加副本集的安全认证和服务鉴权功能，可以在副本集搭建的时候直接添加，也可以在之前搭建好的副本集服务上添加</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%AC%E6%96%87%E4%BD%BF%E7%94%A8%E4%B9%8B%E5%89%8D%E6%90%AD%E5%BB%BA%E5%A5%BD%E7%9A%84%E5%89%AF%E6%9C%AC%E9%9B%86%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%9B%A0%E6%AD%A4%EF%BC%8C%E5%85%88%E5%81%9C%E6%AD%A2%E4%B9%8B%E5%89%8D%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1"><span class="nav-number">10.3.2.2.</span> <span class="nav-text">本文使用之前搭建好的副本集服务，因此，先停止之前的集群服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9C%89%E4%B8%A4%E7%A7%8D%EF%BC%9A%E5%BF%AB%E9%80%9F%E5%85%B3%E9%97%AD%E5%92%8C%E6%A0%87%E5%87%86%E5%85%B3%E9%97%AD%EF%BC%8C%E4%B8%8B%E9%9D%A2%E4%BE%9D%E6%AC%A1%E8%AF%B4%E6%98%8E-2"><span class="nav-number">10.3.2.3.</span> <span class="nav-text">停止服务的方式有两种：快速关闭和标准关闭，下面依次说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%88-1-%EF%BC%89%E5%BF%AB%E9%80%9F%E5%85%B3%E9%97%AD%E6%96%B9%E6%B3%95%EF%BC%88%E5%BF%AB%E9%80%9F%EF%BC%8C%E7%AE%80%E5%8D%95%EF%BC%8C%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%87%BA%E9%94%99%EF%BC%89"><span class="nav-number">10.3.2.4.</span> <span class="nav-text">（ 1 ）快速关闭方法（快速，简单，数据可能会出错）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A%E9%80%9A%E8%BF%87%E7%B3%BB%E7%BB%9F%E7%9A%84kill%E5%91%BD%E4%BB%A4%E7%9B%B4%E6%8E%A5%E6%9D%80%E6%AD%BB%E8%BF%9B%E7%A8%8B-1"><span class="nav-number">10.3.2.5.</span> <span class="nav-text">目标：通过系统的kill命令直接杀死进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%9D%E6%AC%A1%E6%9D%80%E6%AD%BB%E4%BB%B2%E8%A3%81%E8%80%85%E3%80%81%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9%E3%80%81%E4%B8%BB%E8%8A%82%E7%82%B9%EF%BC%8C%E7%9B%B4%E5%88%B0%E6%89%80%E6%9C%89%E6%88%90%E5%91%98%E9%83%BD%E7%A6%BB%E7%BA%BF%E3%80%82%E5%BB%BA%E8%AE%AE%E4%B8%BB%E8%8A%82%E7%82%B9%E6%9C%80%E5%90%8Ekill%EF%BC%8C%E4%BB%A5%E9%81%BF%E5%85%8D%E6%BD%9C%E5%9C%A8%E7%9A%84%E5%9B%9E%E6%BB%9A%E3%80%82%E6%9D%80%E5%AE%8C%E8%A6%81%E6%A3%80%E6%9F%A5%E4%B8%80%E4%B8%8B%EF%BC%8C%E9%81%BF%E5%85%8D%E6%9C%89%E7%9A%84%E6%B2%A1%E6%9C%89%E6%9D%80%E6%8E%89"><span class="nav-number">10.3.2.6.</span> <span class="nav-text">依次杀死仲裁者、副本节点、主节点，直到所有成员都离线。建议主节点最后kill，以避免潜在的回滚。杀完要检查一下，避免有的没有杀掉</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E8%A1%A5%E5%85%85%E3%80%91-2"><span class="nav-number">10.3.2.7.</span> <span class="nav-text">【补充】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E4%B8%80%E6%97%A6%E6%98%AF%E5%9B%A0%E4%B8%BA%E6%95%B0%E6%8D%AE%E6%8D%9F%E5%9D%8F%EF%BC%8C%E5%88%99%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8C%E5%A6%82%E4%B8%8B%E6%93%8D%E4%BD%9C%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89-1"><span class="nav-number">10.3.2.8.</span> <span class="nav-text">如果一旦是因为数据损坏，则需要进行如下操作（了解）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%88-2-%EF%BC%89%E6%A0%87%E5%87%86%E7%9A%84%E5%85%B3%E9%97%AD%E6%96%B9%E6%B3%95%EF%BC%88%E6%95%B0%E6%8D%AE%E4%B8%8D%E5%AE%B9%E6%98%93%E5%87%BA%E9%94%99%EF%BC%8C%E4%BD%86%E9%BA%BB%E7%83%A6%EF%BC%89"><span class="nav-number">10.3.2.9.</span> <span class="nav-text">（ 2 ）标准的关闭方法（数据不容易出错，但麻烦）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3-%E9%80%9A%E8%BF%87%E4%B8%BB%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E7%AE%A1%E7%90%86%E5%91%98%E5%B8%90%E5%8F%B7"><span class="nav-number">10.3.3.</span> <span class="nav-text">3.3.3 通过主节点添加一个管理员帐号</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AA%E9%9C%80%E8%A6%81%E5%9C%A8%E4%B8%BB%E8%8A%82%E7%82%B9%E4%B8%8A%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%EF%BC%8C%E5%89%AF%E6%9C%AC%E9%9B%86%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%90%8C%E6%AD%A5"><span class="nav-number">10.3.3.1.</span> <span class="nav-text">只需要在主节点上添加用户，副本集会自动同步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E8%AE%A4%E8%AF%81%E4%B9%8B%E5%89%8D%EF%BC%8C%E5%88%9B%E5%BB%BA%E8%B6%85%E7%AE%A1%E7%94%A8%E6%88%B7%EF%BC%9Amyroot%EF%BC%8C%E5%AF%86%E7%A0%81%EF%BC%9A-123456"><span class="nav-number">10.3.3.2.</span> <span class="nav-text">开启认证之前，创建超管用户：myroot，密码： 123456</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%A6%E7%BB%86%E6%93%8D%E4%BD%9C%E8%AF%A6%E8%A7%81%E5%8D%95%E5%AE%9E%E4%BE%8B%E7%8E%AF%E5%A2%83%E7%9A%84%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%92%8C%E6%9D%83%E9%99%90%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="nav-number">10.3.3.3.</span> <span class="nav-text">详细操作详见单实例环境的添加用户和权限的相关操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-20"><span class="nav-number">10.3.3.4.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%A5%E6%AD%A5%E9%AA%A4%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%9C%A8%E5%BC%80%E5%90%AF%E8%AE%A4%E8%AF%81%E4%B9%8B%E5%90%8E%EF%BC%8C%E4%BD%86%E9%9C%80%E8%A6%81%E9%80%9A%E8%BF%87localhost%E7%99%BB%E5%BD%95%E6%89%8D%E5%85%81%E8%AE%B8%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%EF%BC%8C%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E4%B9%9F%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%90%8C%E6%AD%A5%E5%88%B0%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">10.3.3.5.</span> <span class="nav-text">该步骤也可以在开启认证之后，但需要通过localhost登录才允许添加用户，用户数据也会自动同步到副本集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8E%E7%BB%AD%E5%86%8D%E5%88%9B%E5%BB%BA%E5%85%B6%E4%BB%96%E7%94%A8%E6%88%B7%EF%BC%8C%E9%83%BD%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E8%AF%A5%E8%B6%85%E7%AE%A1%E7%94%A8%E6%88%B7%E5%88%9B%E5%BB%BA"><span class="nav-number">10.3.3.6.</span> <span class="nav-text">后续再创建其他用户，都可以使用该超管用户创建</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-4-%E5%88%9B%E5%BB%BA%E5%89%AF%E6%9C%AC%E9%9B%86%E8%AE%A4%E8%AF%81%E7%9A%84key%E6%96%87%E4%BB%B6"><span class="nav-number">10.3.4.</span> <span class="nav-text">3.3.4 创建副本集认证的key文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AAkey%E6%96%87%E4%BB%B6%E5%88%B0%E5%BD%93%E5%89%8D%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%AD"><span class="nav-number">10.3.4.1.</span> <span class="nav-text">第一步：生成一个key文件到当前文件夹中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E4%BB%BB%E4%BD%95%E6%96%B9%E6%B3%95%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5%E6%96%87%E4%BB%B6%E3%80%82%E4%BE%8B%E5%A6%82%EF%BC%8C%E4%BB%A5%E4%B8%8B%E6%93%8D%E4%BD%9C%E4%BD%BF%E7%94%A8openssl%E7%94%9F%E6%88%90%E5%AF%86%E7%A0%81%E6%96%87%E4%BB%B6%EF%BC%8C%E7%84%B6%E5%90%8E%E4%BD%BF%E7%94%A8chmod%E6%9D%A5%E6%9B%B4%E6%94%B9%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90%EF%BC%8C%E4%BB%85%E4%B8%BA%E6%96%87%E4%BB%B6%E6%89%80%E6%9C%89%E8%80%85%E6%8F%90%E4%BE%9B%E8%AF%BB%E5%8F%96%E6%9D%83%E9%99%90"><span class="nav-number">10.3.4.2.</span> <span class="nav-text">可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-21"><span class="nav-number">10.3.4.3.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%99%E9%87%8C%E5%B0%86%E8%AF%A5%E6%96%87%E4%BB%B6%E5%88%86%E5%88%AB%E6%8B%B7%E8%B4%9D%E5%88%B0%E5%A4%9A%E4%B8%AA%E7%9B%AE%E5%BD%95%E4%B8%AD"><span class="nav-number">10.3.4.4.</span> <span class="nav-text">这里将该文件分别拷贝到多个目录中</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-5-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%8C%87%E5%AE%9Akeyfile"><span class="nav-number">10.3.5.</span> <span class="nav-text">3.3.5 修改配置文件指定keyfile</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E5%88%AB%E7%BC%96%E8%BE%91%E5%87%A0%E4%B8%AA%E6%9C%8D%E5%8A%A1%E7%9A%84mongod-conf%E6%96%87%E4%BB%B6%EF%BC%8C%E6%B7%BB%E5%8A%A0%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9"><span class="nav-number">10.3.5.1.</span> <span class="nav-text">分别编辑几个服务的mongod.conf文件，添加相关内容</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-6-%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">10.3.6.</span> <span class="nav-text">3.3.6 重新启动副本集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E5%88%AB%E5%90%AF%E5%8A%A8%E5%89%AF%E6%9C%AC%E9%9B%86%E8%8A%82%E7%82%B9"><span class="nav-number">10.3.6.1.</span> <span class="nav-text">分别启动副本集节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E6%83%85%E5%86%B5"><span class="nav-number">10.3.6.2.</span> <span class="nav-text">查看进程情况</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-7-%E5%9C%A8%E4%B8%BB%E8%8A%82%E7%82%B9%E4%B8%8A%E6%B7%BB%E5%8A%A0%E6%99%AE%E9%80%9A%E8%B4%A6%E5%8F%B7"><span class="nav-number">10.3.7.</span> <span class="nav-text">3.3.7 在主节点上添加普通账号</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E6%96%B0%E8%BF%9E%E6%8E%A5%EF%BC%8C%E4%BD%BF%E7%94%A8%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7bobo%E9%87%8D%E6%96%B0%E7%99%BB%E5%BD%95%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE"><span class="nav-number">10.3.7.1.</span> <span class="nav-text">重新连接，使用普通用户bobo重新登录，查看数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9A%E4%B9%9F%E8%A6%81%E4%BD%BF%E7%94%A8rs-status-%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B%E5%89%AF%E6%9C%AC%E9%9B%86%E6%98%AF%E5%90%A6%E5%81%A5%E5%BA%B7"><span class="nav-number">10.3.7.2.</span> <span class="nav-text">注意：也要使用rs.status()命令查看副本集是否健康</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-8-SpringDataMongoDB%E8%BF%9E%E6%8E%A5%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="nav-number">10.3.8.</span> <span class="nav-text">3.3.8 SpringDataMongoDB连接副本集</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A%E4%BD%BF%E7%94%A8%E7%94%A8%E6%88%B7bobo%E4%BD%BF%E7%94%A8%E5%AF%86%E7%A0%81-123456-%E8%BF%9E%E6%8E%A5%E5%88%B0MongoDB-%E6%9C%8D%E5%8A%A1%E4%B8%8A-1"><span class="nav-number">10.3.8.1.</span> <span class="nav-text">目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#application-yml-1"><span class="nav-number">10.3.8.2.</span> <span class="nav-text">application.yml</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83-%E6%89%A9%E5%B1%95"><span class="nav-number">10.4.</span> <span class="nav-text">3.4 分片集群环境(扩展)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-%E5%85%B3%E9%97%AD%E5%B7%B2%E5%BC%80%E5%90%AF%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-number">10.4.1.</span> <span class="nav-text">3.3.1 关闭已开启的集群服务（可选）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A%E9%80%9A%E8%BF%87%E7%B3%BB%E7%BB%9F%E7%9A%84kill%E5%91%BD%E4%BB%A4%E7%9B%B4%E6%8E%A5%E6%9D%80%E6%AD%BB%E8%BF%9B%E7%A8%8B-2"><span class="nav-number">10.4.1.1.</span> <span class="nav-text">目标：通过系统的kill命令直接杀死进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E3%80%90%E8%A1%A5%E5%85%85%E3%80%91-3"><span class="nav-number">10.4.1.2.</span> <span class="nav-text">【补充】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E4%B8%80%E6%97%A6%E6%98%AF%E5%9B%A0%E4%B8%BA%E6%95%B0%E6%8D%AE%E6%8D%9F%E5%9D%8F%EF%BC%8C%E5%88%99%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8C%E5%A6%82%E4%B8%8B%E6%93%8D%E4%BD%9C%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89-2"><span class="nav-number">10.4.1.3.</span> <span class="nav-text">如果一旦是因为数据损坏，则需要进行如下操作（了解）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%88-2-%EF%BC%89%E6%A0%87%E5%87%86%E7%9A%84%E5%85%B3%E9%97%AD%E6%96%B9%E6%B3%95%EF%BC%88%E6%95%B0%E6%8D%AE%E4%B8%8D%E5%AE%B9%E6%98%93%E5%87%BA%E9%94%99%EF%BC%8C%E4%BD%86%E9%BA%BB%E7%83%A6%EF%BC%89-1"><span class="nav-number">10.4.1.4.</span> <span class="nav-text">（ 2 ）标准的关闭方法（数据不容易出错，但麻烦）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A%E9%80%9A%E8%BF%87mongo%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%AD%E7%9A%84shutdownServer%E5%91%BD%E4%BB%A4%E6%9D%A5%E4%BE%9D%E6%AC%A1%E5%85%B3%E9%97%AD%E5%90%84%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="nav-number">10.4.1.5.</span> <span class="nav-text">目标：通过mongo客户端中的shutdownServer命令来依次关闭各个服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E5%88%86%E7%89%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%89%AF%E6%9C%AC%E9%9B%86%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%BB%BA%E8%AE%AE%E4%BE%9D%E6%AC%A1%E5%85%B3%E9%97%AD%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9%E3%80%81%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9%E3%80%81%E4%B8%BB%E8%8A%82%E7%82%B9%E3%80%82%E4%B8%BB%E8%A6%81%E7%9A%84%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4%E5%8F%82%E8%80%83%E5%A6%82%E4%B8%8B"><span class="nav-number">10.4.1.6.</span> <span class="nav-text">关闭分片服务器副本集中的服务，建议依次关闭仲裁节点、副本节点、主节点。主要的操作步骤参考如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%89%AF%E6%9C%AC%E9%9B%86%E7%9A%84%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%BB%BA%E8%AE%AE%E4%BE%9D%E6%AC%A1%E5%85%B3%E9%97%AD%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9%E3%80%81%E4%B8%BB%E8%8A%82%E7%82%B9%E3%80%82%E4%B8%BB%E8%A6%81%E7%9A%84%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4%E5%8F%82%E8%80%83%E5%A6%82%E4%B8%8B"><span class="nav-number">10.4.1.7.</span> <span class="nav-text">关闭配置服务器副本集的服务，建议依次关闭副本节点、主节点。主要的操作步骤参考如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E8%B7%AF%E7%94%B1%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%BB%BA%E8%AE%AE%E4%BE%9D%E6%AC%A1%E5%85%B3%E9%97%AD%E4%B8%A4%E4%B8%AA%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9%E3%80%82%E4%B8%BB%E8%A6%81%E7%9A%84%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4%E5%8F%82%E8%80%83%E5%A6%82%E4%B8%8B"><span class="nav-number">10.4.1.8.</span> <span class="nav-text">关闭路由服务器的服务，建议依次关闭两个路由节点。主要的操作步骤参考如下</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-%E5%88%9B%E5%BB%BA%E5%89%AF%E6%9C%AC%E9%9B%86%E8%AE%A4%E8%AF%81%E7%9A%84key%E6%96%87%E4%BB%B6"><span class="nav-number">10.4.2.</span> <span class="nav-text">3.3.2 创建副本集认证的key文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AAkey%E6%96%87%E4%BB%B6%E5%88%B0%E5%BD%93%E5%89%8D%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%AD-1"><span class="nav-number">10.4.2.1.</span> <span class="nav-text">第一步：生成一个key文件到当前文件夹中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E4%BB%BB%E4%BD%95%E6%96%B9%E6%B3%95%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5%E6%96%87%E4%BB%B6%E3%80%82%E4%BE%8B%E5%A6%82%EF%BC%8C%E4%BB%A5%E4%B8%8B%E6%93%8D%E4%BD%9C%E4%BD%BF%E7%94%A8openssl%E7%94%9F%E6%88%90%E5%AF%86%E7%A0%81%E6%96%87%E4%BB%B6%EF%BC%8C%E7%84%B6%E5%90%8E%E4%BD%BF%E7%94%A8chmod%E6%9D%A5%E6%9B%B4%E6%94%B9%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90%EF%BC%8C%E4%BB%85%E4%B8%BA%E6%96%87%E4%BB%B6%E6%89%80%E6%9C%89%E8%80%85%E6%8F%90%E4%BE%9B%E8%AF%BB%E5%8F%96%E6%9D%83%E9%99%90-1"><span class="nav-number">10.4.2.2.</span> <span class="nav-text">可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-22"><span class="nav-number">10.4.2.3.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%99%E9%87%8C%E5%B0%86%E8%AF%A5%E6%96%87%E4%BB%B6%E5%88%86%E5%88%AB%E6%8B%B7%E8%B4%9D%E5%88%B0%E5%A4%9A%E4%B8%AA%E7%9B%AE%E5%BD%95%E4%B8%AD-1"><span class="nav-number">10.4.2.4.</span> <span class="nav-text">这里将该文件分别拷贝到多个目录中</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%8C%87%E5%AE%9Akeyfile"><span class="nav-number">10.4.3.</span> <span class="nav-text">3.3.3 修改配置文件指定keyfile</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E5%88%AB%E7%BC%96%E8%BE%91%E5%87%A0%E4%B8%AA%E6%9C%8D%E5%8A%A1%E7%9A%84mongod-conf%E6%96%87%E4%BB%B6%EF%BC%8C%E6%B7%BB%E5%8A%A0%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9-1"><span class="nav-number">10.4.3.1.</span> <span class="nav-text">分别编辑几个服务的mongod.conf文件，添加相关内容</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb-sharded-cluster-myshardrs01-27018-mongod-conf"><span class="nav-number">10.4.3.2.</span> <span class="nav-text">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;mongod.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb-sharded-cluster-myshardrs01-27118-mongod-conf"><span class="nav-number">10.4.3.3.</span> <span class="nav-text">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;mongod.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb-sharded-cluster-myshardrs01-27218-mongod-conf"><span class="nav-number">10.4.3.4.</span> <span class="nav-text">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;mongod.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb-sharded-cluster-myshardrs02-27318-mongod-conf"><span class="nav-number">10.4.3.5.</span> <span class="nav-text">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;mongod.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb-sharded-cluster-myshardrs02-27418-mongod-conf"><span class="nav-number">10.4.3.6.</span> <span class="nav-text">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;mongod.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb-sharded-cluster-myshardrs02-27518-mongod-conf"><span class="nav-number">10.4.3.7.</span> <span class="nav-text">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;mongod.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb-sharded-cluster-myconfigrs-27019-mongod-conf"><span class="nav-number">10.4.3.8.</span> <span class="nav-text">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;mongod.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb-sharded-cluster-myconfigrs-27119-mongod-conf"><span class="nav-number">10.4.3.9.</span> <span class="nav-text">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;mongod.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb-sharded-cluster-myconfigrs-27219-mongod-conf"><span class="nav-number">10.4.3.10.</span> <span class="nav-text">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;mongod.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb-sharded-cluster-mymongos-27017-mongos-conf"><span class="nav-number">10.4.3.11.</span> <span class="nav-text">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;mongos.conf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb-sharded-cluster-mymongos-27117-mongos-conf"><span class="nav-number">10.4.3.12.</span> <span class="nav-text">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;mongos.conf</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-4-%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8%E8%8A%82%E7%82%B9"><span class="nav-number">10.4.4.</span> <span class="nav-text">3.3.4 重新启动节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BF%85%E9%A1%BB%E4%BE%9D%E6%AC%A1%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E3%80%81%E5%88%86%E7%89%87%E8%8A%82%E7%82%B9%E3%80%81%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9"><span class="nav-number">10.4.4.1.</span> <span class="nav-text">必须依次启动配置节点、分片节点、路由节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F-4"><span class="nav-number">10.4.4.2.</span> <span class="nav-text">注意</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%99%E9%87%8C%E6%9C%89%E4%B8%AA%E9%9D%9E%E5%B8%B8%E7%89%B9%E5%88%AB%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%8C%E5%B0%B1%E6%98%AF%E5%90%AF%E5%8A%A8%E9%A1%BA%E5%BA%8F%E3%80%82%E5%85%88%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%EF%BC%8C%E5%86%8D%E5%90%AF%E5%8A%A8%E5%88%86%E7%89%87%E8%8A%82%E7%82%B9%EF%BC%8C%E6%9C%80%E5%90%8E%E5%90%AF%E5%8A%A8%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9"><span class="nav-number">10.4.4.3.</span> <span class="nav-text">这里有个非常特别的情况，就是启动顺序。先启动配置节点，再启动分片节点，最后启动路由节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E5%85%88%E5%90%AF%E5%8A%A8%E5%88%86%E7%89%87%E8%8A%82%E7%82%B9%EF%BC%8C%E4%BC%9A%E5%8D%A1%E4%BD%8F%EF%BC%8C%E6%8F%90%E7%A4%BA"><span class="nav-number">10.4.4.4.</span> <span class="nav-text">如果先启动分片节点，会卡住，提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%99%E4%B9%9F%E8%AE%B8%E6%98%AF%E4%B8%AAbug%E3%80%82%E5%8E%9F%E5%9B%A0%E6%9C%AA%E7%9F%A5"><span class="nav-number">10.4.4.5.</span> <span class="nav-text">这也许是个bug。原因未知</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-5-%E5%88%9B%E5%BB%BA%E5%B8%90%E5%8F%B7%E5%92%8C%E8%AE%A4%E8%AF%81"><span class="nav-number">10.4.5.</span> <span class="nav-text">3.3.5 创建帐号和认证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AFmongo%EF%BC%8C%E9%80%9A%E8%BF%87localhost%E7%99%BB%E5%BD%95%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AAmongos%E8%B7%AF%E7%94%B1"><span class="nav-number">10.4.5.1.</span> <span class="nav-text">客户端mongo，通过localhost登录任意一个mongos路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9A%E7%9B%B8%E5%BD%93%E4%BA%8E%E4%B8%80%E4%B8%AA%E5%90%8E%E9%97%A8%EF%BC%8C%E5%8F%AA%E8%83%BD%E5%9C%A8admin%E4%B8%8B%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7"><span class="nav-number">10.4.5.2.</span> <span class="nav-text">提示：相当于一个后门，只能在admin下添加用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%A1%E7%90%86%E5%91%98%E5%B8%90%E5%8F%B7"><span class="nav-number">10.4.5.3.</span> <span class="nav-text">创建一个管理员帐号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%EF%BC%9A%E5%A6%82%E6%9E%9C%E5%9C%A8%E5%BC%80%E5%90%AF%E8%AE%A4%E8%AF%81%E4%B9%8B%E5%89%8D%E5%B7%B2%E7%BB%8F%E5%88%9B%E5%BB%BA%E4%BA%86%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E5%8F%B7%EF%BC%8C%E8%BF%99%E9%87%8C%E5%8F%AF%E4%BB%A5%E5%BF%BD%E7%95%A5"><span class="nav-number">10.4.5.4.</span> <span class="nav-text">提示：如果在开启认证之前已经创建了管理员账号，这里可以忽略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%E6%9D%83%E9%99%90%E5%B8%90%E5%8F%B7"><span class="nav-number">10.4.5.5.</span> <span class="nav-text">创建一个普通权限帐号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA-23"><span class="nav-number">10.4.5.6.</span> <span class="nav-text">提示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mongo%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%99%BB%E5%BD%95mongos%E8%B7%AF%E7%94%B1%EF%BC%8C%E7%94%A8%E7%AE%A1%E7%90%86%E5%91%98%E5%B8%90%E5%8F%B7%E7%99%BB%E5%BD%95%E5%8F%AF%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87%E6%83%85%E5%86%B5"><span class="nav-number">10.4.5.7.</span> <span class="nav-text">mongo客户端登录mongos路由，用管理员帐号登录可查看分片情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%80%E5%87%BA%E8%BF%9E%E6%8E%A5%EF%BC%8C%E9%87%8D%E6%96%B0%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%EF%BC%8C%E4%BD%BF%E7%94%A8%E6%99%AE%E9%80%9A%E6%9D%83%E9%99%90%E5%B8%90%E5%8F%B7%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE"><span class="nav-number">10.4.5.8.</span> <span class="nav-text">退出连接，重新连接服务，使用普通权限帐号访问数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-6-SpringDataMongoDB%E8%BF%9E%E6%8E%A5%E8%AE%A4%E8%AF%81"><span class="nav-number">10.4.6.</span> <span class="nav-text">3.3.6 SpringDataMongoDB连接认证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A%E4%BD%BF%E7%94%A8%E7%94%A8%E6%88%B7bobo%E4%BD%BF%E7%94%A8%E5%AF%86%E7%A0%81-123456-%E8%BF%9E%E6%8E%A5%E5%88%B0MongoDB-%E6%9C%8D%E5%8A%A1%E4%B8%8A-2"><span class="nav-number">10.4.6.1.</span> <span class="nav-text">目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#application-yml-2"><span class="nav-number">10.4.6.2.</span> <span class="nav-text">application.yml</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zongqing Li"
      src="https://github.com/hqulzq/hqulzq.github.io/blob/main/images/userimg.jpg?raw=true">
  <p class="site-author-name" itemprop="name">Zongqing Li</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hqulzq" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hqulzq" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hqulzq@163.com" title="E-Mail → mailto:hqulzq@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

      
<script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
<div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div id="myCanvasContainer" class="widget tagcloud">
        <canvas width="250" height="250" id="resCanvas" style="width=100%">
            <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bug%E6%80%BB%E7%BB%93/" rel="tag">Bug总结</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Knife4j/" rel="tag">Knife4j</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MinIO/" rel="tag">MinIO</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis-Plus/" rel="tag">Mybatis-Plus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketMQ/" rel="tag">RocketMQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/diffusion/" rel="tag">diffusion</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/latex/" rel="tag">latex</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/" rel="tag">mongodb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E9%9A%8F%E6%83%B3%E5%BD%95/" rel="tag">代码随想录</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%B4%E5%87%BD%E6%95%B0/" rel="tag">头函数</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%9A%E5%BA%AD%E5%85%AC%E5%AF%93/" rel="tag">尚庭公寓</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" rel="tag">异常处理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" rel="tag">快速入门</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" rel="tag">技术总结</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E7%BB%84/" rel="tag">数组</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E8%A7%A3/" rel="tag">注解</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%8B%A5%E4%BE%9D/" rel="tag">若依</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BA%E6%96%87/" rel="tag">论文</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%93%BE%E8%A1%A8i/" rel="tag">链表i</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" rel="tag">项目实战</a><span class="tag-list-count">6</span></li></ul>
        </canvas>
    </div>
</div>



    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zongqing Li</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #4D4D4C;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #F7F7F7;
      background-image: linear-gradient(#F7F7F7, #F7F7F7);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>

  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('post.copy_button').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('post.copy_success')
          else $(this).text('post.copy_failure')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('post.copy_button')
        }, 300)
      }).append(e)
    })
  </script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":-15,"vOffset":-15},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
